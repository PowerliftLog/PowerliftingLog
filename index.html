<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Unrack</title>

<!-- PWA manifest -->
<link rel="manifest" href="manifest.json">

<!-- iOS PWA meta tags -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" id="status-bar-meta" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Unrack">
<link rel="apple-touch-icon" href="icons/icon-180.png">

<!-- Theme color for browser chrome -->
<meta name="theme-color" id="theme-color-meta" content="#0a0a0a">

<!-- Content Security Policy -->
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://accounts.google.com https://apis.google.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; img-src 'self' data:; frame-src 'self' blob: https://docs.google.com https://accounts.google.com; connect-src 'self' https://www.googleapis.com">

<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/PowerliftingLog/service-worker.js')
        .catch(err => console.warn('SW registration failed:', err));
    });
  }
</script>
<link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAlElEQVR4nO2X0QmAMBBDU/GrW+koDuYoOpp+FUTwwyQQlGaA3nvX3kFLrfVAMEOyeAf4F8C+zlkANhYA1t4GAADTsmUAFHsLgBoJQLWXAVrY+5cAHPYAMDoOucK87QbVgSd75iq+NwVOe4B4A/dC0UXUikfG0BUZQLGXAFyLSOqAai8DOEJvQoc9DeBM6V+zDpAGOAEoFSO7lhfbZgAAAABJRU5ErkJggg==">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" integrity="sha384-vtjasyidUo0kW94K5MXDXntzOJpQgBKXmE7e2Ga4LG0skTTLeBi97eFAXsqewJjw" crossorigin="anonymous" defer></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://apis.google.com/js/api.js" async defer></script>
<script src="parsers.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;600;700;900&family=Barlow:wght@400;500;600&display=swap" rel="stylesheet">
<style>
/* ── THEME TOKENS ────────────────────────────────────────────────────────── */
:root {
  --bg:            #0a0a0a;
  --bg-2:          #0f0f0f;
  --surface-0:     #0e0e0e;
  --surface-1:     #111111;
  --surface-2:     #141414;
  --surface-3:     #1a1a1a;
  --surface-4:     #1c1c1c;
  --surface-5:     #1e1e1e;
  --border:        #2a2a2a;
  --border-2:      #222222;
  --border-3:      #333333;
  --input-bg:      #1c1c1c;
  --input-focus-bg:#1e1c15;
  --grad-start:    #1c1c1c;
  --grad-mid:      #141414;
  --grad-end:      #111111;
  --header-bg:     rgba(10,10,10,0.95);
  --header-border: rgba(255,255,255,0.06);
  --superset-bg:   #0e0e0e;
  --superset-hdr:  #161610;
  --superset-bdr:  #2a2a1a;
  --superset-card: #111111;
  --banner-grad-a: #1c1c14;
  --banner-grad-b: #161610;
  --banner-grad-active-a: #201e10;
  --banner-grad-active-b: #1a1a0e;
  --coach-note-bg: rgba(26,26,10,0.8);
  --coach-note-bdr:#2a2a18;
  --snap-chip-bg:  #1a1a1a;
  --snap-chip-mid: #1e1c18;
  --chart-bg:      #141414;
  --chart-bdr:     #2a2a2a;
  /* text */
  --text-primary:  #f0f0f0;
  --text-bright:   #e8e8e8;
  --text-mid:      #c0c0c0;
  --text-sub:      #888888;
  --text-muted:    #666666;
  --text-faint:    #555555;
  --text-dim:      #444444;
  --text-dimmer:   #333333;
  /* accent */
  --gold:          #C9A84C;
  --gold-data:     #C9A84C;
  --gold-rgb:      201,168,76;
  --card-shadow:   0 2px 12px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.05);
  --card-border:   rgba(255,255,255,0.07);
  --card-bg:       linear-gradient(160deg, var(--grad-start) 0%, var(--grad-mid) 60%, var(--grad-end) 100%);
  --sheet-bg:      rgba(18,18,18,0.82);
  --sheet-border:  var(--border-2);
  --modal-bg:      var(--bg-2);
  --glass-bg:      rgba(20,20,20,0.6);
  --glass-border:  rgba(255,255,255,0.08);
}
[data-theme="navy"] {
  --bg:            #0A0E1A;
  --bg-2:          #0A0E1A;
  --surface-0:     #0A0E1A;
  --surface-1:     #0f1520;
  --surface-2:     #111827;
  --surface-3:     #1E2A3A;
  --surface-4:     #161e2e;
  --surface-5:     #1a2535;
  --border:        #1E2A3A;
  --border-2:      #1a2535;
  --border-3:      #253347;
  --input-bg:      #161e2e;
  --input-focus-bg:#1e2535;
  --grad-start:    #161e2e;
  --grad-mid:      #111827;
  --grad-end:      #0f1520;
  --header-bg:     rgba(10,14,26,0.95);
  --header-border: rgba(255,255,255,0.06);
  --superset-bg:   #0A0E1A;
  --superset-hdr:  #111827;
  --superset-bdr:  #1E2A3A;
  --superset-card: #0f1520;
  --banner-grad-a: #111827;
  --banner-grad-b: #111827;
  --banner-grad-active-a: #1a2535;
  --banner-grad-active-b: #161e2e;
  --coach-note-bg: rgba(17,24,39,0.8);
  --coach-note-bdr:#1E2A3A;
  --snap-chip-bg:  #1E2A3A;
  --snap-chip-mid: #1a2535;
  --chart-bg:      #111827;
  --chart-bdr:     #1E2A3A;
  --sheet-bg:      rgba(14,18,32,0.82);
  --sheet-border:  rgba(255,255,255,0.1);
  --glass-bg:      rgba(30,42,58,0.55);
  --glass-border:  rgba(255,255,255,0.1);
}
[data-theme="light"] {
  --bg:            #F2EDE4;
  --bg-2:          #F2EDE4;
  --surface-0:     #F2EDE4;
  --surface-1:     #EDE7DB;
  --surface-2:     #FAF7F2;
  --surface-3:     #EDE7DB;
  --surface-4:     #FAF7F2;
  --surface-5:     #FFFFFF;
  --border:        #D6CEC4;
  --border-2:      #E0D9D0;
  --border-3:      #C8C0B8;
  --input-bg:      #FAF7F2;
  --input-focus-bg:#FFFFFF;
  --grad-start:    #FAF7F2;
  --grad-mid:      #F5F0E8;
  --grad-end:      #EDE7DB;
  --header-bg:     rgba(242,237,228,0.75);
  --header-border: rgba(255,255,255,0.6);
  --superset-bg:   #F2EDE4;
  --superset-hdr:  #FAF7F2;
  --superset-bdr:  #D6CEC4;
  --superset-card: #EDE7DB;
  --banner-grad-a: #FBF6E8;
  --banner-grad-b: #F7F0DC;
  --banner-grad-active-a: #FDF9F4;
  --banner-grad-active-b: #FAF7F2;
  --coach-note-bg: rgba(237,231,219,0.8);
  --coach-note-bdr:#D6CEC4;
  --snap-chip-bg:  #EDE7DB;
  --snap-chip-mid: #FAF7F2;
  --chart-bg:      #FAF7F2;
  --chart-bdr:     #D6CEC4;
  /* text — inverted for light bg */
  --text-primary:  #2C1F14;
  --text-bright:   #2C1F14;
  --text-mid:      #4A4440;
  --text-sub:      #6B6460;
  --text-muted:    #8A8280;
  --text-faint:    #9A9490;
  --text-dim:      #A8A29E;
  --text-dimmer:   #B0AAA6;
  /* accent — darkened gold for light bg contrast */
  --gold:          #B8922A;
  --gold-data:     #2C1F14;
  --gold-rgb:      184,146,42;
  --card-shadow:   0 1px 4px rgba(0,0,0,0.06), 0 2px 16px rgba(0,0,0,0.04);
  --card-border:   rgba(255,255,255,0.8);
  --card-bg:       linear-gradient(160deg, var(--grad-start) 0%, var(--grad-mid) 60%, var(--grad-end) 100%);
  --sheet-bg:      rgba(250,247,242,0.75);
  --sheet-border:  rgba(180,168,155,0.5);
  --modal-bg:      rgba(242,237,228,0.88);
  --glass-bg:      rgba(255,252,246,0.38);
  --glass-border:  rgba(180,168,155,0.45);
}

* { box-sizing: border-box; margin: 0; padding: 0; touch-action: manipulation; }
html { background: var(--bg); }
body { background: var(--bg); color: var(--text-primary, #f0f0f0); font-family: 'Barlow', sans-serif; min-height: 100dvh; -webkit-font-smoothing: antialiased; padding-bottom: env(safe-area-inset-bottom); }
#main-content { padding-bottom: 100px; }
.app { max-width: 480px; margin: 0 auto; min-height: 100dvh; }
.header { padding: max(18px, env(safe-area-inset-top)) 16px 14px; border-bottom: 1px solid var(--header-border); display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; background: var(--header-bg); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); z-index: 100; }
.header-logo { font-family: 'Barlow Condensed', sans-serif; font-weight: 900; font-size: 22px; letter-spacing: 0.04em; color: var(--gold); }
.header-sub { font-size: 10px; color: var(--text-muted); letter-spacing: 0.12em; text-transform: uppercase; margin-top: 3px; }
.new-btn { font-size: 11px; font-weight: 600; color: var(--text-sub); background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 7px 13px; cursor: pointer; font-family: 'Barlow Condensed', sans-serif; letter-spacing: 0.06em; text-transform: uppercase; transition: all 0.15s; }
.settings-btn { width: 34px; height: 34px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.04); cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--gold); transition: all 0.15s; padding: 0; }
.settings-btn:active { background: rgba(201,168,76,0.1); }
.settings-sheet { padding-bottom: max(32px, env(safe-area-inset-bottom)); min-height: 75vh; display: flex; flex-direction: column; }
.settings-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
.settings-section-label { font-family: 'Barlow Condensed', sans-serif; font-size: 10px; font-weight: 700; letter-spacing: 0.12em; text-transform: uppercase; color: var(--text-faint); margin: 18px 0 8px; }
.settings-section-label:first-of-type { margin-top: 0; }
.settings-athlete-form { background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 10px; padding: 14px; margin-bottom: 6px; backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); display: none; flex-direction: column; gap: 12px; }
.settings-athlete-form.open { display: flex; }
.settings-athlete-row { display: flex; flex-direction: column; gap: 5px; }
.settings-athlete-label { font-family: 'Barlow Condensed', sans-serif; font-size: 10px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: var(--text-sub); }
.settings-athlete-input { background: var(--input-bg); border: 1px solid var(--border-2); border-radius: 8px; padding: 9px 12px; font-family: 'Barlow', sans-serif; font-size: 14px; color: var(--text-primary); width: 100%; }
.settings-athlete-input:focus { outline: none; border-color: var(--gold); }
.settings-athlete-gender { display: flex; gap: 8px; }
.settings-athlete-gender-btn { flex: 1; padding: 9px; background: var(--surface-3); border: 1.5px solid var(--border); border-radius: 8px; font-family: 'Barlow Condensed', sans-serif; font-size: 13px; font-weight: 700; letter-spacing: 0.05em; text-transform: uppercase; color: var(--text-sub); cursor: pointer; transition: all 0.15s; }
.settings-athlete-gender-btn.active { border-color: var(--gold); background: rgba(var(--gold-rgb),0.1); color: var(--gold); }
.settings-athlete-bw-row { display: flex; gap: 8px; align-items: center; }
.settings-athlete-bw-row .settings-athlete-input { flex: 1; }
.settings-athlete-unit-btn { padding: 9px 14px; background: var(--surface-3); border: 1.5px solid var(--border); border-radius: 8px; font-family: 'Barlow Condensed', sans-serif; font-size: 13px; font-weight: 700; color: var(--text-sub); cursor: pointer; white-space: nowrap; transition: all 0.15s; }
.settings-athlete-unit-btn.active { border-color: var(--gold); background: rgba(var(--gold-rgb),0.1); color: var(--gold); }
.settings-athlete-save { width: 100%; padding: 10px; background: var(--gold); border: none; border-radius: 8px; font-family: 'Barlow Condensed', sans-serif; font-size: 13px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: #0a0a0a; cursor: pointer; margin-top: 2px; }
.settings-row-btn { width: 100%; display: flex; align-items: center; justify-content: space-between; padding: 13px 14px; background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 10px; cursor: pointer; transition: border-color 0.15s, background 0.15s; margin-bottom: 6px; backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
.settings-row-btn:active { border-color: var(--gold); background: var(--surface-3); }
.settings-row-left { display: flex; align-items: center; gap: 10px; font-family: 'Barlow', sans-serif; font-size: 15px; color: var(--text-mid); }
.settings-row-left svg { color: var(--text-sub); flex-shrink: 0; }
.settings-row-arrow { color: var(--text-dim); flex-shrink: 0; }
.settings-theme-pills { display: flex; gap: 8px; }
.settings-theme-pill { flex: 1; padding: 11px 8px; border-radius: 10px; font-family: 'Barlow Condensed', sans-serif; font-size: 14px; font-weight: 700; letter-spacing: 0.08em; cursor: pointer; transition: all 0.15s; text-align: center; text-transform: uppercase; border: 2px solid transparent; }
.settings-theme-pill[data-theme="dark"]  { background: #0a0a0a; color: #C9A84C; border-color: #222; }
.settings-theme-pill[data-theme="navy"]  { background: #0A0E1A; color: #C9A84C; border-color: #1a2035; }
.settings-theme-pill[data-theme="light"] { background: #F2EDE4; color: #5a4e38; border-color: #ddd5c8; }
.settings-theme-pill[data-theme="dark"].active  { border-color: #C9A84C; }
.settings-theme-pill[data-theme="navy"].active  { border-color: #C9A84C; }
.settings-theme-pill[data-theme="light"].active { border-color: #8B7A5E; }
.theme-toggle-btn { width: 32px; height: 32px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.04); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 15px; transition: all 0.15s; padding: 0; }
.theme-toggle-btn:active { background: rgba(255,255,255,0.08); }
.upload-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: calc(100dvh - 70px); padding: 32px 32px 80px; text-align: center; }
.upload-icon { width: 72px; height: 72px; border: 1.5px solid rgba(201,168,76,0.4); border-radius: 18px; display: flex; align-items: center; justify-content: center; margin-bottom: 24px; background: rgba(201,168,76,0.06); }
.upload-title { font-family: 'Barlow Condensed', sans-serif; font-weight: 900; font-size: 34px; letter-spacing: 0.02em; margin-bottom: 12px; color: var(--text-primary); }
.upload-desc { color: var(--text-muted); font-size: 14px; line-height: 1.75; margin-bottom: 32px; max-width: 290px; }
.upload-btn { background: #C9A84C; color: #000; border: none; padding: 16px 28px; font-family: 'Barlow Condensed', sans-serif; font-weight: 700; font-size: 17px; letter-spacing: 0.06em; border-radius: 10px; cursor: pointer; width: 100%; max-width: 300px; transition: opacity 0.15s; }
.upload-btn:active { opacity: 0.85; }
.upload-hint { margin-top: 20px; font-size: 12px; color: var(--text-dim); line-height: 1.6; max-width: 260px; }
.upload-divider { display: flex; align-items: center; gap: 12px; width: 100%; max-width: 300px; margin: 16px 0; }
.upload-divider::before, .upload-divider::after { content: ''; flex: 1; height: 1px; background: #222; }
.upload-divider span { font-size: 12px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.08em; }
.drive-btn { background: var(--surface-3); color: var(--text-primary); border: 1px solid #333; padding: 13px 20px; font-family: 'Barlow Condensed', sans-serif; font-weight: 700; font-size: 14px; letter-spacing: 0.06em; border-radius: 10px; cursor: pointer; width: 100%; display: flex; align-items: center; justify-content: center; gap: 10px; }
.drive-btn:active { opacity: 0.85; }
.block-bar { padding: 14px 16px; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.02); }
.block-name { font-family: 'Barlow Condensed', sans-serif; font-weight: 700; font-size: 18px; letter-spacing: 0.03em; color: var(--text-bright); }
.block-dates { font-size: 11px; color: var(--text-muted); margin-top: 3px; letter-spacing: 0.03em; }
.cycle-select { background: rgba(255,255,255,0.05); color: var(--text-sub); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 6px 10px; font-size: 12px; font-family: 'Barlow Condensed', sans-serif; font-weight: 600; letter-spacing: 0.04em; outline: none; max-width: 160px; cursor: pointer; }
.maxes-bar { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; padding: 12px 16px 4px; }
.max-item { background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 12px; padding: 12px 8px 10px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.04); position: relative; overflow: hidden; }
.max-item::before { content: ''; position: absolute; inset: 0; background: linear-gradient(135deg, rgba(201,168,76,0.04) 0%, transparent 60%); pointer-events: none; }
.max-lift { font-family: 'Barlow Condensed', sans-serif; font-size: 11px; font-weight: 600; color: var(--text-faint); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 4px; }
.max-weight { font-family: 'Barlow Condensed', sans-serif; font-weight: 900; font-size: 28px; color: var(--gold-data); line-height: 1; letter-spacing: -0.01em; }
.max-label { font-size: 9px; color: var(--text-dim); letter-spacing: 0.07em; text-transform: uppercase; margin-top: 4px; }
.max-delta-badge { position:absolute;top:6px;right:6px;font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:700;padding:2px 5px;border-radius:6px;line-height:1.2;transition:opacity 0.2s; }
.max-delta-badge.up { background:rgba(76,175,80,0.15);color:#4CAF50; }
.max-delta-badge.down { background:rgba(226,44,44,0.15);color:#E22C2C; }
.max-item.expanded .max-delta-badge { opacity:0; }
.max-tested-drawer { max-height:0;overflow:hidden;transition:max-height 0.25s cubic-bezier(0.4,0,0.2,1),opacity 0.2s;opacity:0; }
.max-item.expanded .max-tested-drawer { max-height:60px;opacity:1; }
.max-tested-divider { border:none;border-top:1px solid var(--border);margin:8px 0 0; }
.max-tested-row { display:flex;align-items:baseline;justify-content:center;gap:6px;padding-top:8px; }
.max-tested-val { font-family:'Barlow Condensed',sans-serif;font-size:16px;font-weight:700;color:var(--text-sub); }
.max-tested-delta { font-family:'Barlow Condensed',sans-serif;font-size:12px;font-weight:700; }
.max-tested-delta.up { color:#4CAF50; }
.max-tested-delta.down { color:#E22C2C; }
.max-tested-label { font-size:8px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.06em;text-align:center;padding-top:2px;padding-bottom:2px; }

/* DOTS/Wilks on metrics page */
.metrics-scores-section { padding: 4px 16px 12px; }
.metrics-scores-label { font-family: 'Barlow Condensed', sans-serif; font-size: 11px; font-weight: 700; letter-spacing: 0.12em; text-transform: uppercase; color: var(--text-sub); margin-bottom: 8px; }
.metrics-scores-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
.metrics-score-pill { background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 10px; padding: 9px 12px; display: flex; flex-direction: column; gap: 1px; }
.metrics-score-pill-label { font-family: 'Barlow Condensed', sans-serif; font-size: 10px; font-weight: 700; letter-spacing: 0.12em; text-transform: uppercase; color: var(--text-sub); }
.metrics-score-pill-val { font-family: 'Barlow Condensed', sans-serif; font-size: 20px; font-weight: 900; color: var(--text-bright); line-height: 1.1; }
.metrics-score-pill-level { font-family: 'Barlow', sans-serif; font-size: 10px; color: var(--gold-data); }
.metrics-score-est { font-family: 'Barlow', sans-serif; font-size: 10px; font-weight: 400; color: var(--text-dim); vertical-align: middle; letter-spacing: 0; }
.metrics-score-note { font-family: 'Barlow', sans-serif; font-size: 11px; color: var(--text-dim); margin-top: 6px; }
.metrics-score-total { font-family: 'Barlow', sans-serif; font-size: 11px; font-weight: 400; color: var(--text-dim); letter-spacing: 0; }
.week-bar { display: flex; gap: 8px; padding: 12px 16px; overflow-x: auto; border-bottom: 1px solid rgba(255,255,255,0.05); scrollbar-width: none; background: rgba(255,255,255,0.01); }
.week-bar::-webkit-scrollbar { display: none; }
.week-pill { flex-shrink: 0; padding: 8px 20px; border-radius: 100px; font-family: 'Barlow Condensed', sans-serif; font-weight: 600; font-size: 14px; letter-spacing: 0.04em; border: 1px solid rgba(255,255,255,0.08); background: rgba(255,255,255,0.04); color: var(--text-muted); cursor: pointer; white-space: nowrap; max-width: 160px; overflow: hidden; text-overflow: ellipsis; transition: all 0.15s; box-shadow: 0 1px 4px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.05); }
.week-pill.active { background: rgba(201,168,76,0.1); color: var(--gold); border-color: rgba(201,168,76,0.6); border-width: 1.5px; box-shadow: 0 1px 8px rgba(201,168,76,0.15), inset 0 1px 0 rgba(201,168,76,0.1); }
.week-pill.done { background: rgba(74,222,128,0.06); border-color: rgba(74,222,128,0.25); color: rgba(74,222,128,0.55); }
.week-pill.done.active { background: rgba(74,222,128,0.08); border-color: rgba(201,168,76,0.6); border-width: 1.5px; color: #4ade80; box-shadow: 0 1px 8px rgba(201,168,76,0.15), inset 0 1px 0 rgba(74,222,128,0.08); }
.day-tabs { display: flex; border-bottom: 1px solid rgba(255,255,255,0.05); overflow-x: auto; scrollbar-width: none; background: rgba(255,255,255,0.01); }
.day-tabs::-webkit-scrollbar { display: none; }
.day-tab { flex-shrink: 0; padding: 8px 12px; text-align: center; font-family: 'Barlow Condensed', sans-serif; font-weight: 600; font-size: 12px; letter-spacing: 0.05em; text-transform: uppercase; color: var(--text-muted); border: none; background: transparent; cursor: pointer; border-bottom: 2px solid transparent; position: relative; white-space: nowrap; transition: all 0.15s; line-height: 1.3; }
.day-tab.active { color: var(--gold); border-bottom-color: var(--gold); background: linear-gradient(180deg, rgba(201,168,76,0.06) 0%, transparent 100%); }
.day-tab.done { color: rgba(74,222,128,0.45); border-bottom: 2px solid rgba(74,222,128,0.3); }
.day-tab.done.active { color: #4ade80; border-bottom-color: var(--gold); background: linear-gradient(180deg, rgba(74,222,128,0.05) 0%, transparent 100%); }
.exercises { padding: 12px 16px 120px; }
.exercise-card { background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 14px; margin-bottom: 10px; overflow: hidden; transition: border-color 0.2s; box-shadow: var(--card-shadow); }
.superset-group { border: 1px solid var(--superset-bdr); border-radius: 12px; margin-bottom: 12px; overflow: hidden; background: var(--superset-bg); }
.superset-header { display: flex; align-items: center; gap: 8px; padding: 7px 14px; background: var(--superset-hdr); border-bottom: 1px solid var(--superset-bdr); }
.superset-badge { font-family: 'Barlow Condensed', sans-serif; font-weight: 700; font-size: 11px; letter-spacing: 0.08em; text-transform: uppercase; color: var(--gold); background: rgba(201,168,76,0.1); border: 1px solid rgba(201,168,76,0.2); border-radius: 4px; padding: 2px 8px; }
.superset-label { font-size: 11px; color: var(--text-dim); font-family: 'Barlow', sans-serif; }
.superset-group .exercise-card { border-radius: 0; border-left: 3px solid rgba(201,168,76,0.2); border-right: none; border-top: none; border-bottom: 1px solid var(--surface-3); margin-bottom: 0; background: var(--superset-card); }
.superset-group .exercise-card:last-child { border-bottom: none; }
.superset-group .exercise-card.completed { border-left-color: rgba(74,222,128,0.3); }
.superset-group .exercise-card.skipped { border-left-color: rgba(255,255,255,0.05); }
.exercise-card.completed { border-color: rgba(74,222,128,0.25); box-shadow: 0 2px 12px rgba(0,0,0,0.4), inset 0 1px 0 rgba(74,222,128,0.06); }
.exercise-card.skipped { border-color: rgba(255,255,255,0.04); box-shadow: none; }
.exercise-card.skipped .ex-summary-name { text-decoration: line-through; color: var(--text-dimmer); }
.exercise-card.skipped .ex-summary-pres { color: var(--border); }
.exercise-card.skipped .track-btn { color: var(--surface-5); }
.exercise-card.skipped .track-btn.tracked { color: var(--gold); }
.exercise-card.skipped .exercise-name { text-decoration: line-through; color: var(--text-faint); }
.ex-summary { display: flex; align-items: center; justify-content: space-between; padding: 13px 16px 6px; cursor: pointer; gap: 8px; user-select: none; }
.ex-summary-left { display: flex; flex-direction: column; gap: 3px; flex: 1; min-width: 0; }
.ex-summary-name { font-family: 'Barlow Condensed', sans-serif; font-weight: 700; font-size: 18px; letter-spacing: 0.02em; line-height: 1.15; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.ex-summary-name.done { color: var(--text-sub); }
.ex-summary-name.skipped { text-decoration: line-through; color: var(--text-faint); }
.ex-summary-pres { font-family: 'Barlow Condensed', sans-serif; font-size: 14px; color: var(--text-muted); letter-spacing: 0.02em; }
.ex-summary-right { display: flex; align-items: center; gap: 6px; flex-shrink: 0; }
.ex-expand-handle { display: flex; justify-content: center; padding: 0 0 8px; cursor: pointer; }
.ex-expand-pill { width: 32px; height: 3px; border-radius: 2px; background: var(--text-dimmer); opacity: 0.7; transition: opacity 0.15s; }
.ex-expand-handle:active .ex-expand-pill { opacity: 1; background: var(--text-muted); }
.ex-detail { border-top: 1px solid rgba(255,255,255,0.05); }
.skip-btn { font-size: 11px; color: var(--text-muted); background: none; border: 1px solid #333; border-radius: 5px; padding: 4px 8px; cursor: pointer; font-family: 'Barlow', sans-serif; letter-spacing: 0.04em; text-transform: uppercase; transition: all 0.15s; flex-shrink: 0; }
.skip-btn.active { color: var(--text-sub); border-color: #555; background: var(--surface-3); }
.skip-row { padding: 0 16px 14px; display: flex; justify-content: flex-end; gap: 8px; }
.set-adjust-btn { font-size: 11px; color: var(--text-muted); background: none; border: 1px solid #333; border-radius: 5px; padding: 4px 8px; cursor: pointer; font-family: 'Barlow', sans-serif; letter-spacing: 0.04em; text-transform: uppercase; transition: all 0.15s; flex-shrink: 0; }
.set-adjust-btn:active { color: var(--gold); border-color: var(--gold); }
.skipped-badge { font-size: 10px; color: var(--text-faint); font-family: 'Barlow', sans-serif; letter-spacing: 0.06em; text-transform: uppercase; border: 1px solid var(--border); border-radius: 4px; padding: 2px 6px; }
.edit-name-btn { background: none; border: none; cursor: pointer; font-size: 12px; color: var(--gold); opacity: 0.0; padding: 2px 4px; transition: opacity 0.15s; flex-shrink: 0; line-height: 1; }
.exercise-card:hover .edit-name-btn { opacity: 0.5; }
.exercise-name-edit { flex: 1; background: var(--surface-5); border: 1px solid #C9A84C; border-radius: 6px; color: var(--text-primary); font-family: 'Barlow Condensed', sans-serif; font-weight: 700; font-size: 20px; padding: 4px 8px; outline: none; min-width: 0; width: 100%; }
.block-name-edit { background: var(--surface-5); border: 1px solid #C9A84C; border-radius: 6px; color: var(--text-primary); font-family: 'Barlow Condensed', sans-serif; font-weight: 700; font-size: 17px; padding: 3px 8px; outline: none; width: 100%; letter-spacing: 0.04em; }
.exercise-header { padding: 14px 16px 10px; display: flex; align-items: flex-start; justify-content: space-between; gap: 8px; }
.exercise-name { font-family: 'Barlow Condensed', sans-serif; font-weight: 700; font-size: 20px; letter-spacing: 0.02em; line-height: 1.15; flex: 1; }
.exercise-check { width: 26px; height: 26px; border-radius: 7px; border: 1.5px solid var(--border); background: transparent; color: transparent; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-top: 2px; transition: all 0.15s; }
.exercise-check.done { background: rgba(74,222,128,0.1); border-color: rgba(74,222,128,0.4); color: #4ade80; }
.exercise-check.inferred { background: rgba(74,222,128,0.05); border-color: rgba(74,222,128,0.2); color: rgba(74,222,128,0.5); }
.prescription { padding: 0 16px 12px; font-family: 'Barlow Condensed', sans-serif; font-weight: 700; font-size: 20px; color: var(--gold-data); letter-spacing: 0.03em; }
.prescription.purple { color: var(--gold-data); }
.sets-grid { padding: 4px 14px 14px; display: flex; flex-direction: column; gap: 0; }
.set-row { display: flex; align-items: center; gap: 8px; padding: 7px 2px; border-bottom: 1px solid var(--surface-3); }
.set-row:last-child { border-bottom: none; }
.set-num { font-family: 'Barlow Condensed', sans-serif; font-size: 11px; color: var(--text-dimmer); width: 18px; flex-shrink: 0; }

/* ── Actual reps inline editor ───────────────────────────────────────── */
.set-prescribed-btn { background: none; border: none; cursor: pointer; padding: 0; display: flex; align-items: center; gap: 3px; font-family: 'Barlow Condensed', sans-serif; font-weight: 700; font-size: 18px; color: var(--text-mid); min-width: 70px; flex-shrink: 0; white-space: nowrap; align-self: flex-end; padding-bottom: 8px; transition: color 0.15s; }
.set-prescribed-btn:active { color: var(--gold); }
.set-prescribed-chevron { font-size: 13px; opacity: 0.45; margin-left: 1px; }
.set-prescribed-btn.has-actual { color: var(--gold); }
.set-prescribed-btn.has-actual .set-prescribed-chevron { opacity: 0.7; }
.set-reps-popover { display: flex; align-items: center; gap: 6px; background: var(--surface-5); border: 1px solid rgba(201,168,76,0.4); border-radius: 8px; padding: 5px 8px; margin-bottom: 4px; animation: fadeIn 0.12s ease; }
.set-reps-popover-label { font-size: 11px; font-weight: 600; letter-spacing: 0.06em; text-transform: uppercase; color: var(--gold); white-space: nowrap; }
.set-reps-popover-input { width: 52px; background: var(--surface-3); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); font-family: 'Barlow Condensed', sans-serif; font-weight: 700; font-size: 17px; padding: 4px 8px; outline: none; text-align: center; }
.set-reps-popover-input:focus { border-color: rgba(201,168,76,0.5); }
.set-reps-popover-close { background: none; border: none; color: var(--text-faint); font-size: 16px; cursor: pointer; padding: 2px 4px; line-height: 1; }
/* One-time rep tip tooltip */
.rep-tip-tooltip { background: #1e1a10; border: 1px solid rgba(201,168,76,0.35); border-radius: 8px; padding: 8px 12px; font-size: 12px; color: var(--gold); display: flex; align-items: center; justify-content: space-between; gap: 8px; margin: 0 16px 8px; }
.rep-tip-tooltip-text { line-height: 1.4; }
.rep-tip-dismiss { background: none; border: none; color: var(--gold); cursor: pointer; font-size: 16px; opacity: 0.6; padding: 2px; flex-shrink: 0; }

.set-prescribed { font-family: 'Barlow Condensed', sans-serif; font-weight: 700; font-size: 18px; color: var(--text-mid); min-width: 70px; flex-shrink: 0; white-space: nowrap; align-self: flex-end; padding-bottom: 8px; }
.set-inputs-wrap { display: flex; flex-direction: row; gap: 6px; flex: 1; }
.set-input-group { display: flex; flex-direction: column; gap: 2px; flex: 1; min-width: 0; }
.set-input-label { font-size: 9px; color: var(--text-dimmer); text-transform: uppercase; letter-spacing: 0.1em; padding-left: 1px; }
.set-input { background: var(--surface-3); border: 1px solid var(--border-2); border-radius: 7px; color: var(--text-primary); font-family: 'Barlow Condensed', sans-serif; font-weight: 700; font-size: 17px; padding: 7px 4px; width: 100%; text-align: center; outline: none; }
.set-input:focus { border-color: var(--gold); background: var(--input-focus-bg); color: var(--text-primary); }
.set-input.rpe-input:focus { border-color: var(--gold); background: var(--input-focus-bg); }
.set-input::placeholder { color: var(--text-dimmer); font-size: 11px; font-weight: 400; }
.prescribed-label { width: 80px; text-align: center; font-size: 12px; color: var(--text-dimmer); }
.set-check { width: 32px; height: 32px; border-radius: 8px; border: 1.5px solid rgba(255,255,255,0.08); background: transparent; color: transparent; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: all 0.15s; }
.set-check.done { background: rgba(74,222,128,0.1); border-color: rgba(74,222,128,0.3); color: #4ade80; }
.set-check svg { width: 14px; height: 14px; }
.coach-note { padding: 8px 16px; background: var(--coach-note-bg); border-top: 1px solid var(--coach-note-bdr); font-size: 12px; color: #a8a850; font-style: italic; }
.notes-section { border-top: 1px solid var(--surface-3); }
.notes-label { font-size: 10px; color: var(--text-faint); text-transform: uppercase; letter-spacing: 0.08em; padding: 8px 16px 4px; display: flex; align-items: center; gap: 5px; }
.notes-label svg { width: 12px; height: 12px; flex-shrink: 0; }
.upload-icon svg { width: 36px; height: 54px; }
.edit-name-btn svg { width: 12px; height: 12px; vertical-align: middle; }
.clear-workout-btn svg { width: 16px; height: 16px; vertical-align: middle; }
.program-delete-btn svg { width: 14px; height: 14px; vertical-align: middle; }
.next-workout-banner-text svg { width: 10px; height: 10px; vertical-align: middle; margin-right: 2px; }
.calc-no-solution svg { width: 14px; height: 14px; vertical-align: middle; }
.notes-area { padding: 0 16px 12px; }
.notes-input { width: 100%; background: var(--surface-3); border: 1px solid var(--border-2); border-radius: 6px; color: var(--text-sub); font-family: 'Barlow', sans-serif; font-size: 13px; padding: 8px 10px; resize: none; outline: none; min-height: 36px; }
.notes-input:focus { border-color: #333; color: var(--text-primary); }
.notes-input::placeholder { color: var(--text-faint); }
.lifter-prev-note { padding: 0 16px 6px; font-size: 12px; color: var(--text-muted); font-style: italic; }
.prev-performance { border-top: 1px solid var(--surface-3); padding: 8px 16px 10px; }
.prev-performance-label { font-size: 10px; color: #6a5a2a; text-transform: uppercase; letter-spacing: 0.08em; padding-bottom: 6px; }
.prev-performance-sets { display: flex; flex-wrap: wrap; gap: 6px; }
.prev-performance-set { font-size: 12px; color: #b8902a; background: rgba(201,168,76,0.08); border: 1px solid rgba(201,168,76,0.15); padding: 3px 8px; border-radius: 4px; font-family: 'Barlow Condensed', sans-serif; letter-spacing: 0.02em; }
.rest-msg { text-align: center; color: var(--text-dimmer); padding-top: 60px; font-family: 'Barlow Condensed', sans-serif; font-size: 20px; }

/* ── Custom Exercise ─────────────────────────────────────────────────── */
.add-exercise-btn { display: flex; align-items: center; justify-content: center; gap: 8px; width: calc(100% - 32px); margin: 0 16px 12px; padding: 13px 16px; background: none; border: 1px dashed var(--border); border-radius: 10px; color: var(--text-dim); font-family: 'Barlow Condensed', sans-serif; font-weight: 700; font-size: 15px; letter-spacing: 0.06em; cursor: pointer; transition: all 0.15s; }
.add-exercise-btn:active { border-color: var(--gold); color: var(--gold); background: rgba(201,168,76,0.05); }
.custom-ex-badge { display: inline-block; font-size: 9px; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; color: var(--gold); border: 1px solid rgba(201,168,76,0.4); border-radius: 4px; padding: 1px 5px; margin-left: 6px; vertical-align: middle; opacity: 0.8; }
.custom-ex-actions { display: flex; gap: 8px; margin-top: 2px; }
.custom-ex-action-btn { background: none; border: none; cursor: pointer; font-size: 11px; font-family: 'Barlow', sans-serif; font-weight: 600; letter-spacing: 0.04em; padding: 3px 0; transition: opacity 0.15s; }
.custom-ex-action-btn.edit { color: var(--gold); opacity: 0.8; }
.custom-ex-action-btn.delete { color: #E22C2C; opacity: 0.7; }
.custom-ex-action-btn:active { opacity: 1; }
/* Custom exercise modal */
.custom-ex-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.75); z-index: 1100; display: flex; align-items: flex-end; justify-content: center; padding-bottom: env(safe-area-inset-bottom); }
.custom-ex-sheet { background: var(--modal-bg); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px); border: 1px solid var(--border-2); border-radius: 18px 18px 0 0; width: 100%; max-width: 480px; padding: 20px 16px 32px; }
.custom-ex-sheet-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
.custom-ex-sheet-title { font-family: 'Barlow Condensed', sans-serif; font-weight: 700; font-size: 16px; letter-spacing: .06em; text-transform: uppercase; color: var(--text-primary); }
.custom-ex-close { background: none; border: none; color: var(--text-sub); cursor: pointer; padding: 4px; line-height: 1; font-size: 20px; }
.custom-ex-field { margin-bottom: 14px; }
.custom-ex-label { font-size: 11px; font-weight: 600; letter-spacing: 0.08em; text-transform: uppercase; color: var(--text-muted); margin-bottom: 6px; }
.custom-ex-input { width: 100%; background: var(--surface-3); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-family: 'Barlow', sans-serif; font-size: 15px; padding: 10px 12px; outline: none; box-sizing: border-box; transition: border-color 0.15s; }
.custom-ex-input:focus { border-color: rgba(201,168,76,0.5); }
.custom-ex-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
.custom-ex-error { font-size: 12px; color: #E22C2C; margin-bottom: 12px; display: none; }
.custom-ex-error.visible { display: block; }
.custom-ex-save-btn { display: block; width: 100%; padding: 14px; background: rgba(201,168,76,0.15); border: 1px solid rgba(201,168,76,0.4); border-radius: 10px; color: var(--gold); font-family: 'Barlow Condensed', sans-serif; font-weight: 700; font-size: 17px; letter-spacing: 0.06em; cursor: pointer; text-align: center; transition: all 0.15s; margin-top: 4px; }
.custom-ex-save-btn:active { background: rgba(201,168,76,0.25); }
/* Delete confirmation sheet */
.delete-ex-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.75); z-index: 1200; display: flex; align-items: flex-end; justify-content: center; padding-bottom: env(safe-area-inset-bottom); }
.delete-ex-sheet { background: var(--modal-bg); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px); border: 1px solid var(--border-2); border-radius: 18px 18px 0 0; width: 100%; max-width: 480px; padding: 24px 16px 32px; }
.delete-ex-title { font-family: 'Barlow Condensed', sans-serif; font-weight: 700; font-size: 16px; letter-spacing: .06em; text-transform: uppercase; color: var(--text-primary); margin-bottom: 6px; }
.delete-ex-desc { font-size: 13px; color: var(--text-muted); margin-bottom: 20px; line-height: 1.5; }
.delete-ex-btn { display: block; width: 100%; padding: 14px; border-radius: 10px; font-family: 'Barlow Condensed', sans-serif; font-weight: 700; font-size: 17px; letter-spacing: 0.06em; cursor: pointer; text-align: center; transition: all 0.15s; margin-bottom: 10px; }
.delete-ex-btn.danger { background: rgba(226,44,44,0.12); border: 1px solid rgba(226,44,44,0.35); color: #E22C2C; }
.delete-ex-btn.single { background: var(--surface-3); border: 1px solid var(--border); color: var(--text-sub); }
.delete-ex-btn:active { opacity: 0.75; }

.complete-workout-btn { display: block; width: calc(100% - 32px); margin: 8px 16px 24px; padding: 16px; background: var(--surface-3); border: 1px solid var(--border); border-radius: 12px; color: var(--text-dim); font-family: 'Barlow Condensed', sans-serif; font-weight: 700; font-size: 18px; letter-spacing: 0.08em; text-transform: uppercase; cursor: default; text-align: center; transition: all 0.2s; opacity: 0.45; }
.complete-workout-btn:disabled { pointer-events: none; }
.complete-workout-btn.ready { background: rgba(201,168,76,0.1); border-color: rgba(201,168,76,0.35); color: var(--gold); opacity: 1; cursor: pointer; }
.complete-workout-btn.ready:active { background: rgba(201,168,76,0.18); transform: scale(0.98); }
.workout-done-row { display: flex; align-items: center; gap: 10px; margin: 8px 16px 24px; }
.workout-done-row .complete-workout-btn { margin: 0; flex: 1; }
.workout-done-row .clear-workout-btn { flex-shrink: 0; }
.workout-complete-msg { text-align: center; color: #4ade80; font-family: 'Barlow Condensed', sans-serif; font-weight: 700; font-size: 16px; letter-spacing: 0.08em; padding: 20px 16px 32px; opacity: 0.6; display: flex; align-items: center; justify-content: center; animation: completePulse 1.2s ease-out forwards; }
@keyframes completePulse {
  0%   { opacity: 0; text-shadow: 0 0 0px rgba(74,222,128,0); }
  30%  { opacity: 1; text-shadow: 0 0 20px rgba(74,222,128,0.8), 0 0 40px rgba(74,222,128,0.4); }
  70%  { opacity: 0.8; text-shadow: 0 0 10px rgba(74,222,128,0.4); }
  100% { opacity: 0.6; text-shadow: none; }
}
.clear-workout-btn { background: none; border: none; cursor: pointer; font-size: 16px; opacity: 0.5; padding: 2px 4px; transition: opacity 0.15s; line-height: 1; }
.clear-workout-btn:hover { opacity: 1; }

/* ── Workout Preview Mode ── */
.preview-exercise-list { display: flex; flex-direction: column; gap: 0; padding: 0 16px; }
.preview-exercise { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border-2); cursor: pointer; transition: opacity 0.15s; }
.preview-exercise:last-child { border-bottom: none; }
.preview-ex-name { font-family: 'Barlow Condensed', sans-serif; font-size: 15px; font-weight: 700; color: var(--text-primary); flex: 1; letter-spacing: 0.02em; }
.preview-ex-pres { font-family: 'Barlow Condensed', sans-serif; font-size: 14px; font-weight: 600; color: var(--text-muted); text-align: right; flex-shrink: 0; margin-left: 10px; }
.preview-ex-note { font-size: 11px; color: rgba(var(--gold-rgb),0.5); margin-top: 2px; font-style: italic; }
.preview-exercise.completed .preview-ex-name { color: var(--text-dim); }
.preview-exercise.completed .preview-ex-pres { color: var(--text-dimmer); }
.preview-ex-check { margin-left: 10px; flex-shrink: 0; display: flex; align-items: center; }
.preview-ex-check svg { width: 14px; height: 14px; }
.set-row:has(.set-check.done) { opacity: 0.4; }
.exercise-check svg { width: 14px; height: 14px; }

/* ── Start/Resume Workout Banners ── */
@keyframes startGlow {
  0%, 100% { background: rgba(var(--gold-rgb),0.04); box-shadow: none; }
  50% { background: rgba(var(--gold-rgb),0.09); box-shadow: inset 0 0 20px rgba(var(--gold-rgb),0.06); }
}
.workout-start-banner { display: flex; align-items: center; justify-content: center; padding: 14px 20px; border-bottom: 1px solid rgba(var(--gold-rgb),0.1); cursor: pointer; animation: startGlow 3s ease-in-out infinite; }
.workout-start-banner:active { background: rgba(var(--gold-rgb),0.14); animation: none; }
.workout-start-text { font-family: 'Barlow Condensed', sans-serif; font-size: 14px; font-weight: 800; letter-spacing: 0.1em; text-transform: uppercase; color: var(--gold); }
.workout-resume-banner { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 14px 20px; border: 1px solid rgba(var(--gold-rgb),0.2); border-left: none; border-right: none; cursor: pointer; background: transparent; }
.workout-resume-banner:active { background: rgba(var(--gold-rgb),0.06); }
.workout-resume-text { font-family: 'Barlow Condensed', sans-serif; font-size: 14px; font-weight: 800; letter-spacing: 0.1em; text-transform: uppercase; color: var(--gold); }
.workout-resume-sub { font-size: 11px; color: var(--text-faint); margin-top: 2px; }
.next-workout-banner { display: flex; align-items: center; justify-content: space-between; margin: 10px 16px 12px; padding: 11px 14px; background: linear-gradient(135deg, var(--banner-grad-a) 0%, var(--banner-grad-b) 100%); border: 1px solid rgba(201,168,76,0.2); border-radius: 10px; cursor: pointer; transition: border-color 0.15s; box-shadow: 0 2px 8px rgba(0,0,0,0.3), inset 0 1px 0 rgba(201,168,76,0.07); }
.next-workout-banner:active { border-color: rgba(201,168,76,0.6); background: linear-gradient(135deg, var(--banner-grad-active-a) 0%, var(--banner-grad-active-b) 100%); }
.next-workout-banner-text { font-family: 'Barlow Condensed', sans-serif; font-size: 13px; font-weight: 700; letter-spacing: 0.06em; color: var(--gold); opacity: 0.9; }
.next-workout-banner-arrow { color: var(--gold); font-size: 14px; opacity: 0.7; }

/* Tracking button */
.track-btn { background: none; border: none; cursor: pointer; padding: 2px; transition: transform 0.1s; line-height: 1; color: var(--text-dimmer); display: flex; align-items: center; gap: 3px; }
.track-btn.tracked { color: var(--gold); }
.track-btn.is-comp { color: var(--text-dimmer); }
.track-btn.is-comp.tracked { color: var(--gold); }
.track-btn:active { transform: scale(1.3); }
.track-btn svg { width: 18px; height: 18px; display: block; }
.track-hint { padding: 0 16px 10px; font-size: 11px; color: var(--text-dim); font-style: italic; display: flex; align-items: center; gap: 5px; }
.track-hint svg { width: 12px; height: 12px; flex-shrink: 0; }
.track-hint-inline { font-size: 10px; color: var(--text-dim); font-family: 'Barlow', sans-serif; letter-spacing: 0.06em; text-transform: uppercase; font-style: normal; }

/* ── HOME SCREEN ─────────────────────────────────────────────────────────── */
.home-screen { padding: 48px 16px 80px; overflow: hidden; }
.home-greeting { font-family: 'Barlow Condensed', sans-serif; font-size: 13px; font-weight: 600; letter-spacing: 0.12em; text-transform: uppercase; color: var(--text-faint); margin-bottom: 2px; }

/* Hero card */
.home-hero { position: relative; background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 20px; overflow: hidden; margin-bottom: 10px; cursor: pointer; transition: transform 0.15s, border-color 0.15s; backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
.home-hero:active { transform: scale(0.98); }
.home-hero-bg { position: absolute; inset: 0; background: linear-gradient(135deg, rgba(var(--gold-rgb),0.08) 0%, transparent 60%); pointer-events: none; }
.home-hero-barbell { position: absolute; right: -12px; bottom: -18px; opacity: 0.08; pointer-events: none; }
.home-hero-inner { position: relative; z-index: 1; padding: 16px 20px; }
.home-hero-label { font-family: 'Barlow Condensed', sans-serif; font-size: 11px; font-weight: 700; letter-spacing: 0.14em; text-transform: uppercase; color: var(--gold); margin-bottom: 6px; }
.home-hero-day { font-family: 'Barlow Condensed', sans-serif; font-size: 26px; font-weight: 900; color: var(--text-bright); letter-spacing: 0.02em; line-height: 1; margin-bottom: 4px; }
.home-hero-meta { font-family: 'Barlow', sans-serif; font-size: 12px; color: var(--text-faint); margin-bottom: 12px; }
.home-hero-exercises { display: flex; flex-direction: column; gap: 6px; margin-bottom: 14px; }
.home-hero-ex { display: flex; align-items: center; gap: 10px; }
.home-hero-ex-dot { width: 5px; height: 5px; border-radius: 50%; background: var(--gold); flex-shrink: 0; }
.home-hero-ex-name { font-family: 'Barlow', sans-serif; font-size: 14px; font-weight: 500; color: var(--text-mid); flex: 1; }
.home-hero-ex-pres { font-family: 'Barlow Condensed', sans-serif; font-size: 13px; color: var(--text-faint); }
.home-hero-more { font-family: 'Barlow', sans-serif; font-size: 12px; color: var(--text-dim); padding-left: 15px; }
.home-hero-cta { display: flex; align-items: center; justify-content: space-between; padding-top: 10px; border-top: 1px solid var(--border-2); }
.home-hero-cta-text { font-family: 'Barlow Condensed', sans-serif; font-size: 13px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: var(--gold); }
.home-hero-cta-arrow { color: var(--gold); font-size: 18px; }
.home-hero.done { border-color: rgba(74,222,128,0.25); }
.home-hero.done .home-hero-bg { background: linear-gradient(135deg, rgba(74,222,128,0.06) 0%, transparent 60%); }
.home-hero.done .home-hero-label { color: #4ade80; }
.home-hero.done .home-hero-cta-text { color: #4ade80; }
.home-hero.done .home-hero-cta-arrow { color: #4ade80; }

/* Session Summary Hero Card */
.session-hero { position: relative; background: var(--glass-bg); border: 1px solid rgba(74,222,128,0.25); border-radius: 20px; overflow: hidden; margin-bottom: 10px; backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
.session-hero-bg { position: absolute; inset: 0; background: linear-gradient(135deg, rgba(74,222,128,0.07) 0%, transparent 55%); pointer-events: none; }
.session-hero-inner { position: relative; z-index: 1; padding: 14px 20px 16px; }
.session-hero-label { font-family: 'Barlow Condensed', sans-serif; font-size: 11px; font-weight: 700; letter-spacing: 0.14em; text-transform: uppercase; color: #4ade80; margin-bottom: 5px; display: flex; align-items: center; gap: 6px; }
.session-hero-label-dot { width: 6px; height: 6px; border-radius: 50%; background: #4ade80; }
.session-hero-day { font-family: 'Barlow Condensed', sans-serif; font-size: 26px; font-weight: 900; color: var(--text-bright); letter-spacing: 0.02em; line-height: 1; margin-bottom: 3px; }
.session-hero-meta { font-family: 'Barlow', sans-serif; font-size: 12px; color: var(--text-faint); margin-bottom: 12px; }

/* Comp lift rows */
.session-lift-rows { display: flex; flex-direction: column; gap: 9px; margin-bottom: 16px; }
.session-lift-row { display: flex; align-items: center; gap: 0; }
.session-lift-name { font-family: 'Barlow Condensed', sans-serif; font-size: 13px; font-weight: 700; letter-spacing: 0.06em; text-transform: uppercase; color: var(--text-muted); width: 76px; flex-shrink: 0; }
.session-lift-set { font-family: 'Barlow Condensed', sans-serif; font-size: 17px; font-weight: 900; color: var(--text-bright); letter-spacing: 0.02em; flex: 1; }
.session-lift-set .rpe-val { font-size: 13px; font-weight: 500; color: var(--text-muted); margin-left: 4px; }
/* Stat tiles */
.session-stats { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; padding-top: 14px; border-top: 1px solid var(--border-2); }
.session-stat { text-align: center; }
.session-stat-val { font-family: 'Barlow Condensed', sans-serif; font-size: 20px; font-weight: 900; color: var(--text-bright); line-height: 1.1; }
.session-stat-label { font-family: 'Barlow', sans-serif; font-size: 10px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.08em; margin-top: 2px; }

/* Workout Celebration Overlay */
#celebration-overlay {
  position: fixed; inset: 0; z-index: 9999;
  background: var(--bg);
  opacity: 0; pointer-events: none;
  transition: opacity 0.25s ease;
  overflow: hidden;
}
#celebration-overlay.visible { opacity: 1; pointer-events: all; }
.cel-scroll {
  height: 100%; overflow-y: auto; -webkit-overflow-scrolling: touch;
  display: flex; justify-content: center;
  padding: env(safe-area-inset-top, 48px) 20px env(safe-area-inset-bottom, 60px);
  padding-top: max(env(safe-area-inset-top), 48px);
  padding-bottom: max(env(safe-area-inset-bottom), 60px);
}
.cel-inner {
  width: 100%; max-width: 420px;
  display: flex; flex-direction: column; align-items: center;
  transform: translateY(32px);
  transition: transform 0.35s cubic-bezier(0.34, 1.4, 0.64, 1);
}
#celebration-overlay.visible .cel-inner { transform: translateY(0); }
.cel-check {
  width: 64px; height: 64px; border-radius: 50%;
  background: rgba(74,222,128,0.1);
  border: 1.5px solid rgba(74,222,128,0.35);
  display: flex; align-items: center; justify-content: center;
  margin-bottom: 18px;
  animation: cel-pop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) 0.1s both;
}
@keyframes cel-pop {
  from { transform: scale(0.4); opacity: 0; }
  to   { transform: scale(1);   opacity: 1; }
}
.cel-check svg { color: #4ade80; }
.cel-title {
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 40px; font-weight: 900; letter-spacing: 0.02em;
  color: var(--text-bright); line-height: 1;
  margin-bottom: 6px; text-align: center;
}
.cel-day {
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 15px; font-weight: 700; letter-spacing: 0.1em;
  color: var(--gold); text-transform: uppercase; margin-bottom: 3px;
}
.cel-meta {
  font-family: 'Barlow', sans-serif; font-size: 12px;
  color: var(--text-sub); margin-bottom: 24px;
}
/* Glass cards */
.cel-card {
  width: 100%;
  background: var(--glass-bg);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
  backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
  padding: 14px 16px; margin-bottom: 10px;
}
.cel-card-label {
  font-family: 'Barlow Condensed', sans-serif; font-size: 10px;
  font-weight: 700; letter-spacing: 0.14em; text-transform: uppercase;
  color: var(--text-faint); margin-bottom: 10px;
}
/* Lift rows */
.cel-lift-row {
  display: flex; align-items: center; padding: 8px 0;
  border-bottom: 1px solid var(--border);
}
.cel-lift-row:last-child { border-bottom: none; }
.cel-lift-name {
  font-family: 'Barlow Condensed', sans-serif; font-size: 11px;
  font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase;
  color: var(--text-sub); width: 64px; flex-shrink: 0;
}
.cel-lift-set {
  font-family: 'Barlow Condensed', sans-serif; font-size: 20px;
  font-weight: 900; color: var(--text-bright); flex: 1; letter-spacing: 0.01em; line-height: 1;
}
.cel-lift-sub {
  font-family: 'Barlow', sans-serif; font-size: 12px;
  color: var(--text-sub); margin-left: 2px;
}
.cel-lift-rpe {
  font-family: 'Barlow', sans-serif; font-size: 11px;
  color: var(--gold-data); margin-left: 6px;
}
.cel-lift-pr {
  font-family: 'Barlow Condensed', sans-serif; font-size: 10px; font-weight: 700;
  letter-spacing: 0.1em; color: var(--gold);
  background: rgba(201,168,76,0.12); border: 1px solid rgba(201,168,76,0.3);
  border-radius: 5px; padding: 2px 6px; flex-shrink: 0; margin-left: 6px;
}
.cel-lift-none { font-family: 'Barlow', sans-serif; font-size: 13px; color: var(--text-dim); flex: 1; }
/* Stats row */
.cel-stats {
  width: 100%; display: grid; grid-template-columns: 1fr 1fr 1fr;
  gap: 8px; margin-bottom: 10px;
}
.cel-stat {
  background: var(--glass-bg); border: 1px solid var(--glass-border);
  border-radius: 12px; backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
  padding: 12px 8px; text-align: center;
}
.cel-stat-val {
  font-family: 'Barlow Condensed', sans-serif; font-size: 22px;
  font-weight: 900; color: var(--text-bright); line-height: 1;
}
.cel-stat-unit { font-size: 11px; color: var(--text-sub); }
.cel-stat-label {
  font-family: 'Barlow', sans-serif; font-size: 10px; color: var(--text-dim);
  text-transform: uppercase; letter-spacing: 0.08em; margin-top: 4px;
}
/* Exercise list */
.cel-ex-row {
  display: flex; align-items: baseline; padding: 7px 0;
  border-bottom: 1px solid var(--border);
}
.cel-ex-row:last-child { border-bottom: none; }
.cel-ex-name {
  font-family: 'Barlow Condensed', sans-serif; font-size: 14px;
  font-weight: 700; color: var(--text-primary); flex: 1; letter-spacing: 0.02em;
}
.cel-ex-done { color: var(--text-sub); }
.cel-ex-sets {
  font-family: 'Barlow', sans-serif; font-size: 12px;
  color: var(--text-sub); flex-shrink: 0; margin-left: 8px;
}
.cel-hint {
  font-family: 'Barlow Condensed', sans-serif; font-size: 11px;
  letter-spacing: 0.12em; text-transform: uppercase;
  color: var(--text-faint); margin-top: 28px; margin-bottom: 8px;
}
.home-hero.done .home-hero-ex-dot { background: #4ade80; }

/* Import confirm button */
.import-confirm-btn {
  display: block; width: 100%; margin-top: 20px;
  padding: 15px; background: var(--gold);
  border: none; border-radius: 12px;
  color: #0a0a0a; font-family: 'Barlow Condensed', sans-serif;
  font-weight: 700; font-size: 17px; letter-spacing: 0.08em;
  text-transform: uppercase; cursor: pointer; text-align: center;
  transition: opacity 0.15s, transform 0.1s;
}
.import-confirm-btn:active { opacity: 0.85; transform: scale(0.98); }

/* Import Intent Modal */
.import-intent-card {
  display: flex; align-items: flex-start; gap: 14px;
  padding: 14px 16px; border-radius: 14px;
  border: 1.5px solid var(--glass-border); background: var(--glass-bg);
  backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
  cursor: pointer; margin-bottom: 10px;
  transition: border-color 0.15s, background 0.15s;
}
.import-intent-card.selected {
  border-color: var(--gold); background: rgba(201,168,76,0.06);
}
.import-intent-icon { width: 28px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-top: 2px; }
.import-intent-body { flex: 1; }
.import-intent-title {
  font-family: 'Barlow Condensed', sans-serif; font-size: 16px;
  font-weight: 700; color: var(--text-bright); letter-spacing: 0.02em;
  margin-bottom: 3px;
}
.import-intent-desc {
  font-family: 'Barlow', sans-serif; font-size: 12px;
  color: var(--text-sub); line-height: 1.45;
}
.import-intent-check {
  font-size: 14px; color: var(--gold); flex-shrink: 0;
  margin-top: 2px; transition: opacity 0.15s;
}
.import-intent-card.selected .import-intent-icon svg { fill: var(--gold); }
.import-intent-card:not(.selected) .import-intent-icon svg { fill: var(--text-faint); transition: fill 0.15s; }

/* Two-col cards row */
.home-card { background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 18px; padding: 12px 14px 12px; display: flex; flex-direction: column; backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
.home-card-label { font-family: 'Barlow Condensed', sans-serif; font-size: 10px; font-weight: 700; letter-spacing: 0.14em; text-transform: uppercase; color: var(--text-faint); margin-bottom: 8px; }

/* Home two-column row */
.home-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
.home-row > .home-card { margin-bottom: 0; }
.home-row.single-col { grid-template-columns: 1fr; }

/* Last workout card */
.last-workout-card { cursor: pointer; transition: transform 0.15s, border-color 0.15s; position: relative; overflow: hidden; }
.last-workout-card:active { transform: scale(0.97); }
.last-workout-card .home-card-label { color: rgba(74,222,128,0.5); }
.last-workout-card-day { font-family: 'Barlow Condensed', sans-serif; font-size: 15px; font-weight: 900; color: var(--text-bright); line-height: 1.15; margin-bottom: 2px; letter-spacing: 0.02em; }
.last-workout-card-meta { font-family: 'Barlow', sans-serif; font-size: 11px; color: var(--text-faint); margin-bottom: 8px; }
.last-workout-stats { display: flex; flex-direction: column; gap: 6px; }
.last-workout-stat { display: flex; align-items: baseline; justify-content: space-between; }
.last-workout-stat-label { font-family: 'Barlow', sans-serif; font-size: 10px; text-transform: uppercase; letter-spacing: 0.06em; color: var(--text-dim); }
.last-workout-stat-val { font-family: 'Barlow Condensed', sans-serif; font-size: 16px; font-weight: 900; color: var(--text-bright); line-height: 1; }
.last-workout-stat-val .unit { font-size: 10px; font-weight: 400; color: var(--text-sub); margin-left: 1px; }
.last-workout-nav { font-family: 'Barlow Condensed', sans-serif; font-size: 10px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: var(--gold); margin-top: 8px; padding-top: 6px; border-top: 1px solid var(--border-2); display: flex; align-items: center; justify-content: space-between; }
.last-workout-nav-arrow { color: var(--gold); font-size: 14px; }

/* Week card — ring widget */
.week-progress-card { margin-bottom: 10px; }
.home-row .week-progress-card { margin-bottom: 0; }
.week-ring-wrap { position: relative; width: 80px; height: 80px; margin: 4px auto 6px; }
.week-ring-svg { width: 100%; height: 100%; }
.week-ring-center { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; }
.week-ring-num { font-family: 'Barlow Condensed', sans-serif; font-size: 22px; font-weight: 900; color: var(--text-bright); line-height: 1; }
.week-ring-slash { font-weight: 600; color: var(--text-dim); font-size: 18px; margin: 0 1px; }
.week-ring-dots { display: flex; justify-content: center; gap: 7px; }
.week-ring-dot { width: 7px; height: 7px; border-radius: 50%; }
.week-ring-dot.done { background: #4ade80; box-shadow: 0 0 4px rgba(74,222,128,0.25); }
.week-ring-dot.current { border: 1.5px solid var(--gold); background: transparent; }
.week-ring-dot.upcoming { background: rgba(255,255,255,0.08); }
[data-theme="light"] .week-ring-dot.upcoming { background: rgba(0,0,0,0.10); }
[data-theme="light"] .set-check { border-color: rgba(0,0,0,0.1); }
[data-theme="light"] .exercise-check { border-color: rgba(0,0,0,0.12); }
[data-theme="light"] .preview-exercise { border-bottom-color: var(--border); }
[data-theme="light"] .workout-start-banner { border-bottom-color: rgba(var(--gold-rgb),0.15); }
[data-theme="light"] .workout-resume-banner { border-color: rgba(var(--gold-rgb),0.2); }

/* e1RM + scores card */
.home-pr-card { background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 18px; padding: 14px 16px; margin-bottom: 14px; backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); cursor: pointer; transition: transform 0.15s; }
.home-pr-card:active { transform: scale(0.98); }
/* Weekly Summary card on home */
.home-week-summary { background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 18px; padding: 12px 16px; margin-bottom: 10px; backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
.home-week-summary-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
.home-week-summary-label { font-family: 'Barlow Condensed', sans-serif; font-size: 11px; font-weight: 700; letter-spacing: 0.12em; text-transform: uppercase; color: var(--text-sub); }
.home-week-summary-meta { font-family: 'Barlow', sans-serif; font-size: 11px; color: var(--text-dim); }
.week-summary-lifts { display: flex; flex-direction: column; gap: 6px; margin-bottom: 10px; }
.week-summary-lift-row { display: flex; align-items: center; gap: 0; }
.week-summary-lift-name { font-family: 'Barlow Condensed', sans-serif; font-size: 13px; font-weight: 700; letter-spacing: 0.06em; text-transform: uppercase; color: var(--text-muted); width: 76px; flex-shrink: 0; }
.week-summary-lift-set { font-family: 'Barlow Condensed', sans-serif; font-size: 17px; font-weight: 900; color: var(--text-bright); letter-spacing: 0.02em; flex: 1; }
.week-summary-lift-set .rpe-val { font-size: 13px; font-weight: 500; color: var(--text-muted); margin-left: 4px; }
.week-summary-lift-set .var-label { font-size: 11px; font-weight: 400; color: var(--text-dim); margin-left: 4px; }
.week-summary-lift-e1rm { display: flex; flex-direction: column; align-items: center; flex-shrink: 0; min-width: 44px; }
.week-summary-e1rm-val { font-family: 'Barlow Condensed', sans-serif; font-size: 17px; font-weight: 800; color: var(--gold); line-height: 1; }
.week-summary-e1rm-label { font-family: 'Barlow Condensed', sans-serif; font-size: 9px; font-weight: 600; letter-spacing: 0.08em; color: var(--text-dim); text-transform: uppercase; line-height: 1; margin-top: 1px; }
.week-summary-stats { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; padding-top: 12px; border-top: 1px solid var(--border-2); }
.week-summary-stat { text-align: center; }
.week-summary-stat-val { font-family: 'Barlow Condensed', sans-serif; font-size: 20px; font-weight: 900; color: var(--text-bright); line-height: 1.1; }
.week-summary-stat-val .unit { font-size: 12px; font-weight: 600; color: var(--text-muted); margin-left: 2px; }
.week-summary-stat-label { font-family: 'Barlow', sans-serif; font-size: 10px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.08em; margin-top: 2px; }
.week-summary-empty { font-family: 'Barlow', sans-serif; font-size: 13px; color: var(--text-dim); text-align: center; padding: 8px 0; }

/* No-program state */
.home-empty { text-align: center; padding: 60px 24px; }
.home-empty-icon { margin: 0 auto 20px; opacity: 0.15; }
.home-empty-title { font-family: 'Barlow Condensed', sans-serif; font-size: 22px; font-weight: 900; color: var(--text-bright); margin-bottom: 8px; letter-spacing: 0.04em; }
.home-empty-desc { font-family: 'Barlow', sans-serif; font-size: 14px; color: var(--text-faint); line-height: 1.6; margin-bottom: 24px; }
.home-upload-btn { padding: 14px 28px; background: var(--gold); border: none; border-radius: 100px; font-family: 'Barlow Condensed', sans-serif; font-size: 14px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: #0a0a0a; cursor: pointer; }

/* Shared modal overlay/handle */
.checkin-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); }
.checkin-handle { width: 36px; height: 4px; background: var(--border-3); border-radius: 2px; margin: 0 auto 20px; }
@keyframes slideUpCheckin { from { transform: translateY(100%); } to { transform: translateY(0); } }

/* Schedule / intake modals */
.schedule-modal { position: fixed; inset: 0; z-index: 600; display: flex; align-items: flex-end; justify-content: center; }
.schedule-clear-btn { width: 100%; padding: 12px; background: none; border: 1px solid var(--border); border-radius: 100px; font-family: 'Barlow Condensed', sans-serif; font-size: 13px; font-weight: 700; letter-spacing: 0.08em; color: var(--text-sub); cursor: pointer; }

/* Intake sheet */
.intake-sheet { position: relative; z-index: 1; background: var(--surface-2); border: 1px solid var(--border); border-top: 1px solid var(--border-3); border-radius: 28px 28px 0 0; padding: 28px 20px calc(env(safe-area-inset-bottom) + 28px); width: 100%; max-width: 480px; animation: slideUpCheckin 0.3s cubic-bezier(0.34,1.56,0.64,1); }
.intake-step-label { font-family: 'Barlow Condensed', sans-serif; font-size: 11px; font-weight: 700; letter-spacing: 0.12em; text-transform: uppercase; color: var(--gold); margin-bottom: 6px; }
.intake-title { font-family: 'Barlow Condensed', sans-serif; font-size: 26px; font-weight: 900; color: var(--text-bright); margin-bottom: 4px; }
.intake-sub { font-family: 'Barlow', sans-serif; font-size: 13px; color: var(--text-faint); margin-bottom: 24px; }
.intake-dow-grid { display: flex; gap: 6px; margin-bottom: 10px; }
.intake-dow-pill { flex: 1; padding: 12px 4px; background: var(--surface-3); border: 1.5px solid var(--border); border-radius: 12px; font-family: 'Barlow Condensed', sans-serif; font-size: 12px; font-weight: 700; letter-spacing: 0.04em; color: var(--text-sub); cursor: pointer; transition: all 0.12s; text-align: center; position: relative; }
.intake-dow-pill.selected { border-color: var(--gold); color: var(--gold); background: rgba(var(--gold-rgb),0.1); }
.intake-dow-num { position: absolute; top: -6px; right: -6px; width: 16px; height: 16px; border-radius: 50%; background: var(--gold); color: #0a0a0a; font-size: 9px; font-weight: 900; display: flex; align-items: center; justify-content: center; }
.intake-count-hint { font-family: 'Barlow', sans-serif; font-size: 12px; color: var(--text-dim); margin-bottom: 20px; }
.intake-next-btn { width: 100%; padding: 15px; background: var(--gold); border: none; border-radius: 100px; font-family: 'Barlow Condensed', sans-serif; font-size: 15px; font-weight: 700; letter-spacing: 0.12em; text-transform: uppercase; color: #0a0a0a; cursor: pointer; margin-bottom: 10px; opacity: 0.35; transition: opacity 0.15s; }
.intake-next-btn.ready { opacity: 1; }
.intake-skip-btn { width: 100%; padding: 10px; background: none; border: none; font-family: 'Barlow', sans-serif; font-size: 13px; color: var(--text-dim); cursor: pointer; }
.intake-field-label { font-family: 'Barlow Condensed', sans-serif; font-size: 12px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: var(--text-sub); margin-bottom: 8px; margin-top: 16px; }
.intake-gender-row { display: flex; gap: 8px; }
.intake-gender-btn { flex: 1; padding: 12px; background: var(--surface-3); border: 1.5px solid var(--border); border-radius: 12px; font-family: 'Barlow Condensed', sans-serif; font-size: 14px; font-weight: 700; color: var(--text-sub); cursor: pointer; transition: all 0.12s; }
.intake-gender-btn.selected { border-color: var(--gold); color: var(--gold); background: rgba(var(--gold-rgb),0.1); }
.intake-input { width: 100%; padding: 12px 14px; background: var(--surface-3); border: 1.5px solid var(--border); border-radius: 12px; font-family: 'Barlow', sans-serif; font-size: 16px; color: var(--text-bright); box-sizing: border-box; outline: none; }
.intake-input:focus { border-color: var(--gold); }
.intake-bw-row { display: flex; gap: 10px; align-items: flex-end; }
.intake-bw-input { flex: 1; }
.intake-unit-toggle { display: flex; flex-direction: column; gap: 4px; }
.intake-unit-btn { flex: 1; padding: 8px 16px; background: var(--surface-3); border: 1.5px solid var(--border); border-radius: 8px; font-family: 'Barlow Condensed', sans-serif; font-size: 13px; font-weight: 700; color: var(--text-sub); cursor: pointer; transition: all 0.12s; text-transform: lowercase; }
.intake-unit-btn.active { border-color: var(--gold); color: var(--gold); background: rgba(201,168,76,0.08); }

/* Onboarding */
.onboarding-overlay { position: fixed; inset: 0; z-index: 9999; background: var(--bg); display: flex; flex-direction: column; align-items: center; justify-content: center; }
.onboarding-container { width: 100%; max-width: 400px; padding: 0 24px; text-align: center; animation: onboardFadeIn 0.4s ease; }
@keyframes onboardFadeIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
.onboard-icon { margin-bottom: 28px; }
.onboard-title { font-family: 'Barlow Condensed', sans-serif; font-size: 32px; font-weight: 900; color: var(--text-bright); margin-bottom: 8px; letter-spacing: -0.01em; }
.onboard-sub { font-family: 'Barlow', sans-serif; font-size: 15px; color: var(--text-faint); line-height: 1.6; margin-bottom: 32px; }
.onboard-features { display: flex; flex-direction: column; gap: 14px; margin-bottom: 36px; text-align: left; }
.onboard-feature { display: flex; align-items: flex-start; gap: 12px; }
.onboard-feature-icon { width: 36px; height: 36px; border-radius: 10px; background: rgba(var(--gold-rgb),0.1); border: 1px solid rgba(var(--gold-rgb),0.15); display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
.onboard-feature-icon svg { width: 18px; height: 18px; color: var(--gold); }
.onboard-feature-text { padding-top: 2px; }
.onboard-feature-label { font-family: 'Barlow Condensed', sans-serif; font-size: 14px; font-weight: 700; color: var(--text-bright); letter-spacing: 0.02em; }
.onboard-feature-desc { font-family: 'Barlow', sans-serif; font-size: 12px; color: var(--text-dim); margin-top: 1px; }
.onboard-primary-btn { width: 100%; padding: 16px; background: var(--gold); border: none; border-radius: 100px; font-family: 'Barlow Condensed', sans-serif; font-size: 16px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: #0a0a0a; cursor: pointer; transition: opacity 0.15s; }
.onboard-primary-btn:active { opacity: 0.85; }
.onboard-primary-btn.disabled { opacity: 0.35; pointer-events: none; }
.onboard-skip-btn { width: 100%; padding: 12px; background: none; border: none; font-family: 'Barlow', sans-serif; font-size: 13px; color: var(--text-dim); cursor: pointer; margin-top: 4px; }
.onboard-form { text-align: left; margin-bottom: 28px; }
.onboard-form .intake-field-label:first-child { margin-top: 0; }

/* Upload option cards */
.upload-options { display: flex; flex-direction: column; gap: 0; width: 100%; text-align: left; }
.upload-option-card { display: flex; align-items: center; gap: 14px; padding: 16px; background: var(--surface-2); border: 1px solid var(--border); border-radius: 14px; cursor: pointer; transition: border-color 0.15s, background 0.15s; margin-bottom: 10px; }
.upload-option-card:active { background: var(--surface-3); }
.upload-option-card.expanded { border-color: var(--gold); border-bottom-left-radius: 0; border-bottom-right-radius: 0; margin-bottom: 0; }
.upload-option-card.expanded .upload-option-arrow { transform: rotate(180deg); }
.upload-option-icon { width: 44px; height: 44px; border-radius: 12px; background: rgba(var(--gold-rgb),0.1); border: 1px solid rgba(var(--gold-rgb),0.12); display: flex; align-items: center; justify-content: center; flex-shrink: 0; color: var(--gold); }
.upload-option-icon-drive { background: rgba(66,133,244,0.1); border-color: rgba(66,133,244,0.15); color: #4285f4; }
.upload-option-body { flex: 1; min-width: 0; }
.upload-option-title { font-family: 'Barlow Condensed', sans-serif; font-size: 15px; font-weight: 700; color: var(--text-bright); letter-spacing: 0.01em; }
.upload-option-desc { font-family: 'Barlow', sans-serif; font-size: 12px; color: var(--text-dim); margin-top: 2px; }
.upload-option-arrow { flex-shrink: 0; color: var(--text-dim); transition: transform 0.2s; }



/* Format example viewer */
.format-example-modal { position: fixed; inset: 0; z-index: 10000; display: flex; align-items: flex-end; justify-content: center; }
.format-example-sheet { position: relative; z-index: 1; background: var(--surface-2); border: 1px solid var(--border); border-top: 1px solid var(--border-3); border-radius: 28px 28px 0 0; padding: 24px 20px calc(env(safe-area-inset-bottom) + 20px); width: 100%; max-width: 480px; max-height: 85vh; overflow-y: auto; animation: slideUpCheckin 0.3s cubic-bezier(0.34,1.56,0.64,1); -webkit-overflow-scrolling: touch; }
.format-example-title { font-family: 'Barlow Condensed', sans-serif; font-size: 22px; font-weight: 900; color: var(--text-bright); margin-bottom: 4px; }
.format-example-sub { font-family: 'Barlow', sans-serif; font-size: 13px; color: var(--text-faint); margin-bottom: 20px; line-height: 1.5; }
.format-tab-row { display: flex; gap: 6px; margin-bottom: 16px; }
.format-tab { flex: 1; padding: 10px 8px; background: var(--surface-3); border: 1.5px solid var(--border); border-radius: 10px; font-family: 'Barlow Condensed', sans-serif; font-size: 13px; font-weight: 700; color: var(--text-sub); cursor: pointer; text-align: center; transition: all 0.15s; }
.format-tab.active { border-color: var(--gold); color: var(--gold); background: rgba(var(--gold-rgb),0.08); }
.format-grid { border: 1px solid var(--border-3); border-radius: 10px; overflow: hidden; margin-bottom: 14px; font-family: 'Barlow', sans-serif; font-size: 12px; }
.format-grid-header { display: flex; background: rgba(var(--gold-rgb),0.1); border-bottom: 1px solid var(--border-3); }
.format-grid-header span { flex: 1; padding: 8px 10px; font-family: 'Barlow Condensed', sans-serif; font-weight: 700; font-size: 11px; letter-spacing: 0.06em; text-transform: uppercase; color: var(--gold); }
.format-grid-row { display: flex; border-bottom: 1px solid var(--border); }
.format-grid-row:last-child { border-bottom: none; }
.format-grid-row span { flex: 1; padding: 7px 10px; color: var(--text-sub); line-height: 1.4; }
.format-grid-row.section-header span { color: var(--text-bright); font-weight: 600; background: rgba(255,255,255,0.03); }
.format-note { font-family: 'Barlow', sans-serif; font-size: 12px; color: var(--text-dim); line-height: 1.6; margin-bottom: 16px; padding: 12px; background: var(--surface-3); border-radius: 10px; border: 1px solid var(--border); }
.format-note strong { color: var(--text-bright); }

/* Parse error modal */
.parse-error-modal { position: fixed; inset: 0; z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 24px; }
.parse-error-card { position: relative; z-index: 1; background: var(--surface-2); border: 1px solid var(--border-3); border-radius: 20px; padding: 28px 24px; width: 100%; max-width: 380px; text-align: center; animation: onboardFadeIn 0.3s ease; }
.parse-error-icon { margin-bottom: 16px; }
.parse-error-title { font-family: 'Barlow Condensed', sans-serif; font-size: 22px; font-weight: 900; color: var(--text-bright); margin-bottom: 6px; }
.parse-error-msg { font-family: 'Barlow', sans-serif; font-size: 14px; color: var(--text-faint); line-height: 1.6; margin-bottom: 24px; }
.parse-error-actions { display: flex; flex-direction: column; gap: 8px; }
.parse-error-btn-primary { width: 100%; padding: 14px; background: var(--gold); border: none; border-radius: 100px; font-family: 'Barlow Condensed', sans-serif; font-size: 14px; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; color: #0a0a0a; cursor: pointer; }
.parse-error-btn-secondary { width: 100%; padding: 12px; background: none; border: 1px solid var(--border); border-radius: 100px; font-family: 'Barlow Condensed', sans-serif; font-size: 13px; font-weight: 700; letter-spacing: 0.06em; text-transform: uppercase; color: var(--text-sub); cursor: pointer; }
.parse-error-btn-dismiss { width: 100%; padding: 10px; background: none; border: none; font-family: 'Barlow', sans-serif; font-size: 13px; color: var(--text-dim); cursor: pointer; }

/* Settings toggle */
.settings-toggle { width: 44px; height: 26px; border-radius: 13px; border: none; cursor: pointer; position: relative; transition: background 0.2s; flex-shrink: 0; background: var(--border-3); }
.settings-toggle::after { content: ''; position: absolute; width: 20px; height: 20px; border-radius: 50%; background: #fff; top: 3px; left: 3px; transition: transform 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
.settings-toggle.on { background: #C9A84C; }
.settings-toggle.on::after { transform: translateX(18px); }

/* Bottom nav */
.bottom-nav { position: fixed; bottom: calc(16px + env(safe-area-inset-bottom, 0px)); left: 50%; transform: translateX(-50%); width: calc(100% - 32px); max-width: 420px; background: var(--surface-5); border: 1px solid var(--card-border); border-radius: 100px; display: flex; z-index: 200; padding: 5px; gap: 3px; box-shadow: 0 8px 32px rgba(0,0,0,0.7), 0 2px 8px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.06); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
.nav-btn { flex: 1; padding: 10px 0 9px; display: flex; flex-direction: column; align-items: center; gap: 5px; background: none; border: none; border-radius: 100px; cursor: pointer; color: var(--text-dim); font-family: 'Barlow Condensed', sans-serif; font-size: 10px; font-weight: 600; letter-spacing: 0.08em; text-transform: uppercase; transition: color 0.15s, background 0.15s; }
.nav-btn.active { color: var(--gold); background: rgba(201,168,76,0.14); box-shadow: inset 0 1px 0 rgba(201,168,76,0.15); }
.nav-icon { width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; }
.nav-icon svg { width: 22px; height: 22px; fill: currentColor; }

.metrics-export-btn { background: none; border: none; color: var(--text-faint); cursor: pointer; padding: 4px 6px; display: flex; align-items: center; margin-left: auto; transition: color 0.15s; }
.metrics-export-btn:active { color: var(--gold); }
.metrics-export-btn svg { width: 16px; height: 16px; }
.metrics-back-btn { background: none; border: 1px solid #333; border-radius: 100px; color: var(--text-sub); font-family: 'Barlow Condensed', sans-serif; font-size: 14px; letter-spacing: 0.04em; padding: 6px 14px; cursor: pointer; transition: all 0.15s; }
.metrics-back-btn:active { border-color: var(--gold); color: var(--gold); }
.metrics-cycle-toggle { display: flex; gap: 8px; padding: 0 0 16px; }
.metrics-toggle-pill { flex: 1; padding: 8px 12px; border-radius: 100px; font-family: 'Barlow Condensed', sans-serif; font-weight: 600; font-size: 14px; letter-spacing: 0.04em; border: 1px solid #222; background: transparent; color: var(--text-faint); cursor: pointer; transition: all 0.15s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.metrics-toggle-pill.active { color: var(--gold); border-color: var(--gold); border-width: 2px; }
.metrics-toggle-pill:active { opacity: 0.7; }
.metrics-drill-label { font-family: 'Barlow Condensed', sans-serif; font-weight: 700; font-size: 18px; letter-spacing: 0.04em; color: var(--gold); }
.metrics-cycle-hint { font-size: 11px; color: var(--text-dimmer); text-align: center; padding: 0 0 12px; font-style: italic; letter-spacing: 0.04em; }
.program-item { display: flex; align-items: center; justify-content: space-between; padding: 14px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
.program-item:last-child { border-bottom: none; }
.program-item-info { display: flex; flex-direction: column; gap: 3px; flex: 1; cursor: pointer; }
.program-item-name { font-family: 'Barlow Condensed', sans-serif; font-weight: 700; font-size: 17px; letter-spacing: 0.02em; }
.program-item-name.active-cycle { color: var(--gold); }
.program-item-meta { font-size: 11px; color: var(--text-muted); }
.program-item-actions { display: flex; gap: 8px; align-items: center; }
.program-select-btn { font-size: 11px; padding: 5px 12px; border-radius: 100px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.03); color: var(--text-sub); font-family: 'Barlow Condensed', sans-serif; cursor: pointer; letter-spacing: 0.04em; }
.program-select-btn.current { border-color: var(--gold); color: var(--gold); }
.program-delete-btn { background: none; border: none; color: var(--text-dim); font-size: 18px; cursor: pointer; padding: 8px 10px; transition: color 0.15s; line-height: 1; }
.program-delete-btn:active { color: #E22C2C; }
.export-scope-picker { display: none; gap: 6px; margin-top: 6px; padding: 6px 0 2px; }
.export-scope-btn { flex: 1; padding: 6px 8px; border: 1px solid var(--border); border-radius: 6px; background: none; color: var(--text-sub); font-family: 'Barlow Condensed', sans-serif; font-weight: 700; font-size: 11px; letter-spacing: 0.05em; cursor: pointer; transition: all 0.15s; text-transform: uppercase; }
.export-scope-btn:hover { border-color: var(--gold); color: var(--gold); }

/* ── Export Modal ─────────────────────────────────────────────────────────── */
.export-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.75); z-index: 1000; display: flex; align-items: flex-end; justify-content: center; padding-bottom: env(safe-area-inset-bottom); }
.export-modal { background: var(--modal-bg); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px); border: 1px solid var(--border-2); border-radius: 18px 18px 0 0; width: 100%; max-width: 480px; padding: 20px 16px 32px; }
.export-modal-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 18px; }
.export-modal-title { font-family: 'Barlow Condensed', sans-serif; font-weight: 700; font-size: 16px; letter-spacing: .06em; text-transform: uppercase; color: var(--text-primary); }
.export-modal-close { background: none; border: none; color: var(--text-dim); cursor: pointer; padding: 4px; line-height: 1; font-size: 20px; }
.export-modal-close:active { color: var(--text-primary); }
.export-card { background: var(--surface-2); border: 1px solid var(--border-2); border-radius: 12px; padding: 16px; margin-bottom: 10px; }
.export-card-header { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }
.export-card-icon { width: 36px; height: 36px; flex-shrink: 0; }
.export-card-info { flex: 1; }
.export-card-name { font-family: 'Barlow Condensed', sans-serif; font-weight: 700; font-size: 15px; letter-spacing: .04em; color: var(--text-primary); margin-bottom: 2px; }
.export-card-desc { font-size: 12px; color: var(--text-faint); line-height: 1.4; }
.export-scope-toggle { display: flex; gap: 6px; margin-bottom: 12px; }
.export-scope-pill { flex: 1; padding: 7px 10px; border: 1px solid var(--border); border-radius: 6px; background: none; color: var(--text-muted); font-family: 'Barlow Condensed', sans-serif; font-weight: 700; font-size: 11px; letter-spacing: .06em; text-transform: uppercase; cursor: pointer; transition: all 0.15s; text-align: center; }
.export-scope-pill.active { border-color: var(--gold); color: var(--gold); }
.export-action-btn { width: 100%; padding: 11px; background: #C9A84C; border: none; border-radius: 8px; color: #000; font-family: 'Barlow Condensed', sans-serif; font-weight: 700; font-size: 13px; letter-spacing: .08em; text-transform: uppercase; cursor: pointer; transition: opacity 0.15s; }
.export-action-btn:active { opacity: 0.8; }
.metrics-screen { padding: 16px 16px 100px; }
.cycle-tabs { display: flex; gap: 8px; padding: 0 0 14px; overflow-x: auto; scrollbar-width: none; }
.cycle-tabs::-webkit-scrollbar { display: none; }
.cycle-tab { flex-shrink: 0; padding: 7px 18px; border-radius: 100px; font-family: 'Barlow Condensed', sans-serif; font-weight: 600; font-size: 14px; letter-spacing: 0.04em; border: 1px solid #333; background: transparent; color: var(--text-faint); cursor: pointer; white-space: nowrap; transition: all 0.15s; }
.cycle-tab.active { background: #C9A84C; color: #000; border-color: var(--gold); }
.metrics-lift-group { margin-bottom: 20px; background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 14px; overflow: hidden; box-shadow: var(--card-shadow); }
.metrics-lift-header { padding: 14px 16px 12px; display: flex; align-items: center; justify-content: space-between; }
.metrics-lift-title { font-family: 'Barlow Condensed', sans-serif; font-weight: 900; font-size: 22px; letter-spacing: 0.04em; }
.metrics-best { font-family: 'Barlow Condensed', sans-serif; font-weight: 700; font-size: 18px; color: var(--gold-data); }
.metrics-best-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.08em; text-align: right; }
.variation-tabs { display: flex; gap: 0; overflow-x: auto; scrollbar-width: none; border-top: 1px solid var(--surface-5); border-bottom: 1px solid var(--surface-5); }
.variation-tabs::-webkit-scrollbar { display: none; }
.variation-tab { flex-shrink: 0; padding: 8px 14px; font-size: 12px; color: var(--text-dim); background: none; border: none; cursor: pointer; font-family: 'Barlow', sans-serif; white-space: nowrap; border-bottom: 2px solid transparent; transition: all 0.15s; }
.variation-tab.active { color: #a78bfa; border-bottom-color: #a78bfa; }
.chart-wrap { padding: 16px; }
.chart-empty { padding: 20px 16px; text-align: center; font-size: 13px; color: var(--text-dimmer); font-style: italic; }
canvas.rm-chart { width: 100%; height: 140px; display: block; }
.rm-datapoints { padding: 0 16px 12px; display: flex; flex-direction: column; gap: 0; }
.rm-row { display: flex; align-items: center; justify-content: space-between; padding: 7px 0; border-bottom: 1px solid rgba(255,255,255,0.04); }
.rm-session { font-size: 12px; color: var(--text-muted); }
.rm-value { font-family: 'Barlow Condensed', sans-serif; font-weight: 700; font-size: 18px; color: var(--gold-data); }
.rm-delta { font-size: 12px; margin-left: 6px; }
.rm-delta.up { color: #4ade80; }
.rm-delta.down { color: #E22C2C; }

/* Add lift button */
.add-lift-btn { display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; padding: 14px; background: none; border: 1px dashed var(--border); border-radius: 12px; color: var(--text-dim); font-family: 'Barlow Condensed', sans-serif; font-size: 17px; letter-spacing: 0.04em; cursor: pointer; margin-bottom: 16px; transition: all 0.15s; }
.add-lift-btn:hover { border-color: #444; color: var(--text-sub); }
.add-lift-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 300; display: flex; align-items: flex-end; }
.add-lift-sheet { background: var(--sheet-bg); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px); border-radius: 16px 16px 0 0; padding: 24px 20px 40px; width: 100%; max-width: 480px; margin: 0 auto; border-top: 1px solid var(--sheet-border); }
.add-lift-title { font-family: 'Barlow Condensed', sans-serif; font-weight: 700; font-size: 22px; margin-bottom: 16px; }
.add-lift-input { width: 100%; background: var(--input-bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-family: 'Barlow', sans-serif; font-size: 16px; padding: 12px 14px; outline: none; margin-bottom: 8px; }
.add-lift-input:focus { border-color: var(--gold); color: var(--text-primary); }
.add-lift-group-label { font-size: 12px; color: var(--text-faint); margin-bottom: 6px; }
.add-lift-groups { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px; }
.group-pill { padding: 6px 14px; border-radius: 100px; border: 1px solid var(--border); background: transparent; color: var(--text-faint); font-size: 13px; cursor: pointer; font-family: 'Barlow', sans-serif; }
.group-pill.active { background: #a78bfa22; border-color: #a78bfa; color: #a78bfa; }
.add-lift-actions { display: flex; gap: 10px; }
.add-lift-cancel { flex: 1; padding: 12px; background: none; border: 1px solid #222; border-radius: 8px; color: var(--text-faint); font-family: 'Barlow Condensed', sans-serif; font-size: 18px; cursor: pointer; }
.add-lift-confirm { flex: 2; padding: 12px; background: #C9A84C; border: none; border-radius: 8px; color: var(--text-primary); font-family: 'Barlow Condensed', sans-serif; font-size: 18px; font-weight: 700; cursor: pointer; }
.add-lift-confirm:disabled { background: var(--border); color: var(--text-faint); cursor: default; }
.untracked-list { max-height: 220px; overflow-y: auto; margin-bottom: 14px; display: flex; flex-direction: column; gap: 4px; }
.untracked-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; background: var(--surface-3); border: 1px solid var(--border-2); border-radius: 8px; cursor: pointer; transition: border-color 0.12s, background 0.12s; }
.untracked-item:hover { border-color: #333; background: var(--surface-5); }
.untracked-item.selected { border-color: var(--gold); background: rgba(201,168,76,0.08); }
.untracked-item-name { font-family: 'Barlow', sans-serif; font-size: 14px; color: var(--text-mid); }
.untracked-item.selected .untracked-item-name { color: var(--gold); }
.untracked-item-group { font-family: 'Barlow Condensed', sans-serif; font-size: 11px; letter-spacing: 0.06em; text-transform: uppercase; color: var(--text-dim); }
.untracked-item.selected .untracked-item-group { color: #8a6a2a; }
.untracked-divider { font-size: 11px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.08em; margin: 10px 0 6px; }
.untracked-empty { font-size: 13px; color: var(--text-dim); padding: 8px 0; }
.no-data-msg { padding: 60px 24px; text-align: center; color: var(--text-dimmer); font-size: 14px; line-height: 1.7; }

/* Legend */
.var-pill-row { display: flex; flex-wrap: wrap; gap: 6px; padding: 10px 16px 12px; border-bottom: 1px solid rgba(255,255,255,0.05); }
.var-pill { background: transparent; border: 1px solid rgba(255,255,255,0.1); color: var(--text-muted); font-family: 'Barlow Condensed', sans-serif; font-weight: 600; font-size: 12px; letter-spacing: 0.05em; text-transform: uppercase; padding: 4px 10px; border-radius: 20px; cursor: pointer; transition: all 0.15s; white-space: nowrap; }
.var-pill.active { background: rgba(201,168,76,0.12); border-color: rgba(201,168,76,0.5); color: var(--gold); }
.var-pill:active { opacity: 0.7; }
.legend-item { display: flex; align-items: center; gap: 6px; }
.legend-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
.legend-label { font-size: 12px; color: var(--text-sub); }

/* Variation data sections */
.var-section { padding: 10px 16px 6px; border-top: 1px solid rgba(255,255,255,0.04); }
.var-section:first-child { border-top: none; }
.var-section-title { display: flex; align-items: center; gap: 7px; font-family: 'Barlow Condensed', sans-serif; font-weight: 700; font-size: 16px; letter-spacing: 0.04em; color: var(--text-sub); text-transform: uppercase; margin-bottom: 8px; }
.var-section-drill { cursor: pointer; padding: 6px 8px; margin: -6px -8px 4px; border-radius: 6px; transition: background 0.15s; }
.var-section-drill:active { background: var(--surface-5); }

/* Method badges */
.method-badge { font-size: 10px; letter-spacing: 0.05em; padding: 2px 6px; border-radius: 4px; font-family: 'Barlow', sans-serif; }
.rpe-badge { color: var(--gold); background: rgba(201,168,76,0.1); }
.est-badge { color: var(--text-dim); background: rgba(255,255,255,0.04); }

/* ── CALCULATOR SCREEN ─────────────────────────────────────────────────────── */
.calc-screen { padding: 16px 16px 100px; }
.calc-mode-toggle { display: flex; background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 12px; padding: 4px; margin-bottom: 16px; box-shadow: var(--card-shadow); }
.calc-mode-btn { flex: 1; padding: 10px 8px; border: none; border-radius: 8px; background: transparent; color: var(--text-sub, #888); font-family: 'Barlow Condensed', sans-serif; font-weight: 700; font-size: 14px; letter-spacing: 0.06em; text-transform: uppercase; cursor: pointer; transition: all 0.15s; }
.calc-mode-btn.active { background: rgba(var(--gold-rgb, 201,168,76), 0.15); color: var(--gold, #C9A84C); box-shadow: inset 0 0 0 1px rgba(var(--gold-rgb, 201,168,76), 0.3); }
.calc-section { background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 14px; padding: 16px; margin-bottom: 14px; box-shadow: var(--card-shadow); }
.calc-section-title { font-family: 'Barlow Condensed', sans-serif; font-weight: 700; font-size: 12px; letter-spacing: 0.12em; text-transform: uppercase; color: var(--text-muted); margin-bottom: 14px; }
.calc-input-row { display: flex; align-items: center; gap: 10px; margin-bottom: 14px; overflow: hidden; }
.calc-weight-input { flex: 1; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.08); border-radius: 10px; color: var(--text-primary); font-family: 'Barlow Condensed', sans-serif; font-weight: 700; font-size: 32px; padding: 12px 16px; outline: none; text-align: center; -moz-appearance: textfield; }
.calc-weight-input::-webkit-outer-spin-button,
.calc-weight-input::-webkit-inner-spin-button { -webkit-appearance: none; }
.calc-weight-input:focus { border-color: var(--gold); }

.calc-totals-display { display: flex; gap: 12px; margin-bottom: 16px; }
.calc-total-box { flex: 1; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.06); border-radius: 10px; padding: 12px 14px; text-align: center; }
.calc-total-val { font-family: 'Barlow Condensed', sans-serif; font-weight: 900; font-size: 28px; color: var(--gold-data); line-height: 1; }
.calc-total-unit { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.08em; margin-top: 3px; }
.calc-bar-wrap { display: flex; align-items: center; justify-content: center; margin: 8px 0 4px; overflow: visible; }
.calc-bar-svg { width: 100%; height: 175px; overflow: visible; }
.calc-bar-visual-zone { min-height: 80px; } .calc-plate-breakdown { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 4px; min-height: 44px; }
.calc-plate-chip { display: flex; align-items: center; gap: 6px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; padding: 8px 12px; }
.calc-plate-dot { width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0; }
.calc-plate-label { font-family: 'Barlow Condensed', sans-serif; font-weight: 700; font-size: 15px; color: var(--text-primary); }
.calc-plate-count { font-family: 'Barlow Condensed', sans-serif; font-size: 13px; color: var(--text-muted); }
.calc-bar-note { font-size: 12px; color: var(--text-faint); text-align: center; margin-top: 8px; font-style: italic; }
.calc-no-solution { font-size: 14px; color: #E22C2C; text-align: center; padding: 16px 0; }
/* Manual mode plate grid */
.calc-plates-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
.calc-plate-row { display: flex; align-items: center; gap: 4px; background: rgba(0,0,0,0.25); border: 1px solid rgba(255,255,255,0.05); border-radius: 8px; padding: 5px 6px; min-width: 0; }
.calc-plate-color-swatch { width: 8px; height: 28px; border-radius: 2px; flex-shrink: 0; }
.calc-plate-name { font-family: 'Barlow Condensed', sans-serif; font-weight: 700; font-size: 14px; flex: 1; min-width: 0; white-space: nowrap; }
.calc-plate-stepper { display: flex; align-items: center; gap: 0; flex-shrink: 0; }
.calc-stepper-btn { width: 28px; height: 28px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); justify-content: center; transition: all 0.1s; line-height: 1; user-select: none; color: var(--text-mid); font-size: 18px; }
.calc-stepper-btn:active { background: var(--border); border-color: var(--gold); }
.calc-stepper-val { width: 32px; text-align: center; font-family: 'Barlow Condensed', sans-serif; font-weight: 700; font-size: 18px; color: var(--gold-data); }
.calc-stepper-val.zero { color: var(--text-dimmer); }
.calc-reset-btn { width: 100%; padding: 12px; background: none; border: 1px solid rgba(255,255,255,0.07); border-radius: 8px; color: var(--text-faint); font-family: 'Barlow Condensed', sans-serif; font-weight: 700; font-size: 14px; letter-spacing: 0.06em; text-transform: uppercase; cursor: pointer; margin-top: 8px; transition: all 0.15s; }
.calc-reset-btn:active { border-color: #E22C2C; color: #E22C2C; }
.calc-bar-selector { display: flex; gap: 8px; margin-bottom: 16px; }
.calc-bar-btn { flex: 1; padding: 10px 8px; border: 1px solid rgba(255,255,255,0.07); border-radius: 10px; background: rgba(0,0,0,0.2); color: var(--text-muted); font-family: 'Barlow Condensed', sans-serif; font-weight: 700; font-size: 13px; letter-spacing: 0.04em; cursor: pointer; text-align: center; transition: all 0.15s; line-height: 1.3; }
.calc-bar-btn.active { border-color: var(--gold); color: var(--gold); background: rgba(201,168,76,0.08); }
.calc-bar-btn-sub { font-size: 11px; font-weight: 400; color: var(--text-faint); display: block; margin-top: 2px; }
.calc-bar-btn.active .calc-bar-btn-sub { color: #8a6f30; }
.calc-collar-row { display: flex; align-items: center; justify-content: space-between; padding: 12px 14px; background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 12px; margin-bottom: 14px; box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
.calc-collar-label { font-family: 'Barlow Condensed', sans-serif; font-weight: 700; font-size: 15px; color: var(--text-sub); }
.calc-collar-sub { font-size: 11px; color: var(--text-muted); margin-top: 1px; }
.calc-collar-toggle { width: 44px; height: 24px; border-radius: 12px; background: var(--border-2); border: none; cursor: pointer; position: relative; transition: background 0.2s; flex-shrink: 0; }
.calc-collar-toggle.on { background: var(--gold, #C9A84C); }
.calc-collar-toggle::after { content: ''; position: absolute; top: 3px; left: 3px; width: 18px; height: 18px; border-radius: 50%; background: #555; transition: transform 0.2s, background 0.2s; }
.calc-collar-toggle.on::after { transform: translateX(20px); background: #fff; }

/* ── LIGHT THEME OVERRIDES ───────────────────────────────────────────────── */
[data-theme="light"] .settings-btn { color: var(--gold); border-color: rgba(0,0,0,0.1); background: rgba(0,0,0,0.04); }
[data-theme="light"] .settings-btn:active { background: rgba(184,146,42,0.1); }
[data-theme="light"] .new-btn { color: var(--text-sub); border-color: rgba(0,0,0,0.12); background: rgba(0,0,0,0.04); }
[data-theme="light"] .upload-btn { background: var(--gold); color: #fff; }
[data-theme="light"] .upload-icon { border-color: rgba(184,146,42,0.4); background: rgba(184,146,42,0.06); }
[data-theme="light"] .week-pill { color: var(--text-sub); border-color: var(--border); background: var(--surface-2); }
[data-theme="light"] .week-pill.active { color: var(--gold); border-color: var(--gold); background: rgba(184,146,42,0.06); }
[data-theme="light"] .week-pill.done { background: rgba(74,222,128,0.08); border-color: rgba(74,222,128,0.35); color: rgba(74,222,128,0.7); }
[data-theme="light"] .week-pill.done.active { border-color: var(--gold); color: #22c55e; background: rgba(74,222,128,0.08); }
[data-theme="light"] .day-tab { color: var(--text-sub); border-bottom-color: transparent; }
[data-theme="light"] .day-tab.active { color: var(--gold); border-bottom-color: var(--gold); background: linear-gradient(180deg, rgba(184,146,42,0.06) 0%, transparent 100%); }
[data-theme="light"] .day-tab.done { color: rgba(74,222,128,0.6); border-bottom-color: rgba(74,222,128,0.4); }
[data-theme="light"] .day-tab.done.active { color: #22c55e; border-bottom-color: var(--gold); background: linear-gradient(180deg, rgba(74,222,128,0.06) 0%, transparent 100%); }
[data-theme="light"] .rep-tip-tooltip { background: #fffbe8; border-color: rgba(184,146,42,0.4); color: #8a6a1a; }
[data-theme="light"] .coach-note { color: #7A7230; }
[data-theme="light"] .skip-btn { color: var(--text-sub); border-color: var(--border); }
[data-theme="light"] .skip-btn.active { color: var(--text-mid); background: var(--surface-3); }
[data-theme="light"] .custom-ex-input { background: #FFFFFF; border-color: var(--border); color: var(--text-primary); }
[data-theme="light"] .add-exercise-btn { border-color: #C8C0B8; color: var(--text-muted); }
[data-theme="light"] .next-workout-banner { border-color: rgba(184,146,42,0.45); background: linear-gradient(135deg, var(--banner-grad-a) 0%, var(--banner-grad-b) 100%); }
[data-theme="light"] .nav-btn.active .nav-bg { background: rgba(184,146,42,0.1); }
[data-theme="light"] .bottom-nav { background: rgba(242,237,228,0.8); border-color: rgba(255,255,255,0.7); box-shadow: 0 4px 24px rgba(0,0,0,0.12), 0 1px 4px rgba(0,0,0,0.08); }
[data-theme="light"] .add-lift-btn { color: var(--text-dim); border-color: var(--border); }
[data-theme="light"] .group-pill.active { color: var(--gold); border-color: var(--gold); }
[data-theme="light"] .settings-row-btn { border-color: var(--glass-border); }
[data-theme="light"] .calc-total-box { background: #FFFFFF; border-color: var(--border); box-shadow: 0 1px 3px rgba(0,0,0,0.06); }
[data-theme="light"] .calc-weight-input { background: #FFFFFF; border-color: var(--border); color: var(--text-primary); }
[data-theme="light"] .calc-weight-input:focus { border-color: var(--gold); }
[data-theme="light"] .calc-plate-chip { background: #FFFFFF; border-color: var(--border); }
[data-theme="light"] .calc-plate-row { background: rgba(0,0,0,0.03); border-color: var(--border); }
/* Home screen light theme */
[data-theme="light"] .home-upload-btn { color: #fff; }
[data-theme="light"] .checkin-overlay { background: rgba(0,0,0,0.35); }
/* e1RM number bubbles — dark text, lighter card */
[data-theme="light"] .max-item { background: #FFFFFF; border-color: var(--border); box-shadow: 0 1px 3px rgba(0,0,0,0.07); }
/* calc bar selector buttons */
[data-theme="light"] .calc-bar-btn { background: #FFFFFF; border-color: var(--border); color: var(--text-sub); }
[data-theme="light"] .calc-bar-btn.active { border-color: var(--gold); color: var(--gold); background: rgba(184,146,42,0.06); }
[data-theme="light"] .calc-bar-btn.active .calc-bar-btn-sub { color: var(--gold); opacity: 0.7; }
/* var pills (variation selector on metrics) */
[data-theme="light"] .var-pill { border-color: var(--border); color: var(--text-sub); background: #FFFFFF; }
[data-theme="light"] .var-pill.active { background: rgba(184,146,42,0.08); border-color: var(--gold); color: var(--gold); }
/* calc unit LBS/KG toggle */
[data-theme="light"] .calc-unit-btn.active { color: var(--gold); font-weight: 700; }
/* prescription text — keep gold but use light-mode gold */
[data-theme="light"] [style*="color:#C9A84C"],
[data-theme="light"] [style*="color: #C9A84C"] { color: var(--gold) !important; }
[data-theme="light"] [style*="color:rgba(201,168,76"],
[data-theme="light"] [style*="color: rgba(201,168,76"] { color: var(--gold) !important; }

/* ── COLUMN MAPPER WIZARD ──────────────────────────────────────────────────── */
.colmap-modal { position:fixed;inset:0;z-index:10001;display:none;background:var(--bg);overflow-y:auto;-webkit-overflow-scrolling:touch; }
.colmap-header { padding:16px 20px 0;display:flex;justify-content:space-between;align-items:center; }
.colmap-header-title { font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:20px;color:var(--gold);letter-spacing:0.02em; }
.colmap-header-sub { font-size:11px;color:var(--text-faint);text-transform:uppercase;letter-spacing:0.06em;margin-top:1px; }
.colmap-close { width:36px;height:36px;border-radius:10px;border:1px solid var(--border);background:var(--surface-2);display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--text-sub); }
.colmap-step-bar { display:flex;gap:6px;padding:14px 20px 16px;align-items:center; }
.colmap-step-pill { height:3px;flex:1;border-radius:2px;background:var(--border);transition:background 0.25s; }
.colmap-step-pill.active { background:var(--gold); }
.colmap-step-pill.done { background:var(--green); }
.colmap-step-label { font-size:11px;color:var(--text-faint);margin-left:8px;white-space:nowrap;font-weight:500; }
.colmap-content { padding:0 20px 120px; }
.colmap-section-title { font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:18px;color:var(--text-bright);margin-bottom:4px; }
.colmap-section-sub { font-size:13px;color:var(--text-faint);margin-bottom:16px;line-height:1.4; }
.colmap-step { display:none;animation:onboardFadeIn 0.2s ease; }
.colmap-step.active { display:block; }

/* Sheet preview table */
.colmap-preview { background:var(--surface-2);border:1px solid var(--border);border-radius:12px;overflow:hidden;margin-bottom:20px; }
.colmap-preview-hdr { padding:10px 14px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center; }
.colmap-preview-label { font-size:11px;color:var(--text-faint);text-transform:uppercase;letter-spacing:0.06em; }
.colmap-sheet-name { font-size:12px;color:var(--gold);font-weight:600; }
.colmap-table-wrap { overflow-x:auto;-webkit-overflow-scrolling:touch; }
.colmap-table { min-width:100%;font-size:12px;border-collapse:collapse; }
.colmap-table th { text-align:left;padding:8px 10px;color:var(--text-faint);font-weight:500;font-size:10px;text-transform:uppercase;letter-spacing:0.05em;border-bottom:1px solid var(--border);background:var(--surface-3);white-space:nowrap; }
.colmap-table td { padding:7px 10px;border-bottom:1px solid rgba(255,255,255,0.03);color:var(--text-sub);font-size:12px;white-space:nowrap; }
.colmap-table tr.cm-hdr-row td { color:var(--gold);font-weight:600;background:rgba(201,168,76,0.05); }
.colmap-table tr.cm-data-row td { color:var(--text-primary); }
.colmap-table td.cm-row-num { color:var(--text-faint);font-size:10px;text-align:center;padding:7px 6px;width:28px;min-width:28px;cursor:pointer;user-select:none;-webkit-user-select:none;transition:all 0.15s; }
.colmap-table tr.cm-hdr-row td.cm-row-num { color:var(--text-faint);opacity:0.5; }
.colmap-table tr.cm-start-row td { border-top:2px solid var(--gold); }
.colmap-table tr.cm-start-row td.cm-row-num { color:var(--gold);font-weight:700; }
.colmap-table tr.cm-skip-row td { opacity:0.3; }
.cm-start-hint { font-size:11px;color:var(--text-faint);padding:6px 0 2px;font-style:italic; }
.cm-tap-cell { cursor:pointer;transition:background 0.1s; }
.cm-tap-cell:active { background:rgba(201,168,76,0.15); }
.cm-selected-cell { background:rgba(201,168,76,0.25);border:2px solid var(--gold);font-weight:600;color:var(--gold); }

/* Column mapper rows */
.colmap-grid { display:flex;flex-direction:column;gap:8px;margin-bottom:20px; }
.colmap-row { display:flex;align-items:center;gap:10px;background:var(--surface-2);border:1px solid var(--border);border-radius:10px;padding:10px 14px; }
.colmap-sub-row { margin-left:20px;background:var(--surface-3);border-color:rgba(255,255,255,0.04); }
.colmap-toggle-btn { margin-left:auto;padding:5px 12px;border-radius:100px;border:1px solid var(--border);background:none;color:var(--text-sub);font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:600;letter-spacing:0.04em;cursor:pointer;white-space:nowrap;transition:all 0.15s; }
.colmap-toggle-btn:active { border-color:var(--gold);color:var(--gold); }
.colmap-dot { width:10px;height:10px;border-radius:50%;flex-shrink:0; }
.colmap-dot.gold { background:var(--gold); }
.colmap-dot.blue { background:#7B9FD4; }
.colmap-dot.green { background:var(--green); }
.colmap-dot.purple { background:#B07BD4; }
.colmap-dot.grey { background:var(--text-dim); }
.colmap-select { background:var(--surface-3);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-family:'Barlow',sans-serif;font-size:13px;padding:7px 28px 7px 10px;min-width:100px;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%23666'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center;cursor:pointer; }
.colmap-select.assigned { border-color:var(--gold);color:var(--gold); }
.colmap-label { font-size:13px;font-weight:600;color:var(--text-primary);flex:1; }
.colmap-label span { font-size:11px;color:var(--text-faint);font-weight:400;display:block;margin-top:1px; }
.colmap-optional { font-size:9px;color:var(--text-dim);background:var(--surface-3);padding:2px 6px;border-radius:4px;text-transform:uppercase;letter-spacing:0.05em;margin-left:4px; }

/* Day detection cards */
.colmap-card { background:var(--surface-2);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:16px; }
.colmap-card-title { font-size:13px;font-weight:600;margin-bottom:10px;color:var(--text-primary); }
.colmap-option { display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.04);cursor:pointer; }
.colmap-option:last-child { border-bottom:none; }
.colmap-radio { width:18px;height:18px;border-radius:50%;border:2px solid var(--text-dim);display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:border-color 0.15s; }
.colmap-radio.selected { border-color:var(--gold); }
.colmap-radio.selected::after { content:'';width:8px;height:8px;border-radius:50%;background:var(--gold); }
.colmap-option-text { font-size:13px;color:var(--text-sub);line-height:1.4; }
.colmap-option-text strong { color:var(--text-primary);font-weight:600; }
.colmap-found-days { display:flex;flex-wrap:wrap;gap:6px;margin-top:12px; }
.colmap-day-chip { background:rgba(201,168,76,0.12);border:1px solid rgba(201,168,76,0.25);color:var(--gold);font-size:12px;font-weight:600;padding:5px 12px;border-radius:20px; }

/* Summary */
.colmap-summary { background:var(--surface-2);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:16px; }
.colmap-summary-row { display:flex;justify-content:space-between;align-items:center;padding:6px 0;font-size:13px; }
.colmap-summary-label { color:var(--text-faint); }
.colmap-summary-value { color:var(--gold);font-weight:600; }
.colmap-summary-value.green { color:var(--green); }

/* Buttons */
.colmap-btn-primary { width:100%;padding:14px;border:none;border-radius:100px;background:var(--gold);color:#0a0a0a;font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:15px;text-transform:uppercase;letter-spacing:0.06em;cursor:pointer;margin-bottom:8px; }
.colmap-btn-primary:disabled { opacity:0.4;cursor:default; }
.colmap-btn-secondary { width:100%;padding:12px;border:1px solid var(--border);border-radius:100px;background:none;color:var(--text-sub);font-family:'Barlow',sans-serif;font-size:13px;cursor:pointer; }

/* ── IMPORT INTAKE FIELDS ──────────────────────────────────────────────────── */
.intake-field { margin-bottom:14px; }
.intake-field-label { font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:var(--text-sub);display:block;margin-bottom:6px; }
.intake-field-input { width:100%;background:var(--surface-5);border:1px solid var(--border-3);border-radius:8px;padding:10px 12px;font-family:'Barlow',sans-serif;font-size:14px;color:var(--text-primary);outline:none;-webkit-appearance:none; }
.intake-field-input:focus { border-color:var(--gold); }
.intake-field-input::placeholder { color:var(--text-dim); }
.intake-maxes-row { display:flex;gap:8px; }
.intake-maxes-row .intake-field { flex:1; }
.intake-bw-row .intake-field { flex:1; }
.intake-gender-row { display:flex;gap:8px;margin-bottom:14px; }
.intake-gender-btn { flex:1;padding:10px;background:var(--surface-3);border:1.5px solid var(--border);border-radius:8px;font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:700;letter-spacing:0.05em;text-transform:uppercase;color:var(--text-sub);cursor:pointer;transition:all 0.12s;text-align:center; }
.intake-gender-btn.selected { border-color:var(--gold);color:var(--gold);background:rgba(var(--gold-rgb),0.1); }
.intake-section-label { font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:0.12em;text-transform:uppercase;color:var(--text-faint);margin:20px 0 10px; }
.intake-skip-link { font-size:12px;color:var(--text-dim);text-align:center;cursor:pointer;padding:8px 0; }

/* ── Import Review Step ────────────────────────────────────────────────── */
.review-day-list { display:flex;flex-direction:column;gap:12px;margin:16px 0; }
.review-day-card { background:var(--surface-3);border-radius:12px;overflow:hidden; }
.review-day-header { font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:700;letter-spacing:0.04em;color:var(--gold);padding:10px 14px 6px;border-bottom:1px solid var(--border); }
.review-ex-row { padding:8px 14px;border-bottom:1px solid var(--border); }
.review-ex-row:last-child { border-bottom:none; }
.review-ex-name { font-family:'Barlow',sans-serif;font-size:13px;font-weight:600;color:var(--text-primary); }
.review-ex-pres { font-family:'Barlow',sans-serif;font-size:12px;color:var(--gold);margin-top:2px; }
.review-ex-note { font-family:'Barlow',sans-serif;font-size:11px;color:var(--text-dim);font-style:italic;margin-top:2px; }
.review-wrong-link { font-family:'Barlow',sans-serif;font-size:12px;color:var(--text-dim);cursor:pointer;text-decoration:underline;text-underline-offset:2px; }

/* Editable metadata fields */
.colmap-field { margin-bottom:12px; }
.colmap-field-label { font-size:11px;font-weight:700;letter-spacing:0.08em;text-transform:uppercase;color:var(--text-faint);margin-bottom:5px;font-family:'Barlow Condensed',sans-serif; }
.colmap-field-input { width:100%;background:var(--surface-3);border:1px solid var(--border);border-radius:8px;padding:10px 12px;font-family:'Barlow',sans-serif;font-size:14px;color:var(--text-primary);outline:none;-webkit-appearance:none; }
.colmap-field-input:focus { border-color:var(--gold); }
.colmap-field-input::placeholder { color:var(--text-dim); }
.colmap-field-hint { font-size:11px;color:var(--text-dim);margin-top:3px; }
.colmap-maxes-row { display:flex;gap:8px; }
.colmap-maxes-row .colmap-field { flex:1; }
.colmap-maxes-row .colmap-field-input { text-align:center; }

/* Reduced motion preference */
@media (prefers-reduced-motion: reduce) {
  *, *::before, *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
}

/* Save error toast */
.save-error-toast{position:fixed;top:env(safe-area-inset-top,12px);left:50%;transform:translateX(-50%);background:#b91c1c;color:#fff;padding:10px 20px;border-radius:10px;font-size:13px;font-family:'Barlow',sans-serif;z-index:9998;text-align:center;max-width:90%;animation:toastIn .3s ease}
@keyframes toastIn{from{opacity:0;transform:translateX(-50%) translateY(-20px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}

</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div>
      <div class="header-logo">Unrack <span style="font-size:10px;font-weight:400;color:#888;letter-spacing:0.02em;vertical-align:middle">v0.9.1</span></div>
      <div class="header-sub" id="athlete-name"></div>
    </div>
    <button class="settings-btn" onclick="openSettings()" title="Settings" aria-label="Settings">
      <svg viewBox="0 0 28 40" fill="currentColor" width="14" height="20" aria-hidden="true"><polygon points="18,0 7,22 14,22 10,40 21,18 14,18"/></svg>
    </button>
  </div>
  <div id="main-content"></div>
  <!-- Workout Celebration Overlay -->
  <div id="celebration-overlay" onclick="dismissCelebration()">
    <div class="cel-scroll">
      <div class="cel-inner">
        <!-- Header -->
        <div class="cel-check">
          <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
        </div>
        <div class="cel-title">Session Complete.</div>
        <div class="cel-day" id="cel-day"></div>
        <div class="cel-meta" id="cel-meta"></div>

        <!-- Lift summary card -->
        <div class="cel-card" id="cel-lifts-card">
          <div class="cel-card-label">Top Sets</div>
          <div id="cel-lifts"></div>
        </div>

        <!-- Stats row -->
        <div class="cel-stats" id="cel-stats"></div>

        <!-- All exercises -->
        <div class="cel-card" id="cel-exercises-card">
          <div class="cel-card-label">All Exercises</div>
          <div id="cel-exercises"></div>
        </div>

        <div class="cel-hint">tap anywhere to dismiss</div>
      </div>
    </div>
  </div>
  <nav class="bottom-nav" role="navigation" aria-label="Main navigation">
    <button class="nav-btn" id="nav-home" onclick="setScreen('home')" aria-label="Home">
      <span class="nav-icon"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg></span>Home
    </button>
    <button class="nav-btn" id="nav-workout" onclick="setScreen('workout')" aria-label="Workout">
      <span class="nav-icon"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M20.57 14.86L22 13.43 20.57 12 17 15.57 8.43 7 12 3.43 10.57 2 9.14 3.43 7.71 2 5.57 4.14 4.14 2.71 2.71 4.14l1.43 1.43L2 7.71l1.43 1.43L2 10.57 3.43 12 7 8.43 15.57 17 12 20.57 13.43 22l1.43-1.43L16.29 22l2.14-2.14 1.43 1.43 1.43-1.43-1.43-1.43L22 16.29l-1.43-1.43z"/></svg></span>Workout
    </button>
    <button class="nav-btn" id="nav-metrics" onclick="setScreen('metrics')" aria-label="Metrics">
      <span class="nav-icon"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M5 9v11H1V9h4zm4-5v16H5V4h4zm4 8v8h-4v-8h4zm4-4v12h-4V8h4zm4-6v18h-4V2h4z"/></svg></span>Metrics
    </button>
    <button class="nav-btn" id="nav-calc" onclick="setScreen('calc')" aria-label="Calculator">
      <span class="nav-icon"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M6 2a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H6zm0 2h12v4H6V4zm0 6h2v2H6v-2zm4 0h2v2h-2v-2zm4 0h2v2h-2v-2zM6 14h2v2H6v-2zm4 0h2v2h-2v-2zm4 0h2v6h-2v-6zM6 18h2v2H6v-2zm4 0h2v2h-2v-2z"/></svg></span>Calc
    </button>
  </nav>
</div>

<!-- Format Example Modal -->
<div class="format-example-modal" id="format-example-modal" style="display:none">
  <div class="checkin-overlay" onclick="closeFormatExample()"></div>
  <div class="format-example-sheet">
    <div class="checkin-handle"></div>
    <div id="format-example-body"></div>
  </div>
</div>

<!-- Parse Error Modal -->
<div class="parse-error-modal" id="parse-error-modal" style="display:none">
  <div class="checkin-overlay" onclick="closeParseError()"></div>
  <div class="parse-error-card" id="parse-error-card"></div>
</div>

<!-- Column Mapper Wizard -->
<div class="colmap-modal" id="colmap-modal">
  <div class="colmap-header">
    <div>
      <div class="colmap-header-title">Map Your Spreadsheet</div>
      <div class="colmap-header-sub">Customize how your file is read</div>
    </div>
    <div class="colmap-close" onclick="closeColumnMapper()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
    </div>
  </div>
  <div class="colmap-step-bar">
    <div class="colmap-step-pill" id="cm-pill-1"></div>
    <div class="colmap-step-pill" id="cm-pill-2"></div>
    <div class="colmap-step-pill" id="cm-pill-3"></div>
    <span class="colmap-step-label" id="cm-step-label">Step 1 of 3</span>
  </div>
  <div class="colmap-content">
    <div class="colmap-step" id="cm-step-1"></div>
    <div class="colmap-step" id="cm-step-2"></div>
    <div class="colmap-step" id="cm-step-3"></div>
  </div>
</div>

<!-- Onboarding Overlay -->
<div class="onboarding-overlay" id="onboarding-overlay" style="display:none">
  <div class="onboarding-container" id="onboarding-body"></div>
</div>

<!-- Intake Modal removed (dead code) -->

<!-- Import Intake Modal (multi-step) -->
<div class="schedule-modal" id="import-intent-modal" style="display:none">
  <div class="checkin-overlay" onclick="closeImportIntent()"></div>
  <div class="intake-sheet" style="max-height:90vh;overflow-y:auto;background:var(--glass-bg);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);border:1px solid var(--glass-border);">
    <div class="checkin-handle"></div>
    <div id="import-intake-body"></div>
  </div>
</div>

<!-- Schedule Editor Modal -->
<div class="add-lift-modal" id="add-lift-modal" style="display:none" onclick="if(event.target===this)closeAddLift()">
  <div class="add-lift-sheet">
    <div class="add-lift-title">Track a Lift</div>
    <div id="untracked-list-wrap"></div>
    <div class="untracked-divider">Or enter manually</div>
    <input class="add-lift-input" id="add-lift-name" placeholder="Exercise name" oninput="onAddLiftInput(this.value)" />
    <div class="add-lift-group-label">Group under:</div>
    <div class="add-lift-groups">
      <button class="group-pill active" data-group="squat" onclick="selectGroup(this)">Squat</button>
      <button class="group-pill" data-group="bench" onclick="selectGroup(this)">Bench</button>
      <button class="group-pill" data-group="deadlift" onclick="selectGroup(this)">Deadlift</button>
      <button class="group-pill" data-group="other" onclick="selectGroup(this)">Other</button>
    </div>
    <div class="add-lift-actions">
      <button class="add-lift-cancel" onclick="closeAddLift()">Cancel</button>
      <button class="add-lift-confirm" id="add-lift-confirm-btn" onclick="confirmAddLift()" disabled>Add Lift</button>
    </div>
  </div>
</div>

<!-- Program Manager Modal -->
<div class="add-lift-modal" id="program-modal" style="display:none" onclick="if(event.target===this)closeProgramModal()">
  <div class="add-lift-sheet" style="max-height:80vh;overflow-y:auto">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px">
      <div class="add-lift-title" style="margin-bottom:0">Programs</div>
      <button onclick="closeProgramModal()" style="background:none;border:none;color:var(--text-faint);font-size:22px;cursor:pointer;padding:4px">×</button>
    </div>
    <!-- Add new section -->
    <div style="margin-bottom:20px">
      <div class="add-lift-group-label" style="margin-bottom:10px">Add New Program</div>
      <button class="drive-btn" onclick="closeProgramModal();openDrivePicker()" style="margin:0 auto;width:100%;justify-content:center;flex-direction:row-reverse">
        <svg viewBox="0 0 87.3 78" width="20" height="18">
          <path d="M6.6 66.85l3.85 6.65c.8 1.4 1.95 2.5 3.3 3.3l13.75-23.8H1.2c0 1.55.4 3.1 1.2 4.5l4.2 9.35z" fill="#0066DA"/>
          <path d="M43.65 25L29.9 1.2c-1.35.8-2.5 1.9-3.3 3.3L1.2 52.7c-.8 1.4-1.2 2.95-1.2 4.5h27.5L43.65 25z" fill="#00AC47"/>
          <path d="M73.55 76.8c1.35-.8 2.5-1.9 3.3-3.3l1.6-2.75 7.65-13.25c.8-1.4 1.2-2.95 1.2-4.5H59.85L73.55 76.8z" fill="#EA4335"/>
          <path d="M43.65 25L57.4 1.2C56.05.4 54.5 0 52.9 0H34.4c-1.6 0-3.15.45-4.5 1.2L43.65 25z" fill="#00832D"/>
          <path d="M59.85 53H27.5l-13.75 23.8c1.35.8 2.9 1.2 4.5 1.2h50.4c1.6 0 3.15-.45 4.5-1.2L59.85 53z" fill="#2684FC"/>
          <path d="M73.4 26.5l-12.7-22c-.8-1.4-1.95-2.5-3.3-3.3L43.65 25l16.2 28h27.45c0-1.55-.4-3.1-1.2-4.5L73.4 26.5z" fill="#FFBA00"/>
        </svg>
        Import from Drive
      </button>

      <div style="display:flex;align-items:center;gap:8px;margin:14px 0 10px">
        <div style="flex:1;height:1px;background:var(--border)"></div>
        <div style="font-size:11px;color:var(--text-faint);font-family:'Barlow',sans-serif;letter-spacing:0.08em;text-transform:uppercase">or upload from device</div>
        <div style="flex:1;height:1px;background:var(--border)"></div>
      </div>
      <button class="upload-btn" style="width:100%;max-width:none;padding:11px 14px;font-size:13px;letter-spacing:0.05em;display:flex;align-items:center;justify-content:center;gap:7px;flex-direction:row-reverse" onclick="closeProgramModal();document.getElementById('file-input').click()">Upload File<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" width="15" height="15"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg></button>
    </div>
    <!-- Existing cycles -->
    <div id="program-list"></div>
  </div>
</div>

<!-- Delete Confirm Modal -->
<div class="add-lift-modal" id="delete-modal" style="display:none;z-index:400" onclick="if(event.target===this)closeDeleteModal()">
  <div class="add-lift-sheet">
    <div class="add-lift-title" style="color:#E22C2C">Delete Program?</div>
    <div style="font-size:14px;color:var(--text-sub);line-height:1.6;margin-bottom:20px">
      This will permanently delete <strong id="delete-modal-name" style="color:var(--text-primary)"></strong> and all logged workout data for this cycle. This cannot be undone.
    </div>
    <div class="add-lift-actions">
      <button class="add-lift-cancel" onclick="closeDeleteModal()">Cancel</button>
      <button id="delete-confirm-btn" class="add-lift-confirm" style="background:#E22C2C;color:#000" onclick="confirmDeleteBlock()">Delete Forever</button>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div class="add-lift-modal" id="settings-modal" style="display:none" onclick="if(event.target===this)closeSettings()">
  <div class="add-lift-sheet settings-sheet">
    <div class="settings-header">
      <div class="add-lift-title">Settings</div>
      <button class="export-modal-close" onclick="closeSettings()">✕</button>
    </div>

    <div class="settings-section-label">Programs</div>
    <button class="settings-row-btn" onclick="closeSettings();openProgramModal()">
      <div class="settings-row-left">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
        Manage Programs
      </div>
      <svg class="settings-row-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
    </button>

    <div class="settings-section-label">Export</div>
    <button class="settings-row-btn" onclick="closeSettings();openExportFromSettings()">
      <div class="settings-row-left">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
        Training Log &amp; Report
      </div>
      <svg class="settings-row-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
    </button>

    <div class="settings-section-label">Home</div>
    <button class="settings-row-btn" onclick="toggleAthleteProfileForm()" id="athlete-profile-row">
      <div class="settings-row-left">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
        Athlete Profile
      </div>
      <svg class="settings-row-arrow" id="athlete-profile-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
    </button>
    <div class="settings-athlete-form" id="athlete-profile-form">
      <div class="settings-athlete-row">
        <div class="settings-athlete-label">Name</div>
        <input class="settings-athlete-input" id="ap-name" type="text" placeholder="Your name" autocomplete="off">
      </div>
      <div class="settings-athlete-row">
        <div class="settings-athlete-label">Gender</div>
        <div class="settings-athlete-gender">
          <button class="settings-athlete-gender-btn" id="ap-male" onclick="setApGender('male')">Male</button>
          <button class="settings-athlete-gender-btn" id="ap-female" onclick="setApGender('female')">Female</button>
        </div>
      </div>
      <div class="settings-athlete-row">
        <div class="settings-athlete-label">Bodyweight</div>
        <div class="settings-athlete-bw-row">
          <input class="settings-athlete-input" id="ap-bw" type="number" inputmode="decimal" placeholder="0">
          <button class="settings-athlete-unit-btn" id="ap-unit" onclick="toggleApUnit()">lbs</button>
        </div>
      </div>
      <div class="settings-athlete-row">
        <div class="settings-athlete-label" style="margin-bottom:6px">Current 1RM (lbs)</div>
        <div style="display:flex;gap:8px">
          <div style="flex:1;text-align:center">
            <div style="font-size:10px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:4px">Squat</div>
            <input class="settings-athlete-input" id="ap-max-s" type="number" inputmode="numeric" placeholder="—" style="text-align:center">
          </div>
          <div style="flex:1;text-align:center">
            <div style="font-size:10px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:4px">Bench</div>
            <input class="settings-athlete-input" id="ap-max-b" type="number" inputmode="numeric" placeholder="—" style="text-align:center">
          </div>
          <div style="flex:1;text-align:center">
            <div style="font-size:10px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:4px">Deadlift</div>
            <input class="settings-athlete-input" id="ap-max-d" type="number" inputmode="numeric" placeholder="—" style="text-align:center">
          </div>
        </div>
      </div>
      <button class="settings-athlete-save" onclick="saveAthleteProfile()">Save</button>
    </div>
    <button class="settings-row-btn" onclick="resetOnboarding()" style="cursor:pointer">
      <div class="settings-row-left">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        Reset Onboarding (Testing)
      </div>
    </button>

    <button id="scores-settings-row" class="settings-row-btn" onclick="toggleScoresSetting()" style="cursor:pointer">
      <div class="settings-row-left">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
        DOTS / Wilks Scores
      </div>
      <div class="settings-toggle on" id="scores-toggle" role="switch" aria-checked="true" aria-label="DOTS / Wilks Scores toggle"></div>
    </button>

    <div class="settings-section-label" style="margin-top:auto;padding-top:24px">Theme</div>
    <div class="settings-theme-pills" id="settings-theme-pills">
      <button class="settings-theme-pill" data-theme="dark" onclick="applyTheme('dark');updateSettingsThemePills()">Dark</button>
      <button class="settings-theme-pill" data-theme="navy" onclick="applyTheme('navy');updateSettingsThemePills()">Navy</button>
      <button class="settings-theme-pill" data-theme="light" onclick="applyTheme('light');updateSettingsThemePills()">Light</button>
    </div>

    <div style="text-align:center;padding-top:20px;padding-bottom:8px">
      <a href="https://powerliftlog.github.io/PowerliftingLog/privacy/" target="_blank" style="font-family:'Barlow',sans-serif;font-size:12px;color:var(--text-dim);text-decoration:underline;text-underline-offset:3px">Privacy Policy</a>
    </div>
  </div>
</div>

<input type="file" id="file-input" accept=".xlsx,.xls,.csv,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel,text/csv" style="display:none">

<script>
// ── THEME ─────────────────────────────────────────────────────────────────────
const THEME_META  = { dark: '#0a0a0a', navy: '#0A0E1A', light: '#F2EDE4' };

function loadTheme(){ return localStorage.getItem('liftlog_theme')||'dark'; }
function saveTheme(t){ try{ localStorage.setItem('liftlog_theme', t); }catch(e){ console.error(e); } }

function applyTheme(t){
  document.documentElement.setAttribute('data-theme', t==='dark' ? '' : t);
  const meta = document.getElementById('theme-color-meta');
  if(meta) meta.content = THEME_META[t]||THEME_META.dark;
  const statusBar = document.getElementById('status-bar-meta');
  if(statusBar) statusBar.content = t==='light' ? 'default' : 'black-translucent';
  saveTheme(t);
}


// Apply on load
applyTheme(loadTheme());

const _savedBlocks=loadBlocks()||[];
const state = { blocks:_savedBlocks, activeBlock:_savedBlocks[_savedBlocks.length-1]||null, activeWeek:0, activeDay:0, logs:loadLogs(), screen:'home', metricsDrillBlock:null, metricsActiveVar:{}, customLifts:loadCustomLifts(), trackedLifts:loadTrackedLifts(), editingExKey:null, editingRepsKey:null, editingBlockName:false, expandedEx:new Set(), extraSets:{}, workoutActive:null, calc:{ mode:'target', inputUnit:'lbs', inputVal:'', barId:'standard', collarsOn:false, manualCounts:{ 25:0, 20:0, 15:0, 10:0, 5:0, 2.5:0, 1.25:0, 0.5:0, 0.25:0 } } };
// Restore nav position from last session
(function restoreNav(){
  const nav=loadNav();
  if(nav.blockId){ const b=state.blocks.find(b=>b.id===nav.blockId); if(b) state.activeBlock=b; }
  if(typeof nav.week==='number') state.activeWeek=nav.week;
  if(typeof nav.day==='number') state.activeDay=nav.day;
  // Bounds-check restored week/day indices against active block
  const _rb=state.activeBlock;
  if(_rb&&_rb.weeks){
    if(state.activeWeek>=_rb.weeks.length) state.activeWeek=0;
    const _rw=_rb.weeks[state.activeWeek];
    if(_rw&&_rw.days&&state.activeDay>=_rw.days.length) state.activeDay=0;
  }
})();

// Re-run set-level pre-population for blocks restored from localStorage
// This fills in missing set keys that may not have existed in older versions
function showSaveError(){if(window._saveErrorShown)return;window._saveErrorShown=true;const toast=document.createElement('div');toast.className='save-error-toast';toast.textContent='Storage full \u2014 some data may not be saved. Consider exporting your data.';document.body.appendChild(toast);setTimeout(()=>toast.remove(),8000);}

function _showWarningToast(msg){const t=document.createElement('div');t.className='save-error-toast';t.textContent=msg;document.body.appendChild(t);setTimeout(()=>t.remove(),8000);}
function loadLogs(){ try{ return JSON.parse(localStorage.getItem('liftlog_v4')||'{}'); }catch(e){ console.error('[liftlog] loadLogs error:',e); setTimeout(()=>_showWarningToast('Warning: Your workout log data could not be loaded. It may be corrupted. Your programs are unaffected.'),500); return {}; } }
let _saveLogsTimer=null;
function _saveLogsImmediate(){ try{ localStorage.setItem('liftlog_v4', JSON.stringify(state.logs)); }catch(e){ console.error('[liftlog] saveLogs error:',e); showSaveError(); } }
function saveLogs(){ clearTimeout(_saveLogsTimer); _saveLogsTimer=setTimeout(_saveLogsImmediate,300); }
window.addEventListener('beforeunload',()=>{ if(_saveLogsTimer){ clearTimeout(_saveLogsTimer); _saveLogsImmediate(); } });
function rePopulateSets(blocks){
  try{
    for(const block of blocks){
      if(block.format!=='A') continue;
      for(const week of block.weeks){
        for(const day of week.days){
          for(const ex of day.exercises){
            const key=[block.id,week.label,day.name,ex.name].join('||');
            const exLog=state.logs[key];
            if(!exLog?.done) continue;
            if(!ex.prescription) continue;
            const sets=parseSets(ex.prescription);
            if(!sets.length) { const wu=parseWarmupSets(ex.prescription); if(wu.length) sets.push(...wu); }
            sets.forEach((s,si)=>{
              const sk=key+`||s${si}`;
              if(state.logs[sk]){
                // Backfill RPE onto existing set entries that were migrated without it
                if(exLog.rpe && !state.logs[sk].rpe) state.logs[sk].rpe=exLog.rpe;
                return;
              }
              const setEntry={done:true};
              if(exLog.actual) setEntry.actual=exLog.actual;
              else if(!s.isRpe) setEntry.actual=String(s.weight);
              if(exLog.rpe) setEntry.rpe=exLog.rpe;
              state.logs[sk]=setEntry;
            });
          }
        }
      }
    }
    if(blocks.length>0) saveLogs();
  }catch(e){ console.error('[liftlog] rePopulateSets error:',e); }
}
if(_savedBlocks.length>0) rePopulateSets(_savedBlocks);
function loadBlocks(){ try{ const d=localStorage.getItem('liftlog_blocks'); return d?JSON.parse(d):null; }catch(e){ console.error('[liftlog] loadBlocks error:',e); setTimeout(()=>_showWarningToast('Warning: Your program data could not be loaded. It may be corrupted. Try re-uploading your Excel file.'),500); return null; } }
function saveBlocks(){ try{ localStorage.setItem('liftlog_blocks',JSON.stringify(state.blocks)); }catch(e){ console.error('[liftlog] saveBlocks error:',e); showSaveError(); } }
function loadCustomLifts(){ try{ return JSON.parse(localStorage.getItem('liftlog_custom')||'[]'); }catch{ return []; } }
function saveCustomLifts(){ try{ localStorage.setItem('liftlog_custom', JSON.stringify(state.customLifts)); }catch(e){ console.error('[liftlog] saveCustomLifts error:',e); showSaveError(); } }
function loadTrackedLifts(){ try{ return JSON.parse(localStorage.getItem('liftlog_tracked')||'{}'); }catch{ return {}; } }
function saveTrackedLifts(){ try{ localStorage.setItem('liftlog_tracked', JSON.stringify(state.trackedLifts)); }catch(e){ console.error('[liftlog] saveTrackedLifts error:',e); showSaveError(); } }
function loadNav(){ try{ return JSON.parse(localStorage.getItem('liftlog_nav')||'{}'); }catch{ return {}; } }
function saveNav(){ try{ localStorage.setItem('liftlog_nav', JSON.stringify({blockId:state.activeBlock?.id||null,week:state.activeWeek,day:state.activeDay})); }catch(e){ console.error('[liftlog] saveNav error:',e); showSaveError(); } }
function lk(bid,wl,dn,en){ return [bid,wl,dn,en].join('||'); }
function esc(s){ return String(s).replace(/\\/g,'\\\\').replace(/'/g,"\\'"); }
function escH(s){ const d=document.createElement('div');d.textContent=String(s);return d.innerHTML; }
function cssEsc(s){ return CSS.escape ? CSS.escape(s) : s.replace(/([[\](){}|\\^$*.+?])/g,'\\$1'); }

// ── SCREEN NAV ────────────────────────────────────────────────────────────────
let _workoutScrollY = 0;
function setScreen(s){
  // Save workout scroll position when leaving workout tab
  if(state.screen==='workout') _workoutScrollY = window.scrollY;
  state.screen=s;
  if(s==='metrics') state.metricsDrillBlock=null;
  document.getElementById('nav-home').classList.toggle('active',s==='home');
  document.getElementById('nav-workout').classList.toggle('active',s==='workout');
  document.getElementById('nav-metrics').classList.toggle('active',s==='metrics');
  document.getElementById('nav-calc').classList.toggle('active',s==='calc');
  render();
  // Restore workout scroll; all other tabs start at top
  if(s==='workout'){ requestAnimationFrame(()=>window.scrollTo(0, _workoutScrollY)); }
  else { window.scrollTo(0, 0); }
}

// ── LIFT CLASSIFICATION ───────────────────────────────────────────────────────
// LIFT_GROUPS, COMP_KEYWORDS, VARIATION_MODIFIERS, isCompLift → from parsers.js

function isTracked(name){
  // Returns true if this exercise should appear in metrics
  const n=name.toLowerCase().trim();
  if(state.trackedLifts[n]===false) return false; // explicitly deselected
  if(state.trackedLifts[n]===true) return true;   // explicitly opted in
  return isCompLift(name);                          // default: comp lifts on, variations off
}

function toggleTracked(name, event){
  if(event){ event.stopPropagation(); event.preventDefault(); }
  const n=name.toLowerCase().trim();
  const current=isTracked(name);
  state.trackedLifts[n]=!current;
  saveTrackedLifts();
  // Preserve scroll — find the closest exercise card to anchor against
  const btn=event?.target?.closest('.exercise-card');
  let anchorOffset=null;
  if(btn){ anchorOffset=btn.getBoundingClientRect().top; }
  render();
  if(btn && anchorOffset!==null){
    const expandKey=btn.dataset.expandKey;
    if(expandKey){
      const newCard=document.querySelector(`.exercise-card[data-expand-key="${CSS.escape(expandKey)}"]`);
      if(newCard){ window.scrollBy(0, newCard.getBoundingClientRect().top - anchorOffset); }
    }
  }
}

// Auto-register comp lifts when a program is loaded
function autoRegisterCompLifts(blocks){
  for(const block of blocks){
    for(const week of block.weeks){
      for(const day of week.days){
        for(const ex of day.exercises){
          const n=ex.name.toLowerCase().trim();
          // Only set if not already explicitly set by user
          if(state.trackedLifts[n]===undefined&&isCompLift(ex.name)){
            state.trackedLifts[n]=true;
          }
        }
      }
    }
  }
  saveTrackedLifts();
}

function classifyLift(name){
  const n=name.toLowerCase();
  for(const [group,keywords] of Object.entries(LIFT_GROUPS)){
    if(keywords.some(k=>n.includes(k))) return group;
  }
  // Check custom lifts
  const custom=state.customLifts.find(c=>c.name.toLowerCase()===n);
  if(custom) return custom.group;
  return null;
}

// ── EXERCISE INPUT MODE ───────────────────────────────────────────────────────
const CARDIO_KEYWORDS = ['treadmill','bike','cycling','rowing machine','elliptical','stairmaster','stair master','cardio','walk','jog','run','sprint'];
const BODYWEIGHT_KEYWORDS = [
  'sit up','situp','sit-up','crunch','leg raise','hanging leg','v-up','ab wheel','ab rollout',
  'dead bug','bird dog','pallof','push up','pushup','push-up','pull up','pullup','pull-up',
  'chin up','chinup','chin-up','dip','bodyweight','stretch','foam roll','mobility',
  'yoga','jumping jack','burpee','mountain climber','glute bridge','hip thrust bodyweight',
  'lunge bodyweight','pike','handstand','muscle up','muscle-up','flutter kick'
];
const ISOMETRIC_KEYWORDS = ['plank','wall sit','iso hold','isometric','dead hang','l-sit','hollow hold'];
const WEIGHTED_OVERRIDES = ['db ','db\t','dumbbell','bb ','bb\t','barbell','cable','machine','kettlebell','kb ','band','weighted','smith','ez ','ez-'];
const TIMED_PATTERN=/\d+\s*(min|sec|s|m)\b/i;
function getExerciseInputMode(name,pres){
  const n=name.toLowerCase().trim();
  // Explicit weighted overrides — DB, BB, cable, machine, kettlebell etc.
  if(WEIGHTED_OVERRIDES.some(k=>n.includes(k))) return 'weighted';
  if(CARDIO_KEYWORDS.some(k=>n.includes(k))) return 'cardio';
  // Isometric exercises — just need a checkmark (or time field if timed pres)
  if(ISOMETRIC_KEYWORDS.some(k=>n.includes(k))){
    return (TIMED_PATTERN.test(n)||(pres&&TIMED_PATTERN.test(pres))) ? 'bw-timed' : 'bw';
  }
  if(BODYWEIGHT_KEYWORDS.some(k=>n.includes(k))){
    return (TIMED_PATTERN.test(n)||(pres&&TIMED_PATTERN.test(pres))) ? 'bw-timed' : 'bw';
  }
  return 'weighted';
}

// ── EPLEY 1RM ─────────────────────────────────────────────────────────────────
function epley(weight,reps){
  if(!weight||!reps||reps<1) return null;
  if(reps===1) return weight;
  return Math.round(weight*(1+reps/30));
}

// RTS RPE chart: maps reps @ RPE to % of 1RM
// RPE_TABLE[reps][rpe] = fraction of 1RM
const RPE_TABLE = {
  1:  {10:1.000, 9.5:0.978, 9:0.955, 8.5:0.939, 8:0.922, 7.5:0.907, 7:0.892, 6.5:0.878, 6:0.863, 5.5:0.849, 5:0.835},
  2:  {10:0.955, 9.5:0.939, 9:0.922, 8.5:0.907, 8:0.892, 7.5:0.878, 7:0.863, 6.5:0.849, 6:0.835, 5.5:0.822, 5:0.808},
  3:  {10:0.922, 9.5:0.907, 9:0.892, 8.5:0.878, 8:0.863, 7.5:0.849, 7:0.835, 6.5:0.822, 6:0.808, 5.5:0.794, 5:0.781},
  4:  {10:0.892, 9.5:0.878, 9:0.863, 8.5:0.849, 8:0.835, 7.5:0.822, 7:0.808, 6.5:0.794, 6:0.781, 5.5:0.768, 5:0.755},
  5:  {10:0.863, 9.5:0.849, 9:0.835, 8.5:0.822, 8:0.808, 7.5:0.794, 7:0.781, 6.5:0.768, 6:0.755, 5.5:0.742, 5:0.730},
  6:  {10:0.835, 9.5:0.822, 9:0.808, 8.5:0.794, 8:0.781, 7.5:0.768, 7:0.755, 6.5:0.742, 6:0.730, 5.5:0.717, 5:0.705},
  7:  {10:0.808, 9.5:0.794, 9:0.781, 8.5:0.768, 8:0.755, 7.5:0.742, 7:0.730, 6.5:0.717, 6:0.705, 5.5:0.693, 5:0.681},
  8:  {10:0.781, 9.5:0.768, 9:0.755, 8.5:0.742, 8:0.730, 7.5:0.717, 7:0.705, 6.5:0.693, 6:0.681, 5.5:0.669, 5:0.658},
  9:  {10:0.755, 9.5:0.742, 9:0.730, 8.5:0.717, 8:0.705, 7.5:0.693, 7:0.681, 6.5:0.669, 6:0.658, 5.5:0.647, 5:0.636},
  10: {10:0.730, 9.5:0.717, 9:0.705, 8.5:0.693, 8:0.681, 7.5:0.669, 7:0.658, 6.5:0.647, 6:0.636, 5.5:0.625, 5:0.614},
};

function rpeAdjusted1rm(weight, reps, rpe){
  if(!weight||!reps||!rpe) return null;
  const rpeVal=Math.round(parseFloat(rpe)*2)/2; // round to nearest 0.5
  const repRow=RPE_TABLE[Math.min(Math.max(Math.round(reps),1),10)];
  if(!repRow) return null;
  const pct=repRow[rpeVal];
  if(!pct) return null;
  return Math.round(weight/pct);
}

function calc1rm(weight, reps, rpe){
  // Prefer RPE-adjusted if RPE is available, fall back to Epley
  if(rpe&&parseFloat(rpe)>=5){
    const rpeResult=rpeAdjusted1rm(weight,reps,rpe);
    if(rpeResult) return {value:rpeResult, method:'rpe'};
  }
  const epleyResult=epley(weight,reps);
  return epleyResult?{value:epleyResult, method:'epley'}:null;
}

// ── BUILD METRICS DATA ────────────────────────────────────────────────────────
function buildMetrics(drillBlockId){
  const groups = { squat:{label:'Squat',variations:{}}, bench:{label:'Bench',variations:{}}, deadlift:{label:'Deadlift',variations:{}}, other:{label:'Other',variations:{}} };
  const blockIndex={};
  state.blocks.forEach((b,i)=>{ blockIndex[b.id]=i; });

  state.customLifts.forEach(cl=>{
    const g=groups[cl.group]||groups.other;
    if(!g.variations[cl.name]) g.variations[cl.name]=[];
  });

  // Raw weekly data — collect all points first
  const rawPoints=[]; // {blockId, blockName, weekLabel, exName, group, e1rm, method, topWeight, topReps}

  for(const [key,val] of Object.entries(state.logs)){
    const parts=key.split('||');
    if(parts.length<5) continue;
    const blockId=parts[0];
    const exName=parts[3];
    const weekLabel=parts[1];
    const setIdx=parts[4];
    if(!setIdx.startsWith('s')) continue;

    const setIdxNum=parseInt(setIdx.slice(1));
    let weight=null;
    if(val.actual){ weight=parseFloat(val.actual); }
    else if(val.done){ weight=getPrescribedWeight(parts[0],parts[1],parts[2],parts[3],setIdxNum); }
    if(!weight||isNaN(weight)||weight<=0) continue;

    const reps=getSetReps(parts[0],parts[1],parts[2],parts[3],setIdxNum);
    if(!reps) continue;

    const rpe=val.rpe?parseFloat(val.rpe):null;
    const result=calc1rm(weight,reps,rpe);
    if(!result) continue;

    const group=classifyLift(exName);
    if(!group) continue;
    if(!isTracked(exName)) continue;

    const block=state.blocks.find(b=>b.id===blockId);
    if(!block) continue;

    // Track best e1rm per exercise per week per block
    // Prefer RPE-based results over Epley estimates; tie-break by higher e1rm
    const existing=rawPoints.find(p=>p.blockId===blockId&&p.weekLabel===weekLabel&&p.exName===exName);
    if(existing){
      const newIsRpe=result.method==='rpe', oldIsRpe=existing.method==='rpe';
      if((newIsRpe&&!oldIsRpe)||(newIsRpe===oldIsRpe&&result.value>existing.e1rm)){
        existing.e1rm=result.value; existing.method=result.method; existing.topWeight=weight; existing.topReps=reps;
      }
    }
    else rawPoints.push({blockId,blockName:block.name,weekLabel,dayName:parts[2],exName,group,e1rm:result.value,method:result.method,topWeight:weight,topReps:reps});
  }

  if(drillBlockId){
    // ── WEEKLY VIEW: show each week for the selected cycle ──────────────────
    const pts=rawPoints.filter(p=>p.blockId===drillBlockId);
    for(const pt of pts){
      const g=groups[pt.group]||groups.other;
      if(!g.variations[pt.exName]) g.variations[pt.exName]=[];
      // Resolve actual completion date from __complete__ log entry
      const cKey = pt.blockId+'||'+pt.weekLabel+'||'+pt.dayName+'||__complete__';
      const cDate = state.logs[cKey]?.completedDate || null;
      g.variations[pt.exName].push({session:pt.weekLabel,blockId:pt.blockId,weekLabel:pt.weekLabel,completedDate:cDate,e1rm:pt.e1rm,method:pt.method,topWeight:pt.topWeight,topReps:pt.topReps});
    }
    // Sort by week within cycle
    for(const g of Object.values(groups))
      for(const v of Object.values(g.variations))
        v.sort((a,b)=>sessionOrder(a.weekLabel)-sessionOrder(b.weekLabel));
  } else {
    // ── CYCLE VIEW: one point per cycle (best e1rm that cycle) ─────────────
    for(const pt of rawPoints){
      const g=groups[pt.group]||groups.other;
      if(!g.variations[pt.exName]) g.variations[pt.exName]=[];
      const existing=g.variations[pt.exName].find(p=>p.blockId===pt.blockId);
      if(existing){
        const newIsRpe=pt.method==='rpe', oldIsRpe=existing.method==='rpe';
        if((newIsRpe&&!oldIsRpe)||(newIsRpe===oldIsRpe&&pt.e1rm>existing.e1rm)){
          existing.e1rm=pt.e1rm; existing.method=pt.method; existing.topWeight=pt.topWeight; existing.topReps=pt.topReps; existing.bestWeek=pt.weekLabel;
        }
      }
      else g.variations[pt.exName].push({session:pt.blockName,blockId:pt.blockId,weekLabel:pt.weekLabel,e1rm:pt.e1rm,method:pt.method,topWeight:pt.topWeight,topReps:pt.topReps,bestWeek:pt.weekLabel,isCyclePoint:true});
    }
    // Sort by block index
    for(const g of Object.values(groups))
      for(const v of Object.values(g.variations))
        v.sort((a,b)=>(blockIndex[a.blockId]||0)-(blockIndex[b.blockId]||0));
  }

  return groups;
}

function sessionOrder(label){
  // Try to extract week number: "W1", "W2", "10 Weeks Out", "9 weeks out"
  const wm=label.match(/W(\d+)/i); if(wm) return parseInt(wm[1]);
  const nm=label.match(/(\d+)/); if(nm) return 1000-parseInt(nm[1]); // "10 weeks out" -> earlier = higher number
  return 999;
}

function getPrescribedWeight(blockId,weekLabel,dayName,exName,setIdx){
  // Returns numeric prescribed weight for a set, or null if RPE-based/unprescribed
  const block=state.blocks.find(b=>b.id===blockId);
  if(!block) return null;
  const week=block.weeks.find(w=>w.label===weekLabel);
  if(!week) return null;
  const day=week.days.find(d=>d.name===dayName);
  if(!day) return null;
  const ex=day.exercises.find(e=>e.name===exName);
  if(!ex||!ex.prescription) return null;
  const sets=parseSets(ex.prescription);
  const s=sets[setIdx];
  if(!s) return null;
  if(s.isRpe) return null; // RPE-based — can't assume weight
  const w=parseFloat(s.weight);
  return isNaN(w)?null:w;
}

function getSetReps(blockId,weekLabel,dayName,exName,setIdx){
  const block=state.blocks.find(b=>b.id===blockId);
  if(!block) return null;
  const week=block.weeks.find(w=>w.label===weekLabel);
  if(!week) return null;
  const day=week.days.find(d=>d.name===dayName);
  if(!day) return null;
  const ex=day.exercises.find(e=>e.name===exName);
  if(!ex||!ex.prescription) return null;

  const sets=parseSets(ex.prescription);
  if(sets[setIdx]) return sets[setIdx].reps;

  const simple=parseSimple(ex.prescription);
  if(simple){
    const r=String(simple.reps).split('-')[0];
    return parseInt(r)||null;
  }

  // Ranged prescription e.g. "3-4x15 (M)"
  const ranged=parseRangeSet(ex.prescription);
  if(ranged){
    const r=String(ranged.reps).split('-')[0];
    return parseInt(r)||null;
  }

  // Free-entry fallback — no reps prescribed, can't calculate 1RM
  return null;
}

// ── METRICS RENDER ────────────────────────────────────────────────────────────
function renderMetrics(){
  const main=document.getElementById('main-content');
  const multiCycle=state.blocks.length>1;
  const activeBlockId=state.activeBlock?.id||state.blocks[state.blocks.length-1]?.id;

  // drill state: null = current cycle, 'all' = all cycles view
  const drill=state.metricsDrillBlock; // null | 'all' | specific blockId (legacy)

  // Determine which block to show data for
  // null drill = current cycle; 'all' = all blocks
  const drillBlockId = (drill && drill !== 'all') ? drill : (drill === 'all' ? null : activeBlockId);
  const metrics=buildMetrics(drillBlockId);
  let h=`<div class="metrics-screen">`;

  // No program loaded — empty state
  if(state.blocks.length===0){
    h+=`<div style="padding:16px">`;
    ['Squat','Bench','Deadlift'].forEach(label=>{
      h+=`<div class="metrics-lift-group" style="margin-bottom:16px">
        <div class="metrics-lift-header">
          <div class="metrics-lift-title">${label}</div>
          <div style="text-align:right"><div class="metrics-best" style="color:var(--border)">—</div><div class="metrics-best-label">Best Est. 1RM</div></div>
        </div>
        <div class="chart-wrap" style="position:relative">
          <canvas class="rm-chart" width="400" height="120" style="opacity:0.15"></canvas>
          <div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:12px;color:var(--text-dimmer);letter-spacing:0.06em;text-transform:uppercase">No data</div>
        </div>
      </div>`;
    });
    h+=`<div style="text-align:center;font-size:13px;color:var(--text-dim);padding:8px 0 24px">Load a program and log weights to start tracking</div>`;
    h+=`</div></div>`;
    main.innerHTML=h;
    return;
  }

  // Inline cycle toggle pills
  if(multiCycle){
    const activeBlock=state.blocks.find(b=>b.id===activeBlockId);
    const cycleName=activeBlock?activeBlock.name:'Current Cycle';
    const isCurrent=drill!=='all';
    h+=`<div class="metrics-cycle-toggle">
      <button class="metrics-toggle-pill${isCurrent?' active':''}" onclick="setMetricsDrill(null)">${cycleName}</button>
      <button class="metrics-toggle-pill${!isCurrent?' active':''}" onclick="setMetricsDrill('all')">All Cycles</button>
      <button class="metrics-export-btn" onclick="openExportModal('${esc(activeBlockId)}')" title="Export"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg></button>
    </div>`;
  }

  // Single cycle — show export button in its own header row
  if(!multiCycle && state.blocks.length > 0){
    h+=`<div class="metrics-cycle-toggle" style="justify-content:flex-end">
      <button class="metrics-export-btn" onclick="openExportModal('${esc(activeBlockId)}')" title="Export"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg></button>
    </div>`;
  }

  // ── Est. 1RM from logged comp lifts ──────────────────────────────────────
  const e1rmByGroup = { squat: null, bench: null, deadlift: null };
  const filterBlockId = drillBlockId; // null = all cycles, string = specific block
  for (const [key, val] of Object.entries(state.logs)) {
    const parts = key.split('||');
    if (parts.length < 5 || !parts[4].startsWith('s')) continue;
    if (filterBlockId && parts[0] !== filterBlockId) continue;
    const exName = parts[3];
    if (!isCompLift(exName)) continue;
    const group = classifyLift(exName);
    if (!group || group === 'other') continue;
    const si = parseInt(parts[4].slice(1));
    let weight = val.actual ? parseFloat(val.actual) : null;
    if (!weight || isNaN(weight) || weight <= 0) continue;
    const reps = getSetReps(parts[0], parts[1], parts[2], exName, si);
    if (!reps) continue;
    const rpe = val.rpe ? parseFloat(val.rpe) : null;
    const result = calc1rm(weight, reps, rpe);
    if (!result) continue;
    if (!e1rmByGroup[group] || result.value > e1rmByGroup[group]) e1rmByGroup[group] = Math.round(result.value);
  }
  if (e1rmByGroup.squat || e1rmByGroup.bench || e1rmByGroup.deadlift) {
    const _ath = loadAthlete() || {};
    const tested = { squat: _ath.tested1rm_squat || 0, bench: _ath.tested1rm_bench || 0, deadlift: _ath.tested1rm_deadlift || 0 };
    h += `<div class="maxes-bar">`;
    for (const [gk, label] of [['squat','Squat'],['bench','Bench'],['deadlift','Dead']]) {
      const e = e1rmByGroup[gk];
      if (!e) continue;
      const t = tested[gk];
      const delta = t ? e - t : 0;
      const hasTested = t > 0;
      const badgeHtml = hasTested ? `<div class="max-delta-badge ${delta >= 0 ? 'up' : 'down'}">${delta >= 0 ? '+' : ''}${delta}</div>` : '';
      const drawerHtml = hasTested ? `<div class="max-tested-drawer"><hr class="max-tested-divider"><div class="max-tested-row"><div class="max-tested-val">${t}</div><div class="max-tested-delta ${delta >= 0 ? 'up' : 'down'}">${delta >= 0 ? '+' : ''}${delta}</div></div><div class="max-tested-label">Current 1RM</div></div>` : '';
      h += `<div class="max-item" onclick="toggleMaxCard(this)" style="cursor:pointer">${badgeHtml}<div class="max-lift">${label}</div><div class="max-weight">${e}</div><div class="max-label">Est. 1RM</div>${drawerHtml}</div>`;
    }
    h += `</div>`;
  }

  // ── DOTS / Wilks scores on metrics ──────────────────────────────────────
  const showScores = getShowScores();
  if (showScores) {
    const _ath2 = loadAthlete();
    const hasProfile = _ath2 && _ath2.gender && _ath2.bodyweight;
    if (!hasProfile) {
      h += `<div class="metrics-scores-section">
        <div class="metrics-scores-label">DOTS / Wilks</div>
        <div class="metrics-score-note">Add gender &amp; bodyweight in Settings to see scores</div>
      </div>`;
    } else {
      const scores = getScores();
      if (scores) {
        const missing = [
          scores.missing.squat    ? 'Squat'    : null,
          scores.missing.bench    ? 'Bench'    : null,
          scores.missing.deadlift ? 'Deadlift' : null,
        ].filter(Boolean);
        const missingNote = missing.length
          ? '<div class="metrics-score-note" style="font-style:italic">Est. from available lifts — missing: ' + missing.join(', ') + '</div>'
          : '';
        h += `<div class="metrics-scores-section">
          <div class="metrics-scores-label">DOTS / Wilks <span class="metrics-score-total">· ${scores.total} lb total</span></div>
          <div class="metrics-scores-row">
            <div class="metrics-score-pill"><div class="metrics-score-pill-label">DOTS</div><div class="metrics-score-pill-val">${scores.dots?.toFixed(1)||'—'} <span class="metrics-score-est">est</span></div><div class="metrics-score-pill-level">${dotsLevel(scores.dots)||''}</div></div>
            <div class="metrics-score-pill"><div class="metrics-score-pill-label">Wilks</div><div class="metrics-score-pill-val">${scores.wilks?.toFixed(1)||'—'} <span class="metrics-score-est">est</span></div><div class="metrics-score-pill-level">${dotsLevel(scores.wilks)||''}</div></div>
          </div>
          ${missingNote}
        </div>`;
      } else {
        h += `<div class="metrics-scores-section">
          <div class="metrics-scores-label">DOTS / Wilks</div>
          <div class="metrics-score-note">Log comp lifts to calculate scores</div>
        </div>`;
      }
    }
  }

  let hasAnyData=false;
  for(const [groupKey,group] of Object.entries(metrics)){
    const vars=Object.entries(group.variations).filter(([,pts])=>pts.length>0);
    if(vars.length===0) continue;
    hasAnyData=true;

    // Variation pill selector — default to first var, preserve selection across re-renders
    const activeVar = (state.metricsActiveVar[groupKey] && vars.find(([vn])=>vn===state.metricsActiveVar[groupKey]))
      ? state.metricsActiveVar[groupKey] : vars[0][0];
    state.metricsActiveVar[groupKey] = activeVar;
    const activePts = vars.find(([vn])=>vn===activeVar)?.[1] || [];

    // Best e1RM = best of selected variation only
    const best = activePts.length > 0 ? Math.max(...activePts.map(p=>p.e1rm)) : null;

    h+=`<div class="metrics-lift-group">`;
    // When only one variation, show specific exercise name; when multiple, show group label
    const displayTitle = vars.length === 1 ? vars[0][0] : group.label;
    h+=`<div class="metrics-lift-header">
      <div class="metrics-lift-title">${escH(displayTitle)}</div>
      <div style="text-align:right">
        <div class="metrics-best">${best?best+'lb':'-'}</div>
        <div class="metrics-best-label">Best Est. 1RM</div>
      </div>
    </div>`;

    if(vars.length > 1){
      h+=`<div class="var-pill-row">`;
      vars.forEach(([vname])=>{
        const isActive = vname === activeVar;
        h+=`<button class="var-pill${isActive?' active':''}" onclick="setMetricsVar('${esc(groupKey)}','${esc(vname)}')">${escH(vname)}</button>`;
      });
      h+=`</div>`;
    }

    h+=`<div class="chart-wrap"><canvas class="rm-chart" id="chart-${escH(groupKey)}" width="400" height="160"></canvas></div>`;

    h+=`<div class="rm-datapoints"><div class="var-section">`;
    activePts.forEach((pt,i)=>{
      const prev=activePts[i-1];
      const delta=prev?pt.e1rm-prev.e1rm:null;
      const deltaStr=delta!==null?`<span class="rm-delta ${delta>=0?'up':'down'}">${delta>=0?'+':''}${delta}lb</span>`:'';
      const methodBadge=pt.method==='rpe'
        ?`<span class="method-badge rpe-badge">RPE</span>`
        :`<span class="method-badge est-badge">EST</span>`;
      const sublabel=drill
        ?(()=>{
          const parts=[];
          if(pt.topWeight&&pt.topReps) parts.push(`${pt.topReps}×${pt.topWeight}lb`);
          if(pt.completedDate){
            const [y,m,d]=pt.completedDate.split('-');
            parts.push(`${m}/${d}`);
          }
          return parts.join(' · ');
        })()
        :(pt.bestWeek?`Best: ${pt.bestWeek}`:'');
      h+=`<div class="rm-row">
        <div style="display:flex;flex-direction:column;gap:1px">
          <div class="rm-session">${pt.session}</div>
          ${sublabel?`<div style="font-size:11px;color:var(--text-dim)">${sublabel}</div>`:''}
        </div>
        <div style="display:flex;align-items:center;gap:4px">${deltaStr}${methodBadge}<div class="rm-value">${pt.e1rm}lb</div></div>
      </div>`;
    });
    h+=`</div></div>`;
    h+=`</div>`;
  }

  if(!hasAnyData){
    h+=`<div class="no-data-msg">No performance data yet.<br><br>Log actual weights during your workouts and your estimated 1RMs will appear here.</div>`;
  }

  h+=`<button class="add-lift-btn" onclick="openAddLift()">+ Track Another Lift</button>`;
  h+=`</div>`;
  main.innerHTML=h;

  setTimeout(()=>{
    for(const [groupKey,group] of Object.entries(metrics)){
      const vars=Object.entries(group.variations).filter(([,pts])=>pts.length>0);
      if(vars.length===0) continue;
      const activeVar=state.metricsActiveVar[groupKey]||vars[0][0];
      const activePts=vars.find(([vn])=>vn===activeVar)?.[1]||[];
      drawSingleVarChart(`chart-${groupKey}`, activePts, drillBlockId!==null);
    }
  },0);
}

function toggleMaxCard(el) {
  const allCards = el.parentElement.querySelectorAll('.max-item');
  const wasExpanded = el.classList.contains('expanded');
  // Toggle all cards together
  allCards.forEach(c => { if (wasExpanded) c.classList.remove('expanded'); else c.classList.add('expanded'); });
}
function setMetricsDrill(val){ state.metricsDrillBlock=val; renderMetrics(); }
function setMetricsVar(groupKey, varName){ state.metricsActiveVar[groupKey]=varName; renderMetrics(); }

function drawSingleVarChart(canvasId, pts, drillMode){
  const canvas=document.getElementById(canvasId);
  if(!canvas) return;
  const ctx=canvas.getContext('2d');
  const W=canvas.offsetWidth||400;
  const H=160;
  canvas.width=W; canvas.height=H;

  if(!pts||pts.length===0){ ctx.clearRect(0,0,W,H); return; }

  const allVals=pts.map(p=>p.e1rm);
  const yMin=Math.min(...allVals)*0.96;
  const yMax=Math.max(...allVals)*1.04;
  const yRange=yMax-yMin||1;

  const pad={top:16,right:16,bottom:28,left:44};
  const chartW=W-pad.left-pad.right;
  const chartH=H-pad.top-pad.bottom;

  ctx.clearRect(0,0,W,H);

  // Grid lines + y labels
  ctx.save();
  ctx.globalAlpha = 0.6;
  ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--surface-5').trim()||'#1e1e1e'; ctx.lineWidth=1;
  [0,0.5,1].forEach(t=>{
    const y=pad.top+chartH*(1-t);
    ctx.beginPath(); ctx.moveTo(pad.left,y); ctx.lineTo(W-pad.right,y); ctx.stroke();
  });
  ctx.restore();
  ctx.fillStyle='#444'; ctx.font='10px Barlow,sans-serif'; ctx.textAlign='right';
  [0,0.5,1].forEach(t=>{
    const y=pad.top+chartH*(1-t);
    ctx.fillText(Math.round(yMin+yRange*t)+'lb',pad.left-4,y+3);
  });

  // X labels
  function shortLabel(s){ const m=s.match(/W(\d+)$/i); return m?`W${m[1]}`:s.replace(/cycle\s*/i,'C'); }
  const step=pts.length>6?Math.ceil(pts.length/4):1;
  ctx.fillStyle='#444'; ctx.font='9px Barlow,sans-serif'; ctx.textAlign='center';
  pts.forEach((pt,i)=>{
    if(i%step!==0&&i!==pts.length-1) return;
    const x=pts.length===1?pad.left+chartW/2:pad.left+(i/(pts.length-1))*chartW;
    ctx.fillText(shortLabel(pt.session),x,H-6);
  });

  const coords=pts.map((pt,i)=>({
    x:pts.length===1?pad.left+chartW/2:pad.left+(i/(pts.length-1))*chartW,
    y:pad.top+chartH*(1-(pt.e1rm-yMin)/yRange),
    pt
  }));

  const col='#C9A84C';

  if(coords.length===1){
    ctx.fillStyle=col; ctx.beginPath(); ctx.arc(coords[0].x,coords[0].y,5,0,Math.PI*2); ctx.fill();
  } else {
    // Subtle fill under line
    ctx.save();
    ctx.beginPath();
    coords.forEach((c,i)=>i===0?ctx.moveTo(c.x,c.y):ctx.lineTo(c.x,c.y));
    ctx.lineTo(coords[coords.length-1].x, pad.top+chartH);
    ctx.lineTo(coords[0].x, pad.top+chartH);
    ctx.closePath();
    const grad=ctx.createLinearGradient(0,pad.top,0,pad.top+chartH);
    grad.addColorStop(0,'rgba(201,168,76,0.18)');
    grad.addColorStop(1,'rgba(201,168,76,0)');
    ctx.fillStyle=grad;
    ctx.fill();
    ctx.restore();

    // Line
    ctx.strokeStyle=col; ctx.lineWidth=2; ctx.lineJoin='round'; ctx.setLineDash([]);
    ctx.beginPath();
    coords.forEach((c,i)=>i===0?ctx.moveTo(c.x,c.y):ctx.lineTo(c.x,c.y));
    ctx.stroke();

    // Dots
    coords.forEach(c=>{
      ctx.fillStyle=col; ctx.beginPath(); ctx.arc(c.x,c.y,4,0,Math.PI*2); ctx.fill();
      ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--bg').trim()||'#0a0a0a'; ctx.beginPath(); ctx.arc(c.x,c.y,2,0,Math.PI*2); ctx.fill();
    });
  }
}


// ── ADD CUSTOM LIFT ───────────────────────────────────────────────────────────
let selectedGroup='squat';
let selectedUntrackedName=null;

function getUntrackedProgramLifts(){
  if(!state.activeBlock) return [];
  const seen=new Set();
  const result=[];
  for(const week of state.activeBlock.weeks){
    for(const day of week.days){
      for(const ex of day.exercises){
        const n=ex.name.trim();
        const nl=n.toLowerCase();
        if(seen.has(nl)) continue;
        seen.add(nl);
        if(isTracked(n)) continue;
        // skip bodyweight/cardio — no meaningful weight data
        const mode=getExerciseInputMode(n,'');
        if(mode==='bw'||mode==='cardio') continue;
        const group=classifyLift(n)||'other';
        result.push({name:n,group});
      }
    }
  }
  return result;
}

function renderUntrackedList(){
  const items=getUntrackedProgramLifts();
  const wrap=document.getElementById('untracked-list-wrap');
  if(!wrap) return;
  if(!items.length){
    wrap.innerHTML=`<div class="untracked-empty">All exercises in your program are already tracked.</div>`;
    return;
  }
  wrap.innerHTML=`<div class="untracked-list">${items.map(it=>`
    <div class="untracked-item${selectedUntrackedName===it.name?' selected':''}" onclick="selectUntrackedItem('${esc(it.name)}','${it.group}')">
      <span class="untracked-item-name">${it.name}</span>
      <span class="untracked-item-group">${it.group}</span>
    </div>`).join('')}</div>`;
}

function selectUntrackedItem(name, group){
  selectedUntrackedName=name;
  document.getElementById('add-lift-name').value='';
  setSelectedGroup(group);
  renderUntrackedList();
  document.getElementById('add-lift-confirm-btn').disabled=false;
}

function onAddLiftInput(val){
  if(val.trim()){
    selectedUntrackedName=null;
    renderUntrackedList();
    document.getElementById('add-lift-confirm-btn').disabled=false;
  } else {
    document.getElementById('add-lift-confirm-btn').disabled=!selectedUntrackedName;
  }
}

function openAddLift(){
  selectedUntrackedName=null;
  document.getElementById('add-lift-modal').style.display='flex';
  document.getElementById('add-lift-name').value='';
  document.getElementById('add-lift-confirm-btn').disabled=true;
  setSelectedGroup('squat');
  renderUntrackedList();
}
function closeAddLift(){ document.getElementById('add-lift-modal').style.display='none'; }

function setSelectedGroup(group){
  selectedGroup=group;
  document.querySelectorAll('.group-pill').forEach(p=>{
    p.classList.toggle('active', p.dataset.group===group);
  });
}
function selectGroup(el){ setSelectedGroup(el.dataset.group); }

function confirmAddLift(){
  const manualName=document.getElementById('add-lift-name').value.trim();
  const name=manualName||selectedUntrackedName;
  if(!name) return;
  if(!state.customLifts.find(c=>c.name.toLowerCase()===name.toLowerCase()))
    state.customLifts.push({name,group:selectedGroup});
  // also mark as tracked
  state.trackedLifts[name.toLowerCase()]=true;
  saveCustomLifts();
  saveTrackedLifts();
  closeAddLift();
  renderMetrics();
}


// ── PARSERS ──────────────────────────────────────────────────────────────────
// EXERCISE_DICT, spellcheck, DAYS, detectFormat, parseA/B/C/D, parseWorkbook,
// deduplicateExerciseNames → all moved to parsers.js


function mergeBlocks(incoming){
  deduplicateExerciseNames(incoming);
  // Safety: ensure every block has an id
  for(const b of incoming){
    if(!b.id) b.id = (b.name||'block').replace(/[^a-zA-Z0-9]/g,'_').substring(0,40) + '_' + Date.now();
  }
  const existing=state.blocks;
  for(const inc of incoming){
    const idx=existing.findIndex(b=>b.id===inc.id);
    if(idx!==-1){ existing[idx]=inc; } // replace structure, logs survive (keyed separately)
    else { existing.push(inc); }
  }
  state.blocks=existing;
  state.activeBlock=incoming[incoming.length-1]||state.activeBlock;
}

// ── TRACKING VALUE CLASSIFIER ─────────────────────────────────────────────────
// Classifies a raw tracking column value into a structured result.
// Returns: { type, weight, rpe, slashWeights, lifterNote }
// Types: 'done' | 'done_note' | 'weight_rpe' | 'weight_only' | 'slash_weights' | 'note_only' | 'set_rep_summary' | null
function classifyTracking(raw){
  if(raw===null||raw===undefined) return null;
  const s=String(raw).trim();
  if(!s) return null;
  const sl=s.toLowerCase();

  // Skip header rows
  if(sl.includes('tracking')||sl.includes('record weight')) return null;

  // Reject prescription-like strings — these are program data, not logged weights.
  // Patterns: "3x5(315)", "W2: 3x5", "4x8 @ 7", "3x5(L)", "2-3 sets"
  // This prevents misread when tracking column offset is wrong and lands on a prescription cell.
  if(/^\d+x\d+\s*[\(@(]/i.test(s)) return null;   // "3x5(315)", "4x8 @ 7"
  if(/^W\d+:/i.test(s)) return null;               // "W2: 3x5"
  if(/^\d+-\d+\s*(sets|x)/i.test(s)) return null;  // "2-3 sets", "3-4x8"

  // Pure done markers: x, X, done, complete, ✓, ✔, checkmark variants
  if(/^[xX✓✔️☑✅]$/.test(s)||/^(done|complete|completed|yes)$/i.test(s)){
    return{type:'done',weight:null,rpe:null,slashWeights:null,lifterNote:null};
  }

  // "x easy", "x + note text" — done with a trailing note
  if(/^[xX✓✔️]\s+\S/i.test(s)){
    const noteText=s.replace(/^[xX✓✔️]\s*/,'').trim();
    return{type:'done_note',weight:null,rpe:null,slashWeights:null,lifterNote:noteText||null};
  }

  // "weight @ RPE" — with or without spaces around @: "235 @ 7", "171@6", "315@4"
  const atRpeMatch=s.match(/^(\d+\.?\d*)\s*@\s*(\d+\.?\d*)$/);
  if(atRpeMatch){
    return{type:'weight_rpe',weight:parseFloat(atRpeMatch[1]),rpe:parseFloat(atRpeMatch[2]),slashWeights:null,lifterNote:null};
  }

  // Pure number (cell stored as number or clean string like "295" or "22.5")
  if(/^\d+\.?\d*$/.test(s)){
    return{type:'weight_only',weight:parseFloat(s),rpe:null,slashWeights:null,lifterNote:null};
  }

  // Slash-separated weights: "140/180/210", "25/50/75x2", "90/120/140/160"
  // Must be all digits, slashes, dots, and optional trailing "x2" multiplier
  if(/^[\d./]+(\s*x\d+)?$/.test(s)&&s.includes('/')){
    const parts=s.split('/').map(p=>p.trim());
    const weights=[];
    for(const p of parts){
      // Handle "75x2" — last segment with multiplier
      const mx=p.match(/^(\d+\.?\d*)\s*x(\d+)$/i);
      if(mx){
        const w=parseFloat(mx[1]); const times=parseInt(mx[2]);
        for(let i=0;i<times;i++) weights.push(w);
      } else {
        const n=parseFloat(p);
        if(!isNaN(n)) weights.push(n);
      }
    }
    if(weights.length>0) return{type:'slash_weights',weight:null,rpe:null,slashWeights:weights,lifterNote:null};
  }

  // "NxN" set/rep summary like "2x10", "2x45" — open-rep or bodyweight tracking
  if(/^\d+x\d+$/i.test(s)){
    return{type:'set_rep_summary',weight:null,rpe:null,slashWeights:null,lifterNote:s};
  }

  // Weight with unit or note: "20lbs", "130 heavy", "4x12 20lbs", "Last set @8"
  // Try to extract a leading or embedded number as weight
  const weightNoteMatch=s.match(/^(\d+\.?\d*)\s*(lbs?|kg)?(.*)$/i);
  if(weightNoteMatch){
    const w=parseFloat(weightNoteMatch[1]);
    const rest=(weightNoteMatch[3]||'').trim();
    if(!isNaN(w)){
      return{type:'weight_only',weight:w,rpe:null,slashWeights:null,lifterNote:rest||null};
    }
  }

  // "Last set @8" style — RPE noted without explicit weight
  const rpeOnlyMatch=s.match(/(?:last\s+set\s*)?@\s*(\d+\.?\d*)/i);
  if(rpeOnlyMatch){
    return{type:'done_note',weight:null,rpe:parseFloat(rpeOnlyMatch[1]),slashWeights:null,lifterNote:s};
  }

  // Pure text note — mark done, store as lifter note
  return{type:'note_only',weight:null,rpe:null,slashWeights:null,lifterNote:s};
}

// ── COUNT SETS IN PRESCRIPTION ────────────────────────────────────────────────
// Returns the expected number of sets for an exercise prescription, used
// to distribute slash-weights or spread a single weight across all sets.
function countPrescrSets(pres){
  if(!pres) return 1;
  const s=parseSets(pres);
  if(s.length>0) return s.length;
  const wu=parseWarmupSets(pres);
  if(wu.length>0) return wu.length;
  const simple=parseSimple(pres);
  if(simple) return simple.sets;
  const range=parseRangeSet(pres);
  if(range) return range.sets;
  return 1;
}

// ── POPULATE LOGS FROM SHEET ──────────────────────────────────────────────────
// Main function: reads trackingRaw from parsed block structure and writes
// to state.logs. Never overwrites existing user-entered log keys.
// options.onlyWeekLabels: array of week labels to restrict to (e.g. ['W3','W4'])
// options.blockId: restrict to one block id
function populateLogsFromSheet(blocks, options={}){
  let populated=0;
  const {onlyWeekLabels=null}=options;

  for(const block of blocks){
    if(options.blockId&&block.id!==options.blockId) continue;

    if(block.format==='A'){
      for(const week of block.weeks){
        if(onlyWeekLabels&&!onlyWeekLabels.includes(week.label)) continue;
        for(const day of week.days){
          for(const ex of day.exercises){
            const key=lk(block.id,week.label,day.name,ex.name);
            // Never overwrite existing user data
            if(state.logs[key]?.done) continue;

            const cls=classifyTracking(ex.trackingRaw);
            if(!cls) continue;
            if(cls.type==='note_only'&&!cls.lifterNote) continue;

            // Determine if bodyweight exercise — don't store weights for these
            const isBW=getExerciseInputMode(ex.name,ex.prescription)==='bw'||
                        getExerciseInputMode(ex.name,ex.prescription)==='bw-timed';

            const setCount=countPrescrSets(ex.prescription);
            const exEntry={done:true};
            if(cls.lifterNote) exEntry.lifterNote=cls.lifterNote;

            if(!isBW){
              if(cls.type==='weight_rpe'||cls.type==='weight_only'){
                exEntry.actual=String(cls.weight);
                if(cls.rpe) exEntry.rpe=String(cls.rpe);
              }
            }

            state.logs[key]=exEntry;

            // Write individual set entries
            if(cls.type==='slash_weights'&&cls.slashWeights){
              for(let si=0;si<setCount;si++){
                const sk=key+`||s${si}`;
                if(state.logs[sk]) continue; // never overwrite
                const w=cls.slashWeights[si]??cls.slashWeights[cls.slashWeights.length-1];
                const setEntry={done:true};
                if(!isBW) setEntry.actual=String(w);
                state.logs[sk]=setEntry;
              }
            } else {
              for(let si=0;si<setCount;si++){
                const sk=key+`||s${si}`;
                if(state.logs[sk]) continue;
                const setEntry={done:true};
                if(!isBW&&(cls.type==='weight_rpe'||cls.type==='weight_only')){
                  setEntry.actual=String(cls.weight);
                  if(cls.rpe) setEntry.rpe=String(cls.rpe);
                }
                state.logs[sk]=setEntry;
              }
            }
            populated++;
          }
        }
      }
      // Second pass A: infer static exercise completion from week-keyed siblings (Format A specific)
      inferStaticCompletions(block, onlyWeekLabels);
      // Second pass B: for any day that had at least one logged exercise,
      // mark remaining unlogged exercises as inferredComplete
      // (coaches often skip accessory/cardio tracking even when the workout happened)
      for(const week of block.weeks){
        if(onlyWeekLabels&&!onlyWeekLabels.includes(week.label)) continue;
        for(const day of week.days){
          const hasAnyLogged=day.exercises.some(ex=>{
            const key=lk(block.id,week.label,day.name,ex.name);
            return state.logs[key]?.done&&!state.logs[key]?.inferredComplete;
          });
          if(!hasAnyLogged) continue;
          for(const ex of day.exercises){
            const key=lk(block.id,week.label,day.name,ex.name);
            if(state.logs[key]?.done) continue;
            const setCount=countPrescrSets(ex.prescription);
            state.logs[key]={done:true,inferredComplete:true};
            for(let si=0;si<setCount;si++){
              if(!state.logs[key+`||s${si}`])
                state.logs[key+`||s${si}`]={done:true,inferredComplete:true};
            }
          }
          // Set __complete__ flag for days with real logged data — shows green card, no Finish Workout
          const forceKey=lk(block.id,week.label,day.name,'__complete__');
          if(!state.logs[forceKey]) state.logs[forceKey]={done:true,importedComplete:true};
        }
      }

    } else if(block.format==='B'){
      for(const week of block.weeks){
        if(onlyWeekLabels&&!onlyWeekLabels.includes(week.label)) continue;
        for(const day of week.days){
          for(const ex of day.exercises){
            // Only populate if there is actual logged weight/completion data
            // Lifter notes alone (e.g. equipment notes like "Cage 24/17") do NOT mark an exercise done
            if(!ex.loggedWeight) {
              // Still store lifter note on an existing log entry if one exists
              if(ex.lifterNote){
                const key=lk(block.id,week.label,day.name,ex.name);
                if(state.logs[key]&&!state.logs[key].lifterNote){
                  state.logs[key].lifterNote=ex.lifterNote;
                }
              }
              continue;
            }
            const key=lk(block.id,week.label,day.name,ex.name);
            if(state.logs[key]?.done) continue;

            const cls=classifyTracking(ex.loggedWeight);
            const isBW=getExerciseInputMode(ex.name,ex.prescription)==='bw'||
                        getExerciseInputMode(ex.name,ex.prescription)==='bw-timed';
            const setCount=countPrescrSets(ex.prescription);

            const exEntry={done:true};
            // Format B has dedicated lifterNote column — always capture it
            if(ex.lifterNote) exEntry.lifterNote=ex.lifterNote;

            if(cls&&!isBW){
              if(cls.type==='weight_rpe'||cls.type==='weight_only'){
                exEntry.actual=String(cls.weight);
                if(cls.rpe) exEntry.rpe=String(cls.rpe);
              }
              if(cls.lifterNote&&!exEntry.lifterNote) exEntry.lifterNote=cls.lifterNote;
            }

            state.logs[key]=exEntry;

            if(cls&&cls.type==='slash_weights'&&cls.slashWeights){
              for(let si=0;si<setCount;si++){
                const sk=key+`||s${si}`;
                if(state.logs[sk]) continue;
                const w=cls.slashWeights[si]??cls.slashWeights[cls.slashWeights.length-1];
                const setEntry={done:true};
                if(!isBW) setEntry.actual=String(w);
                state.logs[sk]=setEntry;
              }
            } else {
              for(let si=0;si<setCount;si++){
                const sk=key+`||s${si}`;
                if(state.logs[sk]) continue;
                const setEntry={done:true};
                if(cls&&!isBW&&(cls.type==='weight_rpe'||cls.type==='weight_only')){
                  setEntry.actual=String(cls.weight);
                  if(cls.rpe) setEntry.rpe=String(cls.rpe);
                }
                state.logs[sk]=setEntry;
              }
            }
            populated++;
          }
        }
        // Second pass: if any exercise in a day has logged data (day was "live"),
        // mark all remaining unlogged exercises as inferredComplete.
        // This handles coaches who don't track every accessory (side plank, cardio, etc.)
        for(const day of week.days){
          // Count how many exercises in this day have actual logged weight data
          const hasAnyLogged=day.exercises.some(ex=>!!ex.loggedWeight);
          if(!hasAnyLogged) continue; // fresh/future day — don't touch
          for(const ex of day.exercises){
            const key=lk(block.id,week.label,day.name,ex.name);
            if(state.logs[key]?.done) continue; // already handled
            const setCount=countPrescrSets(ex.prescription);
            state.logs[key]={done:true,inferredComplete:true};
            for(let si=0;si<setCount;si++){
              if(!state.logs[key+`||s${si}`])
                state.logs[key+`||s${si}`]={done:true,inferredComplete:true};
            }
          }
          // Set __complete__ flag for days with real logged data — shows green card, no Finish Workout
          const forceKey=lk(block.id,week.label,day.name,'__complete__');
          if(!state.logs[forceKey]) state.logs[forceKey]={done:true,importedComplete:true};
        }
      }
    }
  }

  if(populated>0) saveLogs();
  return populated;
}

// ── INFER STATIC EXERCISE COMPLETIONS ────────────────────────────────────────
// If all week-keyed exercises in a day are logged for week W, mark any
// static-prescription exercises in that same day as done (no weight).
function inferStaticCompletions(block, onlyWeekLabels=null){
  for(const week of block.weeks){
    if(onlyWeekLabels&&!onlyWeekLabels.includes(week.label)) continue;
    for(const day of week.days){
      // Separate exercises into week-keyed and static
      const weekKeyed=day.exercises.filter(ex=>!ex.isStaticPrescription);
      const statics=day.exercises.filter(ex=>ex.isStaticPrescription);
      if(statics.length===0) continue; // nothing to infer

      // Count how many week-keyed exercises have logs for this week
      const keyedDoneCount=weekKeyed.filter(ex=>{
        const key=lk(block.id,week.label,day.name,ex.name);
        return !!state.logs[key]?.done;
      }).length;

      // Only infer if ALL week-keyed exercises in the day are complete
      if(weekKeyed.length>0&&keyedDoneCount===weekKeyed.length){
        for(const ex of statics){
          const key=lk(block.id,week.label,day.name,ex.name);
          if(state.logs[key]?.done) continue; // already logged
          // Mark done with no weight — inferred completion
          const setCount=countPrescrSets(ex.prescription);
          state.logs[key]={done:true,inferredComplete:true};
          for(let si=0;si<setCount;si++){
            const sk=key+`||s${si}`;
            if(!state.logs[sk]) state.logs[sk]={done:true,inferredComplete:true};
          }
        }
      }
    }
  }
}

// parseSets, parseSimple, parseRangeSet, parseBarePres, parseWarmupSets → parsers.js


// ── HOME SCREEN ───────────────────────────────────────────────────────────────

// ── Storage keys ─────────────────────────────────────────────────────────────
const SCHEDULE_KEY         = 'liftlog_schedule';       // { blockId: [dow0, dow1, ...] } ordered array matching training day order
const ATHLETE_KEY          = 'liftlog_athlete';         // { gender, age, bodyweight, bwUnit }
const APP_SETTINGS_KEY     = 'liftlog_app_settings';   // { showScores: bool }
const ONBOARDED_KEY        = 'liftlog_onboarded';      // '1' after onboarding complete

function loadAppSettings()  { try { return JSON.parse(localStorage.getItem(APP_SETTINGS_KEY)||'{}'); } catch { return {}; } }
function saveAppSettings(s) { try { localStorage.setItem(APP_SETTINGS_KEY, JSON.stringify(s)); } catch(e) { console.error(e); showSaveError(); } }
function getShowScores()    { const s = loadAppSettings(); return s.showScores    !== false; } // default ON

function toggleAthleteProfileForm() {
  const form = document.getElementById('athlete-profile-form');
  const arrow = document.getElementById('athlete-profile-arrow');
  const isOpen = form.classList.contains('open');
  if (!isOpen) {
    // Populate with current values
    const a = loadAthlete() || {};
    document.getElementById('ap-name').value = a.name || '';
    document.getElementById('ap-bw').value = a.bodyweight || '';
    const unit = a.bwUnit || 'lbs';
    document.getElementById('ap-unit').textContent = unit;
    document.getElementById('ap-unit').classList.toggle('active', true);
    document.getElementById('ap-male').classList.toggle('active', a.gender === 'male');
    document.getElementById('ap-female').classList.toggle('active', a.gender === 'female');
    document.getElementById('ap-max-s').value = a.tested1rm_squat || '';
    document.getElementById('ap-max-b').value = a.tested1rm_bench || '';
    document.getElementById('ap-max-d').value = a.tested1rm_deadlift || '';
    form.classList.add('open');
    arrow.style.transform = 'rotate(90deg)';
  } else {
    form.classList.remove('open');
    arrow.style.transform = '';
  }
}
function setApGender(g) {
  document.getElementById('ap-male').classList.toggle('active', g === 'male');
  document.getElementById('ap-female').classList.toggle('active', g === 'female');
  document.getElementById('ap-male').dataset.val = g === 'male' ? 'male' : '';
  document.getElementById('ap-female').dataset.val = g === 'female' ? 'female' : '';
}
function toggleApUnit() {
  const btn = document.getElementById('ap-unit');
  const isLbs = btn.textContent === 'lbs';
  btn.textContent = isLbs ? 'kg' : 'lbs';
}
function saveAthleteProfile() {
  const name = document.getElementById('ap-name').value.trim();
  const bw = parseFloat(document.getElementById('ap-bw').value);
  const unit = document.getElementById('ap-unit').textContent;
  const gender = document.getElementById('ap-male').classList.contains('active') ? 'male'
               : document.getElementById('ap-female').classList.contains('active') ? 'female'
               : null;
  const existing = loadAthlete() || {};
  const maxS = parseInt(document.getElementById('ap-max-s')?.value) || 0;
  const maxB = parseInt(document.getElementById('ap-max-b')?.value) || 0;
  const maxD = parseInt(document.getElementById('ap-max-d')?.value) || 0;
  const updated = {
    ...existing,
    ...(name && { name }),
    ...(gender && { gender }),
    ...(!isNaN(bw) && bw > 0 && { bodyweight: bw, bwUnit: unit }),
    tested1rm_squat: maxS || existing.tested1rm_squat || 0,
    tested1rm_bench: maxB || existing.tested1rm_bench || 0,
    tested1rm_deadlift: maxD || existing.tested1rm_deadlift || 0
  };
  saveAthlete(updated);
  // Close form
  document.getElementById('athlete-profile-form').classList.remove('open');
  document.getElementById('athlete-profile-arrow').style.transform = '';
  // Re-render home if on home screen
  if (state.screen === 'home') render();
}
function toggleScoresSetting() {
  const s = loadAppSettings();
  s.showScores = !getShowScores();
  saveAppSettings(s);
  const t = document.getElementById('scores-toggle');
  if (t) t.classList.toggle('on', s.showScores);
  if (state.screen === 'metrics') renderMetrics();
}


function resetOnboarding() {
  localStorage.removeItem(ONBOARDED_KEY);
  saveAthlete(null);
  closeSettings();
  location.reload();
}

// ── Persistence helpers ───────────────────────────────────────────────────────

function loadSchedule()  { try { return JSON.parse(localStorage.getItem(SCHEDULE_KEY)||'{}'); } catch { return {}; } }
function saveSchedule(d) { try { localStorage.setItem(SCHEDULE_KEY, JSON.stringify(d)); } catch(e) { console.error(e); showSaveError(); } }


// Athlete profile
function loadAthlete()  { try { return JSON.parse(localStorage.getItem(ATHLETE_KEY)||'null'); } catch { return null; } }
function saveAthlete(d) { try { localStorage.setItem(ATHLETE_KEY, JSON.stringify(d)); } catch(e) { console.error(e); showSaveError(); } }



// ── Schedule editor (from This Week card) ─────────────────────────────────────
// Simple: shows 7 day slots, N of them are active (training days).
// ── Next workout info ─────────────────────────────────────────────────────────
function getNextWorkoutInfo() {
  const block = state.activeBlock;
  if (!block) return null;
  const nw = findNextWorkout(block);
  const week = block.weeks[nw.weekIdx];
  const day = week?.days[nw.dayIdx];
  if (!day) return null;
  const allDone = isDayComplete(block, week, day);
  const metaParts = [];
  if (block.weeks.length > 1) metaParts.push(`W${nw.weekIdx + 1}`);
  if (block.name) metaParts.push(displayBlockName(block.name));
  return { day, week, weekIdx: nw.weekIdx, dayIdx: nw.dayIdx, allDone, meta: metaParts.join(' · ') };
}

function displayBlockName(name) {
  if (!name) return '';
  // Strip trailing timestamp suffix (e.g. "_1772319728896")
  let clean = name.replace(/_\d{10,}$/, '');
  // Clean up underscores from filename-based names
  clean = clean.replace(/_/g, ' ').trim();
  // Truncate to 24 chars
  if (clean.length > 24) clean = clean.slice(0, 22) + '…';
  return clean;
}

// ── e1RM peaks ────────────────────────────────────────────────────────────────
// ── DOTS & Wilks score calculations ──────────────────────────────────────────
// All inputs in kg, total in kg, returns numeric score
function calcDOTS(bwKg, totalKg, gender) {
  if (!bwKg || !totalKg || bwKg <= 0 || totalKg <= 0) return null;
  const m = gender === 'female'
    ? { a:-57.96288,    b:13.6175032,   c:-0.1126655495, d:0.0005158568,  e:-0.0000010706 }
    : { a:-307.75076,   b:24.0900756,   c:-0.1918759221, d:0.0007391293,  e:-0.0000010930 };
  const x = bwKg;
  const coeff = 500 / (m.a + m.b*x + m.c*x*x + m.d*x*x*x + m.e*x*x*x*x);
  return Math.round(coeff * totalKg * 100) / 100;
}

function calcWilks(bwKg, totalKg, gender) {
  if (!bwKg || !totalKg || bwKg <= 0 || totalKg <= 0) return null;
  // Wilks formula — coefficients from Wilks 1998
  const m = gender === 'female'
    ? { a:594.31747775582, b:-27.23842536447, c:0.82112226871, d:-0.00930733913, e:0.00004731582, f:-0.00000009054 }
    : { a:-216.0475144,    b:16.2606339,      c:-0.002388645,  d:-0.00113732,    e:7.01863e-06,   f:-1.291e-08 };
  const x = bwKg;
  const poly = m.a + m.b*x + m.c*x*x + m.d*x*x*x + m.e*x*x*x*x + m.f*x*x*x*x*x;
  return Math.round((500 / poly) * totalKg * 100) / 100;
}

function getScores() {
  const athlete = loadAthlete();
  if (!athlete || !athlete.bodyweight || !athlete.gender) return null;

  // Convert BW to kg
  const bwKg = athlete.bwUnit === 'kg'
    ? athlete.bodyweight
    : athlete.bodyweight / 2.20462;

  // Use e1RM peaks for squat/bench/deadlift, convert lbs→kg
  const prs = getHomePRs();
  const squat    = prs.find(p => p.lift === 'Squat')?.val    || 0;
  const bench    = prs.find(p => p.lift === 'Bench')?.val    || 0;
  const deadlift = prs.find(p => p.lift === 'Deadlift')?.val || 0;

  if (squat + bench + deadlift === 0) return null;

  // Total in kg (logged weights are in lbs)
  const totalKg = (squat + bench + deadlift) / 2.20462;

  const gender = athlete.gender; // 'male' | 'female'
  return {
    dots:  calcDOTS(bwKg, totalKg, gender),
    wilks: calcWilks(bwKg, totalKg, gender),
    total: Math.round(squat + bench + deadlift),
    squat, bench, deadlift,
    missing: { squat: !squat, bench: !bench, deadlift: !deadlift }
  };
}

function dotsLevel(score) {
  if (!score) return null;
  if (score >= 550) return 'Elite';
  if (score >= 500) return 'Advanced';
  if (score >= 400) return 'Intermediate';
  if (score >= 300) return 'Novice';
  return 'Beginner';
}

function getHomePRs() {
  const block = state.activeBlock;
  if (!block) return [];
  const peaks = { squat: null, bench: null, deadlift: null };
  for (const [key, val] of Object.entries(state.logs)) {
    const parts = key.split('||');
    if (parts.length < 5 || parts[0] !== block.id) continue;
    if (!parts[4].startsWith('s')) continue;
    if (!isCompLift(parts[3])) continue;
    const group = classifyLift(parts[3]);
    if (!group || group === 'other') continue;
    const weight = val.actual ? parseFloat(val.actual) : null;
    if (!weight || isNaN(weight) || weight <= 0) continue;
    const si = parseInt(parts[4].slice(1));
    const reps = getSetReps(parts[0], parts[1], parts[2], parts[3], si);
    if (!reps) continue;
    const rpe = val.rpe ? parseFloat(val.rpe) : null;
    const result = calc1rm(weight, reps, rpe);
    if (!result) continue;
    if (!peaks[group] || result.value > peaks[group]) peaks[group] = Math.round(result.value);
  }
  const out = [];
  if (peaks.squat)    out.push({ lift:'Squat',    val:peaks.squat,    unit:'lbs' });
  if (peaks.bench)    out.push({ lift:'Bench',     val:peaks.bench,    unit:'lbs' });
  if (peaks.deadlift) out.push({ lift:'Deadlift',  val:peaks.deadlift, unit:'lbs' });
  return out;
}

// ── Weekly Summary (for home screen) ──────────────────────────────────────────
function _computeWeekSummary(block, week) {
  if (!week) return null;
  const wl = week.label;
  const bid = block.id;

  let totalVolume = 0, totalSets = 0, totalRpe = 0, rpeCount = 0;
  const bestByFamily = { squat: null, bench: null, deadlift: null };

  for (const day of (week.days || [])) {
    const dn = day.name;
    for (const ex of (day.exercises || [])) {
      const group = classifyLift(ex.name);
      const isComp = isCompLift(ex.name);
      const pres = ex.prescription || '';
      const parsed = parseSimple(pres) || parseRangeSet(pres) || parseBarePres(pres);
      const numSets = parsed ? (parsed.sets || 1) : 4;
      const extraCount = state.extraSets?.[lk(bid, wl, dn, ex.name)] || 0;
      const maxSets = numSets + extraCount + 5;

      for (let si = 0; si < maxSets; si++) {
        const setKey = lk(bid, wl, dn, ex.name) + '||s' + si;
        const val = state.logs[setKey];
        if (!val || !val.done) continue;

        const weight = val.actual ? parseFloat(val.actual) : getPrescribedWeight(bid, wl, dn, ex.name, si);
        const reps = val.actualReps ? parseInt(val.actualReps) : getSetReps(bid, wl, dn, ex.name, si);
        if (!weight || isNaN(weight) || weight <= 0 || !reps) continue;

        totalSets++;
        totalVolume += weight * reps;

        if (val.rpe) {
          const r = parseFloat(val.rpe);
          if (!isNaN(r)) { totalRpe += r; rpeCount++; }
        }

        if (group && group !== 'other') {
          const result = calc1rm(weight, reps, val.rpe ? parseFloat(val.rpe) : null);
          if (result) {
            const cur = bestByFamily[group];
            const isUpgrade = !cur
              || (isComp && cur.isVariation)
              || (isComp === !cur.isVariation && result.value > cur.e1rm);
            if (isUpgrade) {
              bestByFamily[group] = {
                name: ex.name,
                weight, reps,
                rpe: val.rpe ? parseFloat(val.rpe) : null,
                e1rm: result.value,
                isVariation: !isComp,
                isComp
              };
            }
          }
        }
      }
    }
  }

  if (totalSets === 0) return null;

  return {
    weekLabel: wl,
    totalVolume,
    totalSets,
    avgRpe: rpeCount > 0 ? (totalRpe / rpeCount).toFixed(1) : null,
    bestLifts: bestByFamily
  };
}

function getWeeklySummary() {
  const block = state.activeBlock;
  if (!block || !block.weeks) return null;

  const weekIdx = block._currentWeekIdx || 0;

  // Try current week first
  const current = _computeWeekSummary(block, block.weeks[weekIdx]);
  if (current) { current.weekIdx = weekIdx; return current; }

  // Current week has no logged data — fall back to last completed week
  for (let i = weekIdx - 1; i >= 0; i--) {
    const prev = _computeWeekSummary(block, block.weeks[i]);
    if (prev) { prev.weekIdx = i; return prev; }
  }

  return null;
}

// ── Session Summary (for completed-today hero card) ───────────────────────────
function getSessionSummary(block, week, day) {
  if (!block || !week || !day) return null;
  const bid = block.id;
  const wl  = week.label;
  const dn  = day.name;

  let totalVolume = 0;
  let totalSets   = 0;
  let totalRpe    = 0;
  let rpeCount    = 0;
  let maxRpe      = 0;

  // Comp lift best sets: { squat, bench, deadlift } → { weight, reps, rpe, e1rm, isPR }
  const compBest = { squat: null, bench: null, deadlift: null };
  // All-time peaks for PR comparison
  const allTimePeaks = { squat: null, bench: null, deadlift: null };
  for (const [key, val] of Object.entries(state.logs)) {
    const parts = key.split('||');
    if (parts.length < 5 || parts[0] !== bid) continue;
    if (!parts[4].startsWith('s')) continue;
    const exName = parts[3];
    const group  = classifyLift(exName);
    if (!group || group === 'other') continue;
    if (!isCompLift(exName)) continue;
    const weight = val.actual ? parseFloat(val.actual) : null;
    if (!weight || isNaN(weight) || weight <= 0) continue;
    const si   = parseInt(parts[4].slice(1));
    const reps = getSetReps(parts[0], parts[1], parts[2], exName, si);
    if (!reps) continue;
    const rpe    = val.rpe ? parseFloat(val.rpe) : null;
    const result = calc1rm(weight, reps, rpe);
    if (!result) continue;
    // Track all-time peaks
    if (!allTimePeaks[group] || result.value > allTimePeaks[group].e1rm) {
      allTimePeaks[group] = { e1rm: result.value };
    }
  }

  // Now scan only today's session
  for (const ex of (day.exercises || [])) {
    const exKey = lk(bid, wl, dn, ex.name);
    const exLog = state.logs[exKey];
    if (!exLog) continue;
    const group = classifyLift(ex.name);
    const isComp = isCompLift(ex.name);

    // Determine how many sets are prescribed so we don't scan indefinitely
    const pres = ex.prescription || '';
    const parsedSets = parseSets(pres);
    if(!parsedSets.length) { const wu=parseWarmupSets(pres); if(wu.length) parsedSets.push(...wu); }
    const simpleP = parseSimple(pres);
    const rangedP = (!parsedSets.length && !simpleP) ? parseRangeSet(pres) : null;
    const prescribedCount = parsedSets.length || simpleP?.sets || rangedP?.sets || 1;
    // Also account for extra sets added this session
    const extraCount = (state.extraSets && state.extraSets[exKey]) ? state.extraSets[exKey] : 0;
    const maxSi = prescribedCount + extraCount;

    for (let si = 0; si < maxSi; si++) {
      const sk  = exKey + '||s' + si;
      const sv  = state.logs[sk];
      if (!sv) continue;
      if (sv.inferredComplete) continue;
      if (!sv.done) continue; // only count completed sets

      const weight = sv.actual ? parseFloat(sv.actual) : null;
      if (!weight || isNaN(weight) || weight <= 0) continue;
      const rpe = sv.rpe ? parseFloat(sv.rpe) : null;

      // Volume: use prescribed reps, fall back to 1
      const reps = getSetReps(bid, wl, dn, ex.name, si) || sv.actualReps || 1;
      const repsNum = typeof reps === 'string' ? (parseInt(reps) || 1) : (reps || 1);
      totalVolume += weight * repsNum;
      totalSets++;
      if (rpe && rpe > 0) {
        totalRpe += rpe;
        rpeCount++;
        if (rpe > maxRpe) maxRpe = rpe;
      }

      // Comp lift best set
      if (isComp && group && group !== 'other') {
        const result = calc1rm(weight, repsNum, rpe);
        if (result) {
          const cur = compBest[group];
          if (!cur || result.value > cur.e1rm) {
            compBest[group] = { weight, reps: repsNum, rpe, e1rm: result.value, method: result.method };
          }
        }
      }
    }
  }

  // Flag PRs: is today's e1rm the all-time best?
  for (const g of ['squat','bench','deadlift']) {
    if (!compBest[g]) continue;
    const peak = allTimePeaks[g];
    // It's a PR if today's e1rm equals or exceeds the all-time peak
    // (all-time includes today, so within ~1lb they're equal means it's a PR)
    compBest[g].isPR = peak && (compBest[g].e1rm >= peak.e1rm - 0.5);
  }

  return {
    compBest,
    totalVolume: Math.round(totalVolume),
    totalSets,
    avgRpe: rpeCount > 0 ? Math.round(totalRpe / rpeCount * 10) / 10 : null,
    maxRpe: maxRpe > 0 ? maxRpe : null,
  };
}


// ── Last completed workout (scan backwards from current position) ────────────
function getLastCompletedWorkout() {
  const block = state.activeBlock;
  if (!block || !block.weeks) return null;

  // Build a flat list of all (weekIdx, dayIdx) pairs
  const all = [];
  block.weeks.forEach((w, wi) => {
    (w.days || []).forEach((d, di) => {
      if (d.exercises && d.exercises.length > 0) {
        all.push({ wi, di, week: w, day: d });
      }
    });
  });

  // Find current position in flat list
  const curFlat = all.findIndex(a => a.wi === state.activeWeek && a.di === state.activeDay);

  // Scan backwards from current position (or from end if not found)
  const startFrom = curFlat >= 0 ? curFlat : all.length - 1;
  for (let i = startFrom; i >= 0; i--) {
    const { wi, di, week, day } = all[i];
    if (isDayComplete(block, week, day)) {
      // Skip if this is the same day that the hero card shows as "Up Next" (already completed today)
      const nw = getNextWorkoutInfo();
      if (nw && nw.weekIdx === wi && nw.dayIdx === di && nw.allDone) continue;
      return { week, day, weekIdx: wi, dayIdx: di };
    }
  }
  return null;
}

// ── Week progress dots ────────────────────────────────────────────────────────
function getWeekDots() {
  const block = state.activeBlock;
  if (!block) return null;

  // Use the same week the hero card and weekly summary use
  const nwInfo = getNextWorkoutInfo();
  const weekIdx = nwInfo ? nwInfo.weekIdx : (block._currentWeekIdx || 0);
  const week = block.weeks[weekIdx];
  if (!week || !week.days) return null;

  // Count ALL days in this week (not just ones with exercises)
  // This ensures dots match the day tabs shown on the workout screen
  const allDays = week.days;
  if (allDays.length === 0) return null;

  const dots = allDays.map((d, di) => {
    const isDone = isDayComplete(block, week, d);
    const isCurrent = nwInfo && (weekIdx === nwInfo.weekIdx && di === nwInfo.dayIdx && !isDone);
    return { di, name: d.name, done: isDone, isCurrent: !!isCurrent };
  });

  const done = dots.filter(d => d.done).length;
  return { dots, done, total: dots.length };
}

// ── Renderers ─────────────────────────────────────────────────────────────────
function renderWeekCard() {
  const wp = getWeekDots();
  if (!wp) return '';

  const total = wp.total || 1;
  const done = wp.done || 0;
  const pct = done / total;

  // SVG ring math
  const r = 34, cx = 40, cy = 40, sw = 5;
  const circ = 2 * Math.PI * r;
  const progressLen = pct * circ;
  const remainLen = (1 - pct) * circ;

  // Day dots
  const dots = wp.dots.map(dot => {
    let cls = 'week-ring-dot';
    if (dot.done) cls += ' done';
    else if (dot.isCurrent) cls += ' current';
    else cls += ' upcoming';
    return '<div class="' + cls + '"></div>';
  }).join('');

  return '<div class="home-card week-progress-card">'
    + '<div class="home-card-label" style="color:var(--text-dim)">This Week</div>'
    + '<div class="week-ring-wrap">'
    + '<svg viewBox="0 0 80 80" fill="none" class="week-ring-svg">'
    + '<circle cx="' + cx + '" cy="' + cy + '" r="' + r + '" stroke="rgba(255,255,255,0.04)" stroke-width="' + sw + '" fill="none"/>'
    + (done > 0 ? '<circle cx="' + cx + '" cy="' + cy + '" r="' + r + '" stroke="#4ade80" stroke-width="' + sw + '" fill="none" stroke-linecap="round" stroke-dasharray="' + progressLen.toFixed(1) + ' ' + circ.toFixed(1) + '" transform="rotate(-90 ' + cx + ' ' + cy + ')" style="filter:drop-shadow(0 0 3px rgba(74,222,128,0.2))"/>' : '')
    + (done < total ? '<circle cx="' + cx + '" cy="' + cy + '" r="' + r + '" stroke="rgba(201,168,76,0.15)" stroke-width="' + sw + '" fill="none" stroke-linecap="round" stroke-dasharray="0 ' + progressLen.toFixed(1) + ' ' + remainLen.toFixed(1) + ' ' + circ.toFixed(1) + '" transform="rotate(-90 ' + cx + ' ' + cy + ')"/>' : '')
    + '</svg>'
    + '<div class="week-ring-center">'
    + '<div class="week-ring-num">' + done + '<span class="week-ring-slash"> / </span>' + total + '</div>'
    + '</div>'
    + '</div>'
    + '<div class="week-ring-dots">' + dots + '</div>'
    + '</div>';
}

function renderLastWorkoutCard() {
  const block = state.activeBlock;
  if (!block) return '';
  const last = getLastCompletedWorkout();
  if (!last) return '';

  const { week, day, weekIdx, dayIdx } = last;
  const summary = getSessionSummary(block, week, day);

  // Day name (truncate if long)
  const dayName = day.name || 'Workout';
  const truncName = dayName.length > 18 ? dayName.slice(0, 16) + '…' : dayName;

  // Meta line
  const metaParts = [];
  if (block.weeks.length > 1) metaParts.push('W' + (weekIdx + 1));
  metaParts.push(displayBlockName(block.name) || '');
  const meta = metaParts.filter(Boolean).join(' · ');

  // Stats
  const vol = summary?.totalVolume
    ? (summary.totalVolume >= 10000 ? (summary.totalVolume / 1000).toFixed(1) + 'k' : summary.totalVolume.toLocaleString())
    : '—';
  const volUnit = summary?.totalVolume ? (summary.totalVolume >= 10000 ? '' : ' lbs') : '';
  const sets = summary?.totalSets || '—';
  const avgRpe = summary?.avgRpe != null ? summary.avgRpe : '—';

  return `<div class="home-card last-workout-card" onclick="goToWorkout(${weekIdx},${dayIdx})">
    <div class="home-card-label">✓ Last Workout</div>
    <div class="last-workout-card-day">${escH(truncName)}</div>
    <div class="last-workout-card-meta">${escH(meta)}</div>
    <div class="last-workout-stats">
      <div class="last-workout-stat">
        <div class="last-workout-stat-label">Tonnage</div>
        <div class="last-workout-stat-val">${vol}<span class="unit">${volUnit}</span></div>
      </div>
      <div class="last-workout-stat">
        <div class="last-workout-stat-label">Sets</div>
        <div class="last-workout-stat-val">${sets}</div>
      </div>
      <div class="last-workout-stat">
        <div class="last-workout-stat-label">Avg RPE</div>
        <div class="last-workout-stat-val">${avgRpe}</div>
      </div>
    </div>
    <div class="last-workout-nav">
      <span>View Workout</span>
      <span class="last-workout-nav-arrow">→</span>
    </div>
  </div>`;
}

function renderHome() {
  const block = state.activeBlock;
  const content = document.getElementById('main-content');

  // No program loaded
  if (!block || !block.weeks || block.weeks.length === 0) {
    content.innerHTML = `<div class="home-screen">
      <div class="home-greeting">${getGreeting()}</div>
      <div class="home-empty">
        <div class="home-empty-icon"><svg viewBox="0 0 28 40" fill="var(--gold)" width="48" height="70"><polygon points="18,0 7,22 14,22 10,40 21,18 14,18"/></svg></div>
        <div class="home-empty-title">No Program Loaded</div>
        <div class="home-empty-desc">Upload your training program to get started.</div>
        ${renderUploadOptions('home-')}
      </div>
    </div>`;
    return;
  }

  const _athlete = loadAthlete();
  const athleteName = (_athlete && _athlete.name)
    ? _athlete.name
    : (block.athleteName && block.athleteName !== 'Athlete' ? block.athleteName : null);

  // Hero card — determine what to show
  const nwInfo    = getNextWorkoutInfo();
  const lastDone  = getLastCompletedWorkout();
  let heroHtml    = '';

  // Determine hero state:
  // 1. Next workout exists and is NOT complete → "Up Next" gold hero
  // 2. All workouts complete → "All Complete" gold hero (done state)
  // 3. No completed workouts yet → empty "first workout" card
  // Otherwise → session summary of last completed workout (persists until next workout done)

  const nextIsIncomplete = nwInfo && !nwInfo.allDone;

  if (nextIsIncomplete) {
    // ── "Up Next" hero ──
    const { day, weekIdx, dayIdx, meta } = nwInfo;
    const exs       = day.exercises || [];
    const showCount = Math.min(3, exs.length);
    const more      = exs.length - showCount;
    const exRows    = exs.slice(0, showCount).map(ex => {
      const pres = (ex.prescription || '').slice(0, 20) + (ex.prescription?.length > 20 ? '…' : '');
      return `<div class="home-hero-ex">
        <div class="home-hero-ex-dot"></div>
        <div class="home-hero-ex-name">${escH(ex.name)}</div>
        <div class="home-hero-ex-pres">${escH(pres)}</div>
      </div>`;
    }).join('');
    heroHtml = `<div class="home-hero" onclick="goToWorkout(${weekIdx},${dayIdx},true)">
      <div class="home-hero-bg"></div>
      <svg class="home-hero-barbell" viewBox="0 0 28 40" width="110" height="160" fill="var(--gold)"><polygon points="18,0 7,22 14,22 10,40 21,18 14,18"/></svg>
      <div class="home-hero-inner">
        <div class="home-hero-label">Up Next</div>
        <div class="home-hero-day">${escH(day.name || 'Workout')}</div>
        <div class="home-hero-meta">${escH(meta)}</div>
        <div class="home-hero-exercises">
          ${exRows}
          ${more > 0 ? `<div class="home-hero-more">+${more} more</div>` : ''}
        </div>
        <div class="home-hero-cta">
          <span class="home-hero-cta-text">Start Workout</span>
          <span class="home-hero-cta-arrow">→</span>
        </div>
      </div>
    </div>`;
  } else if (nwInfo && nwInfo.allDone && !lastDone) {
    // All complete but somehow no last workout found — shouldn't happen but handle gracefully
    heroHtml = `<div class="home-hero done">
      <div class="home-hero-bg"></div>
      <div class="home-hero-inner">
        <div class="home-hero-label">✓ All Weeks Complete</div>
        <div class="home-hero-day">Block Finished</div>
        <div class="home-hero-meta">${escH(displayBlockName(block.name))}</div>
        <div class="home-hero-cta" onclick="setScreen('metrics')">
          <span class="home-hero-cta-text">View Metrics</span>
          <span class="home-hero-cta-arrow">→</span>
        </div>
      </div>
    </div>`;
  } else if (lastDone) {
    // ── Session summary hero (persists until next workout is done) ──
    const { week, day, weekIdx, dayIdx } = lastDone;
    const summary = getSessionSummary(block, week, day);
    const dayName = day.name || 'Workout';
    const metaParts = [];
    if (block.weeks.length > 1) metaParts.push('W' + (weekIdx + 1));
    if (block.name) metaParts.push(displayBlockName(block.name));
    // Add date if available
    const cDate = getDayCompletedDate(block, week, day);
    if (cDate) {
      const [y,m,d] = cDate.split('-');
      metaParts.push(m + '/' + d);
    }
    const meta = metaParts.join(' · ');

    // Build lift rows from comp best
    const liftRows = [];
    if (summary?.compBest) {
      for (const [lift, data] of Object.entries(summary.compBest)) {
        if (data && data.weight) {
          const rpeStr = data.rpe ? ` <span class="rpe-val">@${data.rpe}</span>` : '';
          liftRows.push(`<div class="session-lift-row">
            <div class="session-lift-name">${escH(lift)}</div>
            <div class="session-lift-set">${data.reps}×${data.weight}lb${rpeStr}</div>
          </div>`);
        }
      }
    }
    const liftRowsHtml = liftRows.length > 0
      ? `<div class="session-lift-rows">${liftRows.join('')}</div>`
      : '';

    // Stats
    const vol = summary?.totalVolume
      ? (summary.totalVolume >= 10000 ? (summary.totalVolume / 1000).toFixed(1) + 'k' : summary.totalVolume.toLocaleString())
      : '—';
    const volUnit = summary?.totalVolume ? ' lbs' : '';
    const sets = summary?.totalSets || '—';
    const avgRpe = summary?.avgRpe != null ? summary.avgRpe : '—';

    const allBlockDone = nwInfo && nwInfo.allDone;
    const heroLabel = allBlockDone ? '✓ Block Complete' : '✓ Last Session';

    heroHtml = `<div class="session-hero" onclick="goToWorkout(${weekIdx},${dayIdx})">
      <div class="session-hero-bg"></div>
      <div class="session-hero-inner">
        <div class="session-hero-label"><div class="session-hero-label-dot"></div>${heroLabel}</div>
        <div class="session-hero-day">${escH(dayName)}</div>
        <div class="session-hero-meta">${escH(meta)}</div>
        ${liftRowsHtml}
        <div class="session-stats">
          <div class="session-stat"><div class="session-stat-val">${vol}<span class="unit">${volUnit}</span></div><div class="session-stat-label">Volume</div></div>
          <div class="session-stat"><div class="session-stat-val">${sets}</div><div class="session-stat-label">Sets</div></div>
          <div class="session-stat"><div class="session-stat-val">${avgRpe}</div><div class="session-stat-label">Avg RPE</div></div>
        </div>
      </div>
    </div>`;
  } else {
    // ── Fresh block, no workouts completed yet ──
    const nw = nwInfo || { day: block.weeks[0]?.days[0], weekIdx: 0, dayIdx: 0 };
    const firstDay = nw.day;
    heroHtml = `<div class="home-hero" onclick="goToWorkout(${nw.weekIdx},${nw.dayIdx},true)">
      <div class="home-hero-bg"></div>
      <svg class="home-hero-barbell" viewBox="0 0 28 40" width="110" height="160" fill="var(--gold)"><polygon points="18,0 7,22 14,22 10,40 21,18 14,18"/></svg>
      <div class="home-hero-inner">
        <div class="home-hero-label">Ready to Start</div>
        <div class="home-hero-day">${escH(firstDay?.name || 'Day 1')}</div>
        <div class="home-hero-meta">${escH(displayBlockName(block.name) || 'New Block')}</div>
        <div class="home-hero-cta">
          <span class="home-hero-cta-text">Begin First Workout</span>
          <span class="home-hero-cta-arrow">→</span>
        </div>
      </div>
    </div>`;
  }

  const weekHtml      = renderWeekCard();
  // Skip "Last Workout" card when hero already shows session summary (avoids redundancy)
  const lastWkHtml    = nextIsIncomplete ? renderLastWorkoutCard() : '';

  // Two-column row: Last Workout + Week Progress (or just week if no last workout)
  let middleRowHtml;
  if (lastWkHtml && weekHtml) {
    middleRowHtml = '<div class="home-row">' + lastWkHtml + weekHtml + '</div>';
  } else if (weekHtml) {
    middleRowHtml = weekHtml;
  } else if (lastWkHtml) {
    middleRowHtml = '<div class="home-row single-col">' + lastWkHtml + '</div>';
  } else {
    middleRowHtml = '';
  }

  // Weekly Summary card
  const weekSummary = getWeeklySummary();
  let weeklySummaryHtml = '';

  if (weekSummary) {
    const summaryWeekIdx = weekSummary.weekIdx;
    const summaryWeek = block.weeks[summaryWeekIdx];
    const currentWeekIdx = block._currentWeekIdx || 0;
    const isFallback = summaryWeekIdx !== currentWeekIdx;
    const completedCount = (summaryWeek?.days || []).filter(d => isDayComplete(block, summaryWeek, d)).length;
    const totalDayCount = (summaryWeek?.days || []).length;

    // Best lift rows
    let liftRowsHtml = '';
    for (const [group, label] of [['squat','Squat'],['bench','Bench'],['deadlift','Deadlift']]) {
      const data = weekSummary.bestLifts[group];
      if (!data) continue;
      const rpeStr = '';
      const varStr = data.isVariation ? ` <span class="var-label">(${escH(data.name)})</span>` : '';
      liftRowsHtml += '<div class="week-summary-lift-row">'
        + '<div class="week-summary-lift-name">' + label + '</div>'
        + '<div class="week-summary-lift-set">' + data.reps + '×' + data.weight + 'lb' + rpeStr + varStr + '</div>'
        + '<div class="week-summary-lift-e1rm"><div class="week-summary-e1rm-val">' + Math.round(data.e1rm) + '</div><div class="week-summary-e1rm-label">e1RM</div></div>'
        + '</div>';
    }

    // Stats
    const vol = weekSummary.totalVolume >= 10000
      ? (weekSummary.totalVolume / 1000).toFixed(1) + 'k'
      : weekSummary.totalVolume.toLocaleString();

    weeklySummaryHtml = '<div class="home-week-summary">'
      + '<div class="home-week-summary-header">'
      + '<div class="home-week-summary-label">' + (isFallback ? 'Last Week' : 'This Week') + ' · ' + escH(weekSummary.weekLabel) + '</div>'
      + '<div class="home-week-summary-meta">' + completedCount + '/' + totalDayCount + ' days</div>'
      + '</div>'
      + (liftRowsHtml ? '<div class="week-summary-lifts">' + liftRowsHtml + '</div>' : '')
      + '<div class="week-summary-stats" style="grid-template-columns:1fr 1fr">'
      + '<div class="week-summary-stat"><div class="week-summary-stat-val">' + vol + '<span class="unit"> lbs</span></div><div class="week-summary-stat-label">Volume</div></div>'
      + '<div class="week-summary-stat"><div class="week-summary-stat-val">' + weekSummary.totalSets + '</div><div class="week-summary-stat-label">Sets</div></div>'
      + '</div>'
      + '</div>';
  } else {
    weeklySummaryHtml = '<div class="home-week-summary">'
      + '<div class="home-week-summary-label">This Week</div>'
      + '<div class="week-summary-empty">Log sets to see your weekly summary</div>'
      + '</div>';
  }

  content.innerHTML = `<div class="home-screen">
    <div class="home-greeting">${getGreeting()}${athleteName ? ', ' + escH(athleteName) : ''}</div>
    ${heroHtml}
    ${middleRowHtml}
    ${weeklySummaryHtml}
  </div>`;
}

function getGreeting() {
  const h = new Date().getHours();
  if (h < 12) return 'Good morning';
  if (h < 17) return 'Good afternoon';
  return 'Good evening';
}

function goToWorkout(weekIdx, dayIdx, activate) {
  state.activeWeek = weekIdx;
  state.activeDay  = dayIdx;
  state.expandedEx = new Set();
  if (activate) {
    state.workoutActive = { weekIdx, dayIdx };
    // If starting a workout ahead of current training week, advance progression
    const block = state.activeBlock;
    if (block && weekIdx > (block._currentWeekIdx || 0)) {
      block._currentWeekIdx = weekIdx;
      block._weekActivatedAt = new Date().toISOString().split('T')[0];
      saveBlocks();
    }
  }
  saveNav();
  setScreen('workout');
}

function startWorkout(weekIdx, dayIdx) {
  state.workoutActive = { weekIdx, dayIdx };
  state.activeWeek = weekIdx;
  state.activeDay = dayIdx;
  state.expandedEx = new Set();
  // If starting a workout ahead of current training week, advance progression
  const block = state.activeBlock;
  if (block && weekIdx > (block._currentWeekIdx || 0)) {
    block._currentWeekIdx = weekIdx;
    block._weekActivatedAt = new Date().toISOString().split('T')[0];
    saveBlocks();
  }
  saveNav();
  if (state.screen !== 'workout') setScreen('workout');
  else render();
}

const _checkSvg = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>';

// ── RENDER ────────────────────────────────────────────────────────────────────
function render(){
  ['home','workout','metrics','calc'].forEach(s=>{
    const el=document.getElementById('nav-'+s);
    if(el) el.classList.toggle('active', state.screen===s);
  });
  if(state.screen==='home'){ renderHome(); return; }
  if(state.screen==='metrics'){ renderMetrics(); return; }
  if(state.screen==='calc'){ renderCalc(); return; }
  renderWorkout();
}

// ── renderWorkout sub-functions ───────────────────────────────────────────────

function renderUploadOptions(prefix) {
  prefix = prefix || 'up-';
  return `<div class="upload-options">
    <div class="upload-option-card" onclick="openDrivePicker()">
      <div class="upload-option-icon upload-option-icon-drive">
        <svg viewBox="0 0 87.3 78" width="24" height="22">
          <path d="M6.6 66.85l3.85 6.65c.8 1.4 1.95 2.5 3.3 3.3l13.75-23.8H1.2c0 1.55.4 3.1 1.2 4.5l4.2 9.35z" fill="#0066DA"/>
          <path d="M43.65 25L29.9 1.2c-1.35.8-2.5 1.9-3.3 3.3L1.2 52.7c-.8 1.4-1.2 2.95-1.2 4.5h27.5L43.65 25z" fill="#00AC47"/>
          <path d="M73.55 76.8c1.35-.8 2.5-1.9 3.3-3.3l1.6-2.75 7.65-13.25c.8-1.4 1.2-2.95 1.2-4.5H59.85L73.55 76.8z" fill="#EA4335"/>
          <path d="M43.65 25L57.4 1.2C56.05.4 54.5 0 52.9 0H34.4c-1.6 0-3.15.45-4.5 1.2L43.65 25z" fill="#00832D"/>
          <path d="M59.85 53H27.5l-13.75 23.8c1.35.8 2.9 1.2 4.5 1.2h50.4c1.6 0 3.15-.45 4.5-1.2L59.85 53z" fill="#2684FC"/>
          <path d="M73.4 26.5l-12.7-22c-.8-1.4-1.95-2.5-3.3-3.3L43.65 25l16.2 28h27.45c0-1.55-.4-3.1-1.2-4.5L73.4 26.5z" fill="#FFBA00"/>
        </svg>
      </div>
      <div class="upload-option-body">
        <div class="upload-option-title">Import from Google Drive</div>
        <div class="upload-option-desc">Browse and select a spreadsheet from your Drive</div>
      </div>
      <svg class="upload-option-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="18" height="18"><polyline points="9 18 15 12 9 6"/></svg>
    </div>

    <div class="upload-option-card" onclick="document.getElementById('file-input').click()">
      <div class="upload-option-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" width="26" height="26">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
          <polyline points="14 2 14 8 20 8"/>
        </svg>
      </div>
      <div class="upload-option-body">
        <div class="upload-option-title">Upload Excel File</div>
        <div class="upload-option-desc">Select a .xlsx or .xls file from your device</div>
      </div>
      <svg class="upload-option-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="18" height="18"><polyline points="9 18 15 12 9 6"/></svg>
    </div>

    <div style="text-align:center;padding-top:4px">
      <button onclick="openFormatExample()" style="background:none;border:none;font-family:'Barlow',sans-serif;font-size:13px;color:var(--text-dim);cursor:pointer;text-decoration:underline;text-underline-offset:3px">What should my spreadsheet look like?</button>
    </div>
  </div>`;
}

function renderUploadScreen() {
  return `<div class="upload-screen">
    <div class="upload-icon"><svg viewBox="0 0 28 40" fill="#C9A84C" width="36" height="54"><polygon points="18,0 7,22 14,22 10,40 21,18 14,18"/></svg></div>
    <div class="upload-title">Unrack</div>
    <div class="upload-desc">Upload your training program to get started.</div>
    ${renderUploadOptions('wo-')}
    <div class="upload-hint">No account needed · All data stays on your device</div>
  </div>`;
}

function renderBlockBar(block) {
  if(state.editingBlockName){
    return `<div class="block-bar">
      <input class="block-name-edit" id="block-name-input" value="${escH(block.name)}"
        onblur="saveBlockName()"
        onkeydown="if(event.key==='Enter')this.blur();if(event.key==='Escape'){state.editingBlockName=false;render();}">
      <div class="block-dates">${block.dateRange}</div>
    </div>`;
  }
  let h=`<div class="block-bar"><div style="display:flex;align-items:center;gap:6px">
    <div><div class="block-name">${displayBlockName(block.name)}</div><div class="block-dates">${block.dateRange}</div></div>
    <button class="edit-name-btn" style="opacity:0.3;font-size:11px" onclick="state.editingBlockName=true;render();setTimeout(()=>{const el=document.getElementById('block-name-input');if(el){el.focus();el.select();}},50)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
  </div>`;
  if(state.blocks.length>1){
    h+=`<select class="cycle-select" onchange="switchBlock(this.value)">`;
    state.blocks.forEach(b=>h+=`<option value="${b.id}" ${b.id===block.id?'selected':''}>${displayBlockName(b.name) || b.id}</option>`);
    h+=`</select>`;
  }
  h+=`</div>`;
  return h;
}

function renderWeekPills(block) {
  let h=`<div class="week-bar">`;
  block.weeks.forEach((w,wi)=>{
    const weekDone=w.days.every(d=>isDayComplete(block,w,d));
    const classes=['week-pill'];
    if(state.activeWeek===wi) classes.push('active');
    if(weekDone) classes.push('done');
    h+=`<button class="${classes.join(' ')}" data-week-idx="${wi}" onclick="setWeek(${wi})" role="tab" aria-selected="${state.activeWeek===wi}">${escH(w.label)}</button>`;
  });
  h+=`</div>`;
  return h;
}

function renderDayTabs(block, week) {
  if(!week?.days?.length) return '';
  let h=`<div class="day-tabs" id="day-tabs-bar">`;
  week.days.forEach((d,di)=>{
    const complete=isDayComplete(block,week,d);
    const label=formatDayTabLabel(d.name);
    const classes=['day-tab'];
    if(state.activeDay===di) classes.push('active');
    if(complete) classes.push('done');
    h+=`<button class="${classes.join(' ')}" data-day-idx="${di}" onclick="setDay(${di})">${label}</button>`;
  });
  h+=`</div>`;
  return h;
}

// Format a day name into a clean two-line label for the tab bar.
// "Upper 1 (Bench ACC)" → "<span>UPPER 1</span><span>(BENCH ACC)</span>"
// "Monday" → "MON"
// "Tuesday" → "TUE"
function formatDayTabLabel(name){
  const n=name.trim();
  // If name contains a parenthetical, split there
  const parenIdx=n.indexOf('(');
  if(parenIdx>0){
    const before=n.slice(0,parenIdx).trim().toUpperCase();
    const after=n.slice(parenIdx).trim().toUpperCase();
    return `<span style="display:block">${before}</span><span style="display:block;opacity:0.75;font-size:10px">${after}</span>`;
  }
  // If name has multiple words, try to split at roughly the middle
  const words=n.toUpperCase().split(/\s+/);
  if(words.length>=3){
    const mid=Math.ceil(words.length/2);
    const line1=words.slice(0,mid).join(' ');
    const line2=words.slice(mid).join(' ');
    return `<span style="display:block">${line1}</span><span style="display:block;opacity:0.75;font-size:10px">${line2}</span>`;
  }
  // Short name — just uppercase it, single line
  return n.toUpperCase();
}

function renderNextWorkoutBanner(block) {
  const _next=findNextWorkout(block);
  if(_next.weekIdx===state.activeWeek && _next.dayIdx===state.activeDay) return '';
  const nw=block.weeks[_next.weekIdx]; const nd=nw?.days[_next.dayIdx];
  if(!nd) return '';
  return `<div class="next-workout-banner" onclick="state.activeWeek=${_next.weekIdx};state.activeDay=${_next.dayIdx};state.expandedEx=new Set();saveNav();render()">
    <span class="next-workout-banner-text"><svg viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg> Next workout: ${escH(nw.label)} — ${escH(nd.name)}</span><span class="next-workout-banner-arrow">→</span>
  </div>`;
}

function renderExCard(ex, groupKeys, block, week, day, exIdx) {
  let h = '';
  const key=lk(block.id,week.label,day.name,ex.name);
  // Expand key includes position index to disambiguate duplicate exercise names in the same day
  const expandKey = exIdx !== undefined ? key + '||' + exIdx : key;
  const isCustomEx = ex.isCustom === true;
  const log=state.logs[key]||{};
  const isDone=log.done||false;
  const isSkipped=log.skipped||false;
  const pres=ex.prescription;
  const sets=pres?parseSets(pres):[];
  // Try comma-separated warmup notation: "135x8,225x6,275x3,315x1"
  if(!sets.length && pres) { const wu=parseWarmupSets(pres); if(wu.length) sets.push(...wu); }
  const hasSets=sets.length>0;
  const simple=parseSimple(pres);
  const ranged=(!hasSets&&!simple)?parseRangeSet(pres):null;
  const supersetRounds = ex.supersetGroup?.rounds || 1;
  const bare=(!hasSets&&!simple&&!ranged)?parseBarePres(pres):null;
  const bareWithRounds = bare ? {...bare, sets: supersetRounds} : null;
  const inputMode=getExerciseInputMode(ex.name,pres);

  const isComp=isCompLift(ex.name);
  const group=classifyLift(ex.name);
  const tracked=isTracked(ex.name);
  const showTrackBtn=group!==null;

  const trackBtn=showTrackBtn
    ?`<button class="track-btn ${tracked?'tracked':''} ${isComp?'is-comp':''}" onclick="toggleTracked('${esc(ex.name)}',event)" title="${tracked?'Remove from metrics':'Track in metrics'}"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg></button>`
    :'';

  function presShortSummary(sets,simple,ranged,pres){
    if(sets.length>0){
      const firstWeight=sets[0].isRpe?`@ ${sets[0].weight}`:`@ ${sets[0].weight}lb`;
      const allSame=sets.every(s=>s.reps===sets[0].reps&&s.weight===sets[0].weight);
      if(allSame) return `${sets.length}×${sets[0].reps} ${firstWeight}`;
      return sets.map(s=>s.isRpe?`${s.reps}@${s.weight}`:`${s.reps}@${s.weight}lb`).join(' · ');
    }
    if(simple) return `${simple.sets}×${simple.reps}`;
    if(ranged) return `${ranged.sets}×${ranged.reps}`;
    if(bareWithRounds) return `${bareWithRounds.sets>1?bareWithRounds.sets+'×':''}${bareWithRounds.reps}`;
    if(pres) return pres;
    return '';
  }

  function setInputsHtml(sk,sl,placeholder){
    if(placeholder==='open') return `<div class="set-inputs-wrap">
              <div class="set-input-group"><div class="set-input-label">Reps</div>
                <input class="set-input" inputmode="decimal" placeholder="reps" value="${sl.actual||''}" oninput="setActual('${esc(sk)}',this.value)">
              </div>
            </div>`;
    if(inputMode==='bw') return `<div class="set-inputs-wrap" style="max-width:120px">
              <div class="set-input-group"><div class="set-input-label">Reps</div>
                <input class="set-input" inputmode="numeric" placeholder="reps" value="${sl.actual||''}" oninput="setActual('${esc(sk)}',this.value)">
              </div>
            </div>`;
    if(inputMode==='cardio') return '';
    if(inputMode==='bw-timed') return `<div class="set-inputs-wrap" style="max-width:120px">
              <div class="set-input-group"><div class="set-input-label">Time</div>
                <input class="set-input" placeholder="time" value="${sl.actual||''}" oninput="setActual('${esc(sk)}',this.value)">
              </div>
            </div>`;
    return `<div class="set-inputs-wrap">
              <div class="set-input-group"><div class="set-input-label">Weight (lbs)</div>
                <input class="set-input" inputmode="decimal" placeholder="" value="${sl.actual||''}" oninput="setActual('${esc(sk)}',this.value)">
              </div>
              <div class="set-input-group"><div class="set-input-label">RPE (1–10)</div>
                <input class="set-input rpe-input" inputmode="decimal" placeholder="" value="${sl.rpe||''}" oninput="setRpe('${esc(sk)}',this.value)">
              </div>
            </div>`;
  }

  // Tappable reps button — used across all set rendering paths (simple, ranged, bare)
  function repsButtonHtml(sk, sl, prescReps, label) {
    // Strip " reps" suffix for timed prescriptions (e.g. "45 sec reps" → "45 sec")
    if (/\d+\s*(sec|min|s|m)\b/i.test(String(prescReps))) label = String(prescReps);
    const _hasActual = sl.actualReps && sl.actualReps !== String(prescReps);
    const _display = _hasActual ? `<span style="color:var(--gold)">${sl.actualReps}</span> reps` : label;
    const _editing = state.editingRepsKey === sk;
    if (_editing) {
      return `<div style="display:flex;flex-direction:column;gap:2px;align-self:flex-end;padding-bottom:8px">
        <div class="set-reps-popover">
          <span class="set-reps-popover-label">Reps</span>
          <input class="set-reps-popover-input" id="reps-popover-${esc(sk)}" type="number" inputmode="numeric" value="${sl.actualReps||prescReps}" min="1"
            onblur="saveActualReps('${esc(sk)}',this.value,'${prescReps}')"
            onkeydown="if(event.key==='Enter')this.blur();if(event.key==='Escape'){state.editingRepsKey=null;renderSetRow('${esc(sk)}');}">
          <button class="set-reps-popover-close" onclick="state.editingRepsKey=null;renderSetRow('${esc(sk)}')">✕</button>
        </div>
      </div>`;
    }
    return `<button class="set-prescribed-btn ${_hasActual?'has-actual':''}" onclick="openRepsEditor('${esc(sk)}','${prescReps}')">${_display}<span class="set-prescribed-chevron">›</span></button>`;
  }

  const isExpanded=state.expandedEx.has(expandKey);
  const presSum=presShortSummary(sets,simple,ranged,pres);
  const setsCompletedCount=[...Array(sets.length||(simple?.sets||0)||(ranged?.sets||0)||(bareWithRounds?.sets||0)||(pres?1:0))].filter((_,si)=>(state.logs[key+`||s${si}`]||{}).done).length;
  const totalSetsCount=sets.length||(simple?.sets||0)||(ranged?.sets||0)||(bare?.sets||0)||(pres?1:0);

  h+=`<div class="exercise-card ${isDone?'completed':isSkipped?'skipped':''}" data-expand-key="${escH(expandKey)}" data-ex-key="${escH(key)}">`;
  h+=`<div class="ex-summary" onclick="toggleExpand('${esc(expandKey)}','${groupKeys?esc(groupKeys.join(':::')):''}')">
    <div class="ex-summary-left">
      <div class="ex-summary-name ${isDone?'done':isSkipped?'skipped':''}">${escH(ex.displayName||ex.name)}${isCustomEx?'<span class="custom-ex-badge">Custom</span>':''}</div>
      ${presSum?`<div class="ex-summary-pres">${presSum}${totalSetsCount>0?' · '+setsCompletedCount+'/'+totalSetsCount+' sets':''}</div>`:''}
    </div>
    <div class="ex-summary-right">
      ${showTrackBtn && !tracked ? `<button class="track-btn ${isComp?'is-comp':''}" onclick="toggleTracked('${esc(ex.name)}',event)" title="Track in metrics"><span class="track-hint-inline">Track</span><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg></button>` : trackBtn}
      ${isSkipped ? `<span class="skipped-badge">SKIPPED</span>` : ''}
      <button class="exercise-check ${isDone?(log.inferredComplete?'done inferred':'done'):''}" onclick="event.stopPropagation();toggleEx('${esc(key)}')" aria-label="${isDone?'Mark exercise incomplete':'Mark exercise complete'}">${isDone?_checkSvg:''}</button>
    </div>
  </div>${!isExpanded?`<div class="ex-expand-handle" onclick="toggleExpand('${esc(expandKey)}','${groupKeys?esc(groupKeys.join(':::')):''}')"><div class="ex-expand-pill"></div></div>`:''}`;

  if(isExpanded){
    h+=`<div class="ex-detail">`;

    const editingThis=state.editingExKey===key;
    if(editingThis){
      h+=`<div class="exercise-header" style="padding:10px 16px 4px">
        <input class="exercise-name-edit" id="ex-edit-${esc(key)}" value="${escH((ex.displayName||ex.name).trim())}"
          onblur="saveExName('${esc(key)}','${esc(ex.name)}')"
          onkeydown="if(event.key==='Enter')this.blur();if(event.key==='Escape'){state.editingExKey=null;render();}">
      </div>`;
    } else {
      if(isCustomEx){
        h+=`<div style="display:flex;align-items:center;gap:10px;padding:10px 16px 4px">
          <button class="custom-ex-action-btn edit" onclick="openEditExerciseModal('${esc(key)}',event)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="13" height="13" style="vertical-align:-1px"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg> Edit Exercise</button>
          <button class="custom-ex-action-btn delete" onclick="openDeleteExerciseSheet('${esc(key)}','${esc(ex.name)}',event)">✕ Delete</button>
        </div>`;
      } else {
        h+=`<div style="display:flex;align-items:center;gap:6px;padding:10px 16px 4px">
          <button class="edit-name-btn" style="opacity:0.4" onclick="startEditEx('${esc(key)}')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg> Edit name</button>
        </div>`;
      };
    }
    

    if(hasSets){
      h+=`<div class="sets-grid">`;
      sets.forEach((s,si)=>{
        const sk=key+`||s${si}`; const sl=state.logs[sk]||{};
        h+=`<div class="set-row">
          <div class="set-num">S${si+1}</div>
          ${(()=>{
            const _hasActualReps = sl.actualReps && sl.actualReps !== String(s.reps);
            const _prescLabel = s.isRpe ? s.reps+' '+s.weight : s.weight+' lb × '+s.reps;
            const _displayLabel = _hasActualReps ? (s.isRpe ? s.reps+' '+s.weight : s.weight+' lb × <span style="color:var(--gold)">' + sl.actualReps + '</span>') : _prescLabel;
            const _editing = state.editingRepsKey === sk;
            if(_editing){
              return `<div style="display:flex;flex-direction:column;gap:2px;align-self:flex-end;padding-bottom:8px">
                <div class="set-reps-popover">
                  <span class="set-reps-popover-label">Reps</span>
                  <input class="set-reps-popover-input" id="reps-popover-${esc(sk)}" type="number" inputmode="numeric" value="${sl.actualReps||s.reps}" min="1"
                    onblur="saveActualReps('${esc(sk)}',this.value,'${s.reps}')"
                    onkeydown="if(event.key==='Enter')this.blur();if(event.key==='Escape'){state.editingRepsKey=null;renderSetRow('${esc(sk)}');}">
                  <button class="set-reps-popover-close" onclick="state.editingRepsKey=null;renderSetRow('${esc(sk)}')">✕</button>
                </div>
              </div>`;
            }
            return `<button class="set-prescribed-btn ${_hasActualReps?'has-actual':''}" onclick="openRepsEditor('${esc(sk)}','${s.reps}')">${_displayLabel}<span class="set-prescribed-chevron">›</span></button>`;
          })()}
          ${setInputsHtml(sk,sl,s.isRpe?'lbs':s.weight+'lb')}
          <button class="set-check ${sl.done?'done':''}" data-set-key="${esc(sk)}" onclick="toggleSet('${esc(sk)}')">${sl.done?_checkSvg:''}</button>
        </div>`;
      });

      // Extra sets (+ Set button) — weighted style
      const _extra=state.extraSets[key]||0;
      if(_extra>0){
        const _lastS=sets[sets.length-1]||{};
        for(let _i=0;_i<_extra;_i++){
          const _si=sets.length+_i; const _sk=key+`||s${_si}`; const _sl=state.logs[_sk]||{};
          const _extraHasActual = _sl.actualReps && _sl.actualReps !== String(_lastS.reps);
          const _extraPrescLabel = _lastS.isRpe ? (_lastS.reps||'—')+' '+(_lastS.weight||'') : (_lastS.weight||'—')+' lb × '+(_lastS.reps||'—');
          const _extraDisplayLabel = _extraHasActual ? (_lastS.isRpe ? (_lastS.reps||'—')+' '+(_lastS.weight||'') : (_lastS.weight||'—')+' lb × <span style="color:var(--gold)">' + _sl.actualReps + '</span>') : _extraPrescLabel;
          const _extraEditing = state.editingRepsKey === _sk;
          h+=`<div class="set-row">
            <div class="set-num">S${_si+1}</div>
            ${_extraEditing ? `<div style="display:flex;flex-direction:column;gap:2px;align-self:flex-end;padding-bottom:8px"><div class="set-reps-popover"><span class="set-reps-popover-label">Reps</span><input class="set-reps-popover-input" id="reps-popover-${esc(_sk)}" type="number" inputmode="numeric" value="${_sl.actualReps||_lastS.reps}" min="1" onblur="saveActualReps('${esc(_sk)}',this.value,'${_lastS.reps}')" onkeydown="if(event.key==='Enter')this.blur();if(event.key==='Escape'){state.editingRepsKey=null;renderSetRow('${esc(_sk)}');}"><button class="set-reps-popover-close" onclick="state.editingRepsKey=null;renderSetRow('${esc(_sk)}')">✕</button></div></div>` : `<button class="set-prescribed-btn ${_extraHasActual?'has-actual':''}" onclick="openRepsEditor('${esc(_sk)}','${_lastS.reps}')">${_extraDisplayLabel}<span class="set-prescribed-chevron">›</span></button>`}
            ${setInputsHtml(_sk,_sl,_lastS.isRpe?'lbs':(_lastS.weight?_lastS.weight+'lb':'lbs'))}
            <button class="set-check ${_sl.done?'done':''}" onclick="toggleSet('${esc(_sk)}')">${_sl.done?_checkSvg:''}</button>
          </div>`;
        }
      }
      h+=`</div>`;
    } else if(pres&&simple){
      h+=`<div class="prescription purple">${pres}</div><div class="sets-grid">`;
      for(let si=0;si<simple.sets;si++){
        const sk=key+`||s${si}`; const sl=state.logs[sk]||{};
        h+=`<div class="set-row">
          <div class="set-num">S${si+1}</div>${repsButtonHtml(sk, sl, simple.reps, simple.reps+' reps')}
          ${setInputsHtml(sk,sl,'lbs')}
          <button class="set-check ${sl.done?'done':''}" data-set-key="${esc(sk)}" onclick="toggleSet('${esc(sk)}')">${sl.done?_checkSvg:''}</button>
        </div>`;
      }

      // Extra sets — simple style
      const _extra=state.extraSets[key]||0;
      if(_extra>0){
        for(let _i=0;_i<_extra;_i++){
          const _si=simple.sets+_i; const _sk=key+`||s${_si}`; const _sl=state.logs[_sk]||{};
          h+=`<div class="set-row">
            <div class="set-num">S${_si+1}</div>${repsButtonHtml(_sk, _sl, simple.reps, simple.reps+' reps')}
            ${setInputsHtml(_sk,_sl,'lbs')}
            <button class="set-check ${_sl.done?'done':''}" onclick="toggleSet('${esc(_sk)}')">${_sl.done?_checkSvg:''}</button>
          </div>`;
        }
      }
      h+=`</div>`;
    } else if(pres&&ranged){
      h+=`<div class="prescription purple">${pres}</div><div class="sets-grid">`;
      for(let si=0;si<ranged.sets;si++){
        const sk=key+`||s${si}`; const sl=state.logs[sk]||{};
        const isOpen=ranged.reps==='open';
        h+=`<div class="set-row">
          <div class="set-num">S${si+1}</div>${isOpen?'':repsButtonHtml(sk, sl, ranged.reps, ranged.reps+' reps')}
          ${setInputsHtml(sk,sl,isOpen?'open':'lbs')}
          <button class="set-check ${sl.done?'done':''}" data-set-key="${esc(sk)}" onclick="toggleSet('${esc(sk)}')">${sl.done?_checkSvg:''}</button>
        </div>`;
      }

      // Extra sets — ranged style
      const _extra=state.extraSets[key]||0;
      if(_extra>0){
        const _isOpen=ranged.reps==='open';
        for(let _i=0;_i<_extra;_i++){
          const _si=ranged.sets+_i; const _sk=key+`||s${_si}`; const _sl=state.logs[_sk]||{};
          h+=`<div class="set-row">
            <div class="set-num">S${_si+1}</div>${_isOpen?'':repsButtonHtml(_sk, _sl, ranged.reps, ranged.reps+' reps')}
            ${setInputsHtml(_sk,_sl,_isOpen?'open':'lbs')}
            <button class="set-check ${_sl.done?'done':''}" onclick="toggleSet('${esc(_sk)}')">${_sl.done?_checkSvg:''}</button>
          </div>`;
        }
      }
      h+=`</div>`;
    } else if(bareWithRounds){
      h+=`<div class="sets-grid">`;
      for(let si=0;si<bareWithRounds.sets;si++){
        const sk=key+`||s${si}`; const sl=state.logs[sk]||{};
        h+=`<div class="set-row">
          <div class="set-num">S${si+1}</div>${repsButtonHtml(sk, sl, bareWithRounds.reps, bareWithRounds.reps+' reps')}
          ${setInputsHtml(sk,sl,'lbs')}
          <button class="set-check ${sl.done?'done':''}" data-set-key="${esc(sk)}" onclick="toggleSet('${esc(sk)}')">${sl.done?_checkSvg:''}</button>
        </div>`;
      }

      // Extra sets — bare style
      const _extra=state.extraSets[key]||0;
      if(_extra>0){
        for(let _i=0;_i<_extra;_i++){
          const _si=bareWithRounds.sets+_i; const _sk=key+`||s${_si}`; const _sl=state.logs[_sk]||{};
          h+=`<div class="set-row">
            <div class="set-num">S${_si+1}</div>${repsButtonHtml(_sk, _sl, bareWithRounds.reps, bareWithRounds.reps+' reps')}
            ${setInputsHtml(_sk,_sl,'lbs')}
            <button class="set-check ${_sl.done?'done':''}" onclick="toggleSet('${esc(_sk)}')">${_sl.done?_checkSvg:''}</button>
          </div>`;
        }
      }
      h+=`</div>`;
    } else if(pres){
      const sk=key+`||s0`; const sl=state.logs[sk]||{};
      h+=`<div class="prescription purple">${pres}</div><div class="sets-grid">`;
      h+=`<div class="set-row">
        <div class="set-num">S1</div><div class="set-prescribed">open</div>
        ${setInputsHtml(sk,sl,'lbs')}
        <button class="set-check ${sl.done?'done':''}" data-set-key="${esc(sk)}" onclick="toggleSet('${esc(sk)}')">${sl.done?_checkSvg:''}</button>
      </div>`;
      h+=`</div>`;
    }

    const prevPerf=getPrevWeekPerformance(block.id,week.label,day.name,ex.name);
    if(prevPerf){
      const srcLabel=prevPerf.source
        ?`Last performed (${prevPerf.source} — ${prevPerf.label})`
        :`Last time (${prevPerf.label})`;
      h+=`<div class="prev-performance">
        <div class="prev-performance-label">${srcLabel}</div>
        <div class="prev-performance-sets">
          ${prevPerf.sets.map((s,i)=>`<span class="prev-performance-set">S${i+1}: ${s.actual}${s.rpe?' @'+s.rpe:''}</span>`).join('')}
        </div>
      </div>`;
    }

    const allCoachNotes=[...(ex.coachNotes||[])];
    if(ex.note&&!allCoachNotes.includes(ex.note)) allCoachNotes.unshift(ex.note);
    if(allCoachNotes.length>0){
      h+=`<div class="notes-section">
        <div class="notes-label"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg> Coach Notes</div>
        ${allCoachNotes.map(n=>`<div class="coach-note">${escH(n)}</div>`).join('')}
      </div>`;
    }

    const prevNote=getPrevWeekNote(block.id,week.label,day.name,ex.name);
    const importedNote=log.lifterNote||null;
    h+=`<div class="notes-section">
      <div class="notes-label"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg> My Notes</div>
      ${importedNote?`<div class="coach-note" style="color:var(--text-sub);border-top:1px solid #222"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="13" height="13" style="vertical-align:-1px;margin-right:4px;opacity:0.6"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg>From sheet: ${escH(importedNote)}</div>`:''}
      ${prevNote?`<div class="lifter-prev-note">Last time: "${escH(prevNote)}"</div>`:''}
      <div class="notes-area"><textarea class="notes-input" placeholder="Add a note for next time..." oninput="setNote('${esc(key)}',this.value)" aria-label="Exercise notes">${escH(log.notes||'')}</textarea></div>
    </div>`;
    h+=`</div>`; // ex-detail - close notes section
    h+=`<div class="skip-row">
      <button class="set-adjust-btn" onclick="adjustSets('${esc(key)}',-1)">− Set</button>
      <button class="set-adjust-btn" onclick="adjustSets('${esc(key)}',1)">+ Set</button>
      <button class="skip-btn ${isSkipped?'active':''}" onclick="toggleSkip('${esc(key)}')">${isSkipped?'↩ Undo Skip':'Skip Exercise'}</button>
    </div>`;
  }

  h+=`</div>`; // exercise-card
  return h;
}

function renderExerciseList(block, week, day) {
  if(!day || day.exercises.length===0){
    return `<div class="rest-msg">Rest day. Eat enough protein.</div>`;
  }

  const renderItems = [];
  let i = 0;
  while (i < day.exercises.length) {
    const ex = day.exercises[i];
    if (ex.supersetGroup) {
      const groupLabel = ex.supersetGroup.label;
      const cluster = [];
      while (i < day.exercises.length && day.exercises[i].supersetGroup && day.exercises[i].supersetGroup.label === groupLabel) {
        cluster.push(day.exercises[i]);
        i++;
      }
      renderItems.push({ type: 'superset', label: groupLabel, exercises: cluster });
    } else {
      renderItems.push({ type: 'single', ex });
      i++;
    }
  }

  let h = '';
  let globalExIdx = 0; // position counter across all items in the day
  renderItems.forEach(item => {
    if (item.type === 'single') {
      h += renderExCard(item.ex, null, block, week, day, globalExIdx++);
    } else {
      const groupKeys = item.exercises.map(ex => lk(block.id, week.label, day.name, ex.name));
      // Build index-suffixed expand keys to match what renderExCard uses for data-expand-key
      const startIdx = globalExIdx;
      const groupExpandKeys = item.exercises.map((ex, i) => lk(block.id, week.label, day.name, ex.name) + '||' + (startIdx + i));
      h += `<div class="superset-group">`;
      const _displayLabel = item.label.replace(/_\d+$/, '');
      h += `<div class="superset-header" onclick="toggleExpand('${esc(groupExpandKeys[0])}','${esc(groupExpandKeys.join(':::'))}')" style="cursor:pointer"><span class="superset-badge">${_displayLabel}</span><span class="superset-label">${item.exercises.map(e=>escH(e.name)).join(" · ")}</span></div>`;
      item.exercises.forEach(ex => { h += renderExCard(ex, groupExpandKeys, block, week, day, globalExIdx++); });
      h += `</div>`;
    }
  });

  const isHistorical = !!block.historical;

  // Historical blocks: locked green, no controls
  if (isHistorical) {
    h+=`<div class="workout-complete-msg">Workout Complete</div>`;
    return h;
  }

  const forceLog = state.logs[lk(block.id,week.label,day.name,'__complete__')];
  const forceComplete = !!forceLog?.done;
  const isImportedComplete = forceComplete && (forceLog?.importedComplete === true);
  const isLiveComplete = forceComplete && !forceLog?.importedComplete && !forceLog?.historical;

  // Imported completed workout — green card, no Finish Workout, no trash
  if (isImportedComplete) {
    h+=`<div class="workout-complete-msg">Workout Complete</div>`;
    return h;
  }

  // Live workout — user explicitly tapped Finish Workout
  if (isLiveComplete) {
    h+=`<div class="workout-complete-msg">Workout Complete <button class="clear-workout-btn" onclick="clearWorkout()" title="Clear workout"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6M14 11v6"/><path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg></button></div>`;
    return h;
  }

  // Active workout — show Add Exercise + gold Finish Workout button
  h+=`<button class="add-exercise-btn" onclick="openAddExerciseModal()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" width="16" height="16"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg> Add Exercise</button>`;
  const totalEx = day.exercises.length;
  const resolvedEx = day.exercises.filter(ex => {
    const log = state.logs[lk(block.id,week.label,day.name,ex.name)] || {};
    return log.done || log.skipped;
  }).length;
  const allResolved = resolvedEx === totalEx && totalEx > 0;
  h+=`<button class="complete-workout-btn${allResolved?' ready':''}" onclick="completeWorkout()" ${allResolved?'':'disabled'}>Finish Workout</button>`;

  return h;
}

// ── Main orchestrator ─────────────────────────────────────────────────────────
function isWorkoutActive(weekIdx, dayIdx) {
  return state.workoutActive && state.workoutActive.weekIdx === weekIdx && state.workoutActive.dayIdx === dayIdx;
}

function getDayProgress(block, week, day) {
  if (!day || !day.exercises.length) return { total: 0, done: 0, hasAnyData: false };
  const total = day.exercises.length;
  let done = 0;
  let hasAnyData = false;
  day.exercises.forEach(ex => {
    const key = lk(block.id, week.label, day.name, ex.name);
    const log = state.logs[key] || {};
    if (log.done || log.skipped) done++;
    // Check if any set has data logged
    if (log.done || log.skipped || log.notes) { hasAnyData = true; return; }
    const pres = ex.prescription;
    if (!pres) return;
    const sets = parseSets(pres);
    if (!sets.length) { const wu = parseWarmupSets(pres); if (wu.length) sets.push(...wu); }
    const simple = parseSimple(pres);
    const ranged = (!sets.length && !simple) ? parseRangeSet(pres) : null;
    const numSets = sets.length || (simple?.sets || 0) || (ranged?.sets || 0) || 1;
    for (let si = 0; si < numSets; si++) {
      const sk = key + `||s${si}`;
      const sl = state.logs[sk] || {};
      if (sl.done || sl.actual || sl.rpe) { hasAnyData = true; return; }
    }
  });
  return { total, done, hasAnyData };
}

function renderPreviewList(block, week, day) {
  if (!day || day.exercises.length === 0) {
    return `<div class="rest-msg">Rest day. Eat enough protein.</div>`;
  }
  let h = '<div class="preview-exercise-list">';
  day.exercises.forEach(ex => {
    const key = lk(block.id, week.label, day.name, ex.name);
    const log = state.logs[key] || {};
    const isDone = log.done || false;
    const isSkipped = log.skipped || false;
    const completedClass = (isDone || isSkipped) ? ' completed' : '';
    const presShort = ex.prescription || '';
    const noteHtml = ex.note ? `<div class="preview-ex-note">${escH(ex.note)}</div>` : '';
    h += `<div class="preview-exercise${completedClass}">
      <div style="flex:1">
        <div class="preview-ex-name">${escH(ex.displayName || ex.name)}</div>
        ${noteHtml}
      </div>
      <div class="preview-ex-pres">${escH(presShort)}</div>
      ${isDone ? `<div class="preview-ex-check" style="color:#4ade80">${_checkSvg}</div>` : ''}
      ${isSkipped ? `<div class="preview-ex-check" style="color:var(--text-faint)"><span style="font-size:11px;font-family:'Barlow Condensed',sans-serif;font-weight:700;letter-spacing:0.06em">SKIP</span></div>` : ''}
    </div>`;
  });
  h += '</div>';
  return h;
}

function renderStartResumeBanner(block, week, day) {
  const progress = getDayProgress(block, week, day);
  const forceLog = state.logs[lk(block.id, week.label, day.name, '__complete__')];
  const isComplete = !!forceLog?.done;
  const isHistorical = !!block.historical;
  
  if (isComplete || isHistorical) return '';
  
  if (progress.hasAnyData && progress.done < progress.total) {
    // Resume state — outlined/hollow style
    return `<div class="workout-resume-banner" onclick="startWorkout(${state.activeWeek},${state.activeDay})">
      <span class="workout-resume-text">Resume Workout</span>
      <span class="workout-resume-sub">${progress.done} of ${progress.total} done</span>
    </div>`;
  }
  // Fresh start — pulsing glow
  return `<div class="workout-start-banner" onclick="startWorkout(${state.activeWeek},${state.activeDay})">
    <span class="workout-start-text">Start Workout</span>
  </div>`;
}

function renderWorkout(){
  const main=document.getElementById('main-content');
  document.getElementById('athlete-name').textContent=state.activeBlock?.athleteName||'';

  if(!state.activeBlock){ main.innerHTML=renderUploadScreen(); return; }

  const block=state.activeBlock;
  const week=block.weeks[state.activeWeek];
  const day=week?.days[state.activeDay];
  const active = isWorkoutActive(state.activeWeek, state.activeDay);

  let h='';
  h+=renderBlockBar(block);
  h+=renderWeekPills(block);
  h+=renderDayTabs(block, week);
  h+=renderNextWorkoutBanner(block);

  if (active) {
    // Active logging mode — full exercise cards
    h+=`<div class="exercises">`;
    h+=renderExerciseList(block, week, day);
    h+=`</div>`;
  } else {
    // Preview mode — read-only list + start/resume banner
    const forceLog = state.logs[lk(block.id, week.label, day.name, '__complete__')];
    const isComplete = !!forceLog?.done;
    const isHistorical = !!block.historical;
    
    if (isComplete || isHistorical) {
      // Completed day — show preview list + complete message
      h += renderPreviewList(block, week, day);
      if (isHistorical) {
        h += `<div class="workout-complete-msg">Workout Complete</div>`;
      } else if (forceLog?.importedComplete) {
        h += `<div class="workout-complete-msg">Workout Complete</div>`;
      } else {
        h += `<div class="workout-complete-msg">Workout Complete <button class="clear-workout-btn" onclick="clearWorkout()" title="Clear workout"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6M14 11v6"/><path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg></button></div>`;
      }
    } else {
      // Not started or partial — show banner + preview list
      h += renderStartResumeBanner(block, week, day);
      h += renderPreviewList(block, week, day);
    }
  }

  main.innerHTML=h;
  // Scroll active day tab and week pill into view
  requestAnimationFrame(()=>{
    const bar=document.getElementById('day-tabs-bar');
    if(bar){const active=bar.querySelector('.day-tab.active');if(active) active.scrollIntoView({block:'nearest',inline:'center',behavior:'instant'});}
    const wbar=document.querySelector('.week-bar');
    if(wbar){const activeW=wbar.querySelector('.week-pill.active');if(activeW) activeW.scrollIntoView({block:'nearest',inline:'center',behavior:'instant'});}
  });
}

function saveBlockName(){
  const el=document.getElementById('block-name-input');
  const newName=el?el.value.trim():'';
  state.editingBlockName=false;
  if(newName&&state.activeBlock&&newName!==state.activeBlock.name){
    state.activeBlock.name=newName;
    saveBlocks();
  }
  render();
}

function startEditEx(key){ state.editingExKey=key; render(); setTimeout(()=>{ const el=document.getElementById('ex-edit-'+key); if(el){el.focus();el.select();} },50); }

function saveExName(key, oldName){
  const el=document.getElementById('ex-edit-'+esc(key));
  const newName=el?el.value.trim():oldName;
  state.editingExKey=null;
  if(!newName||newName===oldName.trim()){ render(); return; }

  // Rename exercise across all weeks/days in all blocks
  for(const block of state.blocks){
    for(const week of block.weeks){
      for(const day of week.days){
        const ex=day.exercises.find(e=>e.name.trim()===oldName.trim());
        if(!ex) continue;
        ex.name=newName;

        // Migrate log keys: old key → new key
        const oldKey=lk(block.id,week.label,day.name,oldName.trim());
        const newKey=lk(block.id,week.label,day.name,newName);
        if(state.logs[oldKey]!==undefined){
          state.logs[newKey]=state.logs[oldKey];
          delete state.logs[oldKey];
        }
        // Migrate set keys
        for(let si=0;si<20;si++){
          const osk=oldKey+`||s${si}`;
          const nsk=newKey+`||s${si}`;
          if(state.logs[osk]!==undefined){
            state.logs[nsk]=state.logs[osk];
            delete state.logs[osk];
          }
        }
      }
    }
  }

  // Migrate tracked lifts entry
  const otn=oldName.trim().toLowerCase();
  const ntn=newName.toLowerCase();
  if(state.trackedLifts[otn]!==undefined){
    state.trackedLifts[ntn]=state.trackedLifts[otn];
    delete state.trackedLifts[otn];
    saveTrackedLifts();
  }

  saveLogs();
  saveBlocks();
  render();
}

function toggleEx(key){
  const l=state.logs[key]||{};
  const nowDone=!l.done;
  // When user manually interacts, clear inferredComplete — this is now a real action
  const {inferredComplete:_,...rest}=l;
  state.logs[key]={...rest,done:nowDone,skipped:false};
  const block=state.activeBlock;
  const week=block?.weeks[state.activeWeek];
  const day=week?.days[state.activeDay];
  const ex=day?.exercises.find(e=>lk(block.id,week.label,day.name,e.name)===key);
  
  // Compute set count for this exercise
  let numSets=1;
  if(ex){
    const pres=ex.prescription;
    const sets=pres?parseSets(pres):[];
    if(!sets.length && pres) { const wu=parseWarmupSets(pres); if(wu.length) sets.push(...wu); }
    const simple=parseSimple(pres);
    const ranged=(!sets.length&&!simple)?parseRangeSet(pres):null;
    numSets=sets.length||(simple?.sets||0)||(ranged?.sets||0)||(pres?1:0)||1;
    numSets += (state.extraSets[key] || 0);
  }
  
  if(nowDone && ex){
    // Checking exercise ON → mark all its sets done too
    for(let si=0;si<numSets;si++){
      const sk=key+`||s${si}`;
      const sl=state.logs[sk]||{};
      if(!sl.done) state.logs[sk]={...sl,done:true};
    }
  } else if(!nowDone && day){
    // Unchecking exercise → clear force-complete flag
    const fk=lk(block.id,week.label,day.name,'__complete__');
    delete state.logs[fk];
  }
  saveLogs();
  
  // ── Targeted DOM updates instead of full render() — prevents scroll jump ──
  
  // 1. Update the exercise checkmark
  updateExerciseCheckmark(key, nowDone);
  
  // 2. Update all set checkmarks within this exercise
  for(let si=0;si<numSets;si++){
    updateSetCheckmark(key+`||s${si}`, nowDone);
  }
  
  // 3. Update progress bar
  updateProgressBar();
  
  // 4. Update day tab checkmarks
  updateDayTabCheckmarks();
  
  // 5. If this tap completed the day, activate finish button
  if(nowDone && block && week && day){
    checkAndActivateFinishButton(block, week, day);
  }
}

function completeWorkout(){
  const block=state.activeBlock;
  const week=block.weeks[state.activeWeek];
  const day=week?.days[state.activeDay];
  if(!day) return;
  state.workoutActive = null;
  // Mark all exercises and their sets as done
  day.exercises.forEach(ex=>{
    const key=lk(block.id,week.label,day.name,ex.name);
    const log=state.logs[key]||{};
    if(!log.done) state.logs[key]={...log,done:true,skipped:false};
    // Mark individual sets done with prescribed weight if not already logged
    const pres=ex.prescription;
    if(pres){
      const sets=parseSets(pres);
      if(!sets.length) { const wu=parseWarmupSets(pres); if(wu.length) sets.push(...wu); }
      const simple=parseSimple(pres);
      const ranged=(!sets.length&&!simple)?parseRangeSet(pres):null;
      const numSets=sets.length||(simple?.sets||0)||(ranged?.sets||0)||1;
      for(let si=0;si<numSets;si++){
        const sk=key+`||s${si}`;
        const sl=state.logs[sk]||{};
        if(!sl.done){
          const setEntry={done:true};
          if(!sl.actual&&sets[si]&&!sets[si].isRpe) setEntry.actual=String(sets[si].weight);
          state.logs[sk]={...sl,...setEntry};
        }
      }
    }
  });
  // Set force-complete flag so isDayComplete() returns true (include today's date for expiry)
  const forceKey=lk(block.id,week.label,day.name,'__complete__');
  const _today = new Date(); 
  const _dateStr = `${_today.getFullYear()}-${_today.getMonth()+1}-${_today.getDate()}`;
  state.logs[forceKey]={done:true, completedDate: _dateStr};
  saveLogs();
  // Capture celebration data before render() (render may mutate references)
  const _dayName = day.name;
  const _weekNum = block.weeks.findIndex(w => w.label === week.label);
  const _blockName = block.name || '';
  render();
  // Fire celebration after render settles
  const metaParts = [];
  if (block.weeks.length > 1 && _weekNum !== -1) metaParts.push('W' + (_weekNum + 1));
  if (_blockName) metaParts.push(_blockName);
  setTimeout(() => {
    showCelebration(_dayName, metaParts.join(' · '), () => {
      // Check for new 1RM singles before going home
      checkNewSingles(block, week, day, () => {
        setScreen('home');
        const main = document.getElementById('main-content');
        if (main) main.scrollTop = 0;
      });
    });
  }, 50);
}
function checkNewSingles(block, week, day, onDone) {
  if (!day || !day.exercises) { onDone(); return; }
  const ath = loadAthlete() || {};
  const currentMaxes = {
    squat: Number(ath.tested1rm_squat) || 0,
    bench: Number(ath.tested1rm_bench) || 0,
    deadlift: Number(ath.tested1rm_deadlift) || 0
  };
  const newRecords = []; // {group, liftName, weight}
  for (const ex of day.exercises) {
    if (!isCompLift(ex.name)) continue;
    const group = classifyLift(ex.name);
    if (!group || !currentMaxes.hasOwnProperty(group)) continue;
    const key = lk(block.id, week.label, day.name, ex.name);
    // Scan sets for logged singles
    const pres = ex.prescription;
    if (!pres) continue;
    const sets = parseSets(pres);
    const simple = parseSimple(pres);
    const ranged = (!sets.length && !simple) ? parseRangeSet(pres) : null;
    const numSets = sets.length || (simple?.sets || 0) || (ranged?.sets || 0) || 1;
    for (let si = 0; si < numSets; si++) {
      const sk = key + `||s${si}`;
      const sl = state.logs[sk];
      if (!sl || !sl.done) continue;
      // Check if this set is a single (1 rep) with a logged actual weight
      const reps = Number(sl.reps) || 0;
      const actual = Number(sl.actual) || 0;
      if (reps === 1 && actual > 0 && actual > currentMaxes[group]) {
        // Only keep the highest single per group
        const existing = newRecords.find(r => r.group === group);
        if (!existing || actual > existing.weight) {
          if (existing) existing.weight = actual;
          else newRecords.push({ group, liftName: ex.name, weight: actual });
        }
      }
    }
  }
  if (newRecords.length === 0) { onDone(); return; }
  // Show prompt for each new record
  showNewPRPrompt(newRecords, currentMaxes, onDone);
}

function showNewPRPrompt(records, currentMaxes, onDone) {
  const liftLabels = { squat: 'Squat', bench: 'Bench', deadlift: 'Deadlift' };
  const rows = records.map(r => {
    const old = currentMaxes[r.group];
    const diff = r.weight - old;
    return `<div style="display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border)">
      <div>
        <div style="font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:700;text-transform:uppercase;letter-spacing:0.06em;color:var(--text-sub)">${liftLabels[r.group]}</div>
        <div style="font-size:11px;color:var(--text-dim)">${escH(r.liftName)}</div>
      </div>
      <div style="text-align:right">
        <div style="font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:900;color:var(--gold)">${r.weight}<span style="font-size:12px;font-weight:400;color:var(--text-dim)"> lbs</span></div>
        ${old ? `<div style="font-size:11px;color:#4CAF50">+${diff} from ${old}</div>` : ''}
      </div>
    </div>`;
  }).join('');

  const overlay = document.createElement('div');
  overlay.id = 'pr-prompt-overlay';
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:500;display:flex;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(4px)';
  overlay.innerHTML = `<div style="background:var(--card-bg);border:1px solid var(--card-border);border-radius:18px;padding:24px 20px;max-width:340px;width:100%;box-shadow:0 8px 32px rgba(0,0,0,0.5)">
    <div style="text-align:center;margin-bottom:16px">
      <div style="font-size:28px;margin-bottom:6px">🏆</div>
      <div style="font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:900;text-transform:uppercase;letter-spacing:0.06em;color:var(--gold)">New 1RM!</div>
      <div style="font-size:12px;color:var(--text-dim);margin-top:4px">Update your Current 1RM?</div>
    </div>
    ${rows}
    <div style="display:flex;gap:10px;margin-top:18px">
      <button onclick="dismissPRPrompt(false)" style="flex:1;padding:12px;border-radius:12px;border:1px solid var(--border);background:transparent;color:var(--text-sub);font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:700;text-transform:uppercase;letter-spacing:0.06em;cursor:pointer">Skip</button>
      <button onclick="dismissPRPrompt(true)" style="flex:1;padding:12px;border-radius:12px;border:none;background:var(--gold);color:#111;font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:700;text-transform:uppercase;letter-spacing:0.06em;cursor:pointer">Update</button>
    </div>
  </div>`;

  // Store data for dismiss handler
  overlay._records = records;
  overlay._onDone = onDone;
  document.body.appendChild(overlay);
}

function dismissPRPrompt(accepted) {
  const overlay = document.getElementById('pr-prompt-overlay');
  if (!overlay) return;
  const onDone = overlay._onDone;
  if (accepted && overlay._records) {
    const ath = loadAthlete() || {};
    for (const r of overlay._records) {
      ath['tested1rm_' + r.group] = r.weight;
    }
    saveAthlete(ath);
  }
  overlay.remove();
  if (onDone) onDone();
}

function clearWorkout(){
  const block=state.activeBlock;
  const week=block.weeks[state.activeWeek];
  const day=week?.days[state.activeDay];
  if(!day) return;
  // Count logged sets to show in warning
  let loggedSets=0;
  day.exercises.forEach(ex=>{
    const key=lk(block.id,week.label,day.name,ex.name);
    for(let si=0;si<20;si++){
      const sk=key+`||s${si}`;
      if(state.logs[sk]?.done) loggedSets++;
    }
  });
  const msg=loggedSets>0
    ? `This will erase all logged data for ${day.name} (${loggedSets} completed set${loggedSets===1?'':'s'}). This cannot be undone.`
    : `This will clear all data for ${day.name}. This cannot be undone.`;
  // Show confirmation overlay
  const existing=document.getElementById('clear-workout-overlay');
  if(existing) existing.remove();
  const overlay=document.createElement('div');
  overlay.id='clear-workout-overlay';
  overlay.className='delete-ex-overlay';
  overlay.onclick=(e)=>{if(e.target===overlay)overlay.remove();};
  overlay.innerHTML=`
  <div class="delete-ex-sheet">
    <div class="delete-ex-title" style="color:#E22C2C">Clear Workout Data?</div>
    <div class="delete-ex-desc">${msg}</div>
    <button class="delete-ex-btn danger" onclick="confirmClearWorkout()">Clear All Data</button>
    <button class="delete-ex-btn single" onclick="document.getElementById('clear-workout-overlay').remove()">Cancel</button>
  </div>`;
  document.body.appendChild(overlay);
}
function confirmClearWorkout(){
  const overlay=document.getElementById('clear-workout-overlay');
  if(overlay) overlay.remove();
  state.workoutActive = null;
  const block=state.activeBlock;
  const week=block.weeks[state.activeWeek];
  const day=week?.days[state.activeDay];
  if(!day) return;
  // Delete all log keys for this day
  day.exercises.forEach(ex=>{
    const key=lk(block.id,week.label,day.name,ex.name);
    delete state.logs[key];
    for(let si=0;si<20;si++){
      const sk=key+`||s${si}`;
      if(state.logs[sk]!==undefined) delete state.logs[sk];
    }
  });
  // Clear force-complete flag
  delete state.logs[lk(block.id,week.label,day.name,'__complete__')];
  saveLogs();
  render();
}

function toggleSkip(key){
  const log=state.logs[key]||{};
  const isSkipped=log.skipped||false;
  const nowSkipped=!isSkipped;
  state.logs[key]={...log, skipped:nowSkipped, done:false};
  saveLogs();
  
  // Targeted DOM updates
  // 1. Update exercise card skip styling
  const escaped=cssEsc(key);
  const card=document.querySelector(`.exercise-card[data-ex-key='${escaped}']`);
  if(card){
    card.classList.toggle('skipped', nowSkipped);
  }
  // 2. Update the exercise checkmark (clear done state)
  updateExerciseCheckmark(key, false);
  // 3. Update progress bar and day tabs
  updateProgressBar();
  updateDayTabCheckmarks();
  // 4. Check if day is now complete (skip counts as resolved)
  const block=state.activeBlock;
  const week=block?.weeks[state.activeWeek];
  const day=week?.days[state.activeDay];
  if(nowSkipped && block && week && day){
    checkAndActivateFinishButton(block, week, day);
  }
}

// A day is complete if:
// 1. All exercises are done or skipped, OR
// 2. Force-complete flag is set (via Complete Workout button)
function isDayComplete(block, week, day){
  if(!day||day.exercises.length===0) return false;
  // Check force-complete flag
  const forceKey=lk(block.id,week.label,day.name,'__complete__');
  if(state.logs[forceKey]?.done) return true;
  // Require all exercises resolved
  const total=day.exercises.length;
  const resolved=day.exercises.filter(ex=>{
    const log=state.logs[lk(block.id,week.label,day.name,ex.name)]||{};
    return log.done||log.skipped;
  }).length;
  return resolved===total;
}
// Returns the completion date string (YYYY-M-D) for a day, or null if not completed
function getDayCompletedDate(block, week, day) {
  if (!block || !week || !day) return null;
  const forceKey = lk(block.id, week.label, day.name, '__complete__');
  const entry = state.logs[forceKey];
  return entry?.completedDate || null;
}
function toggleSet(key){
  const l=state.logs[key]||{};
  const nowDone = !l.done;
  state.logs[key]={...l, done: nowDone, ts: nowDone ? (l.ts || Date.now()) : l.ts};
  saveLogs();
  // Targeted DOM updates instead of full render() — prevents scroll jump
  updateSetCheckmark(key, nowDone);
  autoCompleteExercise(key);
  updateProgressBar();
  updateDayTabCheckmarks();
}
function adjustSets(key, delta){
  const cur = state.extraSets[key] || 0;
  const next = Math.max(0, cur + delta);
  if(delta < 0 && cur > 0){
    const block=state.activeBlock, week=block.weeks[state.activeWeek], day=week.days[state.activeDay];
    const ex=day.exercises.find(e=>lk(block.id,week.label,day.name,e.name)===key);
    if(ex){
      const baseCount=(ex.sets&&ex.sets.length>0)?ex.sets.length:(parseSimple(ex.prescription)||{sets:1}).sets;
      const removedIdx=baseCount+cur-1;
      const sk=key+`||s${removedIdx}`;
      delete state.logs[sk];
      saveLogs();
    }
  }
  state.extraSets[key]=next;
  // Preserve scroll position across render
  const escaped=cssEsc(key);
  const card=document.querySelector(`.exercise-card[data-ex-key='${escaped}']`);
  let scrollAnchorOffset=null;
  if(card){ scrollAnchorOffset=card.getBoundingClientRect().top; }
  render();
  if(card && scrollAnchorOffset!==null){
    const newCard=document.querySelector(`.exercise-card[data-ex-key='${escaped}']`);
    if(newCard){
      const newTop=newCard.getBoundingClientRect().top;
      window.scrollBy(0, newTop - scrollAnchorOffset);
    }
  }
}
function setActual(key,v){
  const existing = state.logs[key]||{};
  state.logs[key]={...existing, actual:v};
  // Auto-complete set when weight is entered
  const shouldCheck=v&&v.trim()!=='';
  state.logs[key].done=shouldCheck;
  if(shouldCheck && !existing.ts) state.logs[key].ts = Date.now();
  saveLogs();
  
  // Update set checkmark directly without full render
  updateSetCheckmark(key,shouldCheck);
  
  // Check if all sets are now done → auto-complete exercise
  autoCompleteExercise(key);
}
function setRpe(key,v){
  state.logs[key]={...(state.logs[key]||{}),rpe:v};
  saveLogs();
  // RPE doesn't trigger checkmark, but might trigger exercise complete
  autoCompleteExercise(key);
}
function updateSetCheckmark(key,isDone){
  const escaped=key.replace(/'/g,"\\'");
  const btn=document.querySelector(`button.set-check[onclick*="${escaped}"]`);
  if(btn){
    btn.className=isDone?'set-check done':'set-check';
    btn.innerHTML=isDone?_checkSvg:'';
  }
}
function updateProgressBar(){
  const block=state.activeBlock; if(!block) return;
  const week=block.weeks[state.activeWeek]; if(!week) return;
  const day=week.days[state.activeDay]; if(!day) return;
  const total=day.exercises.length||0;
  const done=total>0?day.exercises.filter(ex=>{ const l=state.logs[lk(block.id,week.label,day.name,ex.name)]||{}; return l.done||l.skipped; }).length:0;
  const pct=total>0?Math.round(done/total*100):0;
  const bar=document.querySelector('.progress-fill');
  if(bar) bar.style.width=pct+'%';
}
function updateDayTabCheckmarks(){
  const block=state.activeBlock; if(!block) return;
  const week=block.weeks[state.activeWeek]; if(!week) return;
  document.querySelectorAll('.day-tab').forEach(tab=>{
    const di=parseInt(tab.dataset.dayIdx);
    if(isNaN(di)) return;
    const day=week.days[di]; if(!day) return;
    const complete=isDayComplete(block,week,day);
    const check=tab.querySelector('.day-check');
    if(complete&&!check){ tab.insertAdjacentHTML('beforeend','<span class="day-check">✓</span>'); tab.classList.add('done'); }
    else if(!complete&&check){ check.remove(); tab.classList.remove('done'); }
  });
  // Also update week pill checkmarks
  document.querySelectorAll('.week-pill').forEach(pill=>{
    const wi=parseInt(pill.dataset.weekIdx);
    if(isNaN(wi)) return;
    const w=block.weeks[wi]; if(!w) return;
    const allDone=w.days.filter(d=>d.exercises&&d.exercises.length>0).every(d=>isDayComplete(block,w,d));
    if(allDone&&!pill.classList.contains('done')) pill.classList.add('done');
    else if(!allDone&&pill.classList.contains('done')) pill.classList.remove('done');
  });
}
// ── WORKOUT CELEBRATION ───────────────────────────────────────────────────────
let _celebrationCallback = null;

function showCelebration(dayName, meta, onDismiss) {
  const overlay = document.getElementById('celebration-overlay');
  if (!overlay) return;

  _celebrationCallback = onDismiss || null;

  // Populate header
  document.getElementById('cel-day').textContent  = dayName || 'Workout';
  document.getElementById('cel-meta').textContent = meta    || '';

  // Get session data
  const block = state.activeBlock;
  const week  = block?.weeks[state.activeWeek];
  const day   = week?.days[state.activeDay];
  const summary = (block && week && day) ? getSessionSummary(block, week, day) : null;

  // ── Comp lift top sets ──────────────────────────────────────────────────────
  const liftsEl = document.getElementById('cel-lifts');
  const liftsCard = document.getElementById('cel-lifts-card');
  const liftGroups = ['squat','bench','deadlift'];
  const liftLabels = { squat:'Squat', bench:'Bench', deadlift:'Dead' };
  const hasAnyLift = liftGroups.some(g => summary?.compBest?.[g]);

  if (hasAnyLift) {
    liftsCard.style.display = '';
    liftsEl.innerHTML = liftGroups.map(g => {
      const best = summary.compBest[g];
      if (!best) return `<div class="cel-lift-row">
        <div class="cel-lift-name">${liftLabels[g]}</div>
        <div class="cel-lift-none">—</div>
      </div>`;
      const rpeStr = best.rpe ? `@${best.rpe}` : '';
      const prBadge = best.isPR ? `<div class="cel-lift-pr">PR</div>` : '';
      return `<div class="cel-lift-row">
        <div class="cel-lift-name">${liftLabels[g]}</div>
        <div class="cel-lift-set">${best.weight}<span class="cel-lift-sub"> lbs × ${best.reps}</span>${rpeStr ? `<span class="cel-lift-rpe">${rpeStr}</span>` : ''}</div>
        ${prBadge}
      </div>`;
    }).join('');
  } else {
    liftsCard.style.display = 'none';
  }

  // ── Stats row ───────────────────────────────────────────────────────────────
  const statsEl = document.getElementById('cel-stats');
  const vol = summary?.totalVolume
    ? (summary.totalVolume >= 1000 ? (summary.totalVolume/1000).toFixed(1)+'k' : summary.totalVolume)
    : '—';
  const sets   = summary?.totalSets  || '—';
  const avgRpe = summary?.avgRpe     != null ? summary.avgRpe : '—';
  const maxRpe = summary?.maxRpe     || '—';

  statsEl.innerHTML = `
    <div class="cel-stat">
      <div class="cel-stat-val">${vol}<span class="cel-stat-unit">${typeof summary?.totalVolume === 'number' && summary.totalVolume >= 1000 ? '' : summary?.totalVolume ? ' lbs' : ''}</span></div>
      <div class="cel-stat-label">Tonnage</div>
    </div>
    <div class="cel-stat">
      <div class="cel-stat-val">${sets}</div>
      <div class="cel-stat-label">Sets</div>
    </div>
    <div class="cel-stat">
      <div class="cel-stat-val">${avgRpe}</div>
      <div class="cel-stat-label">Avg RPE</div>
    </div>`;

  // ── All exercises ───────────────────────────────────────────────────────────
  const exEl   = document.getElementById('cel-exercises');
  const exCard = document.getElementById('cel-exercises-card');
  const exs    = day?.exercises || [];
  if (exs.length) {
    exCard.style.display = '';
    exEl.innerHTML = exs.map(ex => {
      const exKey = lk(block.id, week.label, day.name, ex.name);
      const exLog = state.logs[exKey] || {};
      const isDone    = !!exLog.done;
      const isSkipped = !!exLog.skipped;
      // Count completed sets
      let setsDone = 0;
      for (let si = 0; si < 20; si++) {
        const sv = state.logs[exKey + '||s' + si];
        if (!sv) break;
        if (sv.done && !sv.inferredComplete) setsDone++;
      }
      const statusStr = isSkipped ? 'skipped'
        : setsDone > 0 ? `${setsDone} set${setsDone > 1 ? 's' : ''}`
        : '';
      const nameClass = isSkipped ? 'cel-ex-name cel-ex-done' : 'cel-ex-name';
      return `<div class="cel-ex-row">
        <div class="${nameClass}">${escH(ex.name)}</div>
        <div class="cel-ex-sets">${statusStr}</div>
      </div>`;
    }).join('');
  } else {
    exCard.style.display = 'none';
  }

  // Reset scroll and show
  const scroll = overlay.querySelector('.cel-scroll');
  if (scroll) scroll.scrollTop = 0;
  overlay.classList.add('visible');
}

// ── GOOGLE DRIVE PICKER ──────────────────────────────────────────────────────
const DRIVE_CLIENT_ID = '868418344070-756bh89t1d5ms7d50e0ofvo3tuent9kl.apps.googleusercontent.com';
const DRIVE_API_KEY = 'AIzaSyC_lOxtDPt4sElQgYKXyfSI4V1dS78cv0o';
const DRIVE_SCOPE = 'https://www.googleapis.com/auth/drive.file';
let _driveAccessToken = null;
let _pickerApiLoaded = false;

function loadPickerApi() {
  return new Promise((resolve) => {
    if (_pickerApiLoaded) { resolve(); return; }
    gapi.load('picker', () => { _pickerApiLoaded = true; resolve(); });
  });
}

function requestDriveToken() {
  return new Promise((resolve, reject) => {
    const client = google.accounts.oauth2.initTokenClient({
      client_id: DRIVE_CLIENT_ID,
      scope: DRIVE_SCOPE,
      callback: (resp) => {
        if (resp.error) { reject(new Error(resp.error)); return; }
        _driveAccessToken = resp.access_token;
        resolve(resp.access_token);
      },
    });
    client.requestAccessToken();
  });
}

async function openDrivePicker() {
  // Hide onboarding overlay temporarily so picker is visible, but don't mark as onboarded yet
  const onboardEl = document.getElementById('onboarding-overlay');
  const wasOnboarding = onboardEl && onboardEl.style.display !== 'none';
  if (wasOnboarding) {
    onboardEl.style.display = 'none';
    document.querySelector('.bottom-nav').style.display = '';
    document.querySelector('.header').style.display = '';
  }

  try {
    // Step 1: Get access token (prompts user to sign in if needed)
    if (!_driveAccessToken) {
      await requestDriveToken();
    }

    // Step 2: Load Picker API
    await loadPickerApi();

    // Step 3: Build and show picker
    const spreadsheetView = new google.picker.DocsView(google.picker.ViewId.SPREADSHEETS)
      .setIncludeFolders(true);

    const picker = new google.picker.PickerBuilder()
      .setDeveloperKey(DRIVE_API_KEY)
      .setOAuthToken(_driveAccessToken)
      .setAppId('868418344070')
      .addView(spreadsheetView)
      .setTitle('Select a training program spreadsheet')
      .setCallback((data) => {
        onDrivePickerCallback(data);
        // If user cancelled and was in onboarding, return to onboarding
        if (data.action === google.picker.Action.CANCEL && wasOnboarding) {
          showOnboardingStep(3);
        }
      })
      .build();
    picker.setVisible(true);
  } catch (err) {
    console.error('[Drive Picker]', err);
    _driveAccessToken = null;
    if (err.message !== 'popup_closed_by_user') {
      showParseError('error', 'Google Drive sign-in failed. Please try again.');
    }
    // If sign-in was cancelled and was in onboarding, return to onboarding
    if (wasOnboarding) {
      showOnboardingStep(3);
    }
  }
}

async function onDrivePickerCallback(data) {
  if (data.action !== google.picker.Action.PICKED) return;
  const doc = data.docs[0];
  if (!doc) return;

  const fileId = doc.id;
  const fileName = doc.name || 'Drive Import';
  const mimeType = doc.mimeType || '';

  try {
    let buffer;

    if (mimeType === 'application/vnd.google-apps.spreadsheet') {
      // Google Sheets — export as xlsx
      const resp = await fetch(
        `https://www.googleapis.com/drive/v3/files/${fileId}/export?mimeType=application/vnd.openxmlformats-officedocument.spreadsheetml.sheet`,
        { headers: { Authorization: `Bearer ${_driveAccessToken}` } }
      );
      if (!resp.ok) throw new Error(`Export failed (${resp.status})`);
      buffer = await resp.arrayBuffer();
    } else {
      // Regular xlsx/xls file — download directly
      const resp = await fetch(
        `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`,
        { headers: { Authorization: `Bearer ${_driveAccessToken}` } }
      );
      if (!resp.ok) throw new Error(`Download failed (${resp.status})`);
      buffer = await resp.arrayBuffer();
    }

    if(buffer.byteLength > 10*1024*1024){ showParseError('File is too large (max 10 MB). Try reducing the number of sheets.'); return; }
    const wb = XLSX.read(buffer);
    wb._plFilename = fileName.replace(/\.\w+$/, '');
    const blocks = parseWorkbook(wb);

    if (!blocks || blocks.length === 0) {
      openColumnMapper(wb);
      return;
    }

    const namePart = fileName.replace(/\.\w+$/, '').replace(/_/g, ' ').trim();
    blocks.forEach(b => {
      if (b.athleteName === 'Athlete') b.athleteName = namePart;
      if (b.name === 'Training Program') b.name = namePart;
    });

    openImportIntent(blocks);
  } catch (err) {
    console.error('[Drive Import]', err);
    showParseError('error', err.message || 'Failed to import file from Google Drive.');
  }
}

// ── IMPORT INTENT ────────────────────────────────────────────────────────────
let _pendingImportBlocks = null;
let _importIntent = 'active'; // 'active' | 'history'

// ── IMPORT INTAKE (multi-step) ─────────────────────────────────────────────
let _intakeStep = 1;

function openImportIntent(blocks) {
  _pendingImportBlocks = blocks;
  _importIntent = 'active';
  _intakeStep = 1;
  document.getElementById('import-intent-modal').style.display = 'flex';
  renderIntakeStep();
}

function closeImportIntent() {
  document.getElementById('import-intent-modal').style.display = 'none';
  _pendingImportBlocks = null;
  // If not yet onboarded, return to upload step
  if (!isOnboarded()) {
    showOnboardingStep(3);
  }
}

function renderIntakeStep() {
  const body = document.getElementById('import-intake-body');
  if (_intakeStep === 1) renderIntakeStep1(body);
  else renderIntakeStep2(body);
  // scroll sheet to top
  body.closest('.intake-sheet').scrollTop = 0;
}

// ── Step 1: Program Type ──────────────────────────────────────────────────
function renderIntakeStep1(body) {
  const blocks = _pendingImportBlocks || [];
  const b0 = blocks[0] || {};
  const names = blocks.map(b => b.name || b.id).join(', ');
  const existingBlocks = state.blocks || [];
  const showMerge = existingBlocks.length > 0;

  // Pre-populate 1RM and date fields
  const ath = loadAthlete() || {};
  const preMaxS = b0.maxes?.squat || ath.tested1rm_squat || '';
  const preMaxB = b0.maxes?.bench || ath.tested1rm_bench || '';
  const preMaxD = b0.maxes?.deadlift || ath.tested1rm_deadlift || '';
  const isHistorical = _importIntent === 'history';
  const isMerge = _importIntent === 'merge';
  let preDate = '';
  if (isHistorical && b0.dateRange) {
    const m = b0.dateRange.match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})/);
    if (m) { let yr = parseInt(m[3]); if (yr < 100) yr += 2000; preDate = yr + '-' + String(m[1]).padStart(2,'0') + '-' + String(m[2]).padStart(2,'0'); }
  }
  if (!preDate && _importIntent === 'active') preDate = new Date().toISOString().split('T')[0];

  // Merge target — auto-select active block, or show dropdown for multiple
  let mergeTargetHtml = '';
  if (showMerge) {
    if (existingBlocks.length === 1) {
      const tgt = existingBlocks[0];
      mergeTargetHtml = `
        <div id="import-merge-select" style="display:${isMerge?'block':'none'};margin-bottom:10px">
          <div style="font-family:'Barlow',sans-serif;font-size:12px;color:var(--text-sub);margin-bottom:4px">Adding to:</div>
          <div style="font-family:'Barlow Condensed',sans-serif;font-size:15px;font-weight:700;color:var(--text-bright);padding:8px 12px;background:var(--surface-3);border-radius:8px;border:1px solid var(--border)">${escH(displayBlockName(tgt.name) || tgt.id)}</div>
          <input type="hidden" id="import-merge-target" value="${tgt.id}">
        </div>`;
    } else {
      const activeId = state.activeBlock?.id || '';
      const mergeOpts = existingBlocks.map(b =>
        `<option value="${b.id}"${b.id===activeId?' selected':''}>${displayBlockName(b.name) || b.id}</option>`
      ).join('');
      mergeTargetHtml = `
        <div id="import-merge-select" style="display:${isMerge?'block':'none'};margin-bottom:10px">
          <div style="font-family:'Barlow',sans-serif;font-size:12px;color:var(--text-sub);margin-bottom:6px">Add to which program?</div>
          <select id="import-merge-target" class="intake-field-input">${mergeOpts}</select>
        </div>`;
    }
  }

  body.innerHTML = `
    <div style="margin-bottom:6px">
      <div style="font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:900;color:var(--text-bright);letter-spacing:0.02em;text-align:center">Import Program</div>
      <div style="font-family:'Barlow',sans-serif;font-size:13px;color:var(--text-sub);margin-top:3px;text-align:center">${escH(names)}</div>
    </div>
    <div class="intake-section-label">What is this program?</div>
    ${showMerge ? `
    <div class="import-intent-card${isMerge?' selected':''}" id="import-card-merge" onclick="selectImportIntent('merge')">
      <div class="import-intent-icon"><svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></div>
      <div class="import-intent-body">
        <div class="import-intent-title">Add to Current Program</div>
        <div class="import-intent-desc">Append new weeks to your active training block.</div>
      </div>
      <div class="import-intent-check" id="import-check-merge" style="opacity:${isMerge?1:0}">✓</div>
    </div>
    ${mergeTargetHtml}` : ''}
    <div class="import-intent-card${_importIntent==='active'?' selected':''}" id="import-card-active" onclick="selectImportIntent('active')">
      <div class="import-intent-icon"><svg viewBox="0 0 28 40" width="22" height="32"><polygon points="18,0 7,22 14,22 10,40 21,18 14,18"/></svg></div>
      <div class="import-intent-body">
        <div class="import-intent-title">Start New Program</div>
        <div class="import-intent-desc">Begin a new training block from scratch.</div>
      </div>
      <div class="import-intent-check" id="import-check-active" style="opacity:${_importIntent==='active'?1:0}">✓</div>
    </div>
    <div class="import-intent-card${isHistorical?' selected':''}" id="import-card-history" onclick="selectImportIntent('history')">
      <div class="import-intent-icon"><svg viewBox="0 0 24 24" width="22" height="22" fill="var(--text-sub)"><path d="M5 9v11H1V9h4zm4-5v16H5V4h4zm4 8v8h-4v-8h4zm4-4v12h-4V8h4zm4-6v18h-4V2h4z"/></svg></div>
      <div class="import-intent-body">
        <div class="import-intent-title">Historical Data</div>
        <div class="import-intent-desc">Already completed. Import for metrics history.</div>
      </div>
      <div class="import-intent-check" id="import-check-history" style="opacity:${isHistorical?1:0}">✓</div>
    </div>

    ${!isMerge ? `
    <div class="intake-section-label">Current 1RM (optional)</div>
    <div class="intake-maxes-row">
      <div class="intake-field">
        <label class="intake-field-label">Squat</label>
        <input class="intake-field-input" id="intake-max-s" type="number" inputmode="numeric" placeholder="—" value="${preMaxS}">
      </div>
      <div class="intake-field">
        <label class="intake-field-label">Bench</label>
        <input class="intake-field-input" id="intake-max-b" type="number" inputmode="numeric" placeholder="—" value="${preMaxB}">
      </div>
      <div class="intake-field">
        <label class="intake-field-label">Deadlift</label>
        <input class="intake-field-input" id="intake-max-d" type="number" inputmode="numeric" placeholder="—" value="${preMaxD}">
      </div>
    </div>

    <div class="intake-section-label">${isHistorical ? 'When did this block start?' : 'Start Date'}</div>
    <div class="intake-field">
      <input class="intake-field-input" id="intake-start-date" type="date" value="${preDate}">
    </div>
    ${isHistorical ? `
    <div style="margin-top:4px;padding:10px 12px;background:var(--surface-3);border-left:3px solid var(--gold);border-radius:0 8px 8px 0">
      <div style="font-family:'Barlow',sans-serif;font-size:12px;color:var(--text-primary);line-height:1.5">
        <span style="color:var(--gold);font-weight:700">Note:</span> Your active program won't change. All weeks will be marked complete using logged weights from the sheet.
      </div>
    </div>` : ''}` : ''}

    <button class="import-confirm-btn" onclick="intakeNext()">${isMerge ? 'Review New Weeks' : 'Review Program'}</button>
  `;
}

function selectImportIntent(intent) {
  _importIntent = intent;
  renderIntakeStep(); // re-render step 1 with new selection
}

// ── Step 2: Review Week 1 (or new weeks for merge) ───────────────────────
function renderIntakeStep2(body) {
  const blocks = _pendingImportBlocks || [];
  const b0 = blocks[0] || {};

  // For merge mode, calculate which weeks are actually new
  if (_importIntent === 'merge') {
    const targetId = _intakeMergeTarget || document.getElementById('import-merge-target')?.value;
    const target = state.blocks.find(b => b.id === targetId);
    if (!target) { confirmImportIntent(); return; }

    const { newWeeks } = computeMergeWeeks(blocks, target);

    if (newWeeks.length === 0) {
      // All weeks are duplicates — nothing to add
      body.innerHTML = `
        <div style="margin-bottom:6px">
          <div style="font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:900;color:var(--text-bright);letter-spacing:0.02em;text-align:center">Nothing New to Import</div>
          <div style="font-family:'Barlow',sans-serif;font-size:13px;color:var(--text-sub);margin-top:3px;text-align:center">All weeks in this file already exist in ${escH(displayBlockName(target.name))}.</div>
        </div>
        <button class="import-confirm-btn" onclick="closeImportIntent()">Done</button>
        <div style="display:flex;justify-content:center;margin-top:8px">
          <span class="intake-skip-link" onclick="intakeBack()">← Back</span>
        </div>
      `;
      return;
    }

    // Show the first new week for review
    const reviewWeek = newWeeks[0];
    let dayCardsHtml = '';
    for (const day of (reviewWeek.days || [])) {
      const exRows = (day.exercises || []).map(ex => `
        <div class="review-ex-row">
          <div class="review-ex-name">${escH(ex.name || 'Unnamed')}</div>
          <div class="review-ex-pres">${escH(ex.prescription || '')}</div>
          ${ex.note ? `<div class="review-ex-note">${escH(ex.note)}</div>` : ''}
        </div>`).join('');
      dayCardsHtml += `
        <div class="review-day-card">
          <div class="review-day-header">${escH(day.name || 'Day')}</div>
          ${exRows || '<div style="padding:8px 12px;font-size:12px;color:var(--text-dim)">No exercises found</div>'}
        </div>`;
    }

    body.innerHTML = `
      <div style="margin-bottom:6px">
        <div style="font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:900;color:var(--text-bright);letter-spacing:0.02em;text-align:center">Review New Weeks</div>
        <div style="font-family:'Barlow',sans-serif;font-size:13px;color:var(--text-sub);margin-top:3px;text-align:center">Adding ${newWeeks.length} new week${newWeeks.length===1?'':'s'} to ${escH(displayBlockName(target.name))}</div>
      </div>
      <div class="review-day-list">
        ${dayCardsHtml}
      </div>
      <button class="import-confirm-btn" onclick="confirmImportIntent()">Looks Good — Import</button>
      <div style="margin-top:10px;text-align:center">
        <span class="review-wrong-link" onclick="showReviewHelp()">Something doesn't look right</span>
      </div>
      <div id="review-help-msg" style="display:none;margin-top:12px;padding:12px 14px;background:var(--surface-3);border-left:3px solid var(--gold);border-radius:0 8px 8px 0">
        <div style="font-family:'Barlow',sans-serif;font-size:13px;color:var(--text-primary);line-height:1.6">
          The parser may not support your spreadsheet's layout. You can:
        </div>
        <div style="margin-top:8px;display:flex;flex-direction:column;gap:8px">
          <button class="colmap-btn-secondary" onclick="closeImportIntent()">Try a Different File</button>
          <button class="colmap-btn-secondary" onclick="confirmImportIntent()">Import Anyway</button>
        </div>
      </div>
      <div style="display:flex;justify-content:center;margin-top:8px">
        <span class="intake-skip-link" onclick="intakeBack()">← Back</span>
      </div>
    `;
    return;
  }

  // Standard review (Start New / Historical) — show first week
  const week1 = b0.weeks?.[0];

  if (!week1 || !week1.days?.length) {
    confirmImportIntent();
    return;
  }

  let dayCardsHtml = '';
  for (const day of week1.days) {
    const exRows = (day.exercises || []).map(ex => {
      const name = ex.name || 'Unnamed';
      const pres = ex.prescription || '';
      const note = ex.note || '';
      return `
        <div class="review-ex-row">
          <div class="review-ex-name">${escH(name)}</div>
          <div class="review-ex-pres">${escH(pres)}</div>
          ${note ? `<div class="review-ex-note">${escH(note)}</div>` : ''}
        </div>`;
    }).join('');

    dayCardsHtml += `
      <div class="review-day-card">
        <div class="review-day-header">${escH(day.name || 'Day')}</div>
        ${exRows || '<div style="padding:8px 12px;font-size:12px;color:var(--text-dim)">No exercises found</div>'}
      </div>`;
  }

  body.innerHTML = `
    <div style="margin-bottom:6px">
      <div style="font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:900;color:var(--text-bright);letter-spacing:0.02em;text-align:center">Review Week 1</div>
      <div style="font-family:'Barlow',sans-serif;font-size:13px;color:var(--text-sub);margin-top:3px;text-align:center">Check that your exercises and prescriptions look right</div>
    </div>
    <div class="review-day-list">
      ${dayCardsHtml}
    </div>
    <button class="import-confirm-btn" onclick="confirmImportIntent()">Looks Good — Import</button>
    <div style="margin-top:10px;text-align:center">
      <span class="review-wrong-link" onclick="showReviewHelp()">Something doesn't look right</span>
    </div>
    <div id="review-help-msg" style="display:none;margin-top:12px;padding:12px 14px;background:var(--surface-3);border-left:3px solid var(--gold);border-radius:0 8px 8px 0">
      <div style="font-family:'Barlow',sans-serif;font-size:13px;color:var(--text-primary);line-height:1.6">
        The parser may not support your spreadsheet's layout. You can:
      </div>
      <div style="margin-top:8px;display:flex;flex-direction:column;gap:8px">
        <button class="colmap-btn-secondary" onclick="closeImportIntent()">Try a Different File</button>
        <button class="colmap-btn-secondary" onclick="confirmImportIntent()">Import Anyway</button>
      </div>
    </div>
    <div style="display:flex;justify-content:center;margin-top:8px">
      <span class="intake-skip-link" onclick="intakeBack()">← Back</span>
    </div>
  `;
}

// ── (Steps 3 & 4 consolidated into Step 2 above) ────────────────────────

function showReviewHelp() {
  const el = document.getElementById('review-help-msg');
  if (el) el.style.display = el.style.display === 'none' ? 'block' : 'none';
}

function readIntakeFields() {
  // Read 1RM and date from step 1 fields if they exist
  const maxSEl = document.getElementById('intake-max-s');
  if (maxSEl) {
    const ath = loadAthlete() || {};
    _intakeCache = {
      name: ath.name || '',
      bodyweight: ath.bodyweight || 0,
      bwUnit: ath.bwUnit || 'lbs',
      gender: ath.gender || '',
      maxSquat: parseInt(document.getElementById('intake-max-s')?.value) || 0,
      maxBench: parseInt(document.getElementById('intake-max-b')?.value) || 0,
      maxDeadlift: parseInt(document.getElementById('intake-max-d')?.value) || 0,
      startDate: document.getElementById('intake-start-date')?.value || '',
    };
  }
  // Also cache merge target from Step 1 if present
  const mergeEl = document.getElementById('import-merge-target');
  if (mergeEl) _intakeMergeTarget = mergeEl.value;
  return _intakeCache || {};
}
let _intakeCache = null;
let _intakeMergeTarget = null;

function intakeNext() {
  if (_intakeStep === 1) {
    // Cache merge target and fields from step 1 before leaving
    const mergeEl = document.getElementById('import-merge-target');
    if (mergeEl) _intakeMergeTarget = mergeEl.value;
    readIntakeFields();
    _intakeStep = 2;
  } else {
    confirmImportIntent();
    return;
  }
  renderIntakeStep();
}

function intakeBack() {
  if (_intakeStep === 2) { _intakeStep = 1; }
  renderIntakeStep();
}

function confirmImportIntent() {
  const blocks = _pendingImportBlocks;
  if (!blocks) return;

  // Apply intake fields to blocks and athlete profile
  const intake = readIntakeFields();

  applyIntakeToBlocks(blocks, intake);
  applyIntakeToProfile(intake);

  closeImportIntent();

  // Close onboarding if still open and mark as complete
  if (!isOnboarded()) {
    finishOnboarding();
  }

  if (_importIntent === 'active') {
    blocks.forEach(b => { if (!b.startDate) b.startDate = new Date().toISOString().split('T')[0]; });
    mergeBlocks(blocks);
    autoRegisterCompLifts(blocks);
    populateLogsFromSheet(blocks);
    const _n = findNextWorkout(state.activeBlock);
    state.activeWeek = _n.weekIdx;
    state.activeDay  = _n.dayIdx;
    saveBlocks(); saveNav(); saveLogs();
    setScreen('home');
  } else if (_importIntent === 'merge') {
    mergeWeeksIntoBlock(blocks);
  } else {
    importHistoricalBlock(blocks);
  }
  _intakeCache = null;
  _intakeMergeTarget = null;
  render();
}

function applyIntakeToBlocks(blocks, intake) {
  if (!intake) return;
  for (const b of blocks) {
    if (intake.name) b.athleteName = intake.name;
    if (intake.maxSquat || intake.maxBench || intake.maxDeadlift) {
      b.maxes = b.maxes || {};
      if (intake.maxSquat) b.maxes.squat = intake.maxSquat;
      if (intake.maxBench) b.maxes.bench = intake.maxBench;
      if (intake.maxDeadlift) b.maxes.deadlift = intake.maxDeadlift;
    }
    if (intake.startDate) {
      b.startDate = intake.startDate;
      // Compute dateRange from start date + week count
      const d = new Date(intake.startDate + 'T00:00:00');
      const weekCount = b.weeks?.length || 1;
      const endDate = new Date(d.getTime() + (weekCount * 7 - 1) * 86400000);
      const fmt = (dt) => (dt.getMonth()+1) + '/' + dt.getDate() + '/' + String(dt.getFullYear()).slice(2);
      b.dateRange = fmt(d) + ' – ' + fmt(endDate);
    }
  }
}

function applyIntakeToProfile(intake) {
  if (!intake) return;
  const existing = loadAthlete() || {};
  const updated = { ...existing };
  if (intake.name) updated.name = intake.name;
  if (intake.gender) updated.gender = intake.gender;
  if (intake.bodyweight > 0) {
    updated.bodyweight = intake.bodyweight;
    updated.bwUnit = intake.bwUnit;
  }
  // Save tested 1RMs
  if (intake.maxSquat) updated.tested1rm_squat = intake.maxSquat;
  if (intake.maxBench) updated.tested1rm_bench = intake.maxBench;
  if (intake.maxDeadlift) updated.tested1rm_deadlift = intake.maxDeadlift;
  saveAthlete(updated);
}

// ── Smart merge helpers ────────────────────────────────────────────────
function weeksHaveSameExercises(weekA, weekB) {
  if (weekA.days.length !== weekB.days.length) return false;
  for (let i = 0; i < weekA.days.length; i++) {
    const namesA = weekA.days[i].exercises.map(e => e.name).join('|');
    const namesB = weekB.days[i].exercises.map(e => e.name).join('|');
    if (namesA !== namesB) return false;
  }
  return true;
}

function computeMergeWeeks(incomingBlocks, target) {
  const newWeeks = [];
  const skipped = [];
  // Find highest existing week number for renumbering
  let maxWeekNum = 0;
  for (const w of target.weeks) {
    const m = w.label.match(/(\d+)/);
    if (m) maxWeekNum = Math.max(maxWeekNum, parseInt(m[1]));
  }
  let nextNum = maxWeekNum + 1;

  for (const inc of incomingBlocks) {
    for (const incomingWeek of (inc.weeks || [])) {
      const existing = target.weeks.find(w => w.label === incomingWeek.label);
      if (!existing) {
        // No label collision — add as-is
        newWeeks.push(incomingWeek);
      } else if (weeksHaveSameExercises(existing, incomingWeek)) {
        // True duplicate — skip
        skipped.push(incomingWeek.label);
      } else {
        // Label collision but different content — renumber
        incomingWeek.label = 'Week ' + nextNum;
        nextNum++;
        newWeeks.push(incomingWeek);
      }
    }
  }
  return { newWeeks, skipped };
}

function mergeWeeksIntoBlock(incomingBlocks) {
  const targetId = _intakeMergeTarget || document.getElementById('import-merge-target')?.value;
  const target = state.blocks.find(b => b.id === targetId);
  if (!target) return;

  const { newWeeks } = computeMergeWeeks(incomingBlocks, target);

  if (newWeeks.length === 0) {
    // Nothing to add — shouldn't reach here (step 2 catches it), but be safe
    setScreen('workout');
    return;
  }

  // Track labels of newly added weeks
  const newWeekLabels = newWeeks.map(w => w.label);

  // Append new weeks
  for (const week of newWeeks) {
    target.weeks.push(week);
    // Populate logs only if the week has tracking data
    const hasAnyTracking = week.days.some(d =>
      d.exercises.some(ex => ex.loggedWeight || ex.trackingRaw)
    );
    if (hasAnyTracking) {
      populateLogsFromSheet([{ ...target, weeks: [week] }],
        { onlyWeekLabels: [week.label] });
    }
  }

  // Run dedup on the newly expanded block
  deduplicateExerciseNames([target]);

  // Extend dateRange
  if (target.startDate) {
    const totalWeeks = target.weeks.length;
    const d = new Date(target.startDate + 'T00:00:00');
    const endDate = new Date(d.getTime() + (totalWeeks * 7 - 1) * 86400000);
    const fmt = (dt) => (dt.getMonth()+1) + '/' + dt.getDate() + '/' + String(dt.getFullYear()).slice(2);
    target.dateRange = fmt(d) + ' – ' + fmt(endDate);
  }

  // Navigate to first new week
  state.activeBlock = state.blocks.find(b => b.id === targetId) || state.activeBlock;
  const firstNewWeekIdx = target.weeks.findIndex(w => newWeekLabels.includes(w.label));
  const next = findNextWorkout(state.activeBlock);
  if (firstNewWeekIdx >= 0 && next.weekIdx < firstNewWeekIdx) {
    state.activeWeek = firstNewWeekIdx;
    state.activeDay = 0;
  } else {
    state.activeWeek = next.weekIdx;
    state.activeDay = next.dayIdx;
  }

  autoRegisterCompLifts([target]);
  saveBlocks(); saveNav(); saveLogs();
  setScreen('workout');
}

function importHistoricalBlock(blocks) {
  const prevActive = state.activeBlock;

  // Merge blocks into state — insert at correct chronological position if startDate exists
  deduplicateExerciseNames(blocks);
  for (const inc of blocks) {
    const idx = state.blocks.findIndex(b => b.id === inc.id);
    if (idx !== -1) {
      state.blocks[idx] = inc;
    } else if (inc.startDate) {
      // Insert before the first block that starts after this one
      const insertIdx = state.blocks.findIndex(b => b.startDate && b.startDate > inc.startDate);
      if (insertIdx !== -1) state.blocks.splice(insertIdx, 0, inc);
      else {
        // No block with a later startDate — insert before activeBlock (historical goes before current)
        const activeIdx = state.blocks.indexOf(prevActive);
        if (activeIdx > 0) state.blocks.splice(activeIdx, 0, inc);
        else state.blocks.push(inc);
      }
    } else {
      // No date — insert before active block
      const activeIdx = state.blocks.indexOf(prevActive);
      if (activeIdx > 0) state.blocks.splice(activeIdx, 0, inc);
      else state.blocks.push(inc);
    }
  }
  // Restore active block — historical import never changes it
  state.activeBlock = prevActive || state.blocks[state.blocks.length - 1];

  // Tag blocks as historical so renderer knows not to show Finish Workout / Add Exercise
  blocks.forEach(b => { b.historical = true; });
  autoRegisterCompLifts(blocks);
  // Populate any logged weights from sheet
  populateLogsFromSheet(blocks);
  // Mark all remaining unlogged exercises as complete so metrics are fully populated
  markAllBlocksComplete(blocks);

  saveBlocks(); saveLogs();
  // Navigate to metrics so user sees data land
  setScreen('metrics');
}

function markAllBlocksComplete(blocks) {
  for (const block of blocks) {
    for (const week of (block.weeks || [])) {
      for (const day of (week.days || [])) {
        for (const ex of (day.exercises || [])) {
          const key = lk(block.id, week.label, day.name, ex.name);
          // Only mark if not already logged with real data
          if (!state.logs[key]?.done || state.logs[key]?.inferredComplete) {
            state.logs[key] = { done: true, inferredComplete: true };
          }
          // Mark sets
          const setCount = countPrescrSets(ex.prescription);
          for (let si = 0; si < setCount; si++) {
            const sk = key + '||s' + si;
            if (!state.logs[sk]?.done || state.logs[sk]?.inferredComplete) {
              state.logs[sk] = { done: true, inferredComplete: true };
            }
          }
        }
        // Set force-complete flag for the day
        const forceKey = lk(block.id, week.label, day.name, '__complete__');
        if (!state.logs[forceKey]) {
          state.logs[forceKey] = { done: true, historical: true };
        }
      }
    }
  }
}

function dismissCelebration() {
  const overlay = document.getElementById('celebration-overlay');
  if (overlay) overlay.classList.remove('visible');
  if (_celebrationCallback) {
    const cb = _celebrationCallback;
    _celebrationCallback = null;
    setTimeout(cb, 200);
  }
}

function autoCompleteExercise(setKey){
  // Extract exercise key from set key: blockId||week||day||exercise||sN → blockId||week||day||exercise
  const parts=setKey.split('||');
  if(parts.length!==5) return; // Not a set key
  const exKey=parts.slice(0,4).join('||');
  
  // Count sets for this exercise
  const block=state.activeBlock;
  if(!block) return;
  const week=block.weeks[state.activeWeek];
  if(!week) return;
  const day=week.days[state.activeDay];
  if(!day) return;
  const ex=day.exercises.find(e=>lk(block.id,week.label,day.name,e.name)===exKey);
  if(!ex) return;
  
  const pres=ex.prescription;
  const sets=pres?parseSets(pres):[];
  if(!sets.length && pres) { const wu=parseWarmupSets(pres); if(wu.length) sets.push(...wu); }
  const simple=parseSimple(pres);
  const ranged=(!sets.length&&!simple)?parseRangeSet(pres):null;
  const totalSets=sets.length||(simple?.sets||0)||(ranged?.sets||0)||(pres?1:0)||1;
  
  // Check if all sets done
  let allDone=true;
  for(let si=0;si<totalSets;si++){
    const sk=exKey+`||s${si}`;
    if(!state.logs[sk]?.done){ allDone=false; break; }
  }
  
  // If all sets done, mark exercise done and update checkmark directly
  if(allDone&&!state.logs[exKey]?.done){
    state.logs[exKey]={...(state.logs[exKey]||{}),done:true};
    saveLogs();
    // Update main exercise checkmark without full render
    updateExerciseCheckmark(exKey,true);
    // Check if whole day is now resolved — activate finish button and scroll it into view
    checkAndActivateFinishButton(block, week, day);
  } else if(!allDone&&state.logs[exKey]?.done){
    // If sets were unchecked, uncheck exercise and clear force-complete flag
    state.logs[exKey]={...(state.logs[exKey]||{}),done:false};
    const _b=state.activeBlock,_w=_b?.weeks[state.activeWeek],_d=_w?.days[state.activeDay];
    if(_d){ const fk=lk(_b.id,_w.label,_d.name,'__complete__'); delete state.logs[fk]; }
    saveLogs();
    updateExerciseCheckmark(exKey,false);
  }
}
function checkAndActivateFinishButton(block, week, day) {
  if (!block || !week || !day) return;
  const totalEx = day.exercises.length;
  const resolvedEx = day.exercises.filter(ex => {
    const log = state.logs[lk(block.id, week.label, day.name, ex.name)] || {};
    return log.done || log.skipped;
  }).length;
  if (resolvedEx === totalEx && totalEx > 0) {
    // Stamp completedDate on __complete__ key — ensures every finished day has a timestamp
    const forceKey = lk(block.id, week.label, day.name, '__complete__');
    const existing = state.logs[forceKey] || {};
    if (!existing.completedDate) {
      const _t = new Date();
      state.logs[forceKey] = { ...existing, done: true, completedDate: `${_t.getFullYear()}-${_t.getMonth()+1}-${_t.getDate()}` };
      saveLogs();
    }
    const btn = document.querySelector('.complete-workout-btn');
    if (btn && !btn.classList.contains('ready')) {
      btn.classList.add('ready');
      btn.disabled = false;
      btn.textContent = 'Finish Workout';
      // Scroll into view after last checkmark animation settles
      setTimeout(() => {
        btn.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }, 300);
    }
  }
}
function updateExerciseCheckmark(exKey,isDone){
  const escaped=exKey.replace(/'/g,"\\'");
  const btn=document.querySelector(`button.exercise-check[onclick*="toggleEx('${escaped}')"]`);
  if(btn){
    btn.className=isDone?'exercise-check done':'exercise-check';
    btn.innerHTML=isDone?_checkSvg:'';
  }
}
function setNote(key,v){ state.logs[key]={...(state.logs[key]||{}),notes:v}; saveLogs(); }
function getPrevWeekNote(blockId,weekLabel,dayName,exName){
  // Find the most recent previous week that has a lifter note for this exercise
  const block=state.blocks.find(b=>b.id===blockId);
  if(!block) return null;
  const curIdx=block.weeks.findIndex(w=>w.label===weekLabel);
  if(curIdx<=0) return null;
  // Search backwards through previous weeks
  for(let i=curIdx-1;i>=0;i--){
    const w=block.weeks[i];
    const day=w.days.find(d=>d.name===dayName);
    if(!day) continue;
    const ex=day.exercises.find(e=>e.name===exName);
    if(!ex) continue;
    const key=[blockId,w.label,dayName,exName].join('||');
    const note=state.logs[key]?.notes;
    if(note&&note.trim()) return note.trim();
  }
  return null;
}
function getPrevWeekPerformance(blockId,weekLabel,dayName,exName){
  function getSets(key){
    const sets=[];
    for(let si=0;si<20;si++){
      const sl=state.logs[key+'||s'+si];
      if(!sl) break;
      sets.push({actual:sl.actual||'—',rpe:sl.rpe||'',done:sl.done});
    }
    return sets;
  }
  // Phase 1: search current block backwards
  const block=state.blocks.find(b=>b.id===blockId);
  if(block){
    const curIdx=block.weeks.findIndex(w=>w.label===weekLabel);
    for(let i=(curIdx>0?curIdx-1:block.weeks.length-1);i>=0;i--){
      if(i>=curIdx) break;
      const w=block.weeks[i];
      const day=w.days.find(d=>d.name===dayName);
      if(!day) continue;
      if(!day.exercises.find(e=>e.name===exName)) continue;
      const key=[blockId,w.label,dayName,exName].join('||');
      if(!state.logs[key]?.done) continue;
      const sets=getSets(key);
      if(sets.length>0) return {label:w.label,source:null,sets};
    }
  }
  // Phase 2: search other blocks (most recent first)
  for(let bi=state.blocks.length-1;bi>=0;bi--){
    const b=state.blocks[bi];
    if(b.id===blockId) continue;
    for(let wi=b.weeks.length-1;wi>=0;wi--){
      const w=b.weeks[wi];
      for(const d of w.days){
        if(!d.exercises.find(e=>e.name===exName)) continue;
        const key=[b.id,w.label,d.name,exName].join('||');
        if(!state.logs[key]?.done) continue;
        const sets=getSets(key);
        if(sets.length>0) return {label:w.label,source:b.name||b.id,sets};
      }
    }
  }
  return null;
}

function toggleExpand(key, groupEncoded){
  const groupKeys=groupEncoded?groupEncoded.split(':::'):null;
  if(groupKeys&&groupKeys.length>1){
    const allOpen=groupKeys.every(k=>state.expandedEx.has(k));
    if(allOpen){ groupKeys.forEach(k=>state.expandedEx.delete(k)); }
    else { groupKeys.forEach(k=>state.expandedEx.add(k)); }
  } else {
    if(state.expandedEx.has(key)){ state.expandedEx.delete(key); }
    else { state.expandedEx.add(key); }
  }
  render();
  // Always anchor back to the card that was tapped — handles both open and close,
  // and correctly accounts for other cards collapsing above/below this one.
  requestAnimationFrame(()=>{
    const card=document.querySelector(`.exercise-card[data-expand-key="${CSS.escape(key)}"]`);
    if(card) card.scrollIntoView({block:'nearest',behavior:'instant'});
  });
}
function findNextWorkout(block){
  if(!block) return {weekIdx:0, dayIdx:0};
  // Check if we should advance based on Sunday boundary
  checkWeekProgression(block);
  const startWi = block._currentWeekIdx || 0;
  for(let wi=startWi;wi<block.weeks.length;wi++){
    const week=block.weeks[wi];
    for(let di=0;di<week.days.length;di++){
      if(!isDayComplete(block,week,week.days[di])) return {weekIdx:wi, dayIdx:di};
    }
  }
  // All complete from startWi onward — stay on last day of last week
  const lastWi=block.weeks.length-1;
  return {weekIdx:lastWi, dayIdx:(block.weeks[lastWi]?.days.length||1)-1};
}

// Silent calendar: track current training week with Sunday midnight boundaries.
// Stored per-block as _currentWeekIdx (int) and _weekActivatedAt (ISO date string).
// Advances to next week when: (1) Sunday has passed since activation AND (2) all days in current week are done.
// Memory + localStorage — persists across sessions.
function checkWeekProgression(block) {
  if (!block || !block.weeks || block.weeks.length <= 1) return;

  // Initialize if not set
  if (block._currentWeekIdx == null) {
    block._currentWeekIdx = 0;
    block._weekActivatedAt = new Date().toISOString().split('T')[0];
    saveBlocks();
  }

  // Loop: advance through all completed weeks (not just one at a time)
  let changed = false;
  while (block._currentWeekIdx < block.weeks.length - 1) {
    const wi = block._currentWeekIdx;
    const week = block.weeks[wi];
    if (!week) break;

    // Check if all days with exercises are complete
    const hasDays = week.days.some(d => d.exercises && d.exercises.length > 0);
    if (!hasDays) break;
    const allDone = week.days
      .filter(d => d.exercises && d.exercises.length > 0)
      .every(d => isDayComplete(block, week, d));
    if (!allDone) break; // stay on current week

    // Check if a Sunday midnight has passed since this week was activated
    const activated = new Date(block._weekActivatedAt + 'T00:00:00');
    const now = new Date();

    // Find the first Sunday at midnight after activation
    const activatedDay = activated.getDay(); // 0=Sun
    const daysUntilSunday = activatedDay === 0 ? 7 : (7 - activatedDay);
    const nextSunday = new Date(activated);
    nextSunday.setDate(nextSunday.getDate() + daysUntilSunday);
    nextSunday.setHours(0, 0, 0, 0);

    if (now >= nextSunday) {
      // Advance to next week and keep checking
      block._currentWeekIdx = wi + 1;
      block._weekActivatedAt = now.toISOString().split('T')[0];
      changed = true;
    } else {
      break; // Sunday hasn't passed yet for this week
    }
  }
  if (changed) saveBlocks();
}
function setWeek(wi){ state.activeWeek=wi; state.activeDay=0; state.expandedEx=new Set(); _workoutScrollY=0; saveNav(); render(); window.scrollTo(0,0); }
function setDay(di){ state.activeDay=di; state.expandedEx=new Set(); _workoutScrollY=0; saveNav(); render(); window.scrollTo(0,0); }
function switchBlock(id){ const b=state.blocks.find(b=>b.id===id); if(b){ const next=findNextWorkout(b); state.activeBlock=b; state.activeWeek=next.weekIdx; state.activeDay=next.dayIdx; state.editingBlockName=false; _workoutScrollY=0; saveNav(); render(); window.scrollTo(0,0); } }


document.getElementById('file-input').addEventListener('change',async(e)=>{
  const file=e.target.files?.[0]; if(!file) return;
  // Hide onboarding temporarily so import intent modal is visible
  const onboardEl = document.getElementById('onboarding-overlay');
  const wasOnboarding = onboardEl && onboardEl.style.display !== 'none';
  if (wasOnboarding) {
    onboardEl.style.display = 'none';
    document.querySelector('.bottom-nav').style.display = '';
    document.querySelector('.header').style.display = '';
  }
  try{
    const data=await file.arrayBuffer();
    if(data.byteLength > 10*1024*1024){ showParseError('File is too large (max 10 MB). Try reducing the number of sheets.'); return; }
    const wb=XLSX.read(data);
    wb._plFilename = file.name;
    const blocks=parseWorkbook(wb);
    if(!blocks||blocks.length===0){ openColumnMapper(wb); return; }
    const namePart=file.name.replace(/\.xlsx?$/i,'').replace(/_/g,' ').trim();
    blocks.forEach(b=>{ if(b.athleteName==='Athlete') b.athleteName=namePart; if(b.name==='Training Program') b.name=namePart; });
    openImportIntent(blocks);
  }catch(err){
    showParseError('error', err.message); console.error(err);
    // If parse failed and was in onboarding, return to upload step
    if (wasOnboarding) { showOnboardingStep(3); }
  }
  e.target.value='';
});

// ── PROGRAM MANAGER ───────────────────────────────────────────────────────────
let _pendingDeleteBlockId=null;

function openProgramModal(){
  renderProgramList();
  document.getElementById('program-modal').style.display='flex';
}
function closeProgramModal(){
  document.getElementById('program-modal').style.display='none';
}
function renderProgramList(){
  const list=document.getElementById('program-list');
  if(!state.blocks.length){ list.innerHTML='<div style="font-size:13px;color:var(--text-dim);padding:8px 0">No programs loaded yet.</div>'; return; }
  let h='<div class="add-lift-group-label" style="margin-bottom:8px">Existing Programs</div>';
  state.blocks.forEach(block=>{
    const isCurrent=state.activeBlock&&state.activeBlock.id===block.id;
    const weeks=block.weeks?.length||0;
    h+=`<div class="program-item" style="flex-wrap:wrap;">
      <div class="program-item-info" onclick="selectBlock('${esc(block.id)}')">
        <div class="program-item-name${isCurrent?' active-cycle':''}">${escH(displayBlockName(block.name))}</div>
        <div class="program-item-meta">${weeks} weeks${block.dateRange?' · '+block.dateRange:''}</div>
      </div>
      <div class="program-item-actions">
        <button class="program-select-btn${isCurrent?' current':''}" onclick="selectBlock('${esc(block.id)}')">${isCurrent?'ACTIVE':'SELECT'}</button>
        <button class="program-delete-btn" onclick="event.stopPropagation();promptDeleteBlock('${esc(block.id)}')" title="Delete program"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6M14 11v6"/><path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg></button>
      </div>
    </div>`;
  });
  list.innerHTML=h;
}
function selectBlock(blockId){
  const block=state.blocks.find(b=>b.id===blockId);
  if(!block) return;
  state.activeBlock=block; state.activeWeek=0; state.activeDay=0;
  closeProgramModal();
  render();
}
function promptDeleteBlock(blockId){
  const block=state.blocks.find(b=>b.id===blockId);
  if(!block) return;
  _pendingDeleteBlockId=blockId;
  document.getElementById('delete-modal-name').textContent=displayBlockName(block.name);
  document.getElementById('delete-modal').style.display='flex';
}
function closeDeleteModal(){
  _pendingDeleteBlockId=null;
  document.getElementById('delete-modal').style.display='none';
}
function confirmDeleteBlock(){
  if(!_pendingDeleteBlockId) return;
  const blockId=_pendingDeleteBlockId;
  for(const key of Object.keys(state.logs)){
    if(key.startsWith(blockId+'||')) delete state.logs[key];
  }
  saveLogs();
  state.blocks=state.blocks.filter(b=>b.id!==blockId);
  if(state.activeBlock?.id===blockId){
    state.activeBlock=state.blocks[state.blocks.length-1]||null;
    state.activeWeek=0; state.activeDay=0;
  }
  saveBlocks();
  closeDeleteModal();
  closeProgramModal();
  render();
}

document.getElementById('new-btn') && document.getElementById('new-btn').addEventListener('click', openProgramModal);

// ── SETTINGS ──────────────────────────────────────────────────────────────────
function openSettings(scrollTo) {
  const modal = document.getElementById('settings-modal');
  if (!modal) return;
  updateSettingsThemePills();
  modal.style.display = 'flex';
  requestAnimationFrame(() => {
    modal.classList.add('open');
    if (scrollTo) {
      const el = document.getElementById(scrollTo);
      if (el) setTimeout(() => el.scrollIntoView({ behavior: 'smooth', block: 'center' }), 180);
    }
  });
}
function closeSettings() {
  const modal = document.getElementById('settings-modal');
  if (!modal) return;
  modal.classList.remove('open');
  // Close athlete profile form if open
  const form = document.getElementById('athlete-profile-form');
  if (form) { form.classList.remove('open'); }
  const arrow = document.getElementById('athlete-profile-arrow');
  if (arrow) arrow.style.transform = '';
  setTimeout(() => { modal.style.display = 'none'; }, 200);
}
function updateSettingsThemePills() {
  const cur = loadTheme();
  document.querySelectorAll('.settings-theme-pill').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.theme === cur);
  });
}
function openExportFromSettings() {
  const blockId = state.activeBlock ? state.activeBlock.id : null;
  if (!blockId) return;
  openExportModal(blockId);
}
// ── EXPORT REPORT ─────────────────────────────────────────────────────────────
function openExportModal(blockId) {
  const existing = document.getElementById('export-modal-overlay');
  if (existing) existing.remove();

  const overlay = document.createElement('div');
  overlay.className = 'export-modal-overlay';
  overlay.id = 'export-modal-overlay';
  overlay.onclick = (e) => { if (e.target === overlay) closeExportModal(); };

  overlay.innerHTML = `
  <div class="export-modal">
    <div class="export-modal-header">
      <span class="export-modal-title">Export</span>
      <button class="export-modal-close" onclick="closeExportModal()">✕</button>
    </div>

    <!-- Training Log Card -->
    <div class="export-card">
      <div class="export-card-header">
        <svg class="export-card-icon" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect width="36" height="36" rx="8" fill="#1D6F42"/>
          <rect x="7" y="9" width="22" height="3" rx="1" fill="white" opacity="0.9"/>
          <rect x="7" y="14" width="22" height="1.5" rx="0.75" fill="white" opacity="0.4"/>
          <rect x="7" y="17.5" width="22" height="1.5" rx="0.75" fill="white" opacity="0.4"/>
          <rect x="7" y="21" width="22" height="1.5" rx="0.75" fill="white" opacity="0.4"/>
          <rect x="7" y="24.5" width="14" height="1.5" rx="0.75" fill="white" opacity="0.4"/>
          <rect x="23" y="22" width="7" height="7" rx="1" fill="#1D6F42"/>
          <path d="M24.5 25.5L26.5 27.5L29 24" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <div class="export-card-info">
          <div class="export-card-name">Training Log</div>
          <div class="export-card-desc">Full workout log with prescribed vs. actual sets — Excel file</div>
        </div>
      </div>
      <div class="export-scope-toggle">
        <button class="export-scope-pill active" id="log-scope-week" onclick="setLogScope('week')">This Week</button>
        <button class="export-scope-pill" id="log-scope-full" onclick="setLogScope('full')">Full Block</button>
      </div>
      <button class="export-action-btn" onclick="exportTrainingLog('${blockId}')">Download Excel</button>
    </div>

    <!-- Training Report Card -->
    <div class="export-card">
      <div class="export-card-header">
        <svg class="export-card-icon" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect width="36" height="36" rx="8" fill="#C9A84C"/>
          <rect x="8" y="22" width="4" height="6" rx="1" fill="white" opacity="0.5"/>
          <rect x="14" y="17" width="4" height="11" rx="1" fill="white" opacity="0.7"/>
          <rect x="20" y="13" width="4" height="15" rx="1" fill="white" opacity="0.85"/>
          <rect x="26" y="8" width="4" height="20" rx="1" fill="white" opacity="1"/>
          <line x1="6" y1="29" x2="32" y2="29" stroke="white" stroke-width="1" opacity="0.3"/>
        </svg>
        <div class="export-card-info">
          <div class="export-card-name">Training Report</div>
          <div class="export-card-desc">Squat / Bench / Deadlift progressions with charts — full block</div>
        </div>
      </div>
      <div style="display:flex;gap:8px">
        <button class="export-action-btn" style="flex:1" onclick="exportHTMLReport('${blockId}','summary');closeExportModal()">Coach Summary</button>
        <button class="export-action-btn" style="flex:1" onclick="exportHTMLReport('${blockId}','full');closeExportModal()">Full Report</button>
      </div>
      <div style="text-align:center;font-size:11px;color:var(--text-dim);margin-top:8px;letter-spacing:0.03em">Save as PDF via share sheet ↑</div>
    </div>
  </div>`;

  document.body.appendChild(overlay);
  // Default log scope state
  overlay._logScope = 'week';
}

function closeExportModal() {
  const overlay = document.getElementById('export-modal-overlay');
  if (overlay) overlay.remove();
}

function setLogScope(scope) {
  const overlay = document.getElementById('export-modal-overlay');
  if (!overlay) return;
  overlay._logScope = scope;
  document.getElementById('log-scope-week').classList.toggle('active', scope === 'week');
  document.getElementById('log-scope-full').classList.toggle('active', scope === 'full');
}

function exportTrainingLog(blockId) {
  const overlay = document.getElementById('export-modal-overlay');
  const scope = overlay ? overlay._logScope : 'full';

  const block = state.blocks.find(b => b.id === blockId);
  if (!block) return;

  let weeks = block.weeks || [];
  if (scope === 'week') {
    const activeWeekLabel = block.weeks[state.activeWeek]?.label;
    weeks = block.weeks.filter(w => w.label === activeWeekLabel);
    if (!weeks.length) { _showWarningToast('No data for current week.'); return; }
  }

  const blockLogs = {};
  for (const [key, val] of Object.entries(state.logs)) {
    if (key.startsWith(blockId + '||')) blockLogs[key] = val;
  }

  const wb = XLSX.utils.book_new();

  // Style presets
  const DAY_HEAD_STYLE = {
    font: { bold: true, sz: 11, color: { rgb: 'FFFFFF' } },
    fill: { fgColor: { rgb: '111111' }, patternType: 'solid' },
    alignment: { horizontal: 'left', vertical: 'center' }
  };

  for (const week of weeks) {
    const rows = [];
    const styleMap = {};
    const r = () => rows.length;
    const days = week.days || [];

    for (let di = 0; di < days.length; di++) {
      const day = days[di];

      // Blank separator between day blocks (not before first)
      if (di > 0) rows.push([]);

      // Day header row: day name + column labels
      rows.push([day.name, 'Sets × Reps @RPE', 'Record Weight & RPE', 'Coach Notes', 'Lifter Notes']);
      styleMap[r() - 1] = DAY_HEAD_STYLE;

      for (const ex of (day.exercises || [])) {
        // Determine set count from prescription parsers
        const sets = parseSets(ex.prescription) || [];
        let setCount = sets.length;
        let fallbackReps = null;
        if (!setCount) {
          const simple = parseSimple(ex.prescription);
          const ranged = parseRangeSet(ex.prescription);
          const bare = parseBarePres(ex.prescription);
          setCount = (simple && simple.sets) || (ranged && ranged.sets) || (bare && bare.sets) || 1;
          fallbackReps = (simple && simple.reps) || (ranged && ranged.reps) || (bare && bare.reps) || null;
        }

        // Include extra sets added via "+ Set"
        const exKey = [blockId, week.label, day.name, ex.name].join('||');
        const extra = state.extraSets ? (state.extraSets[exKey] || 0) : 0;
        const totalSets = setCount + extra;

        // Check if skipped
        const exLog = blockLogs[exKey] || {};
        let loggedStr = '';

        if (exLog.skipped) {
          loggedStr = 'SKIPPED';
        } else {
          // Collect logged set entries into collapsed string
          const loggedParts = [];
          for (let si = 0; si < totalSets; si++) {
            const sk = exKey + '||s' + si;
            const log = blockLogs[sk] || {};
            if (log.actual || log.done) {
              const weight = log.actual || (sets[si] && !sets[si].isRpe ? String(sets[si].weight) : '');
              const repsRaw = sets[si] ? sets[si].reps : fallbackReps;
              const reps = repsRaw === 'open' ? '?' : (repsRaw || '?');
              let part = weight ? `${weight}x${reps}` : `${reps} reps`;
              if (log.rpe) part += ` @${log.rpe}`;
              loggedParts.push(part);
            }
          }
          loggedStr = loggedParts.join(', ');
        }

        // Coach notes: ex.note + ex.coachNotes[]
        const coachParts = [];
        if (ex.note) coachParts.push(ex.note);
        if (ex.coachNotes && ex.coachNotes.length) coachParts.push(...ex.coachNotes);
        const coachNotesStr = coachParts.join('; ');

        // Lifter notes from logs
        const lifterNotes = exLog.notes || '';

        // Single row per exercise
        rows.push([ex.name, ex.prescription || '', loggedStr, coachNotesStr, lifterNotes]);
      }
    }

    // Build sheet
    const ws = XLSX.utils.aoa_to_sheet(rows);

    // Column widths
    ws['!cols'] = [
      { wch: 32 }, // Exercise name
      { wch: 30 }, // Prescription
      { wch: 38 }, // Logged
      { wch: 28 }, // Coach Notes
      { wch: 28 }, // Lifter Notes
    ];

    // Apply styles
    const range = XLSX.utils.decode_range(ws['!ref'] || 'A1');
    for (let R = range.s.r; R <= range.e.r; R++) {
      const style = styleMap[R];
      if (!style) continue;
      for (let C = range.s.c; C <= range.e.c; C++) {
        const addr = XLSX.utils.encode_cell({ r: R, c: C });
        if (!ws[addr]) ws[addr] = { t: 's', v: '' };
        ws[addr].s = style;
      }
    }

    // Sheet name: "W1", "W2", etc. — XLSX sheet names max 31 chars
    const sheetName = week.label.replace(/[:\\/?*[\]]/g, '').slice(0, 31);
    XLSX.utils.book_append_sheet(wb, ws, sheetName);
  }

  const dateStr = new Date().toISOString().slice(0, 10);
  const safeName = displayBlockName(block.name).replace(/[^a-z0-9]/gi, '-').toLowerCase() || 'training';
  const scopeStr = scope === 'week' ? '-' + (block.weeks[state.activeWeek]?.label || 'week').toLowerCase().replace(/\s+/g, '') : '';
  XLSX.writeFile(wb, `${safeName}-training-log${scopeStr}-${dateStr}.xlsx`, { cellStyles: true });

  closeExportModal();
}

function exportHTMLReport(blockId, scope) {
  const block = state.blocks.find(b => b.id === blockId);
  if (!block) return;
  const weeks = block.weeks || [];

  const blockLogs = {};
  for (const [key, val] of Object.entries(state.logs)) {
    if (key.startsWith(blockId + '||')) blockLogs[key] = val;
  }

  const FAMILY_COLORS = ['#C9A84C','#7B9FD4','#7EC89A','#D47B7B','#B07BD4','#D4A97B','#7BD4D4'];
  const cs = getComputedStyle(document.documentElement);
  const tv = (v) => cs.getPropertyValue(v).trim();

  // ── Gather e1RM data by family → exercise → week ─────────────────────────
  const families = { squat: {}, bench: {}, deadlift: {} };

  for (const [key, val] of Object.entries(blockLogs)) {
    const parts = key.split('||');
    if (parts.length < 5 || !parts[4].startsWith('s')) continue;
    const exName = parts[3];
    const group = classifyLift(exName);
    if (!group || !families[group]) continue;

    const si = parseInt(parts[4].slice(1));
    const weight = val.actual ? parseFloat(val.actual) : getPrescribedWeight(parts[0], parts[1], parts[2], exName, si);
    if (!weight || isNaN(weight) || weight <= 0) continue;
    const reps = val.actualReps ? parseInt(val.actualReps) : getSetReps(parts[0], parts[1], parts[2], exName, si);
    if (!reps) continue;
    const rpe = val.rpe ? parseFloat(val.rpe) : null;
    const result = calc1rm(weight, reps, rpe);
    if (!result) continue;

    const weekLabel = parts[1];
    if (!families[group][exName]) families[group][exName] = {};
    if (!families[group][exName][weekLabel])
      families[group][exName][weekLabel] = { e1rm: 0, topWeight: 0, topReps: 0, topRpe: null, method: 'epley' };
    const w = families[group][exName][weekLabel];
    if (result.value > w.e1rm) { w.e1rm = result.value; w.topWeight = weight; w.topReps = reps; w.topRpe = rpe; w.method = result.method; }
  }

  // ── Compliance + volume + RPE + rep completion ───────────────────────────
  let totalDays = 0, completedDays = 0, totalSets = 0, totalVolume = 0;
  let totalRpe = 0, rpeCount = 0;
  const volumeByFamily = { squat: 0, bench: 0, deadlift: 0, other: 0 };
  const volumeByWeekFamily = {}; // weekLabel -> {squat,bench,deadlift,other}
  const rpeBuckets = { '9+': 0, '8': 0, '7': 0, '6': 0, '<=5': 0 };
  let prescribedRepsTotal = 0, actualRepsTotal = 0;
  const repsByFamily = { squat: { prescribed: 0, actual: 0 }, bench: { prescribed: 0, actual: 0 }, deadlift: { prescribed: 0, actual: 0 } };
  let overrideCount = 0, checkedSetCount = 0;

  for (const week of weeks) {
    for (const day of (week.days || [])) {
      totalDays++;
      if (isDayComplete(block, week, day)) completedDays++;
    }
  }

  for (const [key, val] of Object.entries(blockLogs)) {
    const parts = key.split('||');
    if (parts.length < 5 || !parts[4].startsWith('s')) continue;
    if (!val.done) continue;
    checkedSetCount++;
    const exName = parts[3];
    const si = parseInt(parts[4].slice(1));
    const weight = val.actual ? parseFloat(val.actual) : getPrescribedWeight(parts[0], parts[1], parts[2], exName, si);
    const prescReps = getSetReps(parts[0], parts[1], parts[2], exName, si);
    const actualReps = val.actualReps ? parseInt(val.actualReps) : prescReps;
    if (weight && !isNaN(weight) && weight > 0 && actualReps) {
      totalSets++;
      const vol = weight * actualReps;
      totalVolume += vol;
      const group = classifyLift(exName) || 'other';
      volumeByFamily[group] = (volumeByFamily[group] || 0) + vol;
      const wl = parts[1];
      if (!volumeByWeekFamily[wl]) volumeByWeekFamily[wl] = { squat: 0, bench: 0, deadlift: 0, other: 0 };
      volumeByWeekFamily[wl][group] = (volumeByWeekFamily[wl][group] || 0) + vol;

      // Rep completion tracking
      if (prescReps) {
        prescribedRepsTotal += prescReps;
        actualRepsTotal += actualReps;
        if (repsByFamily[group]) {
          repsByFamily[group].prescribed += prescReps;
          repsByFamily[group].actual += actualReps;
        }
        if (val.actualReps) overrideCount++;
      }
    }
    // RPE tracking
    if (val.rpe) {
      const r = parseFloat(val.rpe);
      if (!isNaN(r)) {
        totalRpe += r; rpeCount++;
        if (r >= 9) rpeBuckets['9+']++;
        else if (r >= 8) rpeBuckets['8']++;
        else if (r >= 7) rpeBuckets['7']++;
        else if (r >= 6) rpeBuckets['6']++;
        else rpeBuckets['<=5']++;
      }
    }
  }

  const compliancePct = totalDays > 0 ? Math.round(completedDays / totalDays * 100) : 0;
  const avgRpe = rpeCount > 0 ? (totalRpe / rpeCount).toFixed(1) : '—';

  // ── Best comp lift e1RM per family ──────────────────────────────────────
  function getBestCompVariation(groupKey) {
    const exercises = families[groupKey];
    const exNames = Object.keys(exercises);
    if (!exNames.length) return null;
    // Rank: comp lift > any variation
    const compNames = exNames.filter(n => isCompLift(n));
    const isVariation = compNames.length === 0;
    // Comp lifts first; if none, pick variation with best overall e1RM
    let primary;
    if (compNames.length) {
      primary = compNames[0];
    } else {
      let bestVal = 0;
      primary = exNames[0];
      for (const n of exNames) {
        for (const d of Object.values(exercises[n])) {
          if (d.e1rm > bestVal) { bestVal = d.e1rm; primary = n; }
        }
      }
    }
    // Best e1RM across all weeks for primary
    let bestWeek = null, bestE1rm = 0;
    for (const [wl, data] of Object.entries(exercises[primary])) {
      if (data.e1rm > bestE1rm) { bestE1rm = data.e1rm; bestWeek = wl; }
    }
    // First and last week e1RM for delta
    const allWeeks = Object.keys(exercises[primary]).sort((a, b) => sessionOrder(a) - sessionOrder(b));
    const firstWeek = allWeeks[0];
    const lastWeek = allWeeks[allWeeks.length - 1];
    const startE1rm = exercises[primary][firstWeek]?.e1rm || 0;
    const endE1rm = exercises[primary][lastWeek]?.e1rm || 0;
    const bestData = exercises[primary][bestWeek];
    return {
      name: primary, isVariation, bestE1rm: Math.round(bestE1rm),
      startE1rm: Math.round(startE1rm), endE1rm: Math.round(endE1rm),
      delta: Math.round(endE1rm - startE1rm),
      bestWeight: bestData?.topWeight, bestReps: bestData?.topReps, bestRpe: bestData?.topRpe
    };
  }

  const compLifts = {
    squat: getBestCompVariation('squat'),
    bench: getBestCompVariation('bench'),
    deadlift: getBestCompVariation('deadlift')
  };

  // ── Estimated total + DOTS/Wilks ─────────────────────────────────────────
  const estTotal = (compLifts.squat?.bestE1rm || 0) + (compLifts.bench?.bestE1rm || 0) + (compLifts.deadlift?.bestE1rm || 0);
  const athlete = loadAthlete();
  let dotsScore = null, wilksScore = null;
  if (athlete?.bodyweight && athlete?.gender && estTotal > 0) {
    const bwKg = athlete.bwUnit === 'kg' ? athlete.bodyweight : athlete.bodyweight / 2.20462;
    const totalKg = estTotal / 2.20462;
    dotsScore = calcDOTS(bwKg, totalKg, athlete.gender);
    wilksScore = calcWilks(bwKg, totalKg, athlete.gender);
  }

  // ── Weekly top sets table ────────────────────────────────────────────────
  function getWeeklyTopSet(groupKey, weekLabel) {
    const exercises = families[groupKey];
    let bestComp = null, bestVar = null;
    for (const [exName, weekData] of Object.entries(exercises)) {
      const d = weekData[weekLabel];
      if (!d) continue;
      const isComp = isCompLift(exName);
      if (isComp && (!bestComp || d.e1rm > bestComp.e1rm)) {
        bestComp = { ...d, exName, isVariation: false };
      } else if (!isComp && (!bestVar || d.e1rm > bestVar.e1rm)) {
        bestVar = { ...d, exName, isVariation: true };
      }
    }
    return bestComp || bestVar;
  }

  const weekLabels = weeks.map(w => w.label);

  // Find peak week (highest combined e1RM across all 3 families)
  let peakWeekLabel = null, peakWeekTotal = 0;
  for (const wl of weekLabels) {
    const s = getWeeklyTopSet('squat', wl)?.e1rm || 0;
    const b = getWeeklyTopSet('bench', wl)?.e1rm || 0;
    const d = getWeeklyTopSet('deadlift', wl)?.e1rm || 0;
    const total = s + b + d;
    if (total > peakWeekTotal) { peakWeekTotal = total; peakWeekLabel = wl; }
  }

  // ── Rep completion — hide if < 20% of checked sets have overrides ────────
  const showRepCompletion = checkedSetCount > 0 && (overrideCount / checkedSetCount) >= 0.2;
  const repCompletionPct = prescribedRepsTotal > 0 ? Math.round(actualRepsTotal / prescribedRepsTotal * 100) : 0;

  // ── BUILD HTML ───────────────────────────────────────────────────────────
  const dateStr = new Date().toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
  const athleteName = block.athleteName || athlete?.name || '';

  // ── Comp lift cards HTML ─────────────────────────────────────────────────
  const liftCardColors = { squat: '#C9A84C', bench: '#7B9FD4', deadlift: '#7EC89A' };
  const liftCardLabels = { squat: 'Squat', bench: 'Bench', deadlift: 'Deadlift' };
  let compCardsHtml = '';
  for (const gk of ['squat', 'bench', 'deadlift']) {
    const cl = compLifts[gk];
    const color = liftCardColors[gk];
    const label = liftCardLabels[gk];
    if (!cl) {
      compCardsHtml += `<div class="comp-card"><div class="comp-card-border" style="background:${color}"></div><div class="comp-card-label">${label}</div><div class="comp-card-val">—</div></div>`;
      continue;
    }
    const deltaSign = cl.delta > 0 ? '+' : cl.delta < 0 ? '' : '';
    const deltaColor = cl.delta > 0 ? '#4ade80' : cl.delta < 0 ? '#E22C2C' : '#555';
    const deltaArrow = cl.delta > 0 ? '↑' : cl.delta < 0 ? '↓' : '→';
    compCardsHtml += `<div class="comp-card">
      <div class="comp-card-border" style="background:${color}"></div>
      <div class="comp-card-label">${label}${cl.isVariation ? `<span style="font-size:9px;color:#777;font-weight:400;margin-left:4px">(${cl.name})</span>` : ''}</div>
      <div class="comp-card-val">${cl.bestE1rm}<span class="comp-card-unit"> lbs</span></div>
      <div class="comp-card-delta" style="color:${deltaColor}">${deltaArrow} ${deltaSign}${cl.delta} lbs</div>
      <div class="comp-card-divider"></div>
      <div class="comp-card-best-label">Best Set</div>
      <div class="comp-card-best">${cl.bestWeight}×${cl.bestReps}${cl.bestRpe ? ' @' + cl.bestRpe : ''}</div>
    </div>`;
  }

  // ── Weekly top sets table HTML ───────────────────────────────────────────
  let weeklyTableHtml = '';
  for (const wl of weekLabels) {
    const isPeak = wl === peakWeekLabel;
    const rowClass = isPeak ? ' class="peak-week"' : '';
    let cells = `<td class="week-col">${wl}</td>`;
    for (const gk of ['squat', 'bench', 'deadlift']) {
      const ts = getWeeklyTopSet(gk, wl);
      if (ts) {
        const rpeStr = ts.topRpe ? `<span class="rpe-dim"> @${ts.topRpe}</span>` : '';
        const varLabel = ts.isVariation ? `<div style="font-size:8px;color:#666;margin-top:1px">${ts.exName}</div>` : '';
        cells += `<td>${ts.topWeight}×${ts.topReps}${rpeStr}${varLabel}</td>`;
      } else {
        cells += '<td class="no-data">—</td>';
      }
    }
    weeklyTableHtml += `<tr${rowClass}>${cells}</tr>`;
  }

  // ── Volume chart data ────────────────────────────────────────────────────
  const volChartLabels = weekLabels;
  const volChartData = {
    squat: weekLabels.map(wl => Math.round((volumeByWeekFamily[wl]?.squat || 0) / 1000)),
    bench: weekLabels.map(wl => Math.round((volumeByWeekFamily[wl]?.bench || 0) / 1000)),
    deadlift: weekLabels.map(wl => Math.round((volumeByWeekFamily[wl]?.deadlift || 0) / 1000)),
    other: weekLabels.map(wl => Math.round((volumeByWeekFamily[wl]?.other || 0) / 1000))
  };

  // ── Stat pills HTML ─────────────────────────────────────────────────────
  const totalPrescribed = (() => {
    let t = 0;
    for (const week of weeks) for (const day of (week.days || [])) for (const ex of (day.exercises || [])) {
      const sets = parseSets(ex.prescription);
      t += sets.length || 0;
    }
    return t;
  })();

  // ── Intensity distribution HTML ──────────────────────────────────────────
  const rpeBucketColors = { '9+': '#E22C2C', '8': '#C9A84C', '7': '#C9A84C', '6': '#7B9FD4', '<=5': '#555' };
  let intensityHtml = '';
  if (rpeCount > 0) {
    intensityHtml = '<div class="section-card"><div class="section-title">Intensity Distribution</div>';
    for (const [label, count] of Object.entries(rpeBuckets)) {
      const pct = Math.round(count / rpeCount * 100);
      const displayLabel = label === '<=5' ? '≤ RPE 5' : `RPE ${label}`;
      intensityHtml += `<div class="intensity-row">
        <div class="intensity-label">${displayLabel}</div>
        <div class="intensity-bar-wrap"><div class="intensity-bar-fill" style="width:${pct}%;background:${rpeBucketColors[label]}"></div></div>
        <div class="intensity-pct">${pct}%</div>
      </div>`;
    }
    intensityHtml += '</div>';
  }

  // ── Rep completion HTML ──────────────────────────────────────────────────
  let repCompletionHtml = '';
  if (showRepCompletion) {
    repCompletionHtml = `<div class="section-card">
      <div class="section-title">Rep Completion</div>
      <div class="rep-overall">${repCompletionPct}<span class="rep-overall-pct">%</span></div>
      <div class="rep-overall-label">of prescribed reps completed</div>`;
    for (const [gk, label, color] of [['squat','Squat','#C9A84C'],['bench','Bench','#7B9FD4'],['deadlift','Deadlift','#7EC89A']]) {
      const fd = repsByFamily[gk];
      const pct = fd.prescribed > 0 ? Math.round(fd.actual / fd.prescribed * 100) : 0;
      repCompletionHtml += `<div class="intensity-row">
        <div class="intensity-label">${label}</div>
        <div class="intensity-bar-wrap"><div class="intensity-bar-fill" style="width:${Math.min(pct, 100)}%;background:${color}"></div></div>
        <div class="intensity-pct">${pct}%</div>
      </div>`;
    }
    repCompletionHtml += '</div>';
  }

  // ── Page 2: Lift Progressions ────────────────────────────────────────────
  const chartInits = [];
  let progressionHtml = '';
  if (scope === 'full') {
    for (const [groupKey, groupLabel] of [['squat','Squat'],['bench','Bench'],['deadlift','Deadlift']]) {
      const exercises = families[groupKey];
      const exNames = Object.keys(exercises).filter(n => Object.keys(exercises[n]).length > 0);
      if (!exNames.length) continue;

      const allWeekLabels = [...new Set(
        exNames.flatMap(n => Object.keys(exercises[n]))
      )].sort((a, b) => sessionOrder(a) - sessionOrder(b));

      // Prefer comp lift e1RM for the badge; fall back to best variation
      const compExNames = exNames.filter(n => isCompLift(n));
      const badgeSource = compExNames.length ? compExNames : exNames;
      const bestE1rm = Math.max(...badgeSource.flatMap(n =>
        Object.values(exercises[n]).map(w => w.e1rm)
      ));

      const chartId = 'chart_' + groupKey;
      const datasets = exNames.map((n, i) => {
        const color = FAMILY_COLORS[i % FAMILY_COLORS.length];
        const isComp = isCompLift(n);
        const data = allWeekLabels.map(wl => exercises[n][wl] ? Math.round(exercises[n][wl].e1rm) : null);
        return {
          label: n, data,
          borderColor: color, backgroundColor: 'transparent', fill: false,
          pointBackgroundColor: color,
          pointBorderColor: tv('--bg') || '#0a0a0a',
          pointBorderWidth: 1.5,
          pointRadius: isComp ? 4 : 3, pointHoverRadius: 6,
          tension: 0.3, spanGaps: true,
          borderWidth: isComp ? 2.5 : 1.5,
          borderDash: isComp ? [] : [],
          order: isComp ? 0 : 1
        };
      });
      chartInits.push({ id: chartId, labels: allWeekLabels, datasets });

      let varListHtml = exNames.map((n, i) => {
        const color = FAMILY_COLORS[i % FAMILY_COLORS.length];
        const peakE1rm = Math.max(...Object.values(exercises[n]).map(w => w.e1rm));
        return `<div class="prog-var-row"><span class="prog-var-dot" style="background:${color}"></span><span class="prog-var-name">${n}</span><span class="prog-var-peak">${Math.round(peakE1rm)} lbs</span></div>`;
      }).join('');

      const badgeLabel = compExNames.length ? '' : ` (${badgeSource[0]})`;
      progressionHtml += `<div class="prog-card">
        <div class="prog-header">
          <span class="prog-label">${groupLabel.toUpperCase()}</span>
          <span class="prog-e1rm-badge">${Math.round(bestE1rm)} lbs e1RM${badgeLabel}</span>
        </div>
        <div class="prog-chart-wrap"><canvas id="${chartId}"></canvas></div>
        <div class="prog-var-list">${varListHtml}</div>
      </div>`;
    }
  }

  // ── Chart.js init scripts ────────────────────────────────────────────────
  const volChartScript = `
  new Chart(document.getElementById('volChart'), {
    type: 'bar',
    data: {
      labels: ${JSON.stringify(volChartLabels)},
      datasets: [
        { label:'Squat', data:${JSON.stringify(volChartData.squat)}, backgroundColor:'#C9A84C', borderRadius:2 },
        { label:'Bench', data:${JSON.stringify(volChartData.bench)}, backgroundColor:'#7B9FD4', borderRadius:2 },
        { label:'Deadlift', data:${JSON.stringify(volChartData.deadlift)}, backgroundColor:'#7EC89A', borderRadius:2 },
        { label:'Other', data:${JSON.stringify(volChartData.other)}, backgroundColor:'#555', borderRadius:2 }
      ]
    },
    options: {
      responsive:true, maintainAspectRatio:false,
      plugins: {
        legend:{display:false},
        tooltip:{
          backgroundColor:'${tv('--surface-2')||'#141414'}', borderColor:'${tv('--border')||'#222'}', borderWidth:1,
          titleColor:'#888', bodyColor:'#ccc', padding:8,
          callbacks:{ label: ctx => ctx.dataset.label + ': ' + ctx.parsed.y + 'k lbs' }
        }
      },
      scales:{
        x:{stacked:true, ticks:{color:'#555',font:{family:'Barlow Condensed',size:10}}, grid:{display:false}, border:{display:false}},
        y:{stacked:true, ticks:{color:'#444',font:{family:'Barlow Condensed',size:10}, callback:v=>v+'k'}, grid:{color:'${tv('--surface-3')||'#1a1a1a'}'}, border:{display:false}}
      }
    }
  });`;

  const lineChartScripts = chartInits.map(c => `
  new Chart(document.getElementById('${c.id}'), {
    type: 'line',
    data: { labels: ${JSON.stringify(c.labels)}, datasets: ${JSON.stringify(c.datasets)} },
    options: {
      responsive:true, maintainAspectRatio:false,
      plugins: {
        legend:{display:false},
        tooltip:{
          backgroundColor:'${tv('--surface-2')||'#141414'}', borderColor:'${tv('--border')||'#222'}', borderWidth:1,
          titleColor:'#888', bodyColor:'#ccc', padding:8,
          callbacks:{ label: ctx => ctx.dataset.label + ': ' + ctx.parsed.y + ' lbs' }
        }
      },
      scales:{
        x:{ticks:{color:'#555',font:{family:'Barlow Condensed',size:10}}, grid:{color:'${tv('--surface-3')||'#1a1a1a'}'}, border:{color:'${tv('--surface-3')||'#1a1a1a'}'}},
        y:{ticks:{color:'#444',font:{family:'Barlow Condensed',size:10}}, grid:{color:'${tv('--surface-3')||'#1a1a1a'}'}, border:{color:'${tv('--surface-3')||'#1a1a1a'}'}}
      }
    }
  });`).join('\n');

  // ── Estimated total card HTML ────────────────────────────────────────────
  let estTotalHtml = '';
  if (estTotal > 0) {
    const rightSide = (dotsScore && wilksScore) ? `
      <div class="est-total-scores">
        <div class="est-total-score-row"><span class="est-total-score-label">DOTS</span><span class="est-total-score-val">${dotsScore.toFixed(1)}</span></div>
        <div class="est-total-score-row"><span class="est-total-score-label">Wilks</span><span class="est-total-score-val">${wilksScore.toFixed(1)}</span></div>
        ${athlete?.bodyweight ? `<div class="est-total-bw">${athlete.bodyweight} ${athlete.bwUnit || 'lbs'} BW</div>` : ''}
      </div>` : '';
    estTotalHtml = `<div class="est-total-card">
      <div class="est-total-left">
        <div class="est-total-label">Estimated Total</div>
        <div class="est-total-val">${estTotal}<span class="est-total-unit"> lbs</span></div>
      </div>
      ${rightSide}
    </div>`;
  }

  // ── Volume legend ────────────────────────────────────────────────────────
  const volLegendHtml = [['Squat','#C9A84C'],['Bench','#7B9FD4'],['Deadlift','#7EC89A'],['Other','#555']].map(([l,c]) =>
    `<span class="vol-legend-item"><span class="vol-legend-dot" style="background:${c}"></span>${l}</span>`
  ).join('');

  // ══════════════════════════════════════════════════════════════════════════
  // FINAL HTML
  // ══════════════════════════════════════════════════════════════════════════
  const html = `<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>${escH(displayBlockName(block.name))} — Training Report</title>
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;600;700;900&family=Barlow:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"><\/script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
html{background:${tv('--bg')||'#0a0a0a'}}
body{background:${tv('--bg')||'#0a0a0a'};color:${tv('--text-primary')||'#f0f0f0'};font-family:Barlow,sans-serif;-webkit-font-smoothing:antialiased}
.report{max-width:480px;margin:0 auto;padding:24px 16px 80px}

/* Header */
.rpt-hdr{margin-bottom:20px}
.rpt-brand{font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:10px;letter-spacing:.16em;color:#C9A84C;text-transform:uppercase;margin-bottom:8px}
.rpt-athlete{font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:32px;line-height:1;letter-spacing:.02em;text-transform:uppercase;margin-bottom:2px}
.rpt-block{font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:14px;color:#C9A84C;text-transform:uppercase;letter-spacing:.04em;margin-bottom:6px}
.rpt-meta{font-size:12px;color:${tv('--text-faint')||'#666'};display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px}
.rpt-meta span+span::before{content:'·';margin-right:6px}
.compliance-row{display:flex;align-items:center;gap:10px}
.compliance-track{flex:1;height:4px;background:${tv('--surface-3')||'#1a1a1a'};border-radius:2px}
.compliance-fill{height:100%;background:#4ade80;border-radius:2px}
.compliance-label{font-size:11px;color:${tv('--text-faint')||'#666'};white-space:nowrap}

/* Estimated Total */
.est-total-card{display:flex;justify-content:space-between;align-items:center;background:${tv('--surface-2')||'#141414'};border:1px solid ${tv('--border')||'#222'};border-radius:12px;padding:14px 16px;margin-bottom:12px}
.est-total-label{font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:${tv('--text-dim')||'#555'};margin-bottom:2px}
.est-total-val{font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:36px;line-height:1;color:${tv('--text-primary')||'#f0f0f0'}}
.est-total-unit{font-size:16px;font-weight:600;color:${tv('--text-faint')||'#666'}}
.est-total-scores{text-align:right}
.est-total-score-row{display:flex;justify-content:flex-end;align-items:baseline;gap:6px;margin-bottom:2px}
.est-total-score-label{font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:${tv('--text-dim')||'#555'}}
.est-total-score-val{font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:18px;color:#C9A84C}
.est-total-bw{font-size:10px;color:${tv('--text-dim')||'#555'};margin-top:2px}

/* Comp lift cards */
.comp-cards{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px}
.comp-card{background:${tv('--surface-2')||'#141414'};border:1px solid ${tv('--border')||'#222'};border-radius:10px;padding:12px 10px;position:relative;overflow:hidden}
.comp-card-border{height:3px;border-radius:2px;margin-bottom:8px}
.comp-card-label{font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:${tv('--text-dim')||'#555'};margin-bottom:2px}
.comp-card-val{font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:24px;line-height:1;margin-bottom:2px}
.comp-card-unit{font-size:12px;font-weight:600;color:${tv('--text-faint')||'#666'}}
.comp-card-delta{font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:600;margin-bottom:6px}
.comp-card-divider{height:1px;background:${tv('--border')||'#222'};margin-bottom:6px}
.comp-card-best-label{font-size:9px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:${tv('--text-dim')||'#555'};margin-bottom:1px}
.comp-card-best{font-family:'Barlow Condensed',sans-serif;font-size:12px;font-weight:600;color:${tv('--text-faint')||'#888'}}

/* Weekly top sets */
.section-card{background:${tv('--surface-2')||'#141414'};border:1px solid ${tv('--border')||'#222'};border-radius:12px;padding:14px;margin-bottom:12px}
.section-title{font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:${tv('--text-dim')||'#555'};margin-bottom:10px}
.weekly-table{width:100%;border-collapse:collapse;font-size:11px}
.weekly-table th{font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:9px;letter-spacing:.1em;text-transform:uppercase;color:${tv('--text-dim')||'#555'};padding:4px 6px;text-align:left;border-bottom:1px solid ${tv('--border')||'#222'}}
.weekly-table td{padding:5px 6px;color:${tv('--text-faint')||'#888'};font-family:'Barlow Condensed',sans-serif;font-size:12px;font-weight:500;border-bottom:1px solid ${tv('--surface-1')||'#111'}}
.weekly-table .week-col{color:${tv('--text-sub')||'#999'};font-weight:700;width:50px}
.weekly-table .no-data{color:${tv('--text-dim')||'#444'}}
.weekly-table .rpe-dim{font-size:10px;color:${tv('--text-dim')||'#555'}}
.weekly-table tr.peak-week td{color:#C9A84C}
.weekly-table tr.peak-week .rpe-dim{color:rgba(201,168,76,.6)}

/* Volume chart */
.vol-legend{display:flex;gap:10px;margin-bottom:6px;flex-wrap:wrap}
.vol-legend-item{display:flex;align-items:center;gap:4px;font-family:'Barlow Condensed',sans-serif;font-size:10px;color:${tv('--text-faint')||'#666'};letter-spacing:.04em}
.vol-legend-dot{width:7px;height:7px;border-radius:2px;flex-shrink:0}
.vol-chart-wrap{height:160px}

/* Stats grid */
.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px}
.stat-pill{background:${tv('--surface-2')||'#141414'};border:1px solid ${tv('--border')||'#222'};border-radius:10px;padding:10px 12px}
.stat-pill-label{font-family:'Barlow Condensed',sans-serif;font-size:9px;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:${tv('--text-dim')||'#555'};margin-bottom:2px}
.stat-pill-val{font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:22px;line-height:1}
.stat-pill-sub{font-size:11px;font-weight:500;color:${tv('--text-faint')||'#666'}}

/* Intensity + rep completion */
.intensity-row{display:flex;align-items:center;gap:8px;padding:4px 0}
.intensity-label{font-family:'Barlow Condensed',sans-serif;font-size:11px;color:${tv('--text-faint')||'#888'};width:54px;flex-shrink:0}
.intensity-bar-wrap{flex:1;height:6px;background:${tv('--surface-3')||'#1a1a1a'};border-radius:3px;overflow:hidden}
.intensity-bar-fill{height:100%;border-radius:3px;transition:width .3s}
.intensity-pct{font-family:'Barlow Condensed',sans-serif;font-size:11px;color:${tv('--text-dim')||'#555'};width:32px;text-align:right;flex-shrink:0}
.rep-overall{font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:40px;color:#4ade80;line-height:1;margin-bottom:2px}
.rep-overall-pct{font-size:20px;font-weight:700}
.rep-overall-label{font-size:11px;color:${tv('--text-faint')||'#666'};margin-bottom:10px}

/* Page 2 — Progressions */
.page-2{${scope === 'full' ? 'page-break-before:always;padding-top:20px' : 'display:none'}}
.prog-card{background:${tv('--surface-2')||'#141414'};border:1px solid ${tv('--border')||'#222'};border-radius:12px;overflow:hidden;margin-bottom:14px}
.prog-header{display:flex;justify-content:space-between;align-items:center;padding:14px 14px 0}
.prog-label{font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:20px;letter-spacing:.02em;text-transform:uppercase}
.prog-e1rm-badge{font-family:'Barlow Condensed',sans-serif;font-size:12px;font-weight:700;color:#C9A84C;background:rgba(201,168,76,.1);padding:3px 8px;border-radius:6px}
.prog-chart-wrap{height:180px;padding:8px 10px}
.prog-var-list{padding:8px 14px 12px;border-top:1px solid ${tv('--border')||'#222'}}
.prog-var-row{display:flex;align-items:center;gap:6px;padding:3px 0}
.prog-var-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.prog-var-name{font-size:12px;color:${tv('--text-faint')||'#888'};flex:1}
.prog-var-peak{font-family:'Barlow Condensed',sans-serif;font-size:12px;font-weight:700;color:${tv('--text-sub')||'#aaa'}}

/* Footer */
.rpt-footer{margin-top:16px;font-size:10px;color:${tv('--text-dim')||'#444'};display:flex;justify-content:space-between}

/* Save button */
.save-btn{position:fixed;bottom:20px;right:20px;background:#C9A84C;color:#000;border:none;border-radius:10px;padding:10px 18px;font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:12px;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;z-index:100;box-shadow:0 2px 12px rgba(0,0,0,.4)}

/* Print */
@media print{
  .save-btn{display:none}
  .report{padding:10px;max-width:100%}
  html,body{background:${tv('--bg')||'#0a0a0a'}}
  body{-webkit-print-color-adjust:exact;print-color-adjust:exact}
  .comp-card,.section-card,.stat-pill,.prog-card{break-inside:avoid}
  .vol-chart-wrap,.prog-chart-wrap{break-inside:avoid}
  @page{size:portrait;margin:8mm}
}
</style>
</head>
<body>
<div class="report">

  <!-- Header -->
  <div class="rpt-hdr">
    <div class="rpt-brand">Unrack</div>
    ${athleteName ? `<div class="rpt-athlete">${escH(athleteName)}</div>` : ''}
    <div class="rpt-block">${escH(displayBlockName(block.name))}</div>
    <div class="rpt-meta">
      <span>${escH(block.dateRange || '')}</span>
      <span>${weeks.length} weeks</span>
      <span>${completedDays} sessions</span>
    </div>
    <div class="compliance-row">
      <div class="compliance-track"><div class="compliance-fill" style="width:${compliancePct}%"></div></div>
      <div class="compliance-label">${compliancePct}% compliance</div>
    </div>
  </div>

  <!-- Estimated Total -->
  ${estTotalHtml}

  <!-- Comp Lift Cards -->
  <div class="comp-cards">${compCardsHtml}</div>

  <!-- Weekly Top Sets -->
  <div class="section-card">
    <div class="section-title">Weekly Top Sets</div>
    <table class="weekly-table">
      <thead><tr><th>Week</th><th>Squat</th><th>Bench</th><th>Deadlift</th></tr></thead>
      <tbody>${weeklyTableHtml}</tbody>
    </table>
  </div>

  <!-- Volume by Lift Family -->
  <div class="section-card">
    <div class="section-title">Volume by Lift Family</div>
    <div class="vol-legend">${volLegendHtml}</div>
    <div class="vol-chart-wrap"><canvas id="volChart"></canvas></div>
  </div>

  <!-- Stats -->
  <div class="stats-grid">
    <div class="stat-pill">
      <div class="stat-pill-label">Total Volume</div>
      <div class="stat-pill-val">${totalVolume >= 1000 ? Math.round(totalVolume/1000) + 'k' : totalVolume}<span class="stat-pill-sub"> lbs</span></div>
    </div>
    <div class="stat-pill">
      <div class="stat-pill-label">Sets Completed</div>
      <div class="stat-pill-val">${totalSets}${totalPrescribed ? '<span class="stat-pill-sub"> of ' + totalPrescribed + '</span>' : ''}</div>
    </div>
    <div class="stat-pill">
      <div class="stat-pill-label">Avg RPE</div>
      <div class="stat-pill-val">${avgRpe}</div>
    </div>
    <div class="stat-pill">
      <div class="stat-pill-label">Training Days</div>
      <div class="stat-pill-val">${completedDays}<span class="stat-pill-sub"> / ${totalDays}</span></div>
    </div>
  </div>

  <!-- Intensity Distribution -->
  ${intensityHtml}

  <!-- Rep Completion -->
  ${repCompletionHtml}

  <!-- Footer P1 -->
  <div class="rpt-footer">
    <span>Unrack</span>
    <span>${dateStr}</span>
  </div>

  <!-- Page 2: Lift Progressions -->
  <div class="page-2">
    ${progressionHtml}
    <div class="rpt-footer">
      <span>Unrack</span>
      <span>${dateStr}</span>
    </div>
  </div>

</div>
<button class="save-btn" onclick="setTimeout(()=>window.print(),300)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" width="14" height="14" style="vertical-align:-2px;margin-right:4px"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Save as PDF</button>
<script>
${volChartScript}
${lineChartScripts}
<\/script>
</body>
</html>`;

  // In-app overlay instead of window.open (WKWebView compatible)
  const overlay = document.createElement('div');
  overlay.id = 'report-overlay';
  overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;z-index:10000;background:var(--bg,#0a0a0a);overflow:auto;';
  const iframe = document.createElement('iframe');
  iframe.style.cssText = 'width:100%;height:100%;border:none;';
  const blob = new Blob([html], { type: 'text/html' });
  iframe.src = URL.createObjectURL(blob);
  const closeBtn = document.createElement('button');
  closeBtn.textContent = '\u2715 Close Report';
  closeBtn.style.cssText = 'position:fixed;top:env(safe-area-inset-top,12px);right:12px;z-index:10001;padding:8px 16px;background:#333;color:#fff;border:none;border-radius:8px;font-size:14px;cursor:pointer;';
  closeBtn.onclick = () => { URL.revokeObjectURL(iframe.src); overlay.remove(); };
  overlay.appendChild(closeBtn);
  overlay.appendChild(iframe);
  document.body.appendChild(overlay);
}


// ── TEMPLATE DOWNLOAD ─────────────────────────────────────────────────────────
const TEMPLATE_XLSX_B64 = 'UEsDBBQAAAAIAO2wWVxGx01IlQAAAM0AAAAQAAAAZG9jUHJvcHMvYXBwLnhtbE3PTQvCMAwG4L9SdreZih6kDkQ9ip68zy51hbYpbYT67+0EP255ecgboi6JIia2mEXxLuRtMzLHDUDWI/o+y8qhiqHke64x3YGMsRoPpB8eA8OibdeAhTEMOMzit7Dp1C5GZ3XPlkJ3sjpRJsPiWDQ6sScfq9wcChDneiU+ixNLOZcrBf+LU8sVU57mym/8ZAW/B7oXUEsDBBQAAAAIAO2wWVyoInB97gAAACsCAAARAAAAZG9jUHJvcHMvY29yZS54bWzNksFqwzAMhl9l+J7IcVkGJs2lZacNBits7GZstTWNHWNrJH37OVmbMrYH2NHS70+fQI0OUvcRX2IfMJLFdDe6ziepw5odiYIESPqITqUyJ3xu7vvoFOVnPEBQ+qQOCILzGhySMooUTMAiLETWNkZLHVFRHy94oxd8+IzdDDMasEOHnhJUZQWsnSaG89g1cANMMMLo0ncBzUKcq39i5w6wS3JMdkkNw1AOqzmXd6jg/fnpdV63sD6R8hrzr2QlnQOu2XXy22qz3T2yVnBRF1wU4n4nhOQPUtQfk+sPv5uw643d239sfBVsG/h1F+0XUEsDBBQAAAAIAO2wWVyZXJwjEAYAAJwnAAATAAAAeGwvdGhlbWUvdGhlbWUxLnhtbO1aW3PaOBR+76/QeGf2bQvGNoG2tBNzaXbbtJmE7U4fhRFYjWx5ZJGEf79HNhDLlg3tkk26mzwELOn7zkVH5+g4efPuLmLohoiU8nhg2S/b1ru3L97gVzIkEUEwGaev8MAKpUxetVppAMM4fckTEsPcgosIS3gUy9Zc4FsaLyPW6rTb3VaEaWyhGEdkYH1eLGhA0FRRWm9fILTlHzP4FctUjWWjARNXQSa5iLTy+WzF/NrePmXP6TodMoFuMBtYIH/Ob6fkTlqI4VTCxMBqZz9Wa8fR0kiAgsl9lAW6Sfaj0xUIMg07Op1YznZ89sTtn4zK2nQ0bRrg4/F4OLbL0otwHATgUbuewp30bL+kQQm0o2nQZNj22q6RpqqNU0/T933f65tonAqNW0/Ta3fd046Jxq3QeA2+8U+Hw66JxqvQdOtpJif9rmuk6RZoQkbj63oSFbXlQNMgAFhwdtbM0gOWXin6dZQa2R273UFc8FjuOYkR/sbFBNZp0hmWNEZynZAFDgA3xNFMUHyvQbaK4MKS0lyQ1s8ptVAaCJrIgfVHgiHF3K/99Ze7yaQzep19Os5rlH9pqwGn7bubz5P8c+jkn6eT101CznC8LAnx+yNbYYcnbjsTcjocZ0J8z/b2kaUlMs/v+QrrTjxnH1aWsF3Pz+SejHIju932WH32T0duI9epwLMi15RGJEWfyC265BE4tUkNMhM/CJ2GmGpQHAKkCTGWoYb4tMasEeATfbe+CMjfjYj3q2+aPVehWEnahPgQRhrinHPmc9Fs+welRtH2Vbzco5dYFQGXGN80qjUsxdZ4lcDxrZw8HRMSzZQLBkGGlyQmEqk5fk1IE/4rpdr+nNNA8JQvJPpKkY9psyOndCbN6DMawUavG3WHaNI8ev4F+Zw1ChyRGx0CZxuzRiGEabvwHq8kjpqtwhErQj5iGTYacrUWgbZxqYRgWhLG0XhO0rQR/FmsNZM+YMjszZF1ztaRDhGSXjdCPmLOi5ARvx6GOEqa7aJxWAT9nl7DScHogstm/bh+htUzbCyO90fUF0rkDyanP+kyNAejmlkJvYRWap+qhzQ+qB4yCgXxuR4+5Xp4CjeWxrxQroJ7Af/R2jfCq/iCwDl/Ln3Ppe+59D2h0rc3I31nwdOLW95GblvE+64x2tc0LihjV3LNyMdUr5Mp2DmfwOz9aD6e8e362SSEr5pZLSMWkEuBs0EkuPyLyvAqxAnoZFslCctU02U3ihKeQhtu6VP1SpXX5a+5KLg8W+Tpr6F0PizP+Txf57TNCzNDt3JL6raUvrUmOEr0scxwTh7LDDtnPJIdtnegHTX79l125COlMFOXQ7gaQr4Dbbqd3Do4npiRuQrTUpBvw/npxXga4jnZBLl9mFdt59jR0fvnwVGwo+88lh3HiPKiIe6hhpjPw0OHeXtfmGeVxlA0FG1srCQsRrdguNfxLBTgZGAtoAeDr1EC8lJVYDFbxgMrkKJ8TIxF6HDnl1xf49GS49umZbVuryl3GW0iUjnCaZgTZ6vK3mWxwVUdz1Vb8rC+aj20FU7P/lmtyJ8MEU4WCxJIY5QXpkqi8xlTvucrScRVOL9FM7YSlxi84+bHcU5TuBJ2tg8CMrm7Oal6ZTFnpvLfLQwJLFuIWRLiTV3t1eebnK56Inb6l3fBYPL9cMlHD+U751/0XUOufvbd4/pukztITJx5xREBdEUCI5UcBhYXMuRQ7pKQBhMBzZTJRPACgmSmHICY+gu98gy5KRXOrT45f0Usg4ZOXtIlEhSKsAwFIRdy4+/vk2p3jNf6LIFthFQyZNUXykOJwT0zckPYVCXzrtomC4Xb4lTNuxq+JmBLw3punS0n/9te1D20Fz1G86OZ4B6zh3OberjCRaz/WNYe+TLfOXDbOt4DXuYTLEOkfsF9ioqAEativrqvT/klnDu0e/GBIJv81tuk9t3gDHzUq1qlZCsRP0sHfB+SBmOMW/Q0X48UYq2msa3G2jEMeYBY8wyhZjjfh0WaGjPVi6w5jQpvQdVA5T/b1A1o9g00HJEFXjGZtjaj5E4KPNz+7w2wwsSO4e2LvwFQSwMEFAAAAAgA7bBZXHFKDQGABAAAIhcAABgAAAB4bC93b3Jrc2hlZXRzL3NoZWV0MS54bWylWO1ymzoQfRWNHyCAwB/p2J7Udtp0Jvdej3Pb/pZBtpkAokKuydtXAgomsys8kz8JsDprnQXOHnZ+EfK1OHGuSJkmWbEYnZTKPzlOEZ54yoo7kfNMRw5CpkzpU3l0ilxyFlWgNHGo606clMXZaDmvrm3lci7OKokzvpWkOKcpk28rnojLYuSN/l7YxceTMhec5TxnR/7C1fd8K/WZ02aJ4pRnRSwyIvlhMfrsfXqkgQFUK37E/FJcHRNDZS/Eqzn5Fi1GrtkRT3ioTAqm//3ma54kJpPex68m6aj9TQO8Pv6b/UtFXpPZs4KvRfIzjtRpMZqNSMQP7Jyonbg88YbQ2OQLRVJUf8mlXkv14vBcKJE2YL2DNM7q/6xsCnENoAiANgD6HuAiAL8B+LcCggYQ3AoYN4CKulNzrwq3YYot51JciDSrdTZzUFW/Qut6xZl5UF6U1NFY49Tye55zSby5o3Qyc8kJG+CqBlIEqB+hgpRkx/OCPOy2j0CGtT3DjodCRuRS3UvCsojAaTb2NGvBwhP5VyheAOBHO/g5PijNH0A7upBtNWlbTVql89G9pDlZ8UxvaCt5AW1oZc8QlD55mEHFvMaZ17+rTx0JkIxbdi440e+k1phCQSWq8eNe5h59v6Xv2+knQv/UVxk3RYDo2zP45YQ8TCH6PkrfB7ZfE4MiPWJBSyywE2P7hJMvyRvEyA71S49CfAKUT4DygSI9PuOWz9i6qc053e+1OBOtpRAlO1pTcpG7NEZZjVFWUKTHatKymlj39d9vLk+6WZL/ZRwaXXosVd3SII72XNhtm6AEJyhBKNIjOGsJzqxi/SwumFjPPizW9gw3i7U9zYBY28E3ivV9W837YbF++XVmkCiu7NigDBCZvkcfkHurTGvPpoxKG18VZ0dS6FsGleh+6GHy3K71u1YSdWdAKzCA9k2nAkWgB+zXoAlhRaAkFOdMkdzsDOzm7iD9K+fjWQnsuNYLXYCnN22BwALY8VoixiB9D6fvoSIBhvrMOhfi2U3ENmHZK3kSSQTSsoP9MhhDT97awx2IB1mIhtegu/C6LuwFN5hVSJdXDfJDbtWe4na7as8z5Fft6Bs10OucgGdv5s9MFlp2ULs6AA/KsVaBO/hFwN2Ah9sBMNQn1xkCz97Fv2WhuURav4PTHLQDLkgR9wMebgjAUJ/itKM4te7shTPFI8zIDYAtTq6HfMdsijODQn1mndnxZtbNrYyJI+uzTEBmdjDm33qwd7RmOC0o1P9C7LoudW8wcaCINciPiNhAiptFbCDPgIgNoG/96u5aObW34srKbbT1T3RmsLJDrdx8dcMqRvF2TvF2Dob67K6GCvaOvOGHOIyVneBgU0fec2qZK9gHC5TEZtAR1bsDH4PB3k+70QK1TwYqf4x61QEwJt892Dvy+FgBDPVpdZaG2scDn1fk54lzUOIGoCgpfLRA8dkCGKpJOVfjRTM9/ofJY5wVJOEHvda9m2qQrAey9YkSeaV/e6GUSKtD813OpVmg4weh3/zmxAwx27H48g9QSwMEFAAAAAgA7bBZXCJUHa19BAAALBcAABgAAAB4bC93b3Jrc2hlZXRzL3NoZWV0Mi54bWylWGFzmkoU/Ss7/oAACxrtqJOqadOZvPcc89p+XmFVJsDSZa3m33cXKEjm3oWZfEmAy7nuOeC5x51fhHwtTpwrck2TrFiMTkrlnxynCE88ZcWdyHmmKwchU6b0qTw6RS45i0pQmjjUdSdOyuJstJyX17ZyORdnlcQZ30pSnNOUybcVT8RlMfJGfy/s4uNJmQvOcp6zI3/h6nu+lfrMabpEccqzIhYZkfywGH32Pj3SwADKO37E/FLcHBNDZS/Eqzn5Fi1GrlkRT3ioTAum//3ma54kppNex6+66aj5TAO8Pf7b/UtJXpPZs4KvRfIzjtRpMZqOSMQP7Jyonbg88ZrQ2PQLRVKUf8mlupfqm8NzoURag/UK0jir/rNrLcQtgCIAWgPoe4CLAPwa4A8FBDUgGAoY14CSulNxL4XbMMWWcykuRJq7dTdzUKpforVecWZelBcldTXWOLX8nudcEm/uKN3MXHLCGriqgBQB6leoIFey43lBHnbbR6DD2t5hx0MhI3IpnyVhWUTgNht7m7Vg4Yn8KxQvAPCjHfwcH5TmD6AdLWSjJm3UpGU7H11LmpMVz/SCtpIX0IJW9g7B1ScP07sxJOct0hhAq1BVCZCeW3YuONHfSu0yhYJEqvDjTueOAH4jgG8XIBH6o77KuJYBEsDewb+OycM9LICPCuADBCpqUKVDLWioBXZqbJ9w8iV5gzjZof7VoxCfAOUToHygSofPuOEzti5qc073e23QRPspRMmO1pRc9DmNUV5jlBdU6fCaNLwm1pX995vLkx6Z5H8Zh8adHq+qGmwQS3sv7MFNUIITlCBU6RCcNgSnVst+FhfMsqcftmx7h8GWbW/TY9l28EDLnjVqzvot++XXmUHGuLJjbWY9Q1+RmdWsdXZTxqtNvoqzIyn0Q4NEmvW9Tp7bRgDXSqOaD6gGPWjfiIAYQQfaVaEuYTJQEopzpkhu1gbOdbdXgJsM5Fkp7Lj2DC3B05sOQ6AEdry2CZi+h9P3UKMAS11mbR7x7HFim7DslTyJJAJp2cH+deJC797aw5OIB0WJmldvyvDaWewFA2Ir5M2rGvmh3GpvMTy42vv0JVc7eqAPem0e8Owj/ZnJQhsPGlx74ME10GYIyonnAQ8PBGCpS62NBJ59jn/LQnOJNJkHJ9kbCFyQIp4IPDwSgKUuxfuW4r11ZS+cKR5hYa4HbE1zHew7bvc4N6jU5dYGHm9qXd7KBDmyPssE5GYHYxmuA3tHa4rTgkrd34rt3KXugCAHmliN/IiJ9bQYbGI9fXpMrAc99Pd3O8qpfRSXcW6j43+iO4PK9o1ySh5moJ74MKf4MAdLXW43mwv2ebzhhziMlZ1e30jHwxq17C/YNxgoic2WR1StD3wNemc/bbcYqH2HoEzIaFrtAWMG3oG9I49vLoClLq020lD7JsHnFfl54hy0uB4oSgrfYKD4DgNYqkg5NxuNZh/5HyaPcVaQhB/0ve7dvQbJamu2OlEiL/1vL5QSaXlofptzaW7Q9YPQ3/z6xGxnNhvkyz9QSwMEFAAAAAgA7bBZXF/pMOOlAwAAPxYAABgAAAB4bC93b3Jrc2hlZXRzL3NoZWV0My54bWylmOFu0zAUhV/FygOQxm3XDbUVYBuBBGgqAn57rbtGJHFxPDreHicNcY18kkr7syb5cu6Onfbc2MuTNj/rg1KWPJdFVa+Sg7XH12labw+qlPUrfVSVI3ttSmndqXlM66NRcteKyiKlk8lNWsq8StbL9tq9WS/1ky3ySt0bUj+VpTR/3qlCn1ZJlvy7sMkfD7a5kK6XR/movir77Xhv3FnaV9nlparqXFfEqP0qeZu9FtNW0N7xPVen+uKYNEN50Ppnc/Jxt0omjSNVqK1tSkj38VsxVRRNJefjV1c06f9nI7w8/lf9fTt4N5gHWSumix/5zh5WyW1Cdmovnwq70acPqhvQvKm31UXd/iWn873U3bx9qq0uO7FzUObV+VM+dxNxKaBAQDsB/V8wAYJpJ5heK5h1gtm1gnknaIeensfeThyXVq6XRp+Iae521ZqDdvZXyU1C3HzlVfNF+WqNo7nT2TWXf0i2TK0r1VxIt53s3Vm2ADL3BarJM9moY03ebO5FpAIbrrBRW2125NQ+SSKrHYmX4cNlmJbbA/miraojYjEs/pTvrTIxdeqmsZ9L2s8lbcvdtuWan6CfLkgYJBwSESOBpWlvaQotQcIg4ZCIGAkszXpLM2gJEgYJh0TESGBp3luaQ0uQMEg4JCJGAks3vaUbaAkSBgmHRMRIYGnRW1pAS5AwSDgkIkYCS3e9pbvR9KKx9Lp7cXoNV7g6vYbLjKTXsPjK9MomvhVM4APGiGHEMRJRFBq76FEZNgYRw4hjJKIoNOYDP8OJjxHDiGMkoig05mM/w7mPEcOIYySiKDTmwz/D6Y8Rw4hjJKIoNOZbQIZ7AEYMI46RiKLQmE/dbDGacdPoG9ri5a9owyWuf0cbrjP2kjasvjbnbv2M3uJHDRHDiGMkoig05rtZdoeNQcQw4hiJKArfa31noLgzYMQw4hiJKAqN+c5AcWfAiGHEMRJRFBq7WAoMrAUGFgMDq4GB5cBoZ6C+M1DcGTBiGHGMRBSFxnwA0/lozs1iOdfpXpJzIyWuzrmROiM5N6K+djXqlxAUryEwYhhxjEQUhcZ8S6N4JYERw4hjJKIoNOY7A8WdASOGEcdIRFFozHcGijsDRgwjjpGIonB7wXeGKe4MGDGMOEYiikJjvjNMcWfAiGHEMRJRdDaWXuy9NVurn6V5zKuaFGrv7p28WrgfvTnvVp5PrD62m3kP2lpdtocHJXfKNDc4vtcuALqTZoev3zNe/wVQSwMEFAAAAAgA7bBZXAUxQikiAwAAmhAAAA0AAAB4bC9zdHlsZXMueG1s3Vhtb5swEP4riB8wAqwoTCHShlRp0jZVaj/sqxMMWDKYGadK+uvns4GQxhelVaS9OIqw73zPPXc+2ySrXh04fawpVd6+4W2f+bVS3acg6Lc1bUj/QXS01ZpSyIYoPZRV0HeSkqIHo4YH0WKRBA1hrb9etbvmvlG9txW7VmX+wg/Wq1K0R8mdbwV6Kmmo90x45ueEs41kZi5pGD9YcQSCreBCekpToZkfgqR/serQjoDlgNOwVkgQBtbDBT+bAePoQlYbzXdoJ36i20OG10GewMSmvQeGYcyWpp1ALmaQ5tFraMb5tICxbwXrVUeUorK91wNjY4RnKm/oPx06vYKVJIcwuvOvNugFZwW4rPI58/KuXFAT0AZTBDPMyZt56JA2QhZUTkFF/iharzgtlTaXrKrhqUQHXoRSotGdgpFKtMREPFrMLT2znzJf1WY/nKQ7N81wg6mDjystzFxD50oDPXPkfaWFnTwLbOjofG0p548A8rOckhZqqH3p2S3/tYDd7kHFjF2d6aFrYewAHM3RLPYMNn0XrNexZ6G+7HQErRn/2glFHyQt2d6M9+XkH0MPj+jRHF3LSdfxw2fOqrahNvarHa5XZLTzaiHZi/YGWw1KwPeeqVRsC+OtnkDt8bUvcZLRv0AyRtbpdiTfTOnj30cJq+Y/SOnCFrjBBrtQuzdAv5DON6AHw3E0O/NOTrxJ6sFdm/k/4L2IHyG8zY5xxdphVLOioO3ZwafhFdnoF68TfD2/oCXZcfU0KTP/2P9OC7Zr0mnWA4Q1zDr2v8FNESbTba99sbage1rkw1Af/bn7DeW15t40twazsTq3BnSYH4wBZmOtMD//UzxLNB6rw7gtnZolarNEbayVS5ObD+bHbZPq5o40TeM4SbCM2veUMwY5lrckga8bDeMGFpgf8PS2XOOrjVfI5TrA1vRShWCR4pWIRYrnGjTuvIFFmrpXG/MDFtgqYLUD/t1+oKbcNnE8vv26uGE7GNekKaaBWnTXaJIg2Ung414fbJfEcZq6NaBzM4CflW4N7EZcgzEADpjG/oANXt1HwXhPBcd/I9a/AVBLAwQUAAAACADtsFlcl4q7HMAAAAATAgAACwAAAF9yZWxzLy5yZWxznZK5bsMwDEB/xdCeMAfQIYgzZfEWBPkBVqIP2BIFikWdv6/apXGQCxl5PTwS3B5pQO04pLaLqRj9EFJpWtW4AUi2JY9pzpFCrtQsHjWH0kBE22NDsFosPkAuGWa3vWQWp3OkV4hc152lPdsvT0FvgK86THFCaUhLMw7wzdJ/MvfzDDVF5UojlVsaeNPl/nbgSdGhIlgWmkXJ06IdpX8dx/aQ0+mvYyK0elvo+XFoVAqO3GMljHFitP41gskP7H4AUEsDBBQAAAAIAO2wWVx/8jG5WAEAAEMDAAAPAAAAeGwvd29ya2Jvb2sueG1stZLdSsNAEIVfZdkHMGmqBUvTCy1qQbTYUq83yaQZsj9hd9Nqn97JhmBAKN70ajPnLJNvzs7iZGydGVOzLyW1S3nlfTOPIpdXoIS7MQ1ockpjlfBU2kPkGguicBWAVzJK4ngWKYGaLxdDr42NxoXxkHs0msRO2COc3K/fleyIDjOU6L9THr4lcKZQo8IzFCmPOXOVOb0Yi2ejvZDb3BopUz7pjT1Yj/kfedtB7kTmguJF9iEIJOWzmBqWaJ0PN0J/QYxHoMt91XrzhNKDXQkPz9a0DepD14amiEZjhByGsw9xbv8ToylLzGFl8laB9n2OFmQHqF2FjeNMCwUp/wSoWRiI/rAu+uE8UY2isnMkw66LwHdllmTEklxgSa7L8iCFrtkOVEMmjJimF5im4f2GRyugRA3FG/VzpNMC5RvLuiPknNzeTe5pUVopH0l7169GFMMODPu7/AFQSwMEFAAAAAgA7bBZXLts6uy6AAAAGgMAABoAAAB4bC9fcmVscy93b3JrYm9vay54bWwucmVsc8WTOQ6DMBBFr4J8AIYlSREBVRraiAtYMCxiseWZKHD7ECjAUoo0iMr6Y/n9V4yjJ3aSGzVQ3Whyxr4bKBY1s74DUF5jL8lVGof5plSmlzxHU4GWeSsrhMDzbmD2DJFEe6aTTRr/IaqybHJ8qPzV48A/wPBWpqUakYWTSVMhxwLGbhsTLIfvzmThpEUsTFr4As4WCiyh4Hyh0BIKDxQinjqkzWbNVv3lwHqe3+LWvsR1aC/J9esA1ldIPlBLAwQUAAAACADtsFlcpvxKWyMBAADfBAAAEwAAAFtDb250ZW50X1R5cGVzXS54bWzNlM9OwzAMxl+l6nVqMobEAa27AFfYgRcIjbtGzT/F3ujeHrfdJoFGxTQkuDRqbH8/x5+S5es+Amadsx7LvCGK91Ji1YBTKEIEz5E6JKeIf9NGRlW1agNyMZ/fySp4Ak8F9Rr5avkItdpayp463kYTfJknsJhnD2NizypzFaM1lSKOy53XXyjFgSC4csjBxkSccUIuzxL6yPeAQ93LDlIyGrK1SvSsHGfJzkqkvQUU0xJnegx1bSrQodo6LhEYEyiNDQA5K0bR2TSZeMIwfm+u5g8yU0DOXKcQkR1LcDnuaElfXUQWgkRm+ognIktffT7o3dagf8jm8b6H1A5+oByW62f82eOT/oV9LP5JH7d/2MdbCO1vX7l+FU4Zf+TL4V1bfQBQSwECFAMUAAAACADtsFlcRsdNSJUAAADNAAAAEAAAAAAAAAAAAAAAgAEAAAAAZG9jUHJvcHMvYXBwLnhtbFBLAQIUAxQAAAAIAO2wWVyoInB97gAAACsCAAARAAAAAAAAAAAAAACAAcMAAABkb2NQcm9wcy9jb3JlLnhtbFBLAQIUAxQAAAAIAO2wWVyZXJwjEAYAAJwnAAATAAAAAAAAAAAAAACAAeABAAB4bC90aGVtZS90aGVtZTEueG1sUEsBAhQDFAAAAAgA7bBZXHFKDQGABAAAIhcAABgAAAAAAAAAAAAAAICBIQgAAHhsL3dvcmtzaGVldHMvc2hlZXQxLnhtbFBLAQIUAxQAAAAIAO2wWVwiVB2tfQQAACwXAAAYAAAAAAAAAAAAAACAgdcMAAB4bC93b3Jrc2hlZXRzL3NoZWV0Mi54bWxQSwECFAMUAAAACADtsFlcX+kw46UDAAA/FgAAGAAAAAAAAAAAAAAAgIGKEQAAeGwvd29ya3NoZWV0cy9zaGVldDMueG1sUEsBAhQDFAAAAAgA7bBZXAUxQikiAwAAmhAAAA0AAAAAAAAAAAAAAIABZRUAAHhsL3N0eWxlcy54bWxQSwECFAMUAAAACADtsFlcl4q7HMAAAAATAgAACwAAAAAAAAAAAAAAgAGyGAAAX3JlbHMvLnJlbHNQSwECFAMUAAAACADtsFlcf/IxuVgBAABDAwAADwAAAAAAAAAAAAAAgAGbGQAAeGwvd29ya2Jvb2sueG1sUEsBAhQDFAAAAAgA7bBZXLts6uy6AAAAGgMAABoAAAAAAAAAAAAAAIABIBsAAHhsL19yZWxzL3dvcmtib29rLnhtbC5yZWxzUEsBAhQDFAAAAAgA7bBZXKb8SlsjAQAA3wQAABMAAAAAAAAAAAAAAIABEhwAAFtDb250ZW50X1R5cGVzXS54bWxQSwUGAAAAAAsACwDKAgAAZh0AAAAA';

function downloadTemplate() {
  const byteChars = atob(TEMPLATE_XLSX_B64);
  const byteArr = new Uint8Array(byteChars.length);
  for (let i = 0; i < byteChars.length; i++) byteArr[i] = byteChars.charCodeAt(i);
  const blob = new Blob([byteArr], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'PowerliftPro_Template.xlsx';
  document.body.appendChild(a);
  a.click();
  setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(a.href); }, 100);
}

// ── FORMAT EXAMPLE VIEWER ─────────────────────────────────────────────────────
let _formatExampleTab = 'A';

function openFormatExample() {
  _formatExampleTab = 'A';
  renderFormatExample();
  document.getElementById('format-example-modal').style.display = 'flex';
}

function closeFormatExample() {
  document.getElementById('format-example-modal').style.display = 'none';
}

function setFormatTab(tab) {
  _formatExampleTab = tab;
  renderFormatExample();
}

function renderFormatExample() {
  const body = document.getElementById('format-example-body');
  const tabA = _formatExampleTab === 'A' ? ' active' : '';
  const tabB = _formatExampleTab === 'B' ? ' active' : '';

  let content = `
    <div class="format-example-title">Supported Formats</div>
    <div class="format-example-sub">The app reads two common coaching spreadsheet layouts and auto-detects which one you're using.</div>
    <div class="format-tab-row">
      <button class="format-tab${tabA}" onclick="setFormatTab('A')">Format A</button>
      <button class="format-tab${tabB}" onclick="setFormatTab('B')">Format B</button>
    </div>
  `;

  if (_formatExampleTab === 'A') {
    content += `
      <div class="format-note" style="margin-bottom:12px">
        Each sheet is a full training block. Days run left-to-right as columns. Each exercise lists its weekly prescriptions vertically.
      </div>

      <div class="format-grid">
        <div class="format-grid-header"><span>Monday</span><span>Track</span><span>Thursday</span><span>Track</span></div>
        <div class="format-grid-row section-header"><span>Comp Squat</span><span></span><span>Larson Press</span><span></span></div>
        <div class="format-grid-row"><span>W1: 3x5(315)</span><span style="color:var(--green)">315</span><span>W1: 4x6 @7</span><span style="color:var(--green)">135</span></div>
        <div class="format-grid-row"><span>W2: 4x4(335)</span><span></span><span>W2: 4x5 @7.5</span><span></span></div>
        <div class="format-grid-row"><span>W3: 5x3(355)</span><span></span><span>W3: 3x4 @8</span><span></span></div>
        <div class="format-grid-row section-header"><span>Pause Squat</span><span></span><span>Weighted Dip</span><span></span></div>
        <div class="format-grid-row"><span>W1: 3x3(275)</span><span></span><span>W1: 3x8</span><span></span></div>
      </div>

      <div class="format-note" style="margin-top:14px">
        <strong style="display:block;margin-bottom:6px">How it works</strong>
        <div style="display:flex;flex-direction:column;gap:4px;font-size:13px">
          <div>Each <strong>column pair</strong> is a training day + a tracking column</div>
          <div>Prescriptions are prefixed by week: <strong>W1:</strong>, <strong>W2:</strong>, etc.</div>
          <div>The tracking column records what was actually lifted</div>
          <div>Blank rows separate exercises or supersets</div>
        </div>
      </div>

      <div class="format-note">
        <strong style="display:block;margin-bottom:6px">Prescription examples</strong>
        <div style="display:flex;flex-direction:column;gap:4px;font-size:12px">
          <div><code style="color:var(--gold);background:rgba(201,168,76,0.12);padding:2px 7px;border-radius:4px">3x5(315)</code> &mdash; 3 sets of 5 at 315 lbs</div>
          <div><code style="color:var(--gold);background:rgba(201,168,76,0.12);padding:2px 7px;border-radius:4px">4x3 @8</code> &mdash; 4 sets of 3 at RPE 8</div>
          <div><code style="color:var(--gold);background:rgba(201,168,76,0.12);padding:2px 7px;border-radius:4px">5x2(405) @9</code> &mdash; weight and RPE together</div>
          <div><code style="color:var(--gold);background:rgba(201,168,76,0.12);padding:2px 7px;border-radius:4px">8(L) 8(M) 8(H)</code> &mdash; intensity scale</div>
        </div>
      </div>
    `;
  } else {
    content += `
      <div class="format-note" style="margin-bottom:12px">
        Each sheet is one week. Days appear as section headers within the sheet. Each exercise is a single row with its prescription beside it.
      </div>

      <div class="format-grid">
        <div class="format-grid-header"><span>Exercise</span><span>Prescription</span><span>Record</span></div>
        <div class="format-grid-row section-header"><span>Upper 1</span><span style="font-size:10px;font-weight:400;opacity:0.5">sets, reps, weight, RPE</span><span style="font-size:10px;font-weight:400;opacity:0.5">logged weight</span></div>
        <div class="format-grid-row"><span>Comp Bench</span><span>4x3 @8</span><span style="color:var(--green)">225</span></div>
        <div class="format-grid-row"><span>Close Grip Bench</span><span>3x6(185)</span><span></span></div>
        <div class="format-grid-row"><span>Cable Fly</span><span>3x12</span><span></span></div>
        <div class="format-grid-row section-header"><span>Lower 1</span><span></span><span></span></div>
        <div class="format-grid-row"><span>Comp Squat</span><span>5x2(405) @9</span><span style="color:var(--green)">405</span></div>
        <div class="format-grid-row"><span>Pause Squat</span><span>3x3 @7.5</span><span></span></div>
      </div>

      <div class="format-note" style="margin-top:14px">
        <strong style="display:block;margin-bottom:6px">How it works</strong>
        <div style="display:flex;flex-direction:column;gap:4px;font-size:13px">
          <div><strong>Column A:</strong> Exercise name</div>
          <div><strong>Column B:</strong> Prescription &mdash; can include weight, RPE, or both</div>
          <div><strong>Column C:</strong> What you actually lifted (read on import)</div>
          <div>Day headers are detected automatically from keywords in the row</div>
          <div>Name each sheet by week: "Week 1", "Week 2", etc.</div>
        </div>
      </div>

      <div class="format-note">
        <strong style="display:block;margin-bottom:6px">Prescription examples</strong>
        <div style="display:flex;flex-direction:column;gap:4px;font-size:12px">
          <div><code style="color:var(--gold);background:rgba(201,168,76,0.12);padding:2px 7px;border-radius:4px">3x5</code> &mdash; 3 sets of 5</div>
          <div><code style="color:var(--gold);background:rgba(201,168,76,0.12);padding:2px 7px;border-radius:4px">4x3 @8</code> &mdash; 4 sets of 3 at RPE 8</div>
          <div><code style="color:var(--gold);background:rgba(201,168,76,0.12);padding:2px 7px;border-radius:4px">3x6(185)</code> &mdash; 3 sets of 6 at 185 lbs</div>
          <div><code style="color:var(--gold);background:rgba(201,168,76,0.12);padding:2px 7px;border-radius:4px">5x2(405) @9</code> &mdash; weight and RPE together</div>
          <div><code style="color:var(--gold);background:rgba(201,168,76,0.12);padding:2px 7px;border-radius:4px">3-4x10</code> &mdash; 3 to 4 sets of 10</div>
          <div><code style="color:var(--gold);background:rgba(201,168,76,0.12);padding:2px 7px;border-radius:4px">2-3 sets (pick reps)</code> &mdash; open rep range</div>
        </div>
      </div>
    `;
  }

  content += `
    <button class="parse-error-btn-primary" onclick="closeFormatExample()" style="margin-top:4px">Got It</button>
    <button class="parse-error-btn-secondary" onclick="downloadTemplate()" style="margin-top:8px;display:flex;align-items:center;justify-content:center;gap:8px">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="16" height="16"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
      Download Blank Template
    </button>
  `;

  body.innerHTML = content;
}

// ── PARSE ERROR MODAL ─────────────────────────────────────────────────────────
function showParseError(errorType, details) {
  const card = document.getElementById('parse-error-card');
  let title, msg;

  if (errorType === 'empty') {
    title = 'Could Not Read File';
    msg = details || 'The file appears to be empty or in an unsupported format. Make sure you\'re uploading an Excel file (.xlsx or .xls).';
  } else if (errorType === 'parse') {
    title = 'Unrecognized Format';
    msg = 'Unrack couldn\'t find exercises in this file. The spreadsheet may use a layout we don\'t support yet.';
  } else {
    title = 'Something Went Wrong';
    msg = details || 'There was an error reading this file. Please try again.';
  }

  card.innerHTML = `
    <div class="parse-error-icon">
      <svg viewBox="0 0 24 24" fill="none" stroke="#E22C2C" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" width="48" height="48">
        <circle cx="12" cy="12" r="10"/>
        <line x1="12" y1="8" x2="12" y2="12"/>
        <line x1="12" y1="16" x2="12.01" y2="16"/>
      </svg>
    </div>
    <div class="parse-error-title">${title}</div>
    <div class="parse-error-msg">${msg}</div>
    <div class="parse-error-actions">
      <button class="parse-error-btn-primary" onclick="closeParseError();document.getElementById('file-input').click()">Try Another File</button>
      <button class="parse-error-btn-secondary" onclick="closeParseError();openFormatExample()">View Supported Formats</button>
      <button class="parse-error-btn-secondary" onclick="downloadTemplate()" style="display:flex;align-items:center;justify-content:center;gap:8px">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="15" height="15"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        Download Blank Template
      </button>
      <button class="parse-error-btn-dismiss" onclick="closeParseError()">Dismiss</button>
    </div>
  `;

  document.getElementById('parse-error-modal').style.display = 'flex';
}

function closeParseError() {
  document.getElementById('parse-error-modal').style.display = 'none';
}

// ── ONBOARDING ────────────────────────────────────────────────────────────────
let _onboardGender = null;
let _onboardUnit = 'lbs';

function isOnboarded() { return localStorage.getItem(ONBOARDED_KEY) === '1'; }
function markOnboarded() { try{ localStorage.setItem(ONBOARDED_KEY, '1'); }catch(e){ console.error(e); } }

function checkOnboarding() {
  // Show onboarding only for brand new users: no programs AND never onboarded
  if (isOnboarded() || state.blocks.length > 0) {
    markOnboarded(); // auto-mark existing users
    render();
    return;
  }
  showOnboardingStep(1);
}

function showOnboardingStep(step) {
  const overlay = document.getElementById('onboarding-overlay');
  const body = document.getElementById('onboarding-body');
  overlay.style.display = 'flex';

  // Hide chrome during onboarding
  document.querySelector('.bottom-nav').style.display = 'none';
  document.querySelector('.header').style.display = 'none';

  if (step === 1) {
    body.innerHTML = `
      <div class="onboard-icon">
        <svg viewBox="0 0 28 40" fill="var(--gold)" width="56" height="80"><polygon points="18,0 7,22 14,22 10,40 21,18 14,18"/></svg>
      </div>
      <div class="onboard-title">Unrack</div>
      <div class="onboard-sub">Log it. Track it. Lift it.</div>
      <div class="onboard-features">
        <div class="onboard-feature">
          <div class="onboard-feature-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2"/><rect x="9" y="3" width="6" height="4" rx="1"/><path d="M9 14l2 2 4-4"/></svg></div>
          <div class="onboard-feature-text">
            <div class="onboard-feature-label">Track sets and RPE</div>
            <div class="onboard-feature-desc">Log weights and effort on every set, right from the gym floor</div>
          </div>
        </div>
        <div class="onboard-feature">
          <div class="onboard-feature-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg></div>
          <div class="onboard-feature-text">
            <div class="onboard-feature-label">Monitor progress</div>
            <div class="onboard-feature-desc">Estimated 1RM tracking across all your comp and accessory lifts</div>
          </div>
        </div>
        <div class="onboard-feature">
          <div class="onboard-feature-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg></div>
          <div class="onboard-feature-text">
            <div class="onboard-feature-label">Works offline</div>
            <div class="onboard-feature-desc">No account needed. All data stays on your device.</div>
          </div>
        </div>
      </div>
      <button class="onboard-primary-btn" onclick="showOnboardingStep(2)">Get Started</button>
    `;
    body.style.animation = 'none';
    body.offsetHeight;
    body.style.animation = 'onboardFadeIn 0.4s ease';
  }

  else if (step === 2) {
    const athlete = loadAthlete() || {};
    _onboardGender = athlete.gender || null;
    _onboardUnit = athlete.bwUnit || 'lbs';
    body.innerHTML = `
      <div class="onboard-title" style="font-size:26px;margin-bottom:4px;text-align:center">About You</div>
      <div class="onboard-sub" style="margin-bottom:20px;text-align:center">Used for DOTS & Wilks scores. All fields optional.</div>
      <div class="onboard-form">
        <div class="intake-field-label">Name</div>
        <input class="intake-input" id="onboard-name" type="text" placeholder="Your name"
          value="${escH(athlete.name || '')}" autocomplete="given-name">

        <div class="intake-field-label">Gender</div>
        <div class="intake-gender-row">
          <button class="intake-gender-btn${athlete.gender === 'male' ? ' selected' : ''}" onclick="onboardSetGender('male',this)">Male</button>
          <button class="intake-gender-btn${athlete.gender === 'female' ? ' selected' : ''}" onclick="onboardSetGender('female',this)">Female</button>
        </div>

        <div class="intake-field-label">Bodyweight</div>
        <div class="intake-bw-row">
          <input class="intake-input intake-bw-input" id="onboard-bw" type="number" min="30" max="400" placeholder="Weight"
            value="${athlete.bodyweight || ''}" inputmode="decimal">
          <div class="intake-unit-toggle">
            <button class="intake-unit-btn${_onboardUnit==='lbs'?' active':''}" onclick="onboardSetUnit('lbs',this)">lbs</button>
            <button class="intake-unit-btn${_onboardUnit==='kg'?' active':''}" onclick="onboardSetUnit('kg',this)">kg</button>
          </div>
        </div>
      </div>
      <button class="onboard-primary-btn" onclick="onboardSaveProfile()">Continue</button>
      <button class="onboard-skip-btn" onclick="showOnboardingStep(3)">Skip for now</button>
    `;
    body.style.animation = 'none';
    body.offsetHeight;
    body.style.animation = 'onboardFadeIn 0.4s ease';
  }

  else if (step === 3) {
    body.innerHTML = `
      <div class="onboard-title" style="font-size:26px;margin-bottom:4px;text-align:center">Upload Your Program</div>
      <div class="onboard-sub" style="margin-bottom:24px;text-align:center">Import your training program.</div>
      ${renderUploadOptions('ob-')}
      <button class="onboard-skip-btn" onclick="finishOnboarding()" style="margin-top:12px">I'll do this later</button>
    `;
    body.style.animation = 'none';
    body.offsetHeight;
    body.style.animation = 'onboardFadeIn 0.4s ease';
  }
}

function onboardSetGender(g, el) {
  _onboardGender = g;
  el.closest('.intake-gender-row').querySelectorAll('.intake-gender-btn').forEach(b => b.classList.remove('selected'));
  el.classList.add('selected');
}

function onboardSetUnit(u, el) {
  _onboardUnit = u;
  el.closest('.intake-unit-toggle').querySelectorAll('.intake-unit-btn').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
}

function onboardSaveProfile() {
  const name = document.getElementById('onboard-name')?.value.trim() || null;
  const bw = parseFloat(document.getElementById('onboard-bw')?.value) || null;
  const existing = loadAthlete() || {};
  const athlete = {
    name:       name              || existing.name       || null,
    gender:     _onboardGender    || existing.gender     || null,
    bodyweight: bw                ?? existing.bodyweight ?? null,
    bwUnit:     _onboardUnit      || existing.bwUnit     || 'lbs',
  };
  saveAthlete(athlete);
  showOnboardingStep(3);
}

function finishOnboarding() {
  markOnboarded();
  document.getElementById('onboarding-overlay').style.display = 'none';
  document.querySelector('.bottom-nav').style.display = '';
  document.querySelector('.header').style.display = '';
  render();
}

// ── END ONBOARDING ────────────────────────────────────────────────────────────

checkOnboarding();


// ── CUSTOM EXERCISE ───────────────────────────────────────────────────────────

// Build prescription string from modal inputs
function buildCustomPres(sets, reps, weight, rpe) {
  sets = parseInt(sets) || 1;
  reps = parseInt(reps) || 1;
  weight = weight ? parseFloat(weight) : 0;
  rpe   = rpe   ? parseFloat(rpe)   : 0;
  // Build a prescription string compatible with existing parsers.
  // parseSets pattern: NxM(token) where token is weight (number) or RPE string (isRpe=true)
  // parseSimple pattern: NxM (no weight/RPE in string — show via coachNotes instead)
  if (weight && rpe) {
    // Both: use weight as the prescribed load token, put RPE in coachNotes at call site
    return Array(sets).fill(`${reps}(${weight})`).join(' ');
  }
  if (rpe) {
    return Array(sets).fill(`${reps}(RPE${rpe})`).join(' ');
  }
  if (weight) {
    return Array(sets).fill(`${reps}(${weight})`).join(' ');
  }
  return `${sets}x${reps}`;
}

function buildCustomCoachNote(weight, rpe) {
  if (weight && rpe) return `Target: ${weight}lb @ RPE ${rpe}`;
  if (rpe) return `Target: RPE ${rpe}`;
  if (weight) return `Target: ${weight}lb`;
  return null;
}

// Find the current block/week/day context for modal
function getActiveContext() {
  const block = state.activeBlock;
  if (!block) return null;
  const week = block.weeks[state.activeWeek];
  const day = week?.days[state.activeDay];
  return { block, week, day };
}

// Check if same exercise+protocol already exists on a day
function customExExistsOnDay(day, name, pres) {
  return day.exercises.some(ex =>
    ex.name.toLowerCase() === name.toLowerCase() && ex.prescription === pres
  );
}

// Apply custom exercise forward to all uncompleted instances of same day-of-week
function applyCustomExForward(block, fromWeekIdx, dayName, exObj) {
  for (let wi = fromWeekIdx; wi < block.weeks.length; wi++) {
    const week = block.weeks[wi];
    const day = week.days.find(d => d.name === dayName);
    if (!day) continue;
    // Skip completed days (except the current day itself which is always added)
    if (wi > fromWeekIdx && isDayComplete(block, week, day)) continue;
    // Skip if exact same protocol already exists
    if (customExExistsOnDay(day, exObj.name, exObj.prescription)) continue;
    day.exercises.push({ ...exObj });
  }
}

// Remove custom exercise from all weeks (or just current)
function removeCustomEx(block, dayName, exName, allWeeks) {
  const ctx = getActiveContext();
  if (!ctx) return;
  block.weeks.forEach((week, wi) => {
    if (!allWeeks && wi !== state.activeWeek) return;
    const day = week.days.find(d => d.name === dayName);
    if (!day) return;
    const idx = day.exercises.findIndex(ex => ex.name === exName && ex.isCustom === true);
    if (idx !== -1) {
      day.exercises.splice(idx, 1);
      // Clean up logs
      const k = lk(block.id, week.label, dayName, exName);
      delete state.logs[k];
    }
  });
  saveBlocks();
  saveLogs();
  render();
}

function openAddExerciseModal() {
  _openCustomExModal(null);
}

function openEditExerciseModal(key, evt) {
  if (evt) evt.stopPropagation();
  // Parse key to get exercise info
  const parts = key.split('||');
  const exName = parts[3];
  const ctx = getActiveContext();
  if (!ctx) return;
  const ex = ctx.day.exercises.find(e => e.name === exName && e.isCustom);
  if (!ex) return;
  _openCustomExModal(key, ex);
}

function _openCustomExModal(existingKey, existingEx) {
  const existing = document.getElementById('custom-ex-overlay');
  if (existing) existing.remove();

  const isEdit = !!existingKey;
  let prefillSets = '', prefillReps = '', prefillWeight = '', prefillRpe = '', prefillName = '';

  if (isEdit && existingEx) {
    prefillName = existingEx.name;
    // Parse prescription back out
    const pres = existingEx.prescription || '';
    const m = pres.match(/^(\d+)x(\d+)/);
    // Intentionally not pre-filling sets/reps — user should re-enter to avoid confusion
    const wm = pres.match(/\(([\d.]+)\)/);
    if (wm) prefillWeight = wm[1];
    const rm = pres.match(/RPE([\d.]+)/);
    if (rm) prefillRpe = rm[1];
  }

  const overlay = document.createElement('div');
  overlay.className = 'custom-ex-overlay';
  overlay.id = 'custom-ex-overlay';
  overlay.onclick = (e) => { if (e.target === overlay) closeCustomExModal(); };

  overlay.innerHTML = `
  <div class="custom-ex-sheet">
    <div class="custom-ex-sheet-header">
      <span class="custom-ex-sheet-title">${isEdit ? 'Edit Exercise' : 'Add Exercise'}</span>
      <button class="custom-ex-close" onclick="closeCustomExModal()">✕</button>
    </div>
    <div class="custom-ex-field">
      <div class="custom-ex-label">Exercise Name</div>
      <input class="custom-ex-input" id="cex-name" type="text" placeholder="e.g. Hip Thrust" value="${escH(prefillName)}" autocomplete="off" autocorrect="off" spellcheck="false">
    </div>
    <div class="custom-ex-row">
      <div class="custom-ex-field">
        <div class="custom-ex-label">Sets</div>
        <input class="custom-ex-input" id="cex-sets" type="number" inputmode="numeric" placeholder="3" value="${prefillSets}" min="1">
      </div>
      <div class="custom-ex-field">
        <div class="custom-ex-label">Reps</div>
        <input class="custom-ex-input" id="cex-reps" type="number" inputmode="numeric" placeholder="10" value="${prefillReps}" min="1">
      </div>
    </div>
    <div class="custom-ex-row" style="grid-template-columns:1fr 1fr">
      <div class="custom-ex-field">
        <div class="custom-ex-label">Weight (lbs)</div>
        <input class="custom-ex-input" id="cex-weight" type="number" inputmode="decimal" placeholder="optional" value="${prefillWeight}" min="0">
      </div>
      <div class="custom-ex-field">
        <div class="custom-ex-label">RPE (1–10)</div>
        <input class="custom-ex-input" id="cex-rpe" type="number" inputmode="decimal" placeholder="optional" value="${prefillRpe}" min="1" max="10" step="0.5">
      </div>
    </div>
    <div class="custom-ex-error" id="cex-error">Weight or RPE is required.</div>
    <button class="custom-ex-save-btn" onclick="_saveCustomEx(${isEdit ? `'${existingKey}'` : 'null'})">${isEdit ? 'Save Changes' : 'Add to Workout'}</button>
  </div>`;

  document.body.appendChild(overlay);
  setTimeout(() => document.getElementById('cex-name')?.focus(), 100);
}

function closeCustomExModal() {
  const el = document.getElementById('custom-ex-overlay');
  if (el) el.remove();
}

function _saveCustomEx(existingKey) {
  const name = document.getElementById('cex-name')?.value.trim();
  const sets = document.getElementById('cex-sets')?.value;
  const reps = document.getElementById('cex-reps')?.value;
  const weight = document.getElementById('cex-weight')?.value;
  const rpe = document.getElementById('cex-rpe')?.value;
  const errEl = document.getElementById('cex-error');

  // Validation
  if (!name) { errEl.textContent = 'Exercise name is required.'; errEl.classList.add('visible'); return; }
  if (!weight && !rpe) { errEl.textContent = 'Weight or RPE is required (or both).'; errEl.classList.add('visible'); return; }
  errEl.classList.remove('visible');

  const ctx = getActiveContext();
  if (!ctx) return;
  const { block, week, day } = ctx;

  const pres = buildCustomPres(sets || 3, reps || 1, weight, rpe);
  const coachNote = buildCustomCoachNote(weight, rpe);
  const exObj = { name, prescription: pres, isCustom: true, note: null, coachNotes: coachNote ? [coachNote] : [], supersetGroup: null };

  if (existingKey) {
    // Edit mode — update in place and propagate forward
    const oldParts = existingKey.split('||');
    const oldName = oldParts[3];
    // Update all instances across weeks
    block.weeks.forEach((w, wi) => {
      const d = w.days.find(dd => dd.name === day.name);
      if (!d) return;
      const ex = d.exercises.find(e => e.name === oldName && e.isCustom);
      if (!ex) return;
      // Only update uncompleted weeks (and current week)
      if (wi > state.activeWeek && isDayComplete(block, w, d)) return;
      ex.name = name;
      ex.prescription = pres;
    });
  } else {
    // Add mode — apply to current + forward uncompleted days
    applyCustomExForward(block, state.activeWeek, day.name, exObj);
  }

  saveBlocks();
  closeCustomExModal();
  render();
}

function openDeleteExerciseSheet(key, exName, evt) {
  if (evt) evt.stopPropagation();
  const existing = document.getElementById('delete-ex-overlay');
  if (existing) existing.remove();

  const ctx = getActiveContext();
  if (!ctx) return;
  const dayName = ctx.day.name;

  const overlay = document.createElement('div');
  overlay.className = 'delete-ex-overlay';
  overlay.id = 'delete-ex-overlay';
  overlay.onclick = (e) => { if (e.target === overlay) closeDeleteExSheet(); };

  overlay.innerHTML = `
  <div class="delete-ex-sheet">
    <div class="delete-ex-title">Delete ${exName}</div>
    <div class="delete-ex-desc">Remove this exercise from your workout. This cannot be undone.</div>
    <button class="delete-ex-btn danger" onclick="_confirmDeleteEx('${esc(exName)}','${esc(dayName)}',true)">Delete from all weeks</button>
    <button class="delete-ex-btn single" onclick="_confirmDeleteEx('${esc(exName)}','${esc(dayName)}',false)">Delete from this week only</button>
  </div>`;

  document.body.appendChild(overlay);
}

function closeDeleteExSheet() {
  const el = document.getElementById('delete-ex-overlay');
  if (el) el.remove();
}

function _confirmDeleteEx(exName, dayName, allWeeks) {
  closeDeleteExSheet();
  const block = state.activeBlock;
  if (!block) return;
  removeCustomEx(block, dayName, exName, allWeeks);
}


// ── ACTUAL REPS EDITOR ────────────────────────────────────────────────────────

function openRepsEditor(sk, prescReps) {
  // Show one-time tooltip on first use
  if (!localStorage.getItem('liftlog_rep_tip_seen')) {
    showRepTip();
  }
  state.editingRepsKey = sk;
  renderSetRow(sk);
  // Focus the input after render — preventScroll stops browser from jumping
  setTimeout(() => {
    const input = document.getElementById('reps-popover-' + sk);
    if (input) { input.focus({preventScroll:true}); input.select(); }
  }, 50);
}

function saveActualReps(sk, value, prescReps) {
  state.editingRepsKey = null;
  const v = value ? String(parseInt(value)) : '';
  // Only store if different from prescribed — clear if matches
  if (v && v !== String(prescReps)) {
    state.logs[sk] = { ...(state.logs[sk] || {}), actualReps: v };
  } else {
    if (state.logs[sk]) delete state.logs[sk].actualReps;
  }
  saveLogs();
  renderSetRow(sk);
}

// Lightweight re-render of a single set row without scroll disruption
function renderSetRow(sk) {
  // Extract exercise key from set key (remove ||sN suffix) to find anchor card
  const exKey = sk.replace(/\|\|s\d+$/, '');
  const escaped = cssEsc(exKey);
  const card = document.querySelector(`.exercise-card[data-ex-key='${escaped}']`);
  let anchorOffset = null;
  if (card) { anchorOffset = card.getBoundingClientRect().top; }
  render();
  if (card && anchorOffset !== null) {
    const newCard = document.querySelector(`.exercise-card[data-ex-key='${escaped}']`);
    if (newCard) { window.scrollBy(0, newCard.getBoundingClientRect().top - anchorOffset); }
  }
}

function showRepTip() {
  // Mark seen immediately so re-tapping another exercise never re-shows
  try{ localStorage.setItem('liftlog_rep_tip_seen', '1'); }catch(e){ console.error(e); }
  const existing = document.getElementById('rep-tip-tooltip');
  if (existing) return;
  // Insert above the sets-grid, inside the card
  setTimeout(() => {
    const grids = document.querySelectorAll('.sets-grid');
    if (!grids.length) return;
    const tooltip = document.createElement('div');
    tooltip.className = 'rep-tip-tooltip';
    tooltip.id = 'rep-tip-tooltip';
    tooltip.innerHTML = `<span class="rep-tip-tooltip-text">Tap the prescription to log different reps</span>
      <button class="rep-tip-dismiss" onclick="dismissRepTip()">✕</button>`;
    grids[0].parentNode.insertBefore(tooltip, grids[0]);
  }, 80);
}

function dismissRepTip() {
  const el = document.getElementById('rep-tip-tooltip');
  if (el) el.remove();
}

// ── COLUMN MAPPER WIZARD ──────────────────────────────────────────────────────
const COLMAP_STORAGE_KEY = 'liftlog_colmaps';
let _cmWb = null;          // the workbook being mapped
let _cmStep = 1;           // current wizard step
let _cmSheetRows = {};     // {sheetName: rows[][]} — raw data cache
let _cmMapping = {         // user's column assignments
  exercise: -1,
  prescription: -1,        // combined prescription column (e.g. "3x5 @RPE 8")
  setsCol: -1,             // split mode: separate sets column
  repsCol: -1,             // split mode: separate reps column
  loadCol: -1,             // split mode: separate load/intensity column
  logged: -1,
  coachNotes: -1,
  lifterNotes: -1
};
let _cmSplitPres = false;  // true = split Sets/Reps/Load columns
let _cmDayMode = 'sections'; // 'sections' | 'sheets'
let _cmSheetMode = 'week';   // 'week' | 'block'
let _cmDetectedDays = [];    // discovered day names
let _cmDataStartRow = 0;     // first data row (after header)
let _cmSelCol = -1;          // column user tapped
let _cmExcludedSections = new Set(); // day names user toggled off
let _cmMeta = {}; // user-entered metadata from step 3

function loadSavedMappings() {
  try { return JSON.parse(localStorage.getItem(COLMAP_STORAGE_KEY)) || {}; } catch(e) { return {}; }
}
function saveMappingForFile(fingerprint, mapping) {
  const all = loadSavedMappings();
  all[fingerprint] = mapping;
  try { localStorage.setItem(COLMAP_STORAGE_KEY, JSON.stringify(all)); } catch(e) {}
}
function getFileFingerprint(wb) {
  // Use column headers from first sheet as fingerprint so same coach format auto-maps
  try {
    const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1, defval:null});
    for (let i = 0; i < Math.min(5, rows.length); i++) {
      const row = rows[i]; if (!row) continue;
      const strs = row.filter(c => c != null).map(c => String(c).trim().toLowerCase()).filter(Boolean);
      if (strs.length >= 2) return strs.join('|');
    }
  } catch(e) {}
  return null;
}

function openColumnMapper(wb) {
  _cmWb = wb;
  _cmStep = 1;
  _cmSheetRows = {};
  _cmDetectedDays = [];
  _cmExcludedSections = new Set();
  _cmMeta = {};
  _cmDayMode = 'sections';
  _cmSheetMode = 'week';
  _cmMapping = { exercise: -1, prescription: -1, setsCol: -1, repsCol: -1, loadCol: -1, logged: -1, coachNotes: -1, lifterNotes: -1 };
  _cmSplitPres = false;
  _cmSelCol = -1;

  // Cache all sheet rows
  for (const sn of wb.SheetNames) {
    try {
      const rows = XLSX.utils.sheet_to_json(wb.Sheets[sn], {header:1, defval:null});
      const clean = rows.map(r => r ? r.map(c => (typeof c === 'string' && c.startsWith("'")) ? c.slice(1) : c) : r);
      _cmSheetRows[sn] = clean;
    } catch(e) { _cmSheetRows[sn] = []; }
  }

  // Auto-detect column assignments from header row
  autoDetectColumns();

  // Check for saved mapping
  const fp = getFileFingerprint(wb);
  if (fp) {
    const saved = loadSavedMappings()[fp];
    if (saved) {
      _cmMapping = { ...saved };
      // If we have a saved mapping, try to parse directly with it
      const blocks = parseCWorkbook(wb);
      if (blocks && blocks.length > 0) {
        openImportIntent(blocks);
        return;
      }
    }
  }

  document.getElementById('colmap-modal').style.display = 'block';
  cmGoStep(1);
}

function closeColumnMapper() {
  document.getElementById('colmap-modal').style.display = 'none';
  _cmWb = null;
}

function cmGoStep(n) {
  _cmStep = n;
  document.querySelectorAll('.colmap-step').forEach(s => s.classList.remove('active'));
  const stepEl = document.getElementById('cm-step-' + n);
  if (stepEl) stepEl.classList.add('active');
  for (let i = 1; i <= 3; i++) {
    const pill = document.getElementById('cm-pill-' + i);
    pill.className = 'colmap-step-pill';
    if (i < n) pill.classList.add('done');
    if (i === n) pill.classList.add('active');
  }
  document.getElementById('cm-step-label').textContent = `Step ${n} of 3`;

  if (n === 1) renderCmStep1();
  else if (n === 2) renderCmStep2();
  else renderCmStep3();

  document.getElementById('colmap-modal').scrollTop = 0;
}

function autoDetectColumns() {
  // Scan all rows of first sheet for header keywords
  const firstSheet = _cmSheetRows[_cmWb.SheetNames[0]] || [];
  let bestRow = -1;

  // Find first row with training-data header keywords (Sets, Reps, Load, etc.)
  for (let i = 0; i < firstSheet.length; i++) {
    const row = firstSheet[i]; if (!row) continue;
    const strs = row.map(c => String(c || '').toLowerCase());
    const hasTrainingHdr = strs.some(s => s.includes('sets') || s.includes('reps') || s.includes('exercise') || s.includes('record') || s.includes('weight') || s.includes('load'));
    if (hasTrainingHdr) { bestRow = i; break; }
  }

  if (bestRow >= 0) {
    // Look backward from the header row for a day label row
    // A day label is a short string like "Day 1", "Monday", "Upper 1" in a row
    // that doesn't have header keywords itself
    let dayLabelRow = bestRow;
    for (let i = bestRow - 1; i >= Math.max(0, bestRow - 3); i--) {
      const row = firstSheet[i]; if (!row) continue;
      const vals = row.filter(c => c != null && String(c).trim() !== '');
      if (vals.length === 0) continue;
      const firstVal = String(vals[0]).trim();
      // Day label: short text, few filled cells, looks like a day name
      const isDayLabel = firstVal.length > 0 && firstVal.length < 30 && vals.length <= 3 &&
        (/day\s*\d/i.test(firstVal) || /^(mon|tue|wed|thu|fri|sat|sun)/i.test(firstVal) ||
         /^(upper|lower|push|pull|full|leg)/i.test(firstVal) || /^week/i.test(firstVal));
      if (isDayLabel) { dayLabelRow = i; break; }
    }

    _cmDataStartRow = dayLabelRow;
    const row = firstSheet[bestRow];
    const strs = row.map(c => String(c || '').toLowerCase());

    strs.forEach((s, idx) => {
      // Exercise name column
      if (_cmMapping.exercise < 0 && (s.includes('exercise') || s.includes('movement') || s.includes('lift'))) _cmMapping.exercise = idx;
      // Check for split columns: separate Sets, Reps, Load headers
      if (s === 'sets' || s === 'set') _cmMapping.setsCol = idx;
      if (s === 'reps' || s === 'rep') _cmMapping.repsCol = idx;
      if (s === 'load' || s === 'intensity' || s === 'weight') _cmMapping.loadCol = idx;
      // Combined prescription column  
      if (_cmMapping.prescription < 0 && (s.includes('prescription') || s.includes('scheme'))) _cmMapping.prescription = idx;
      // Logged weight
      if (_cmMapping.logged < 0 && (s.includes('record') || s.includes('actual') || s.includes('logged') || s.includes('result') || s.includes('weight used'))) _cmMapping.logged = idx;
      // Coach notes
      if (_cmMapping.coachNotes < 0 && s.includes('coach')) _cmMapping.coachNotes = idx;
      // Lifter notes
      if (_cmMapping.lifterNotes < 0 && (s.includes('lifter') || s.includes('athlete') || s.includes('my note'))) _cmMapping.lifterNotes = idx;
    });

    // If we found separate Sets + Reps columns, use split mode
    if (_cmMapping.setsCol >= 0 && _cmMapping.repsCol >= 0) {
      _cmSplitPres = true;
      _cmMapping.prescription = -1; // clear combined
    } else if (_cmMapping.prescription < 0) {
      // Check if "sets" matched but reps didn't — might be combined column
      // Only use split if we have at least sets + reps
      _cmSplitPres = false;
      _cmMapping.setsCol = -1;
      _cmMapping.repsCol = -1;
      _cmMapping.loadCol = -1;
    }

    // If no exercise column found, guess from data rows
    if (_cmMapping.exercise < 0 && !_cmSplitPres && _cmMapping.prescription < 0) {
      for (let ri = _cmDataStartRow; ri < Math.min(_cmDataStartRow + 5, firstSheet.length); ri++) {
        const dr = firstSheet[ri]; if (!dr) continue;
        for (let ci = 0; ci < dr.length; ci++) {
          const val = String(dr[ci] || '');
          if (val.length > 5 && /[a-zA-Z]{3,}/.test(val) && _cmMapping.exercise < 0) { _cmMapping.exercise = ci; }
          if (/\d+x\d+|\d+\s*@\s*\d+|sets/i.test(val) && _cmMapping.prescription < 0 && ci !== _cmMapping.exercise) { _cmMapping.prescription = ci; }
        }
        if (_cmMapping.exercise >= 0) break;
      }
    }

    // If exercise found but not prescription (and not split mode), guess next column
    if (_cmMapping.exercise >= 0 && _cmMapping.prescription < 0 && !_cmSplitPres) {
      _cmMapping.prescription = _cmMapping.exercise + 1;
    }
    // If prescription found but not logged, guess next column after prescription
    if (_cmMapping.prescription >= 0 && _cmMapping.logged < 0) {
      const candidate = _cmMapping.prescription + 1;
      if (candidate < (row.length || 10)) _cmMapping.logged = candidate;
    }
  } else {
    // No header found — assume row 0 is header or data
    _cmDataStartRow = 0;
    _cmMapping.exercise = 0;
    _cmMapping.prescription = 1;
    _cmMapping.logged = 2;
  }
}

function cmColLetter(idx) { return idx >= 0 ? String.fromCharCode(65 + idx) : '—'; }

function renderCmStep1() {
  const firstSheetName = _cmWb.SheetNames[0];
  const rows = _cmSheetRows[firstSheetName] || [];
  const maxCols = rows.reduce((m, r) => r ? Math.max(m, r.length) : m, 0);
  const previewLimit = Math.min(50, rows.length);

  // Build table preview — every cell is tappable
  let tableH = '<table class="colmap-table"><tr><th>#</th>';
  for (let c = 0; c < maxCols; c++) tableH += `<th>${cmColLetter(c)}</th>`;
  tableH += '</tr>';
  for (let ri = 0; ri < previewLimit; ri++) {
    const row = rows[ri];
    if (!row || !row.some(c => c != null && String(c).trim() !== '')) continue;
    const isSelected = _cmDataStartRow > 0 && ri >= _cmDataStartRow;
    const isStart = ri === _cmDataStartRow;
    const isDimmed = _cmDataStartRow > 0 && ri < _cmDataStartRow;
    let trCls = isDimmed ? 'cm-skip-row' : (isStart ? 'cm-start-row cm-data-row' : (isSelected ? 'cm-data-row' : ''));
    tableH += `<tr class="${trCls}">`;
    tableH += `<td class="cm-row-num">${ri + 1}</td>`;
    for (let c = 0; c < maxCols; c++) {
      const val = row[c] != null ? String(row[c]).substring(0, 30) : '';
      const isTapTarget = !isDimmed && val.trim();
      tableH += `<td class="cm-tap-cell${isStart && c === _cmSelCol ? ' cm-selected-cell' : ''}" ${isTapTarget ? `onclick="cmTapCell(${ri},${c})"` : ''}>${escH(val)}</td>`;
    }
    tableH += '</tr>';
  }
  tableH += '</table>';

  const hasSelection = _cmDataStartRow > 0;
  const canProceed = hasSelection && _cmMapping.exercise >= 0 && (_cmMapping.prescription >= 0 || _cmSplitPres);

  const el = document.getElementById('cm-step-1');
  el.innerHTML = `
    <div class="colmap-section-title">${hasSelection ? 'Does this look right?' : 'Tap your first exercise'}</div>
    <div class="colmap-section-sub">${hasSelection ? 'We\'ll read everything highlighted below. Tap a different cell to change.' : 'Find the first exercise in your program and tap it. We\'ll figure out the rest.'}</div>
    <div class="colmap-preview">
      <div class="colmap-preview-hdr">
        <span class="colmap-preview-label">Preview</span>
        <span class="colmap-sheet-name">${escH(firstSheetName)}</span>
      </div>
      <div class="colmap-table-wrap">${tableH}</div>
      ${hasSelection ? `<div class="cm-start-hint">↓ Reading from row ${_cmDataStartRow + 1} · Exercise in Col ${cmColLetter(_cmMapping.exercise)}${_cmSplitPres ? ' · Sets/Reps/Load split' : _cmMapping.prescription >= 0 ? ' · Prescription in Col ' + cmColLetter(_cmMapping.prescription) : ''}</div>` : ''}
    </div>
    ${canProceed ? `<button class="colmap-btn-primary" onclick="cmGoStep(2)">Next</button>` : ''}
    <button class="colmap-btn-secondary" onclick="closeColumnMapper()">Cancel</button>
  `;
}

// When user taps a cell, set that as the exercise column + data start row
// Then auto-detect other columns from the header row above
function cmTapCell(rowIdx, colIdx) {
  _cmDataStartRow = rowIdx;
  _cmSelCol = colIdx;
  _cmMapping.exercise = colIdx;

  // Reset other mappings
  _cmMapping.prescription = -1;
  _cmMapping.setsCol = -1;
  _cmMapping.repsCol = -1;
  _cmMapping.loadCol = -1;
  _cmMapping.logged = -1;
  _cmMapping.coachNotes = -1;
  _cmMapping.lifterNotes = -1;
  _cmSplitPres = false;

  const firstSheetName = _cmWb.SheetNames[0];
  const rows = _cmSheetRows[firstSheetName] || [];

  // Look at the header row above the selected row (or a few rows above)
  for (let hri = rowIdx - 1; hri >= Math.max(0, rowIdx - 5); hri--) {
    const hrow = rows[hri]; if (!hrow) continue;
    const strs = hrow.map(c => String(c || '').toLowerCase().trim());

    // Check for split columns (Sets + Reps as separate headers)
    const setsI = strs.findIndex(s => s === 'sets' || s === 'set');
    const repsI = strs.findIndex(s => s === 'reps' || s === 'rep');
    if (setsI >= 0 && repsI >= 0) {
      _cmSplitPres = true;
      _cmMapping.setsCol = setsI;
      _cmMapping.repsCol = repsI;
      const loadI = strs.findIndex(s => s === 'load' || s === 'intensity' || s === 'weight');
      if (loadI >= 0) _cmMapping.loadCol = loadI;
      // Logged weight
      const logI = strs.findIndex(s => s.includes('weight used') || s.includes('logged') || s.includes('actual') || s.includes('record'));
      if (logI >= 0) _cmMapping.logged = logI;
      // Coach notes
      const coachI = strs.findIndex(s => s.includes('coach'));
      if (coachI >= 0) _cmMapping.coachNotes = coachI;
      // Athlete notes
      const noteI = strs.findIndex(s => s.includes('athlete') || s.includes('lifter') || s.includes('my note'));
      if (noteI >= 0) _cmMapping.lifterNotes = noteI;
      break;
    }

    // Check for combined prescription header
    const presI = strs.findIndex(s => s.includes('prescription') || s.includes('scheme'));
    if (presI >= 0) {
      _cmMapping.prescription = presI;
      break;
    }

    // Check for any recognizable header keywords
    const hasKeywords = strs.some(s => s.includes('sets') || s.includes('reps') || s.includes('exercise') || s.includes('record'));
    if (hasKeywords) {
      // Try to assign columns from this header
      strs.forEach((s, idx) => {
        if (s.includes('sets') || s.includes('reps') || s.includes('prescription')) {
          if (_cmMapping.prescription < 0) _cmMapping.prescription = idx;
        }
        if (s.includes('record') || s.includes('actual') || s.includes('logged') || s.includes('weight used')) {
          if (_cmMapping.logged < 0) _cmMapping.logged = idx;
        }
        if (s.includes('coach') && _cmMapping.coachNotes < 0) _cmMapping.coachNotes = idx;
        if ((s.includes('lifter') || s.includes('athlete')) && _cmMapping.lifterNotes < 0) _cmMapping.lifterNotes = idx;
      });
      break;
    }
  }

  // Fallback: if no header found, guess prescription is next column after exercise
  if (!_cmSplitPres && _cmMapping.prescription < 0) {
    _cmMapping.prescription = colIdx + 1;
  }

  renderCmStep1();
}

function renderCmStep2() {
  // Detect days based on mode
  detectDays();

  let daysH = '';
  if (_cmDetectedDays.length > 0) {
    daysH = `<div class="colmap-card">
      <div class="colmap-card-title">We found ${_cmDetectedDays.length} training day${_cmDetectedDays.length===1?'':'s'}</div>
      <div class="colmap-found-days">${_cmDetectedDays.map(d => `<div class="colmap-day-chip">${escH(d)}</div>`).join('')}</div>
    </div>`;
  } else {
    daysH = `<div class="colmap-card">
      <div class="colmap-card-title" style="color:var(--text-faint)">No training days detected</div>
      <div style="font-size:12px;color:var(--text-dim);line-height:1.5">Try switching the day boundary option above. If your sheet doesn't have day headers, all exercises will be grouped into one day per sheet.</div>
    </div>`;
  }

  const el = document.getElementById('cm-step-2');
  el.innerHTML = `
    <div class="colmap-section-title">How are training days organized?</div>
    <div class="colmap-section-sub">Tell us where one day ends and the next begins in your spreadsheet.</div>
    <div class="colmap-card">
      <div class="colmap-card-title">Day boundaries</div>
      <div class="colmap-option" onclick="cmSelectRadio(this,'sections')">
        <div class="colmap-radio${_cmDayMode==='sections'?' selected':''}"></div>
        <div class="colmap-option-text"><strong>Days are sections within each sheet</strong><br>Rows like "Day 1", "Upper 1" mark where each day starts</div>
      </div>
      <div class="colmap-option" onclick="cmSelectRadio(this,'sheets')">
        <div class="colmap-radio${_cmDayMode==='sheets'?' selected':''}"></div>
        <div class="colmap-option-text"><strong>Each sheet is one training day</strong><br>Sheet tabs represent individual days</div>
      </div>
    </div>
    <div class="colmap-card">
      <div class="colmap-card-title">Sheet organization</div>
      <div class="colmap-option" onclick="cmSelectSheetRadio(this,'week')">
        <div class="colmap-radio${_cmSheetMode==='week'?' selected':''}"></div>
        <div class="colmap-option-text"><strong>Each sheet is one week</strong></div>
      </div>
      <div class="colmap-option" onclick="cmSelectSheetRadio(this,'block')">
        <div class="colmap-radio${_cmSheetMode==='block'?' selected':''}"></div>
        <div class="colmap-option-text"><strong>Each sheet is a full training block</strong><br>All weeks are contained in one sheet</div>
      </div>
    </div>
    ${daysH}
    <button class="colmap-btn-primary" onclick="cmGoStep(3)">Next</button>
    <button class="colmap-btn-secondary" onclick="cmGoStep(1)">Back</button>
  `;
}

function renderCmStep3() {
  // Do a trial parse to get stats
  const blocks = parseCWorkbook(_cmWb);
  const totalExercises = blocks ? blocks.reduce((sum, b) => sum + b.weeks.reduce((ws, w) => ws + w.days.reduce((ds, d) => ds + d.exercises.length, 0), 0), 0) : 0;
  const totalWeeks = blocks ? blocks.reduce((m, b) => Math.max(m, b.weeks?.length || 0), 0) : 0;
  const totalDays = blocks ? blocks.reduce((sum, b) => sum + b.weeks.reduce((ws, w) => ws + w.days.length, 0), 0) : 0;
  const daysPerWeek = totalWeeks > 0 ? Math.round(totalDays / totalWeeks) : totalDays;

  let loggedSets = 0;
  if (blocks) {
    blocks.forEach(b => b.weeks.forEach(w => w.days.forEach(d => d.exercises.forEach(ex => {
      if (ex.loggedWeight) loggedSets++;
    }))));
  }

  // Get auto-detected metadata as defaults
  const block = blocks && blocks[0];
  const detectedAthlete = (block && block.athleteName !== 'Athlete') ? block.athleteName : '';
  const detectedProgram = (block && block.name && block.name !== (block.id || 'Training Program')) ? block.name : '';
  const detectedDateRange = (block && block.dateRange) || '';
  const detectedMaxes = (block && block.maxes) || {};

  // Use previously entered values if user already visited this step (preserve edits on back/forward)
  const athlete = _cmMeta.athlete !== undefined ? _cmMeta.athlete : detectedAthlete;
  const program = _cmMeta.program !== undefined ? _cmMeta.program : detectedProgram;
  const sqMax = _cmMeta.squat !== undefined ? _cmMeta.squat : (detectedMaxes.squat || '');
  const bnMax = _cmMeta.bench !== undefined ? _cmMeta.bench : (detectedMaxes.bench || '');
  const dlMax = _cmMeta.deadlift !== undefined ? _cmMeta.deadlift : (detectedMaxes.deadlift || '');

  const el = document.getElementById('cm-step-3');
  el.innerHTML = `
    <div class="colmap-section-title">Review & Confirm</div>
    <div class="colmap-section-sub">Fill in any details about this program. All fields are optional.</div>

    <div class="colmap-summary">
      <div class="colmap-summary-row">
        <span class="colmap-summary-label">Sheets</span>
        <span class="colmap-summary-value">${_cmWb.SheetNames.length}</span>
      </div>
      <div class="colmap-summary-row">
        <span class="colmap-summary-label">Weeks</span>
        <span class="colmap-summary-value">${totalWeeks}</span>
      </div>
      <div class="colmap-summary-row">
        <span class="colmap-summary-label">Days${totalWeeks>1?' / week':''}</span>
        <span class="colmap-summary-value">${daysPerWeek}</span>
      </div>
      <div class="colmap-summary-row">
        <span class="colmap-summary-label">Exercises</span>
        <span class="colmap-summary-value">${totalExercises}</span>
      </div>
      ${loggedSets>0?`<div class="colmap-summary-row">
        <span class="colmap-summary-label">Pre-filled</span>
        <span class="colmap-summary-value green">${loggedSets} logged</span>
      </div>`:''}
    </div>

    <div class="colmap-card">
      <div class="colmap-card-title">Program Details</div>
      <div class="colmap-field">
        <div class="colmap-field-label">Athlete Name</div>
        <input class="colmap-field-input" id="cm-meta-athlete" type="text" placeholder="Your name" value="${escH(athlete)}" oninput="_cmMeta.athlete=this.value">
      </div>
      <div class="colmap-field">
        <div class="colmap-field-label">Program Name</div>
        <input class="colmap-field-input" id="cm-meta-program" type="text" placeholder="e.g. Hypertrophy Block 1" value="${escH(program)}" oninput="_cmMeta.program=this.value">
      </div>
    </div>

    <div class="colmap-card">
      <div class="colmap-card-title">Competition Maxes <span class="colmap-optional">Optional</span></div>
      <div class="colmap-field-hint" style="margin-bottom:10px">Used for percentage-based prescriptions and e1RM tracking.</div>
      <div class="colmap-maxes-row">
        <div class="colmap-field">
          <div class="colmap-field-label">Squat</div>
          <input class="colmap-field-input" id="cm-meta-squat" type="number" inputmode="numeric" placeholder="lbs" value="${sqMax}" oninput="_cmMeta.squat=this.value">
        </div>
        <div class="colmap-field">
          <div class="colmap-field-label">Bench</div>
          <input class="colmap-field-input" id="cm-meta-bench" type="number" inputmode="numeric" placeholder="lbs" value="${bnMax}" oninput="_cmMeta.bench=this.value">
        </div>
        <div class="colmap-field">
          <div class="colmap-field-label">Deadlift</div>
          <input class="colmap-field-input" id="cm-meta-deadlift" type="number" inputmode="numeric" placeholder="lbs" value="${dlMax}" oninput="_cmMeta.deadlift=this.value">
        </div>
      </div>
    </div>

    <div style="padding:12px 14px;background:rgba(201,168,76,0.04);border:1px solid rgba(201,168,76,0.15);border-radius:10px;margin-bottom:20px">
      <div style="font-size:12px;color:var(--text-dim);line-height:1.5">Column mapping will be saved so future uploads from the same format import automatically.</div>
    </div>
    ${totalExercises > 0 ? `
      <button class="colmap-btn-primary" onclick="confirmColumnMapper()">Import Program</button>
    ` : `
      <button class="colmap-btn-primary" disabled>No exercises found</button>
      <div style="font-size:12px;color:var(--red);text-align:center;margin-top:4px">Try adjusting your column assignments or day detection settings.</div>
    `}
    <button class="colmap-btn-secondary" onclick="cmGoStep(2)">Back</button>
  `;
}

function cmSelectRadio(el, mode) {
  _cmDayMode = mode;
  renderCmStep2();
}
function cmSelectSheetRadio(el, mode) {
  _cmSheetMode = mode;
  renderCmStep2();
}

function detectDays() {
  _cmDetectedDays = [];
  const exCol = _cmMapping.exercise;
  const presCol = _cmMapping.prescription;

  if (_cmDayMode === 'sheets') {
    // Each sheet = one day
    _cmDetectedDays = _cmWb.SheetNames.slice();
    return;
  }

  // Sections mode: scan for rows that look like day headers
  // A day header row: has text in exercise col and the prescription col contains a keyword like "sets", "reps", "record"
  // OR: the exercise col text is short (<30 chars) and the row has recognizable header words
  const seen = new Set();
  for (const sn of _cmWb.SheetNames) {
    const rows = _cmSheetRows[sn] || [];
    for (let i = _cmDataStartRow; i < rows.length; i++) {
      const row = rows[i]; if (!row) continue;
      const exVal = String(row[exCol] || '').trim();
      if (!exVal || exVal.length > 40) continue;

      const rowStrs = row.map(c => String(c || '').toLowerCase());
      const hasSetsHdr = rowStrs.some(s => s.includes('sets') || s.includes('record') || s.includes('reps'));

      if (hasSetsHdr && !seen.has(exVal)) {
        seen.add(exVal);
        _cmDetectedDays.push(exVal);
      }
    }
  }
}

// ── FORMAT C PARSER (uses column mapper mapping) ──────────────────────────────
function parseCWorkbook(wb) {
  if (_cmMapping.exercise < 0 || _cmMapping.prescription < 0) return [];

  // Extract metadata from non-exercise rows across all sheets
  const meta = cmExtractMetadata(wb);

  if (_cmSheetMode === 'block') {
    const allWeeks = [];
    for (const sn of wb.SheetNames) {
      const rows = _cmSheetRows[sn] || [];
      const parsed = parseCSheetAsBlock(sn, rows);
      allWeeks.push(...parsed);
    }
    if (allWeeks.length === 0) return [];
    const bId = wb._plFilename ? wb._plFilename.replace(/\.xlsx?$/i, '').trim() : wb.SheetNames[0];
    return [{ id: bId, name: meta.programName || bId || 'Training Program', dateRange: meta.dateRange || '', athleteName: meta.athleteName || 'Athlete', maxes: meta.maxes, weeks: allWeeks, format: 'C' }];
  } else {
    const weeks = [];
    for (const sn of wb.SheetNames) {
      const rows = _cmSheetRows[sn] || [];
      const week = parseCSheet(sn, rows);
      if (week) weeks.push(week);
    }
    if (weeks.length === 0) return [];
    const bId = wb._plFilename ? wb._plFilename.replace(/\.xlsx?$/i, '').trim() : wb.SheetNames[0];
    return [{ id: bId, name: meta.programName || bId || 'Training Program', dateRange: meta.dateRange || '', athleteName: meta.athleteName || 'Athlete', maxes: meta.maxes, weeks, format: 'C' }];
  }
}

// Extract useful metadata from non-exercise rows (preamble, headers, etc.)
function cmExtractMetadata(wb) {
  const meta = { athleteName: null, programName: null, dateRange: null, maxes: {} };
  const exCol = _cmMapping.exercise;
  const presCol = _cmMapping.prescription;

  // Scan first sheet's non-exercise rows for metadata
  const firstSheet = _cmSheetRows[wb.SheetNames[0]] || [];
  for (let i = 0; i < firstSheet.length; i++) {
    const row = firstSheet[i]; if (!row) continue;
    // Scan all cells in the row for metadata patterns
    for (let c = 0; c < row.length; c++) {
      const val = String(row[c] || '').trim();
      if (!val) continue;
      const vl = val.toLowerCase();

      // Max detection: "Squat: 450" or "Squat Max: 450" or "1RM Squat 450"
      const maxMatch = val.match(/(?:1\s*rm\s+)?(squat|bench|deadlift)\s*(?:max|1rm|1\s*rm)?\s*[:\-=]\s*(\d{2,4})/i)
                    || val.match(/(?:1\s*rm\s+|max\s+)(squat|bench|deadlift)\s*[:\-=]?\s*(\d{2,4})/i);
      if (maxMatch) {
        const lift = maxMatch[1].toLowerCase();
        const num = parseInt(maxMatch[2]);
        if (num > 0) {
          if (lift.includes('squat')) meta.maxes.squat = num;
          else if (lift.includes('bench')) meta.maxes.bench = num;
          else if (lift.includes('dead')) meta.maxes.deadlift = num;
        }
        continue;
      }

      // Date range detection: "2/9/2026 - 3/6/2026" or "Feb 9 - Mar 6"
      const dateMatch = val.match(/(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})\s*[\-–—to]+\s*(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})/);
      if (dateMatch && !meta.dateRange) {
        meta.dateRange = val;
        continue;
      }

      // Athlete/coach name detection via label: "Athlete: Joe" or "Name: Joe"
      const nameMatch = val.match(/^(?:athlete|name|lifter|client)\s*[:\-=]\s*(.+)/i);
      if (nameMatch && !meta.athleteName) {
        const name = nameMatch[1].trim();
        if (name.length > 1 && name.length < 40) meta.athleteName = name;
        continue;
      }

      // Program/block name via label: "Program: Hypertrophy Block 1"
      const progMatch = val.match(/^(?:program|block|cycle|phase|mesocycle)\s*[:\-=]\s*(.+)/i);
      if (progMatch && !meta.programName) {
        const name = progMatch[1].trim();
        if (name.length > 1 && name.length < 60) meta.programName = name;
        continue;
      }
    }
  }

  return meta;
}

// Junk row filter for Format C parser — skips rows that aren't exercises
// Metadata has already been extracted by cmExtractMetadata before parsing
function cmIsJunkRow(exVal, row, presCol) {
  if (!exVal) return true;
  // Pure numbers or decimals
  if (/^\d+\.?\d*\s*$/.test(exVal)) return true;
  // No letters at all
  if (!/[a-zA-Z]/.test(exVal)) return true;
  // Standalone metadata keywords (already extracted)
  if (/^(exercise|movement|lift|name|day|week|date|athlete|coach|program|block|notes?|warm\s*up|cool\s*down)$/i.test(exVal)) return true;
  // Goal/tracking metadata rows
  if (/^(goals?\s*(this\s*week)?!?|daily\s*total|total|execution|diet|cardio|other|compliance)$/i.test(exVal)) return true;
  // Standalone short metadata that aren't exercises (only if no prescription data)
  if (presCol >= 0 && (row[presCol] == null || String(row[presCol]).trim() === '')) {
    if (/^(squat|bench|deadlift)\s*$/i.test(exVal) && exVal.length < 12) return true;
  }
  // Labeled metadata rows (e.g. "Athlete: Joe", "Squat Max: 450")
  if (/^(athlete|name|lifter|client|coach|program|block|cycle|phase)\\s*[:\-=]/i.test(exVal)) return true;
  if (/(?:1\s*rm|max)\s*[:\-=]?\s*\d/i.test(exVal)) return true;
  if (/^(squat|bench|deadlift)\s*(?:max|1rm|1\s*rm)?\s*[:\-=]\s*\d/i.test(exVal)) return true;
  // Lift specs rows (grip width, stance width, etc.)
  if (/(?:grip|stance|width|inches?|in\b)/i.test(exVal) && /width/i.test(exVal)) return true;
  // Macros/nutrition rows
  if (/(?:protien|protein|carbs?|fat|calories|macros)/i.test(exVal)) return true;
  // Instruction/note rows
  if (/^(main\s*lifts|accessories)\s*[=:]/i.test(exVal)) return true;
  // Date ranges
  if (/\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4}\s*[\-–—to]+\s*\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4}/.test(exVal)) return true;
  // Duplicate header rows mid-sheet
  const el = exVal.toLowerCase();
  if (el.includes('sets x') || el.includes('sets/') || el.includes('record weight')) return true;
  if (presCol >= 0 && row[presCol] != null) {
    const pLow = String(row[presCol]).toLowerCase();
    if (pLow.includes('sets x') || pLow.includes('record') || pLow === 'reps' || pLow === 'sets') return true;
  }
  return false;
}

function parseCSheet(sn, rows) {
  // Parse one sheet as one week with day sections
  if (!rows || rows.length === 0) return null;
  const exCol = _cmMapping.exercise;
  const presCol = _cmMapping.prescription;
  const logCol = _cmMapping.logged;
  const coachCol = _cmMapping.coachNotes;
  const lifterCol = _cmMapping.lifterNotes;

  // Helper: build prescription from split or combined columns
  function getPres(row) {
    if (_cmSplitPres) {
      const sets = _cmMapping.setsCol >= 0 && row[_cmMapping.setsCol] != null ? String(row[_cmMapping.setsCol]).trim() : '';
      const reps = _cmMapping.repsCol >= 0 && row[_cmMapping.repsCol] != null ? String(row[_cmMapping.repsCol]).trim() : '';
      const load = _cmMapping.loadCol >= 0 && row[_cmMapping.loadCol] != null ? String(row[_cmMapping.loadCol]).trim() : '';
      if (!sets && !reps) return null;
      const isSimple = (v) => /^\d+\.?\d*$/.test(v);
      // If sets col has a full prescription (NxN patterns, commas, words), use directly
      if (sets && !isSimple(sets) && (/\d+x\d+/.test(sets) || /,/.test(sets) || /[a-zA-Z]{3,}/.test(sets))) {
        let p = sets;
        if (reps && !isSimple(reps)) p += ' ' + reps;
        if (load && !isSimple(load) && !/rpe/i.test(load)) p += ' ' + load;
        return p.trim() || null;
      }
      let p = '';
      if (sets && reps) p = sets.replace(/\.0$/, '') + 'x' + reps.replace(/\.0$/, '');
      else if (sets) p = sets.replace(/\.0$/, '');
      else if (reps) p = reps;
      if (load) p += ' ' + load;
      return p.trim() || null;
    }
    return presCol >= 0 && row[presCol] != null ? String(row[presCol]).trim() : null;
  }

  // Helper: get effective presCol for junk detection
  const junkPresCol = _cmSplitPres ? _cmMapping.setsCol : presCol;

  const days = [];
  let curDay = null;

  if (_cmDayMode === 'sheets') {
    // Entire sheet is one day
    curDay = { name: sn, exercises: [] };
    days.push(curDay);
    for (let i = _cmDataStartRow; i < rows.length; i++) {
      const row = rows[i]; if (!row) continue;
      const exVal = String(row[exCol] || '').trim();
      // Skip header rows
      const rowStrs = row.map(c => String(c || '').toLowerCase());
      if (rowStrs.some(s => s.includes('sets') || s.includes('record') || s.includes('exercise'))) continue;
      // Skip junk
      if (cmIsJunkRow(exVal, row, presCol)) continue;
      const pres = presCol >= 0 && row[presCol] != null ? String(row[presCol]).trim() : null;
      const logged = logCol >= 0 && row[logCol] != null ? String(row[logCol]).trim() || null : null;
      const note = coachCol >= 0 && row[coachCol] != null ? String(row[coachCol]).trim() || null : null;
      const lifterNote = lifterCol >= 0 && row[lifterCol] != null ? String(row[lifterCol]).trim() || null : null;
      curDay.exercises.push({ name: exVal.replace(/\s+/g, ' '), prescription: pres, note, lifterNote, loggedWeight: logged });
    }
  } else {
    // Sections mode — detect day header rows
    for (let i = _cmDataStartRow; i < rows.length; i++) {
      const row = rows[i]; if (!row) continue;
      const exVal = String(row[exCol] || '').trim();
      if (!exVal) continue;

      const rowStrs = row.map(c => String(c || '').toLowerCase());
      const hasSetsHdr = rowStrs.some(s => s.includes('sets') || s.includes('record') || s.includes('reps'));
      const isDayHeader = hasSetsHdr && exVal.length < 40;

      if (isDayHeader) {
        if (!_cmExcludedSections.has(exVal)) {
          curDay = { name: exVal, exercises: [] };
          days.push(curDay);
        } else {
          curDay = null; // skip this section
        }
      } else if (curDay) {
        // Skip junk
        if (cmIsJunkRow(exVal, row, presCol)) continue;
        const pres = presCol >= 0 && row[presCol] != null ? String(row[presCol]).trim() : null;
        const logged = logCol >= 0 && row[logCol] != null ? String(row[logCol]).trim() || null : null;
        const note = coachCol >= 0 && row[coachCol] != null ? String(row[coachCol]).trim() || null : null;
        const lifterNote = lifterCol >= 0 && row[lifterCol] != null ? String(row[lifterCol]).trim() || null : null;
        curDay.exercises.push({ name: exVal.replace(/\s+/g, ' '), prescription: pres, note, lifterNote, loggedWeight: logged });
      }
    }
  }

  // Remove empty days (all exercises filtered out)
  const filteredDays = days.filter(d => d.exercises.length > 0);
  if (filteredDays.length === 0) return null;
  return { label: sn, days: filteredDays };
}

function parseCSheetAsBlock(sn, rows) {
  // Parse one sheet that contains an entire block (multiple weeks)
  // Returns array of week objects
  const week = parseCSheet(sn, rows);
  if (!week) return [];
  // For a block-in-one-sheet, the whole thing is one "week" — user can split later
  return [week];
}

function confirmColumnMapper() {
  const blocks = parseCWorkbook(_cmWb);
  if (!blocks || blocks.length === 0) return;

  // Save mapping for future use
  const fp = getFileFingerprint(_cmWb);
  if (fp) {
    saveMappingForFile(fp, { ..._cmMapping });
  }

  closeColumnMapper();

  // Apply user-entered metadata from step 3
  const filename = _cmWb._plFilename || '';
  const namePart = filename.replace(/\.xlsx?$/i, '').replace(/_/g, ' ').trim();
  blocks.forEach(b => {
    // Athlete name: user input > auto-detected > filename
    if (_cmMeta.athlete && _cmMeta.athlete.trim()) {
      b.athleteName = _cmMeta.athlete.trim();
    } else if (b.athleteName === 'Athlete') {
      b.athleteName = namePart;
    }
    // Program name: user input > auto-detected > filename
    if (_cmMeta.program && _cmMeta.program.trim()) {
      b.name = _cmMeta.program.trim();
    } else if (b.name === 'Training Program') {
      b.name = namePart;
    }
    // Maxes: user input overrides auto-detected
    if (!b.maxes) b.maxes = {};
    if (_cmMeta.squat && +_cmMeta.squat > 0) b.maxes.squat = +_cmMeta.squat;
    if (_cmMeta.bench && +_cmMeta.bench > 0) b.maxes.bench = +_cmMeta.bench;
    if (_cmMeta.deadlift && +_cmMeta.deadlift > 0) b.maxes.deadlift = +_cmMeta.deadlift;
  });

  openImportIntent(blocks);
}

// ── CALCULATOR ────────────────────────────────────────────────────────────────
const KG_TO_LBS = 2.2046; // USPA standard conversion factor (1 kg = KG_TO_LBS lbs)
const KG_PLATES = [25, 20, 15, 10, 5, 2.5, 1.25, 0.5, 0.25];
const PLATE_COLORS = {
  25: '#e63946',
  20: '#1d7ed8',
  15: '#f4a228',
  10: '#2daa4f',
  5: '#d4d4d4',
  2.5: '#333333',
  1.25: '#aaaaaa',
  0.5: '#bbbbbb',
  0.25: '#cccccc'
};
const BARS = [
  { id: 'standard', label: 'Standard Bar', kg: 20, lbs: 44 },
  { id: 'squat',    label: 'Squat Bar',    kg: 25, lbs: 55 }
];
const COLLAR_KG = 5; // pair



function lbsToKg(lbs) { return lbs / KG_TO_LBS; }
function kgToLbs(kg) { return kg * KG_TO_LBS; }
// Snap a kg value to nearest valid USPA attempt (multiples of 2.5kg per side)
function snapToAttempt(kg, direction) {
  const base = getBaseKg();
  const load = Math.max(0, kg - base);
  let snapped;
  if (direction === 'up')        snapped = Math.ceil(load / 2.5) * 2.5;
  else if (direction === 'down') snapped = Math.floor(load / 2.5) * 2.5;
  else                           snapped = Math.round(load / 2.5) * 2.5;
  return base + snapped;
}

function getBarKg() { return BARS.find(b => b.id === state.calc.barId).kg; }
function getCollarKg() { return state.calc.collarsOn ? COLLAR_KG : 0; }
function getBaseKg() { return getBarKg() + getCollarKg(); }

// Given a target total kg, return {plates: [{kg, count}], totalKg, remainder}
function calcPlates(targetKg) {
  let loadKg = targetKg - getBaseKg();
  if (loadKg < 0) return null;
  let perSide = loadKg / 2;
  let remaining = perSide;
  let plates = [];
  for (const p of KG_PLATES) {
    if (remaining <= 0) break;
    const count = Math.floor(remaining / p + 0.001);
    if (count > 0) {
      plates.push({ kg: p, count });
      remaining -= count * p;
      remaining = Math.round(remaining * 1000) / 1000;
    }
  }
  const actualPerSide = plates.reduce((s, p) => s + p.kg * p.count, 0);
  const actualTotal = getBaseKg() + actualPerSide * 2;
  return { plates, totalKg: actualTotal, remainder: Math.round(remaining * 1000) / 1000 };
}

function manualTotal() {
  let perSide = 0;
  for (const [kg, count] of Object.entries(state.calc.manualCounts)) {
    perSide += parseFloat(kg) * count;
  }
  return getBaseKg() + perSide * 2;
}

function renderCalcBarSVG(plates, showCollars) {
  let allPlates = [];
  for (const p of plates) {
    for (let i = 0; i < p.count; i++) allPlates.push(p.kg);
  }

  function pThick(kg) {
    if (kg >= 25) return 16; if (kg >= 20) return 15; if (kg >= 15) return 13;
    if (kg >= 10) return 12; if (kg >= 5) return 10; if (kg >= 2.5) return 9;
    if (kg >= 1.25) return 11; if (kg >= 0.5) return 9; return 7;
  }
  function pDiam(kg) {
    if (kg >= 25) return 190; if (kg >= 20) return 190; if (kg >= 15) return 152;
    if (kg >= 10) return 130; if (kg >= 5)  return 104; if (kg >= 2.5) return 82;
    if (kg >= 1.25) return 64; if (kg >= 0.5) return 48; return 36;
  }

  const SVG_H = 260;
  const cy = SVG_H / 2 - 10;
  const barH = 10;
  const divider = 1;
  const padLeft = 8;

  const builtinCollarThick = 10;
  const builtinCollarH = 26;
  const compCollarThick = 14;
  const compCollarH = 38;

  // Shaft extends to fill container — always show generous bar to the right
  let totalPlateW = allPlates.reduce((s, kg) => s + pThick(kg), 0);
  if (allPlates.length > 1) totalPlateW += divider * (allPlates.length - 1);
  const compCollarW = showCollars ? compCollarThick + 3 : 0;
  const minRightShaft = 80; // always show this much empty bar after plates
  const contentW = padLeft + builtinCollarThick + totalPlateW + compCollarW + minRightShaft;
  const SVG_W = Math.max(contentW, 220);

  let parts = [];

  // Bar shaft — full width
  parts.push(`<rect x="${padLeft}" y="${cy - barH/2}" width="${SVG_W - padLeft}" height="${barH}" rx="3" fill="#555"/>`);
  parts.push(`<rect x="${padLeft}" y="${cy - barH/2}" width="${SVG_W - padLeft}" height="3" rx="1" fill="rgba(255,255,255,0.08)"/>`);

  let x = padLeft;

  // Built-in collar
  parts.push(`<rect x="${x}" y="${cy - builtinCollarH/2}" width="${builtinCollarThick}" height="${builtinCollarH}" rx="2" fill="#6a6a6a" stroke="rgba(0,0,0,0.4)" stroke-width="0.5"/>`);
  parts.push(`<rect x="${x+1}" y="${cy - builtinCollarH/2 + 1}" width="${builtinCollarThick-2}" height="2" rx="1" fill="rgba(255,255,255,0.12)"/>`);
  parts.push(`<line x1="${x+2}" y1="${cy - builtinCollarH/2 + 4}" x2="${x+builtinCollarThick-2}" y2="${cy - builtinCollarH/2 + 4}" stroke="rgba(0,0,0,0.3)" stroke-width="1"/>`);
  parts.push(`<line x1="${x+2}" y1="${cy + builtinCollarH/2 - 4}" x2="${x+builtinCollarThick-2}" y2="${cy + builtinCollarH/2 - 4}" stroke="rgba(0,0,0,0.3)" stroke-width="1"/>`);
  x += builtinCollarThick;

  // Plates
  for (let i = 0; i < allPlates.length; i++) {
    const kg = allPlates[i];
    const pt = pThick(kg);
    const ph = pDiam(kg);
    const color = PLATE_COLORS[kg];

    if (i > 0) {
      parts.push(`<rect x="${x}" y="${cy - pDiam(allPlates[i-1])/2}" width="1" height="${pDiam(allPlates[i-1])}" fill="rgba(0,0,0,0.6)"/>`);
      x += divider;
    }

    parts.push(`<rect x="${x}" y="${cy - ph/2}" width="${pt}" height="${ph}" rx="2" fill="${color}" stroke="rgba(0,0,0,0.3)" stroke-width="0.5"/>`);
    parts.push(`<rect x="${x+1}" y="${cy - ph/2 + 1}" width="${pt-2}" height="2" rx="1" fill="rgba(255,255,255,0.18)"/>`);
    parts.push(`<rect x="${x+1}" y="${cy + ph/2 - 3}" width="${pt-2}" height="2" rx="1" fill="rgba(0,0,0,0.2)"/>`);

    // Labels: horizontal below all plates, smaller font for narrow ones
    const labelCx = x + pt/2;
    if (kg <= 2.5) {
      const labelY = cy + ph/2 + 12;
      const fontSize = kg < 1 ? 7 : 8;
      parts.push(`<text x="${labelCx}" y="${labelY}" text-anchor="middle" dominant-baseline="central" fill="#ccc" font-family="Barlow Condensed, sans-serif" font-weight="700" font-size="${fontSize}">${kg}</text>`);
    } else {
      const labelY = cy + ph/2 + 14;
      parts.push(`<text x="${labelCx}" y="${labelY}" text-anchor="middle" dominant-baseline="central" fill="#ccc" font-family="Barlow Condensed, sans-serif" font-weight="700" font-size="11">${kg}</text>`);
    }

    x += pt;
  }

  // Competition collar
  if (showCollars) {
    const cx2 = x;
    parts.push(`<rect x="${cx2}" y="${cy - compCollarH/2}" width="${compCollarThick}" height="${compCollarH}" rx="3" fill="#999" stroke="rgba(0,0,0,0.45)" stroke-width="0.75"/>`);
    parts.push(`<rect x="${cx2+1}" y="${cy - compCollarH/2 + 2}" width="${compCollarThick-2}" height="3" rx="1" fill="rgba(255,255,255,0.15)"/>`);
    parts.push(`<rect x="${cx2+2}" y="${cy-5}" width="${compCollarThick-4}" height="10" rx="2" fill="#777"/>`);
    parts.push(`<circle cx="${cx2 + compCollarThick/2}" cy="${cy}" r="3.5" fill="#555"/>`);
    parts.push(`<circle cx="${cx2 + compCollarThick/2}" cy="${cy}" r="1.5" fill="#888"/>`);
    const handleX = cx2 + compCollarThick/2;
    const handleBaseY = cy - compCollarH/2;
    parts.push(`<rect x="${handleX-2.5}" y="${handleBaseY-18}" width="5" height="18" rx="2" fill="#888"/>`);
    parts.push(`<ellipse cx="${handleX}" cy="${handleBaseY-18}" rx="3.5" ry="3" fill="#111"/>`);
    parts.push(`<circle cx="${handleX}" cy="${handleBaseY}" r="3" fill="#666"/>`);
    parts.push(`<circle cx="${handleX}" cy="${handleBaseY}" r="1.5" fill="#aaa"/>`);
  }

  // viewBox anchored to left edge (collar), width fills container
  return `<svg viewBox="0 0 ${SVG_W} ${SVG_H}" width="100%" height="${SVG_H}" style="display:block" xmlns="http://www.w3.org/2000/svg">${parts.join('')}</svg>`;
}
function renderCalc() {
  const main = document.getElementById('main-content');
  const { mode, inputUnit, inputVal, manualCounts } = state.calc;
  const isLight = document.documentElement.getAttribute('data-theme') === 'light';
  // theme-aware inline color tokens
  const T = isLight ? {
    inputBg:       '#FFFFFF',
    inputBorder:   '1px solid #D6CEC4',
    inputColor:    '#1A1A1A',
    unitBg:        '#FFFFFF',
    unitBorder:    (active) => active ? '1px solid rgba(184,146,42,0.7)' : '1px solid #D6CEC4',
    unitBg2:       (active) => active ? 'rgba(184,146,42,0.1)' : '#F5F0E8',
    unitColor:     (active) => active ? '#B8922A' : '#6B6460',
    snapBg:        '#F5F0E8',
    snapMidBg:     '#FFFFFF',
    snapBorder:    '1px solid #D6CEC4',
    snapMidBorder: '1px solid rgba(184,146,42,0.6)',
    snapColor:     '#6B6460',
    snapMidColor:  '#B8922A',
    totalBg:       '#FFFFFF',
    totalBorder:   '1px solid #D6CEC4',
    totalVal:      '#1A1A1A',
  } : {
    inputBg:       'rgba(0,0,0,0.3)',
    inputBorder:   '1px solid rgba(255,255,255,0.08)',
    inputColor:    '#f0f0f0',
    unitBg:        'transparent',
    unitBorder:    (active) => active ? '1px solid rgba(201,168,76,0.6)' : '1px solid rgba(255,255,255,0.08)',
    unitBg2:       (active) => active ? 'rgba(201,168,76,0.12)' : 'rgba(255,255,255,0.03)',
    unitColor:     (active) => active ? '#C9A84C' : '#555',
    snapBg:        'var(--snap-chip-bg)',
    snapMidBg:     'var(--snap-chip-mid)',
    snapBorder:    '1px solid var(--border)',
    snapMidBorder: '1px solid #C9A84C55',
    snapColor:     '#888',
    snapMidColor:  '#C9A84C',
    totalBg:       'rgba(0,0,0,0.3)',
    totalBorder:   '1px solid rgba(255,255,255,0.06)',
    totalVal:      '#C9A84C',
  };

  let totalKg = 0, totalLbs = 0, plates = [], remainder = 0, noSolution = false;

  if (mode === 'target') {
    const numVal = parseFloat(inputVal);
    if (!isNaN(numVal) && numVal > 0) {
      let rawKg = inputUnit === 'lbs' ? lbsToKg(numVal) : numVal;
      // Round the *load* UP to the nearest 2.5kg step (= 1x 1.25kg plate per side, standard minimum)
      // Always round UP — entering 440 lbs should never give you less than 440 lbs
      let targetKg = snapToAttempt(rawKg);
      const baseKg = getBaseKg();
      if (targetKg < baseKg) targetKg = baseKg;
      const result = calcPlates(targetKg);
      if (result) {
        plates = result.plates;
        totalKg = result.totalKg;
        totalLbs = kgToLbs(totalKg);
        remainder = result.remainder;
        if (remainder > 0.01) noSolution = true;
      }
    }
  } else {
    totalKg = manualTotal();
    totalLbs = kgToLbs(totalKg);
    plates = KG_PLATES
      .map(kg => ({ kg, count: manualCounts[kg] || 0 }))
      .filter(p => p.count > 0);
  }

  const hasPlates = plates.some(p => p.count > 0);
  const barSVG = renderCalcBarSVG(plates, state.calc.collarsOn);

  // Plate breakdown chips (for target mode)
  let breakdownHtml = '';
  if (hasPlates) {
    breakdownHtml = `<div class="calc-plate-breakdown">`;
    for (const p of plates) {
      if (p.count === 0) continue;
      const total = p.count * 2; // both sides
      breakdownHtml += `<div class="calc-plate-chip">
        <div class="calc-plate-dot" style="background:${PLATE_COLORS[p.kg]}"></div>
        <span class="calc-plate-label">${p.kg}kg</span>
        <span class="calc-plate-count">×${p.count} per side</span>
      </div>`;
    }
    breakdownHtml += `</div>`;
  }

  // Manual plate rows
  let manualRowsHtml = '';
  const manualPlateOrder = [25, 2.5, 20, 1.25, 15, 0.5, 10, 0.25, 5];
  for (const kg of manualPlateOrder) {
    const count = manualCounts[kg] || 0;
    manualRowsHtml += `
      <div class="calc-plate-row">
        <div class="calc-plate-color-swatch" style="background:${PLATE_COLORS[kg]}"></div>
        <span class="calc-plate-name">${kg}kg</span>
        <div class="calc-plate-stepper">
          <button class="calc-stepper-btn" onclick="calcAdjust(${kg}, -1)">−</button>
          <span class="calc-stepper-val${count === 0 ? ' zero' : ''}">${count}</span>
          <button class="calc-stepper-btn" onclick="calcAdjust(${kg}, 1)">+</button>
        </div>
      </div>`;
  }

  const bar = BARS.find(b => b.id === state.calc.barId);
  const collarNote = state.calc.collarsOn ? ` + collars (5kg)` : '';
  const plateNote = hasPlates ? ` + ${plates.map(p => `${p.count}×${p.kg}kg`).join(' + ')} per side` : '';

  // Attempt snaps for target mode
  const snapHtml = (mode === 'target' && inputUnit === 'lbs' && inputVal && !isNaN(parseFloat(inputVal))) ? (() => {
    const rounded = snapToAttempt(lbsToKg(parseFloat(inputVal)));
    const roundedLbs = (rounded * KG_TO_LBS).toFixed(1);
    const roundedDisplay = rounded % 1 === 0 ? rounded.toFixed(0) : rounded.toFixed(1);
    const down = rounded - 2.5; const up = rounded + 2.5;
    const downLbs = (down * KG_TO_LBS).toFixed(1); const upLbs = (up * KG_TO_LBS).toFixed(1);
    const downDisplay = down % 1 === 0 ? down.toFixed(0) : down.toFixed(1);
    const upDisplay = up % 1 === 0 ? up.toFixed(0) : up.toFixed(1);
    return `<div style="margin-top:10px;">
      <div style="font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:700;letter-spacing:0.12em;text-transform:uppercase;color:var(--text-faint);margin-bottom:6px;text-align:center;">Valid Attempt</div>
      <div style="display:flex;align-items:center;justify-content:center;gap:6px;flex-wrap:wrap;">
      <div onclick="calcSnapToNearest(${down})" style="display:flex;align-items:center;gap:3px;cursor:pointer;background:${T.snapBg};border:${T.snapBorder};border-radius:8px;padding:4px 8px;font-size:11px;color:${T.snapColor};">
        <span style="color:#C9A84C;font-size:13px;">−</span><span>${downDisplay}kg</span><span style="color:var(--text-faint);font-size:10px;">${downLbs}</span>
      </div>
      <div onclick="calcSnapToNearest(${rounded})" style="display:flex;align-items:center;gap:3px;cursor:pointer;background:${T.snapMidBg};border:${T.snapMidBorder};border-radius:8px;padding:4px 8px;font-size:11px;color:${T.snapMidColor};font-weight:600;">
        <span>→ ${roundedDisplay}kg</span><span style="color:var(--text-sub);font-size:10px;">${roundedLbs}</span>
      </div>
      <div onclick="calcSnapToNearest(${up})" style="display:flex;align-items:center;gap:3px;cursor:pointer;background:${T.snapBg};border:${T.snapBorder};border-radius:8px;padding:4px 8px;font-size:11px;color:${T.snapColor};">
        <span style="color:#C9A84C;font-size:13px;">+</span><span>${upDisplay}kg</span><span style="color:var(--text-faint);font-size:10px;">${upLbs}</span>
      </div>
      </div>
    </div>`;
  })() : '';

  let html = `<div class="calc-screen">

    <!-- ── MODE TOGGLE ── -->
    <div class="calc-section" style="padding:12px;">
      <div class="calc-mode-toggle">
        <button class="calc-mode-btn${mode === 'target' ? ' active' : ''}" onclick="calcSetMode('target')">Target Weight</button>
        <button class="calc-mode-btn${mode === 'manual' ? ' active' : ''}" onclick="calcSetMode('manual')">Load Manually</button>
      </div>
    </div>

    ${mode === 'target' ? `

      <!-- ── TARGET: INPUT ── -->
      <div class="calc-section" style="padding:12px;">
        <div style="display:flex;gap:8px;align-items:stretch;height:68px;">
          <input class="calc-weight-input" id="calc-input" type="number" inputmode="decimal" placeholder="0" value="${inputVal}" onblur="calcInput(this.value)" onkeydown="if(event.key==='Enter'){this.blur()}" style="flex:1;min-width:0;background:${T.inputBg};border:${T.inputBorder};color:${T.inputColor};" />
          <div style="display:flex;flex-direction:column;gap:4px;flex-shrink:0;width:56px;">
            <button onclick="calcSetUnit('lbs')" style="flex:1;border-radius:7px;border:${T.unitBorder(inputUnit==='lbs')};background:${T.unitBg2(inputUnit==='lbs')};color:${T.unitColor(inputUnit==='lbs')};font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:13px;letter-spacing:0.06em;cursor:pointer;transition:all 0.15s;">LBS</button>
            <button onclick="calcSetUnit('kg')" style="flex:1;border-radius:7px;border:${T.unitBorder(inputUnit==='kg')};background:${T.unitBg2(inputUnit==='kg')};color:${T.unitColor(inputUnit==='kg')};font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:13px;letter-spacing:0.06em;cursor:pointer;transition:all 0.15s;">KG</button>
          </div>
        </div>
        ${snapHtml}
      </div>

      <!-- ── TARGET: BAR VISUAL + TOTALS ── -->
      <div class="calc-section" style="padding:12px 12px 10px;">
        <div class="calc-bar-visual-zone">
          <div class="calc-bar-wrap">${barSVG}</div>
          ${noSolution ? `<div class="calc-no-solution"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg> Weight not achievable with standard KG plates</div>` : ''}
          ${breakdownHtml}
        </div>
        <div class="calc-totals-display" style="margin-top:10px;margin-bottom:4px;">
          <div class="calc-total-box">
            <div class="calc-total-val">${totalKg % 1 === 0 ? totalKg.toFixed(0) : totalKg.toFixed(1)}</div>
            <div class="calc-total-unit">Kilograms</div>
          </div>
          <div class="calc-total-box">
            <div class="calc-total-val">${totalLbs.toFixed(1)}</div>
            <div class="calc-total-unit">Pounds</div>
          </div>
        </div>
        <div class="calc-bar-note">${bar.label} (${bar.kg}kg)${collarNote}${plateNote || ' — bar only'}</div>
      </div>

      <!-- ── TARGET: BAR SELECTION + COLLARS ── -->
      <div class="calc-section" style="padding:12px;">
        <div class="calc-bar-selector" style="margin-bottom:10px;">
          ${BARS.map(b => `<button class="calc-bar-btn${state.calc.barId === b.id ? ' active' : ''}" onclick="calcSetBar('${b.id}')">
            ${b.label}<span class="calc-bar-btn-sub">${b.kg}kg / ${b.lbs}lbs</span>
          </button>`).join('')}
        </div>
        <div class="calc-collar-row">
          <div>
            <div class="calc-collar-label">Collars</div>
            <div class="calc-collar-sub">2.5kg each · 5kg / 11lbs total</div>
          </div>
          <button class="calc-collar-toggle${state.calc.collarsOn ? ' on' : ''}" onclick="calcToggleCollars()"></button>
        </div>
      </div>

    ` : `

      <!-- ── MANUAL: PLATE GRID ── -->
      <div class="calc-section" style="padding:12px;">
        <div class="calc-section-title" style="margin-bottom:10px;">Plates (per side)</div>
        <div class="calc-plates-grid">${manualRowsHtml}</div>
        <button class="calc-reset-btn" onclick="calcReset()">Clear All Plates</button>
      </div>

      <!-- ── MANUAL: BAR VISUAL + TOTALS ── -->
      <div class="calc-section" style="padding:12px 12px 10px;">
        <div class="calc-bar-visual-zone">
          <div class="calc-bar-wrap">${barSVG}</div>
          ${breakdownHtml}
        </div>
        <div class="calc-totals-display" style="margin-top:10px;margin-bottom:4px;">
          <div class="calc-total-box">
            <div class="calc-total-val">${totalKg % 1 === 0 ? totalKg.toFixed(0) : totalKg.toFixed(1)}</div>
            <div class="calc-total-unit">Kilograms</div>
          </div>
          <div class="calc-total-box">
            <div class="calc-total-val">${totalLbs.toFixed(1)}</div>
            <div class="calc-total-unit">Pounds</div>
          </div>
        </div>
        <div class="calc-bar-note">${bar.label} (${bar.kg}kg)${collarNote}${plateNote || ' — bar only'}</div>
      </div>

      <!-- ── MANUAL: BAR SELECTION + COLLARS ── -->
      <div class="calc-section" style="padding:12px;">
        <div class="calc-bar-selector" style="margin-bottom:10px;">
          ${BARS.map(b => `<button class="calc-bar-btn${state.calc.barId === b.id ? ' active' : ''}" onclick="calcSetBar('${b.id}')">
            ${b.label}<span class="calc-bar-btn-sub">${b.kg}kg / ${b.lbs}lbs</span>
          </button>`).join('')}
        </div>
        <div class="calc-collar-row">
          <div>
            <div class="calc-collar-label">Collars</div>
            <div class="calc-collar-sub">2.5kg each · 5kg / 11lbs total</div>
          </div>
          <button class="calc-collar-toggle${state.calc.collarsOn ? ' on' : ''}" onclick="calcToggleCollars()"></button>
        </div>
      </div>

    `}

  </div>`;
  main.innerHTML = html;
}

function calcSnapToNearest(targetKg) {
  // Populate input with the nearest valid attempt value
  // Convert back to whatever unit is currently selected
  if (state.calc.inputUnit === 'lbs') {
    const lbs = Math.round(targetKg * KG_TO_LBS * 10) / 10;
    state.calc.inputVal = String(lbs);
  } else {
    state.calc.inputVal = String(targetKg % 1 === 0 ? targetKg : targetKg.toFixed(1));
  }
  const inp = document.getElementById('calc-weight-input');
  if (inp) inp.value = state.calc.inputVal;
  renderCalc();
}

function calcSetMode(m) { state.calc.mode = m; renderCalc(); }
function calcSetUnit(u) { state.calc.inputUnit = u; renderCalc(); }
function calcInput(v) { state.calc.inputVal = v; renderCalc(); }
function calcSetBar(id) { state.calc.barId = id; renderCalc(); }
function calcToggleCollars() { state.calc.collarsOn = !state.calc.collarsOn; renderCalc(); }
function calcAdjust(kg, delta) {
  const cur = state.calc.manualCounts[kg] || 0;
  state.calc.manualCounts[kg] = Math.max(0, cur + delta);
  renderCalc();
}
function calcReset() {
  for (const kg of KG_PLATES) state.calc.manualCounts[kg] = 0;
  renderCalc();
}
</script>
</body>
</html>